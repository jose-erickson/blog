<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Rundis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <link href="/blog/css/bootstrap.min.css" rel="stylesheet">
    <link href="/blog/css/asciidoctor.css" rel="stylesheet">
    <link href="/blog/css/base.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href="/blog/css/prettify.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/blog/assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/blog/assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/blog/assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/blog/assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="favicon.ico">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-58695124-1', 'auto');
      ga('send', 'pageview');

    </script>
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog/index.html">Rundis</a>
        </div>
        <div class="navbar-collapse collapse bs-navbar-collapse">
            <ul class="nav navbar-nav">
                <li><a href="/blog/archive.html">Archive</a></li>
                <li><a href="/blog/about.html">About</a></li>
                <li><a href="/blog/feed.xml">Subscribe</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="https://github.com/rundis/blog"><i class="fa fa-lg fa-github"></i></a>
                </li>
            </ul>
        </div>
    </div>
</div>
<div class="container">

	<div class="page-header">
		<h1>Blog</h1>
	</div>
  			<a href="/blog/2016/haskel_elm_spa_part2.html"><h1>Typed up CRUD SPA with Haskell and Elm - Part 2: Persistence up and running</h1></a>
  			<p>14 January 2016</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/haskell.html">haskell</a>
	      
		      <a href="/blog/tags/elm.html">elm</a>
	      
		      <a href="/blog/tags/haskellelmspa.html">haskellelmspa</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Typed up CRUD SPA with Haskell and Elm - Part 2: Persistence up and running"
           data-url="http://rundis.github.io/blog/2016/haskel_elm_spa_part2.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>My journey into Elm and Haskell continues. It&#8217;s time to add database support.</p>
</div>
<div class="paragraph">
<p>Since <a href="http://rundis.github.io/blog/2015/haskell_elm_spa_part1.html">episode 1</a> I&#8217;ve
managed to implement simple CRUD features for the Artist entity of the <a href="https://github.com/rundis/albums">Albums</a> sample application.
It&#8217;s been anything but plain sailing, but it&#8217;s been a blast so far. Trying to wrap my head around two
new languages and their libraries in parallell is somewhat daunting. The journey would probably
have been smoother if I took more time to learn the language proper. Learning by doing is at times
frustrating, at the same time very rewarding when stuff finally works.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>There seems to be a pretty close correlation between <strong>it compiles</strong> and <strong>it works</strong> when programming
in Elm and Haskell</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Magnus<br>
<cite>(yeah I know; correlation does not imply causation)</cite>
</div>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_overview">Overview</a></li>
<li><a href="#_backend">Backend</a>
<ul class="sectlevel2">
<li><a href="#_adding_cors_support">Adding cors support</a></li>
<li><a href="#_enter_sqlite">Enter SQLite</a></li>
<li><a href="#_backend_summary">Backend summary</a></li>
</ul>
</li>
<li><a href="#_frontend">Frontend</a>
<ul class="sectlevel2">
<li><a href="#_frontend_summary">Frontend summary</a></li>
</ul>
</li>
<li><a href="#_conclusion_and_next_steps">Conclusion and next steps</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overview">Overview</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="ulist">
<div class="title">Useful resources</div>
<ul>
<li>
<p>Check out the other <a href="http://rundis.github.io/blog/tags/haskellelmspa.html">episodes</a> in this blog series.</p>
</li>
<li>
<p>The accompanying <a href="https://github.com/rundis/albums">Albums</a> sample app is on github, and there is a tag
for each episode</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">So what have I done for this episode ?</div>
<ul>
<li>
<p>Added persistence support to the haskell/servant backend server using <a href="https://www.sqlite.org/">SQLite</a></p>
</li>
<li>
<p>REST API now supports POST, PUT, DELETE and GET (multiple/single) Artists</p>
</li>
<li>
<p>The Elm frontend has features for listing, deleting, updating and creating new artists</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="http://rundis.github.io/blog/2016/albumlistingpage.png" alt="albumlistingpage">
</div>
</div>
<div class="paragraph">
<p>I&#8217;ve taken a bottom up approach to developing the features. For both the Frontend and the Backend I&#8217;ve
implemented everything in one module. After that I&#8217;ve done pretty substantial refactorings into smaller
modules while letting the respective compilers guide me along the way. So how did that work out ?</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_backend">Backend</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pretty early on I managed to get <a href="https://github.com/lukexi/halive">halive</a> to start working. Having live recompiling is
really nice and seriously improved my workflow. I have very limited editor support because my editor (<a href="https://github.com/LightTable/LightTable">Light Table</a>)
currently doesn&#8217;t provide much in terms of haskell support. I was almost derailed with developing a Haskell plugin (or making the existing one work), but
managed to keep on track.</p>
</div>
<div class="sect2">
<h3 id="_adding_cors_support">Adding cors support</h3>
<div class="paragraph">
<p>During development of the spike for the previous episode I used a chrome plugin to get around CORS
restrictions from my browser. Surely this has to be solvable ? Indeed it was, <a href="https://github.com/larskuhtz/wai-cors">wai-cors</a> to the rescue.</p>
</div>
<div class="listingblock">
<div class="title">backend/albums.cabal</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">  build-depends:
    -- ...
    ,  wai-cors
    -- ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">backend/src/Main.hs</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">;....

import Network.Wai.Middleware.Cors

;....

albumCors :: Middleware
albumCors = cors $ const (Just albumResourcePolicy)                             <i class="conum" data-value="1"></i><b>(1)</b>


albumResourcePolicy :: CorsResourcePolicy                                       <i class="conum" data-value="2"></i><b>(2)</b>
albumResourcePolicy =
    CorsResourcePolicy
        { corsOrigins = Nothing -- gives you /*
        , corsMethods = ["GET", "POST", "PUT", "DELETE", "HEAD", "OPTION"]
        , corsRequestHeaders = simpleHeaders -- adds "Content-Type" to defaults
        , corsExposedHeaders = Nothing
        , corsMaxAge = Nothing
        , corsVaryOrigin = False
        , corsRequireOrigin = False
        , corsIgnoreFailures = False
        }


main :: IO ()
main = do
  run 8081 $ albumCors $ app                                                    <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define wai cors middleware</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define a cors policy. This one is very lax. You wouldn&#8217;t want to use this for anything public facing as is</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Apply the middleware to our app. Now cross origin headers are added and OPTION prefligh requests are supported. Nice</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Cors inspiration harvested from <a href="https://github.com/nicklawls/lessons" class="bare">https://github.com/nicklawls/lessons</a> btw
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_enter_sqlite">Enter SQLite</h3>
<div class="paragraph">
<p>I looked at a few different options for database support. Most examples and tutorials related
to servant and database usage seems to favor <a href="http://www.yesodweb.com/book/persistent">persistent</a>.
I&#8217;m surely going to have a closer look at that, but my initial impression was that perhaps there was just
a little bit to much going on there. Just a little bit to much "magic" ? Having lost my taste
for ORM&#8217;s in the JVM spehere (hibernate in particular) I wanted to start with something closer to the metal.</p>
</div>
<div class="paragraph">
<p>So to make it a little harder for myself I went for the <a href="https://github.com/nurpax/sqlite-simple">sqlite-simple</a> library.
Pretty happy with the choice so far.</p>
</div>
<div class="listingblock">
<div class="title">backend/albums.cabal</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">  build-depends:
    -- ...
    , sqlite-simple
    -- ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">backend/Main.hs</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">{-# LANGUAGE OverloadedStrings #-}
module Main where


import qualified Storage as S                              <i class="conum" data-value="1"></i><b>(1)</b>
import qualified Api as A                                  <i class="conum" data-value="2"></i><b>(2)</b>
import Network.Wai
import Network.Wai.Handler.Warp
import Servant
import Network.Wai.Middleware.Cors
import Control.Exception (bracket)
import Database.SQLite.Simple as Sql


app :: Sql.Connection -&gt; Application
app conn = serve A.api (A.artistsServer conn)              <i class="conum" data-value="3"></i><b>(3)</b>


testConnect :: IO Sql.Connection
testConnect = Sql.open ":memory:"                          <i class="conum" data-value="4"></i><b>(4)</b>


withTestConnection :: (Sql.Connection -&gt; IO a) -&gt; IO a
withTestConnection cb =                                    <i class="conum" data-value="5"></i><b>(5)</b>
  withConn $ \conn -&gt; cb conn
  where
    withConn = bracket testConnect Sql.close               <i class="conum" data-value="6"></i><b>(6)</b>

{-
  ...
  cors stuff omitted, already covered
-}


main :: IO ()
main = do
  withTestConnection $ \conn -&gt;  do
    S.bootstrapDB conn                                     <i class="conum" data-value="7"></i><b>(7)</b>
    run 8081 $ albumCors $ app conn                        <i class="conum" data-value="8"></i><b>(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Module with functions for communication with the Albums database. Only used for bootstrapping with test data in main</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Module that defines the webservice api</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We make sure to pass a connection to our webservice server</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>For simplicity we are using an in memory database</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Wrap a function (cb) giving it a connection and cleaning up when done</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>bracket</code> ensures we also release the connection in case of any exceptions.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Creates schema and bootstraps with some sample data</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Ensure we pass the connection to our app function</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Read more about the <a href="https://wiki.haskell.org/Bracket_pattern">bracket pattern</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">backend/Api.hs</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">{-# LANGUAGE TypeOperators #-}
{-# LANGUAGE DataKinds     #-}

module Api where

import qualified Model as M                           <i class="conum" data-value="1"></i><b>(1)</b>
import qualified Storage as S
import Data.Aeson
import Control.Monad.IO.Class     (MonadIO, liftIO)
import Control.Monad.Trans.Either
import Servant
import Database.SQLite.Simple as Sql


instance ToJSON M.Artist
instance FromJSON M.Artist


type ArtistAPI =                                       <i class="conum" data-value="2"></i><b>(2)</b>
       Get '[JSON] [M.Artist]
  :&lt;|&gt; ReqBody '[JSON] M.Artist :&gt; Post '[JSON] M.Artist
  :&lt;|&gt; Capture "artistId" Int :&gt; Get '[JSON] M.Artist
  :&lt;|&gt; Capture "artistId" Int :&gt; ReqBody '[JSON] M.Artist :&gt; Put '[JSON] M.Artist
  :&lt;|&gt; Capture "artistId" Int :&gt; Delete '[] ()

-- '

artistsServer :: Sql.Connection -&gt; Server ArtistAPI    <i class="conum" data-value="3"></i><b>(3)</b>
artistsServer conn =
  getArtists :&lt;|&gt; postArtist :&lt;|&gt; getArtist :&lt;|&gt;  updateArtist :&lt;|&gt; deleteArtist

  where
    getArtists                   = liftIO $ S.findArtists conn     <i class="conum" data-value="4"></i><b>(4)</b>
    getArtist artistId           = liftIOMaybeToEither err404 $ S.artistById conn artistId
    postArtist artist            = liftIO $ S.newArtist conn artist
    updateArtist artistId artist = liftIO $ S.updateArtist conn artist artistId
    deleteArtist artistId        = liftIO $ S.deleteArtist conn artistId


liftIOMaybeToEither ::  (MonadIO m) =&gt; a -&gt; IO (Maybe b) -&gt; EitherT a m b
liftIOMaybeToEither err x = do                         <i class="conum" data-value="5"></i><b>(5)</b>
    m &lt;- liftIO x
    case m of
      Nothing -&gt; left err
      Just x -&gt; right x


type API = "artists" :&gt; ArtistAPI


api :: Proxy API
api = Proxy</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The record definitions for our API lives in this module</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We&#8217;ve extended the api type defintions from <a href="http://rundis.github.io/blog/2015/haskell_elm_spa_part1.html#_main_hs">episode 1</a>
to define the shape of get multiple, get single, post, put and delete.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Connection has been added as a parameter to our artist server</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>liftIO</code> is a <a href="https://en.wikibooks.org/wiki/Haskell/Monad_transformers">monad transformer</a>. I&#8217;d love to be able to explain
how it works, but well&#8230;&#8203; Anyways net result is that I don&#8217;t have to define <code>EitherT ServantErr IO ..</code> all over the place</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>liftIOMaybeToEither</code> - what it says. Handy function to return a servant error (which again maps to a http error) if a function like getArtist doesn&#8217;t return
a result. Tx to ToJans for <a href="https://gist.github.com/ToJans/233f82087ee7b385e6e1">inspiration</a></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
put aka update artist should also return a 404 when a non existing artist id is provided.
Actually, error handling is pretty light throughout, but we&#8217;ll get back to that in a later episode !
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">/backend/Model.hs</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">{-# LANGUAGE DeriveGeneric #-}

module Model where

import GHC.Generics

data Artist = Artist                <i class="conum" data-value="1"></i><b>(1)</b>
  { artistId :: Maybe Int           <i class="conum" data-value="2"></i><b>(2)</b>
  , artistName :: String            <i class="conum" data-value="3"></i><b>(3)</b>
  } deriving (Eq, Show, Generic)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Moved record defintions to a separate module. Currently just Artist</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Make id optional. This is a quick and dirty way to be able to use the same
record definiton for new artists as for updates and gets.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Names in records are not scoped withing the record so one solution is to manually
make sure names stay unique.</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
From what I gather record syntax is a bit clunky in Haskell (atleast when compared to Elm).
This <a href="http://stackoverflow.com/questions/6922437/haskell-any-way-to-qualify-or-disambiguate-record-names">stackoverflow post</a>
didn&#8217;t bring any warm fuzzy feelings. If anyone has some better solutions which also plays
well with the handy servant and SQLite simple functions feel free to leave a comment below !
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">backend/Storage.hs</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">{-# LANGUAGE OverloadedStrings #-}
module Storage where


import qualified Model as M
import qualified Data.Text as Txt


import Database.SQLite.Simple as Sql
import Database.SQLite.Simple.Types as SqlTypes


instance Sql.FromRow M.Artist where                         <i class="conum" data-value="1"></i><b>(1)</b>
  fromRow = M.Artist &lt;$&gt; Sql.field &lt;*&gt; Sql.field



artistById :: Sql.Connection -&gt; Int -&gt; IO (Maybe M.Artist)  <i class="conum" data-value="2"></i><b>(2)</b>
artistById conn idParam =
  findById conn "artist" idParam :: IO (Maybe M.Artist)


findArtists :: Sql.Connection -&gt; IO [M.Artist]
findArtists conn =
  Sql.query_ conn "select * from artist" :: IO [M.Artist]


newArtist :: Sql.Connection -&gt; M.Artist -&gt; IO M.Artist
newArtist conn artist = do
  Sql.execute conn "insert into artist (name) values (?) " (Sql.Only $ M.artistName artist)
  rawId &lt;- lastInsertRowId conn
  let updArtist = artist { M.artistId = Just (fromIntegral rawId) }  <i class="conum" data-value="3"></i><b>(3)</b>
  return updArtist


-- Really we should check whether the artist exists here
updateArtist :: Sql.Connection -&gt; M.Artist -&gt; Int -&gt; IO M.Artist
updateArtist conn artist idParam = do
  Sql.executeNamed conn "update artist set name = :name where id = :id" params
  return artist { M.artistId = Just idParam }                        <i class="conum" data-value="4"></i><b>(4)</b>
  where
    params = [":id" := (idParam :: Int), ":name" := ((M.artistName artist) :: String)]


deleteArtist :: Sql.Connection -&gt; Int -&gt; IO ()
deleteArtist conn idParam =
  Sql.execute conn "delete from artist where id = ?" (Sql.Only idParam)


findById :: (FromRow a) =&gt; Sql.Connection -&gt; String -&gt; Int -&gt; IO (Maybe a)
findById conn table idParam = do
  rows &lt;- Sql.queryNamed conn (createFindByIdQuery table) [":id" := (idParam :: Int)]
  let result = case (length rows) of
                  0 -&gt; Nothing
                  _ -&gt; Just $ head rows      <i class="conum" data-value="5"></i><b>(5)</b>

  return result


createFindByIdQuery :: String -&gt; SqlTypes.Query
createFindByIdQuery table =
  SqlTypes.Query $ Txt.pack $ "SELECT * from " ++ table ++ " where id = :id"   <i class="conum" data-value="6"></i><b>(6)</b>

-- ... boostrap function left out, check the source repo for details</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define SQLite row converter to create artist records for rows with id and name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Finding an artist by Id may return empty results. Prematurely factored out a generic findById function that is used here</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add the id of the newly inserted artist row to the resulting artist. (The Maybe artistId starts to smell)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Yuck, this smells even worse. The decision to support an optional id on the Artist record doesn&#8217;t ring true</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Using let allows us to "work inside" the IO monad. Otherwise the compiler complains along the lines of <code>Couldn&#8217;t match expected type ‘[r1]’ with actual type ‘IO [r0]’</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Whacking strings together is discouraged (helps avoid sql injection for one), but getting around it is possible with a little serimony</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_backend_summary">Backend summary</h3>
<div class="paragraph">
<p>Well now we got persistence up and running with a good ole' relational database. That&#8217;s
not very exciting and I might return to change that in a future episode. The REST api is quite simple and lacking in validation and error handling, but it&#8217;s hopefully a decent start and foundation
for future changes.</p>
</div>
<div class="paragraph">
<p>After working with Clojure and Leiningen not to long ago, the server startup time feels blistering fast in comparison.
Getting halive to work made significant improvements to the development workflow.
When working with Haskell I get a constant reminder that I would benefit from learning more about the language
and fundemental concepts. The compiler messages still throws me off a lot of times, but the situation is gradually improving as I&#8217;m learning.
I guess I&#8217;m already spoilt with the error messages from Elm which feels a lot clearer and better at highlighting the root cause(s) of my mistakes.</p>
</div>
<div class="paragraph">
<p>I&#8217;m still fumbling to design a sensible structure for the custom data types. I have a feeling
several iterations will be needed as I add support for additional services.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_frontend">Frontend</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s a shame the hot reloading support in elm-reactor is broken at the time of writing, otherwise the development experience
would have been a lot better. <code>Make</code> &#8594; <code>reload browser</code> is just a keystroak away in Light Table, but still.
Having the informative compiler error and warning messages inline in my Editor is really nice though.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Do better understand the elm-architecture I&#8217;ve tried to follow, you should really check out the
<a href="https://github.com/evancz/elm-architecture-tutorial">tutorial</a>. It does a much better job at explaining the core
concepts than I do.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="http://rundis.github.io/blog/2016/albums_pages.png" alt="albums pages">
</div>
</div>
<div class="listingblock">
<div class="title">frontend/Main.elm</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-elm" data-lang="elm">module Main where


import ArtistListing
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onClick)
import Task exposing (..)
import Effects exposing (Effects, Never)
import StartApp


type alias Model =                                    <i class="conum" data-value="1"></i><b>(1)</b>
  { artistListing : ArtistListing.Model}


type Action =                                         <i class="conum" data-value="2"></i><b>(2)</b>
    ShowHomePage
  | ArtistListingAction ArtistListing.Action


init : (Model, Effects Action)                        <i class="conum" data-value="3"></i><b>(3)</b>
init =
  let
    (artistListing, fx) = ArtistListing.init
  in
    ( Model artistListing
      , Effects.map ArtistListingAction fx            <i class="conum" data-value="4"></i><b>(4)</b>
    )




update : Action -&gt; Model -&gt; (Model, Effects Action)
update action model =
  case action of

    ShowHomePage -&gt;                                   <i class="conum" data-value="5"></i><b>(5)</b>
      let
        (artistListing, fx) = ArtistListing.init
      in
        ( {model | artistListing = artistListing}
        , Effects.map ArtistListingAction fx
        )

    ArtistListingAction sub -&gt;                        <i class="conum" data-value="6"></i><b>(6)</b>
      let
        (artistListing, fx) = ArtistListing.update sub model.artistListing
      in
        ( {model | artistListing = artistListing}
        , Effects.map ArtistListingAction fx
        )


menu : Signal.Address Action -&gt; Model -&gt; Html
menu address model =
  header [class "navbar navbar-default"] [
    div [class "container"] [
      div [class "navbar-header"] [
        button [ class "btn-link navbar-brand", onClick address ShowHomePage ]
        [text "Albums Crud"]
      ]
    ]
  ]


view : Signal.Address Action -&gt; Model -&gt; Html
view address model =
  div [class "container-fluid"] [
      menu address model   <i class="conum" data-value="7"></i><b>(7)</b>
    , ArtistListing.view (Signal.forwardTo address ArtistListingAction) model.artistListing
  ]

-- ... app, main and port for tasks left out, no changes since previous episode</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The main model composes the artistlisting page model</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Actions for main, currently just holds the actions for ArtistListing + a convenience action to reset/show home page</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The init function from ArtistListing returns it&#8217;s model and an effect (get artist from server task). We initialize the
main model with the artistlisting model</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We map the effect from ArtistListing to an Main module effect which is then handled by the startapp "signal loop"</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Quick and dirty way to trigger showing of the artist listing page (re-initialized)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>All ArtistListing actions are tagged with ArtistListingAction, we delegate to the update function for ArtistListing
, update the main model accordingly and the map the returne effect</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>To get/create the view for ArtistListing we call it&#8217;s view function, but we need to ensure signals sent from  ArtistListing makes it back to the main view mailbox address. <code>Signal.forwardTo</code> helps us create a forwarding address.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Read more about <a href="https://github.com/elm-guides/elm-for-js/blob/master/Mailboxes%2C%20Messages%2C%20and%20Addresses.md#talk-to-this-guy">Mailboxes, Messages and Addresses</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">frontend/ArtistListing.elm</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-elm" data-lang="elm">module ArtistListing (Model, Action (..), init, view, update) where


import ServerApi exposing (..)                                                 <i class="conum" data-value="1"></i><b>(1)</b>
import ArtistDetail
-- ... other imports ommited

type Page = ArtistListingPage | ArtistDetailPage


type alias Model =
  { artists : List Artist
  , artistDetail : ArtistDetail.Model
  , page : Page}



type Action =
    HandleArtistsRetrieved (Maybe (List Artist))
  | SelectArtist (Int)
  | DeleteArtist (Int)
  | HandleArtistDeleted (Maybe Http.Response)
  | ArtistDetailAction ArtistDetail.Action
  | NewArtist


init : (Model, Effects Action)
init =
  let
    (artistDetail, fx) = ArtistDetail.init
  in
    ( Model [] artistDetail ArtistListingPage
      , getArtists HandleArtistsRetrieved                                      <i class="conum" data-value="2"></i><b>(2)</b>
    )


update : Action -&gt; Model -&gt; (Model, Effects Action)
update action model =
  case action of

    HandleArtistsRetrieved xs -&gt;                                               <i class="conum" data-value="3"></i><b>(3)</b>
      ( {model | artists = (Maybe.withDefault [] xs) }
      , Effects.none
      )

    DeleteArtist id -&gt;
      (model, deleteArtist id HandleArtistDeleted)

    HandleArtistDeleted res -&gt;
      (model, getArtists HandleArtistsRetrieved)

    NewArtist -&gt;                                                              <i class="conum" data-value="4"></i><b>(4)</b>
      update (ArtistDetailAction &lt;| ArtistDetail.ShowArtist Nothing) model

    SelectArtist id -&gt;
      update (ArtistDetailAction &lt;| ArtistDetail.GetArtist id) model

    ArtistDetailAction sub -&gt;                                                 <i class="conum" data-value="5"></i><b>(5)</b>
      let
        (detailModel, fx) = ArtistDetail.update sub model.artistDetail
      in
        ( { model | artistDetail = detailModel
                  , page = ArtistDetailPage }                                 <i class="conum" data-value="6"></i><b>(6)</b>
        , Effects.map ArtistDetailAction fx
        )



-- ... artistView details ommitted for brevity

view : Signal.Address Action -&gt; Model -&gt; Html
view address model =
  div [class "content"] [
    case model.page of                                                       <i class="conum" data-value="7"></i><b>(7)</b>

      ArtistListingPage -&gt;
        artistsView address model

      ArtistDetailPage -&gt;
        ArtistDetail.view (Signal.forwardTo address ArtistDetailAction) model.artistDetail

  ]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>ServerApi</code> module exposes functions to interact with the backend server</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>getArtists HandleArtistsRetrieved</code> calls the serverAPI with a action param, so that when the ajax/xhr callback finally makes in back into the elm signal loop, the update function is called with the action we want</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Update the model with the list of artists retrieved (if any)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>To show the artist detail page in "create" mode we create a ArtistDetailAction with the appropriate ArtistDetail.action</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>ArtistDetailAction sub actions are actions that are delegated to the actions of the ArtistDetail module.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Note that we change "page context" here so that the view function displays the appropriate page</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Our naive page routing, just toggles display of pages by the page attribute of our model</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;ve implemented a very simplistic page routing here. In a later episode we will refactor to
something more managable for handling proper page routing.</p>
</div>
<div class="paragraph">
<div class="title">frontend/ArtistDetail.elm</div>
<p>This page handles update/creation of a single Artist. I&#8217;ll leave it to you to check out
the details of the <a href="https://github.com/rundis/albums/releases/tag/part_2">sample code</a> on github.</p>
</div>
<div class="listingblock">
<div class="title">frontend/ServerApi.elm</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-elm" data-lang="elm">module ServerApi where


import Json.Decode as JsonD exposing ((:=))
import Json.Encode as JsonE
import Effects exposing (Effects)
import Http
import Task


type alias ArtistRequest a =                                                 <i class="conum" data-value="1"></i><b>(1)</b>
  { a | name : String }

type alias Artist =
  { id : Int
  , name : String
  }

baseUrl : String
baseUrl = "http://localhost:8081"


getArtist : Int -&gt; (Maybe Artist -&gt; a) -&gt; Effects.Effects a
getArtist id action =                                                        <i class="conum" data-value="2"></i><b>(2)</b>
  Http.get artistDecoder (baseUrl ++ "/artists/" ++ toString id)
    |&gt; Task.toMaybe
    |&gt; Task.map action                                                       <i class="conum" data-value="3"></i><b>(3)</b>
    |&gt; Effects.task


getArtists : (Maybe (List Artist) -&gt; a) -&gt; Effects a
getArtists action =
  Http.get artistsDecoder (baseUrl ++ "/artists")
    |&gt; Task.toMaybe
    |&gt; Task.map action
    |&gt; Effects.task

createArtist : ArtistRequest a -&gt; (Maybe Artist -&gt; b) -&gt; Effects.Effects b
createArtist artist action =                                                 <i class="conum" data-value="4"></i><b>(4)</b>
  Http.send Http.defaultSettings
        { verb = "POST"
        , url = baseUrl ++ "/artists"
        , body = Http.string (encodeArtist artist)                           <i class="conum" data-value="5"></i><b>(5)</b>
        , headers = [("Content-Type", "application/json")]
        }
    |&gt; Http.fromJson artistDecoder
    |&gt; Task.toMaybe
    |&gt; Task.map action
    |&gt; Effects.task

-- .. the remaining services and encoding|decoding left out for brevity</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This type is an extensible <a href="http://elm-lang.org/docs/records#record-types">record type</a>. It allows our
artist related services to be a little bit more generic and still keep a level of type checking</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>GET a single artist from our backend api. (Actually it returns and effect that will executa a <a href="http://elm-lang.org/guide/reactivity#tasks">task</a> which upon callback will eventually call the update function in our app with the given action)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We&#8217;ve relented on type safety for actions by allowing it to be a generic param, but we gain some flexibility
that allows our service to be usable in many different contexts</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>To take more control over http actions we use <code>Http.send</code>. It&#8217;s closer to the metal so it&#8217;s a little
bit more boilerplate.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Encode the artist (request) to a json string</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To see the remaining services and details of decoding and encoding please consolt the <a href="https://github.com/rundis/albums/releases/tag/part_2">sample code</a> on github.</p>
</div>
<div class="sect2">
<h3 id="_frontend_summary">Frontend summary</h3>
<div class="paragraph">
<p>We are beginning to see the resmblance of a Single Page Application. We have started to compose
views and pages using the Elm Architecture. The app supports basic CRUD oparations for an Artist entity.
Error handling is light, there is no validation and our routing solution is overly simplistic, but we&#8217;ll get
to that soonish !</p>
</div>
<div class="paragraph">
<p>Working with Elm has been an absolute pleasure. The compiler messages really do help. Doing refactoring (without tests I might add)
doesn&#8217;t feel anywhere near as scary as I&#8217;m used to from other languages.
I&#8217;m starting to understand more about the Elm Architecture, but I&#8217;m still getting a little confused about the details
of Signals, Tasks, Mailboxes, Effects etc. It&#8217;s coming to me gradually. The important thing is I can still be quite productive
even though I don&#8217;t understand all the details.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>I have to say I&#8217;m not looking forward to my next refactoring in some messy imperative jquery page mutant at work.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_and_next_steps">Conclusion and next steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;m aware this blog post got way to long even though I tried to shave of some of the code from the
code listings. I&#8217;ll have to try to take on smaller/more targeted chunks in future episodes.</p>
</div>
<div class="paragraph">
<p>Anyways. I&#8217;m staring to feel I&#8217;m getting somewhere now. Both with Haskell and Elm. Learning Haskell is
by far the most challenging but getting my head around Functional Reactive Programming in Elm isn&#8217;t without challenges either.
My motivation is still strong and I&#8217;m learning a ton of stuff.</p>
</div>
<div class="paragraph">
<p>Candidate areas to address for the next episode are; routing, validation, error handling and obviously more useful features.
I&#8217;m thinking perhaps routing comes first, but we&#8217;ll see.</p>
</div>
</div>
</div></p>
  			<a href="/blog/2016/elm_light_package.html"><h1>Managing and diagramming elm packages with d3 in Light Table</h1></a>
  			<p>01 January 2016</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/elm.html">elm</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      
		      <a href="/blog/tags/d3.html">d3</a>
	      
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Managing and diagramming elm packages with d3 in Light Table"
           data-url="http://rundis.github.io/blog/2016/elm_light_package.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In an effort to making management of project dependencies in Elm projects a little easier, the Elm plugin
for <a href="http://lighttable.com/">Light Table</a> the <a href="https://github.com/rundis/elm-light">elm-light</a> has a few neat features up it&#8217;s sleave.
Check out the demo below for a brief overview.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can find the elm-light plugin <a href="https://github.com/rundis/elm-light">here</a>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_demo">Demo</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://youtu.be/Okk-YjEeUgI">ScreenCast demo</a></p>
</div>
<iframe width="420" height="315" src="https://www.youtube.com/embed/Okk-YjEeUgI" frameborder="0" allowfullscreen></iframe>
<div class="ulist">
<div class="title">Other relevant demos:</div>
<ul>
<li>
<p><a href="http://rundis.github.io/blog/2015/elm_light.html">elm-light intro demo</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_short_implementation_summary">Short implementation summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;m just going to give a very brief overview of a few key pieces for how the features are implemented here.
I might add a more detailed blog post if there is any interest for that in the future.</p>
</div>
<div class="sect2">
<h3 id="_package_management">Package management</h3>
<div class="paragraph">
<p>The package manager is just a thin wrapper around the <code>elm-package</code> executable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn parse-json-file [json-file]
  (when (files/exists? json-file)
    (-&gt; (-&gt;&gt; (files/open-sync json-file)
             :content
             (.parse js/JSON))
        (js-&gt;clj :keywordize-keys true))))


(defn remove-pkg [path pkg]
  (let [pkg-file (files/join path "elm-package.json")]
    (-&gt; (u/parse-json-file pkg-file)
        (update-in [:dependencies] (fn [deps]
                                     (-&gt; (into {}
                                               (map (fn [[k v]]
                                                      [(u/nskw-&gt;name k) v]) deps))
                                         (dissoc pkg))))
        u/pretty-json
        ((partial files/save pkg-file)))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>To list, update and remove dependencies it parses (and updates) the project file for elm projects; <code>elm-package.json</code>. In addition
it parses the <code>exact-dependencies.json</code> file for all resolved dependencies.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Working with json in ClojureScript feels almost seamless to working with native ClojureScript datastructures
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_view_rendering">View rendering</h4>
<div class="paragraph">
<p>To render the package listing the plugin uses <a href="https://github.com/levand/quiescent">quiescent</a> and <a href="https://facebook.github.io/react/">react</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(q/defcomponent PackageTable [props]
  (d/table
   {:className "package-table"}
   (d/thead
    {}
    (d/tr
     {}
     (d/th {} "Package")
     (d/th {} "Range")
     (d/th {} "Exact")
     (d/th {} "")))
   (apply d/tbody {}
          (map #(PackageRow (assoc %
                              :on-remove (:on-remove props)
                              :on-browse (:on-browse props)))
               (:packages props)))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can find a detailed blog post about some of the benefits of using react for view rendering in Light Table
in <a href="http://rundis.github.io/blog/2015/lt_react.html">Implementing a Clojure ns-browser in Light Table with React</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_dependency_autocompletion">Dependency autocompletion</h4>
<div class="paragraph">
<p>Whan adding dependencies there is a handy autocompleter. This uses a json resource from <a href="http://package.elm-lang.org/" class="bare">http://package.elm-lang.org/</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn fetch-all-packages
  "Fetch all packages from package.elm-lang.org"
  [callback]
  (fetch/xhr (str "http://package.elm-lang.org/all-packages?date=" (.getTime (new js/Date)))
             {}
             (fn [data]
               (let [pkgs (js-&gt;clj (.parse js/JSON data) :keywordize-keys true)]
                 (callback pkgs)))))</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dependency_graph">Dependency graph</h3>
<div class="paragraph">
<p>To implement the dependency graph d3 and dagreD3 is used. Both of these ships node-modules. Using node-modules from
Light Table plugins is definetely not rocket science !</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(def dagreD3 (js/require (files/join u/elm-plugin-dir "node_modules/dagre-d3")))
(def d3 (js/require (files/join u/elm-plugin-dir "node_modules/d3")))


defn create-graph [data]                                                         <i class="conum" data-value="1"></i><b>(1)</b>
  (let [g (.setGraph (new dagreD3.graphlib.Graph)  #js {})]
    (doseq [x (:nodes data)]
      (.setNode g (dep-id x) (node-label x)))
    (doseq [x (:edges data)]
      (.setEdge g (:a x) (:b x) #js {:label (:label x)
                                     :style (when (:transitive x)
                                              "stroke-dasharray: 5, 5;")}))
    g))



(behavior ::on-render                                                           <i class="conum" data-value="2"></i><b>(2)</b>
          :desc "Elm render dependencies"
          :triggers #{:elm.graph.render}
          :reaction (fn [this]
                      (let [svg (.select d3 "svg")
                            g (.select svg "g")
                            renderer (.render dagreD3)]
                        (renderer g (create-graph (:data @this)))
                        (init-zoom svg g)
                        (resize-graph this svg))))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The function to create the dependency graph. Helper functions omitted, but not much to it really</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Light Table behavior that is responsible for rendering the graph</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_credits">Credits</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="http://d3js.org/">d3.js</a> - Provides awesome graphing features</p>
</li>
<li>
<p><a href="https://github.com/cpettitt/dagre-d3">dagreD3</a> - Create Directed Acyclic Graphs in a breeze</p>
</li>
</ul>
</div>
</div>
</div></p>
  			<a href="/blog/2015/haskell_elm_spa_part1.html"><h1>Typed up CRUD SPA with Haskell and Elm  - Part 1: Spike time</h1></a>
  			<p>28 December 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/haskell.html">haskell</a>
	      
		      <a href="/blog/tags/elm.html">elm</a>
	      
		      <a href="/blog/tags/haskellelmspa.html">haskellelmspa</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Typed up CRUD SPA with Haskell and Elm  - Part 1: Spike time"
           data-url="http://rundis.github.io/blog/2015/haskell_elm_spa_part1.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Join me on my journey into statically typed functional languages. I&#8217;ve been living a pretty happily
dynamic life so far. What&#8217;s the fuzz with all those types ? What do they give me in a real life
scenario (aka is it worth using for work gigs) ? I need to make an effort and try to figure
some of this out. This blog series is an attempt to document some of my experiences along the way through a practical example.</p>
</div>
<div class="ulist">
<div class="title">There will be:</div>
<ul>
<li>
<p>A single page web application with crud features</p>
</li>
<li>
<p>Lots of types, refactoring and hopefully some testing</p>
</li>
<li>
<p>An evolving web-app github repo for your amusement or amazement</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_just_a_little_background_on_me">Just a little background on me</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For quite some time I&#8217;ve been wanting to learn more about functional languages that are statically (and strongly) typed.
What benefits do they really provide in practice and what are the downsides ?
My background is a from quite a few years with Java, and the last 3-4 years I&#8217;ve been working
 mostly with Groovy, JavaScript and Clojure/ClojureScript.
I&#8217;ve dabbled a little with Elm recently (<a href="http://rundis.github.io/blog/2015/elm_sweeper.html">minesweeper in Elm</a>)
, and I&#8217;ve tried to take on Haskell a couple of times (without much success I might add).</p>
</div>
<div class="paragraph">
<p>I mostly do web apps at work, so I figured I need to try and make something at least remotely
similar to what I do in real life.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_let_s_get_started">Let&#8217;s get started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is the point where I&#8217;ve run into analysis paralysis so many a time before.
So I set out to create a crud app, but what shall I build. After some deliberation
I settled on making something related to Music. You know Albums, Artists, Tracks and such.
I have no idea what the end result will be, but to start off I&#8217;ll make a simple spike.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="http://rundis.github.io/blog/2015/artists.png" alt="artists">
</div>
</div>
<div class="ulist">
<div class="title">The spike should</div>
<ul>
<li>
<p>establish a base architecture</p>
</li>
<li>
<p>implement a simple feature: <strong>List artists</strong></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You will find the sample application code on <a href="https://github.com/rundis/albums">github</a>.
There will be a tag for each blog post in the series</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_backend">Backend</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I wanted to implement server component that would provide REST-services. There are quite
a few options available for Haskell that can help with that. After some research and trials
I ended up using <a href="https://haskell-servant.github.io/">Servant</a>.</p>
</div>
<div class="ulist">
<div class="title">Some of the other options I looked at includes:</div>
<ul>
<li>
<p><a href="https://www.spock.li/">Spock</a></p>
</li>
<li>
<p><a href="https://github.com/scotty-web/scotty">Scotty</a></p>
</li>
<li>
<p><a href="http://snapframework.com/">Snap</a></p>
</li>
<li>
<p><a href="http://www.yesodweb.com/">Yesod</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I just had to choose one, and Servant seemed like a nice fit for REST stuff and I managed to get it
working without to much hazzle.</p>
</div>
<div class="sect2">
<h3 id="_project_set_up">Project set up</h3>
<div class="paragraph">
<p>I&#8217;m using <a href="https://www.haskell.org/cabal/">cabal</a>, but you might also want to consider looking
at <a href="http://docs.haskellstack.org/en/stable/index.html">stack</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">name:                albums
version:             0.1.0.0
synopsis:            Albums rest backend
license:             MIT
license-file:        LICENSE
author:              rundis
maintainer:          mrundberget@hotmail.com
category:            Web
build-type:          Simple
cabal-version:       &gt;=1.10

executable albums
  main-is:             Main.hs              <i class="conum" data-value="1"></i><b>(1)</b>
  build-depends:
      base &gt;= 4.7 &amp;&amp; &lt; 5
    , either
    , aeson &gt;= 0.8                          <i class="conum" data-value="2"></i><b>(2)</b>
    , servant                               <i class="conum" data-value="3"></i><b>(3)</b>
    , servant-server
    , wai
    , warp
  hs-source-dirs:      src                  <i class="conum" data-value="4"></i><b>(4)</b>
  default-language:    Haskell2010</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The entry point for the application</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Provides JSON support</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The servant library that helps us create type safe rest services</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The directory(ies) where the source code for our app resides</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For the purposes of this spike all haskell code will reside in <code>Main.hs</code>. This will
surely not be the case as the app progresses.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you wan&#8217;t to try out automatic reloading support, you may want to check out <a href="https://github.com/lukexi/halive">halive</a>.
Unfortunately I couldn&#8217;t get it to work on my machine (OS/X Maverick), but it might work our for you though :-)
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_main_hs">Main.hs</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">data Artist = Artist
  { artistId :: Int
  , name :: String
  } deriving (Eq, Show, Generic)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A simple type describing the shape of an Artist in our app.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">instance ToJSON Artist                                       <i class="conum" data-value="1"></i><b>(1)</b>

type ArtistAPI =                                             <i class="conum" data-value="2"></i><b>(2)</b>
       Get '[JSON] [Artist]                                  <i class="conum" data-value="3"></i><b>(3)</b>
  :&lt;|&gt; Capture "artistId" Int :&gt; Get '[JSON] Artist          <i class="conum" data-value="4"></i><b>(4)</b>


artistsServer :: Server ArtistAPI
artistsServer = getArtists :&lt;|&gt; artistOperations             <i class="conum" data-value="5"></i><b>(5)</b>

  where getArtists :: EitherT ServantErr IO [Artist]
        getArtists = return artists                          <i class="conum" data-value="6"></i><b>(6)</b>

        artistOperations artistId =
          viewArtist

          where viewArtist :: EitherT ServantErr IO Artist
                viewArtist = artistById artistId             <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>ToJSON</code> is a <a href="https://www.haskell.org/tutorial/classes.html">type class</a>. This line
basically is all we need to set up for json encoding an instance of our Artist type.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We describe our REST api using a type</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Get on this api returns a list of Artists</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Definition of how to get a single Artist by it&#8217;s id</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>server</code> type is the part where we descibe how we actually serve the api</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The handler for listing artists. Currently it just returns a static list</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The handler for retrieving a given artist by its id</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>:&lt;&gt;</code> is a <a href="https://wiki.haskell.org/Combinator">combinator</a> that ships with Servant. It allows us to combine the various parts
of our API into a single type.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">artistById :: Int -&gt; EitherT ServantErr IO Artist
artistById idParam =
  case a of
    Nothing -&gt; left (err404 {errBody = "No artist with given id exists"})  <i class="conum" data-value="1"></i><b>(1)</b>
    Just b -&gt; return b                                                     <i class="conum" data-value="2"></i><b>(2)</b>
  where
    a = find ((== idParam) . artistId) artists                             <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If the find (by id) in <strong>3</strong> returns Nothing (see <a href="https://hackage.haskell.org/package/base-4.8.1.0/docs/Data-Maybe.html">Maybe monad</a>).
We return a 404 error with a custom body</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Upon success return the given artist instance</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Find a given artist by id from our List of artists</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>EitherT</code> - An either monad. Check out the description from the servant tutorial on <a href="https://haskell-servant.github.io/tutorial/server.html#the-eithert-servanterr-io-monad">EitherT</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Wrapping it all up</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">type API = "artists" :&gt; ArtistAPI    <i class="conum" data-value="1"></i><b>(1)</b>


api :: Proxy API
api = Proxy                          <i class="conum" data-value="2"></i><b>(2)</b>


app :: Application
app = serve api artistsServer        <i class="conum" data-value="3"></i><b>(3)</b>


main :: IO ()
main = run 8081 app                  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A generic type for our api. It let&#8217;s us combine multiple types, but the
main reason it&#8217;s factored out for now is to avoid repetion of the root path for our
api <code>artists</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>TBH I haven&#8217;t grokked why this is needed, but it&#8217;s probably to do with some type magic ?</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>An "abstract" web application. serve gives us a <a href="http://www.stackage.org/package/wai">WAI</a> web application.
I guess WAI is like a common API for Haskell Web applicaitons.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The main entry point for our application. It starts our web application on port 8081
(and uses <a href="http://www.stackage.org/package/warp">warp</a> behind the scene to do so.)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To get the backend up and running, check out the readme for the <a href="https://github.com/rundis/albums">sample application</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_backend_experiences">Backend experiences</h3>
<div class="paragraph">
<p>Following the <a href="https://haskell-servant.github.io/tutorial/server.html">Servant tutorial</a> it was quite
easy to get a simple translated example to work. However I did start to struggle once I started
to venture off from the tutorial. Some of it is obviously due to my nearly non-existing haskell knowledge.
But I think what tripped me up most was the EitherT monad. Heck I still don&#8217;t really know what
a monad is. The error messages I got along the way didn&#8217;t help me much, but I guess gradually
they&#8217;ll make more and more sense, once my haskell foo improves.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_frontend">Frontend</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So Elm is pretty cool. The syntax isn&#8217;t too far off from Haskell. I&#8217;ve already started
looking at Elm so it makes sense continuing with Elm to hopefully gain deeper knowledge of its
strenghts and weaknesses.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For a really pleasurable experience when developing elm I would suggest choosing an
editor with linting support. As a shameless plug, one suggestion would be to use <a href="http://lighttable.com/">Light Table</a>
with my <a href="https://github.com/rundis/elm-light">elm-light</a> plugin. (Emacs, Vim, Sublime, Visual Code are other good options)
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_project_setup">Project setup</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
    "version": "1.0.0",
    "summary": "The frontend for the Albums CRUD sample app",
    "repository": "https://github.com/rundis/albums.git",
    "license": "MIT",
    "source-directories": [
        "."                                                      <i class="conum" data-value="1"></i><b>(1)</b>
    ],
    "exposed-modules": [],
    "dependencies": {                                            <i class="conum" data-value="2"></i><b>(2)</b>
        "elm-lang/core": "3.0.0 &lt;= v &lt; 4.0.0",
        "evancz/elm-effects": "2.0.1 &lt;= v &lt; 3.0.0",
        "evancz/elm-html": "4.0.2 &lt;= v &lt; 5.0.0",
        "evancz/elm-http": "3.0.0 &lt;= v &lt; 4.0.0",
        "evancz/start-app": "2.0.2 &lt;= v &lt; 3.0.0"
    },
    "elm-version": "0.16.0 &lt;= v &lt; 0.17.0"
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For simplicity source files currently resides in the root folder of the project.
This will change once the application grows</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Initial set of dependencies used</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_album_elm">Album.elm</h3>
<div class="paragraph">
<p>Before you start you may want to check out <a href="https://github.com/evancz/start-app">start-app</a>.
The frontend code is based on this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-elm" data-lang="elm">type alias Artist =                                     <i class="conum" data-value="1"></i><b>(1)</b>
  { id : Int
  , name : String
  }

type alias Model =                                      <i class="conum" data-value="2"></i><b>(2)</b>
  { artists : List Artist}


type Action = ArtistRetrieved (Maybe (List Artist))     <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Front end representation of Artist. You&#8217;ll notice it&#8217;s strikingly similar
to it&#8217;s Haskell counterpart on the server side</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Type for keeping track of our model. Currently it will only contain
a list of artists, but there is more to come later</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>"Tagged type" that describes the actions supported in the frontend app.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-elm" data-lang="elm">init : (Model, Effects Action)
init =                                                  <i class="conum" data-value="1"></i><b>(1)</b>
  ( Model []
    , getArtists
  )


update : Action -&gt; Model -&gt; (Model, Effects Action)
update action model =                                  <i class="conum" data-value="2"></i><b>(2)</b>
  case action of
    ArtistRetrieved xs -&gt;
      ( {model | artists = (Maybe.withDefault [] xs) }
      , Effects.none
      )


getArtists : Effects.Effects Action
getArtists =                                           <i class="conum" data-value="3"></i><b>(3)</b>
  Http.get artists "http://localhost:8081/artists"
    |&gt; Task.toMaybe
    |&gt; Task.map ArtistRetrieved
    |&gt; Effects.task


artist : Json.Decoder Artist
artist =                                               <i class="conum" data-value="4"></i><b>(4)</b>
  Json.object2 Artist
    ("artistId" := Json.int)
    ("name" := Json.string)


artists : Json.Decoder (List Artist)
artists =                                              <i class="conum" data-value="5"></i><b>(5)</b>
  Json.list artist</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initializer function called by start-app when staring the application
it returns an empty model and an effect <code>getArtists</code>. Meaning getArtists will be
invoked once the page is loaded</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The update function handles actions in our app. Currently it only supports
one action, and that is the a callback once getArtists have returned. It updates
the model with the retrieved artists and returns the updated model</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Our ajax call ! We invoke the our rest endpoint using the elm http library. The first
argument to Http.get, <code>artists</code>, tells elm how to decode the result.
A lot is going on here, but the end result is that it does an xhr request decodes the result (if success)
using the given decoder and eventually invoke the update function with our list of artists (wrapped in a Maybe).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>A decoder for decoding the json representation of an artist from the server to and <code>Artist</code> type instance</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The response from our rest endpoint is a list of artists, so we use the JSON.list function
telling it to use our artist decoder for each item in the list</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-elm" data-lang="elm">artistRow : Artist -&gt; Html
artistRow artist =                                     <i class="conum" data-value="1"></i><b>(1)</b>
  tr [] [
     td [] [text (toString artist.id)]
    ,td [] [text artist.name]
  ]

view : Signal.Address Action -&gt; Model -&gt; Html
view address model =                                  <i class="conum" data-value="2"></i><b>(2)</b>
  div [class "container-fluid"] [
        h1 [] [text "Artists" ]
      , table [class "table table-striped"] [
          thead [] [
            tr [] [
               th [] [text "Id"]
              ,th [] [text "Name"]
          ]
        ]
      , tbody [] (List.map artistRow model.artists)
    ]
  ]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Function to generate the view for a single artist row</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Our main view function for presenting a list of artists</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
We are not rendering dom nodes here, it&#8217;s just a representation of what we want
to render. The actual rendering uses Virual DOM.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Wrapping up the frontend</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-elm" data-lang="elm">app : StartApp.App Model
app =                                          <i class="conum" data-value="1"></i><b>(1)</b>
  StartApp.start
    { init = init
    , update = update
    , view = view
    , inputs = []
    }



main : Signal Html
main =                                         <i class="conum" data-value="2"></i><b>(2)</b>
  app.html



port tasks : Signal (Task.Task Never ())
port tasks =                                   <i class="conum" data-value="3"></i><b>(3)</b>
  app.tasks</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using startapp to wire up our core functions (init, update and view)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entry point function for our frontend app</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When communicating with the outside world elm uses <a href="http://elm-lang.org/guide/interop#ports">ports</a>.
This is used for by our rest invocation. It does so using <a href="http://elm-lang.org/guide/reactivity#tasks">tasks</a> which
is the elm way to describe asynchronous operations.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_frontend_experiences">Frontend experiences</h3>
<div class="paragraph">
<p>Elm ports, tasks and effects are concepts that are yet to dawn completely on me. I protect my brain
temporarily by giving them overy simplistic explanations.
I wasn&#8217;t sure how to do the JSON decoding stuff, but fired up an elm-repl in Light Table and just experiemented a little until
I had something workable.
I used the linter feature of my Light Table plugin quite heavily, and the error messages from elm proved yet again
to be very helpful.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_and_next_steps">Conclusion and next steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I pretty sure I could have knocked this up with Clojure/ClojureScript, groovy/grails or plan old JavaScript
in a fraction of the time I&#8217;ve used. But that&#8217;s not really a fair or relevant comparison.
Learning completely new languages and new libraries takes time.
I think I&#8217;ve learned quite a bit already and I&#8217;m very pleased to have made it this far !</p>
</div>
<div class="paragraph">
<p>Elm was easier to get into than Haskell and the Elm compiler felt a lot more helpful to me than
ghc (haskell compiler). I had a head start on Elm, but I do remember getting started with Elm felt
a lot smoother than jumping into Haskell. I&#8217;m still very much looking forward to improving my haskell skills
and I&#8217;m sure that will proove very valuable eventually.</p>
</div>
<div class="paragraph">
<p>So what&#8217;s up next? Not sure, but i think adding persistence and the facility to add/update
artists might be next up. I will keep you posted !</p>
</div>
</div>
</div></p>
  			<a href="/blog/2015/elm_sweeper.html"><h1>Minesweeper - a brief journey from JavaScript/React to Elm</h1></a>
  			<p>10 November 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/javascript.html">javascript</a>
	      
		      <a href="/blog/tags/react.html">react</a>
	      
		      <a href="/blog/tags/elm.html">elm</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Minesweeper - a brief journey from JavaScript/React to Elm"
           data-url="http://rundis.github.io/blog/2015/elm_sweeper.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>After taking a keen interest to Elm lately I figured I needed to solve a real problem. Something a bit fun and achievable in a couple of evenings/nights.
Not being awfully creative, piggiebacking on other peoples' work is sometimes a good option.
In this post I&#8217;ll take you through some of my steps in porting/re-implementing <a href="https://github.com/cjohansen/react-sweeper" class="bare">https://github.com/cjohansen/react-sweeper</a> (JavaScript and React) to an Elm implementation.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="http://rundis.github.io/blog/2015/elm_sweeper.png" alt="elm sweeper">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you&#8217;d like to have a look at the complete implementation of the game, check out <a href="https://github.com/rundis/elm-sweeper" class="bare">https://github.com/rundis/elm-sweeper</a>.
There you&#8217;ll find instructions on how to get it running too.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_little_background">A little background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Right! So I&#8217;ve taken an interest in <a href="http://elm-lang.org/">Elm</a> lately.  If you&#8217;ve read any of my previous posts you might have
noticed that I&#8217;m quite fond of Clojure and ClojureScript. I still very much am and I have tons to learn there still. But I wanted  to dip my toes
into a statically typed functional language. Elm seems quite approachable and I guess probably the talk <a href="https://www.youtube.com/watch?v=oYk8CKH7OhE">"Let&#8217;s be mainstream"</a>
made my mind up to give it a go. After creating a language plugin for Light Table: <a href="http://rundis.github.io/blog/2015/elm_light.html">elm-light</a>
 and attending an Elm workshop at CodeMesh, I needed something concrete to try it out on.</p>
</div>
<div class="paragraph">
<p>I remembered that a colleague of mine  <a href="http://www.kodemaker.no">at Kodemaker</a>, Christian Johansen,  made a minesweeper implementation using JavaScript and React.
That seemed like a sufficiently interesting problem and I could shamelessly steal most of the game logic :)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_first_steps_the_game_logic">First steps - The Game Logic</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So the obvious place to start was the game logic. I had the option of trying to set up <a href="https://github.com/deadfoxygrandpa/Elm-Test">Elm-Test</a>
to use a test-driven inspired approach. But heck I figured I had to try to put those types to the test, so I went for
an all out repl driven approach. That gave me a chance to experience the good and bad with the <a href="https://github.com/rundis/elm-light#56-editor-repl">repl integration</a> of my own Light Table Elm plugin too.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="http://rundis.github.io/blog/2015/elm_repl.png" alt="elm repl">
</div>
</div>
<div class="sect2">
<h3 id="_starting_with_records_and_type_aliases">Starting with records and type aliases</h3>
<div class="paragraph">
<p>Reading the <a href="https://github.com/cjohansen/react-sweeper/blob/master/immutable-es6/src/game.js">game logic</a> in react-sweeper I decided to
define a couple of types</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-elm" data-lang="elm">type alias Tile               <i class="conum" data-value="1"></i><b>(1)</b>
  { id: Int
  , threatCount: Maybe Int    <i class="conum" data-value="2"></i><b>(2)</b>
  , isRevealed: Bool
  , isMine: Bool}

type GameStatus = IN_PROGRESS | SAFE | DEAD

type alias Game =             <i class="conum" data-value="3"></i><b>(3)</b>
  { status: GameStatus        <i class="conum" data-value="4"></i><b>(4)</b>
  , rows: Int
  , cols: Int
  , tiles: List Tile}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Type alias for records representing a tile in the game.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Threat count is a property on a tile that is not set until the game logic allows it.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Type alias for a record representing a game</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Status of the game, the possible states are defined by GameStatus. SAFE means you&#8217;ve won, DEAD&#8230;&#8203; well</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Describing these types proved to be valuable documentation as well as being very helpful when implementing
the game logic later on.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
What&#8217;s that <code>Maybe</code> thing ? If someone told me it&#8217;s a <a href="https://en.wikipedia.org/wiki/Monad_(functional_programming)">Monad</a> I wouldn&#8217;t be any wiser. I think of it
as a handy way of describing that something may have a value. A nifty way to eliminate the use of null basically.
It also forces you to be explicit about handling the fact that it may not have a value.
You won&#8217;t get null pointer errors in an Elm program! (nor <code>Undefined is not a function</code>).
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_finding_neighbours_of_a_tile">Finding neighbours of a tile</h3>
<div class="paragraph">
<p>When revealing tiles in minesweeper you also reveal any adjacent tiles that aren&#8217;t next to a mine.
In addition you display the threat count (how many mines are adjacent to a tile) for tiles next to those
you just revealed. So we need a way to find the neighbouring tiles of a given tile.</p>
</div>
<div class="sect3">
<h4 id="_javascript_implementation">JavaScript implementation</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">function onWEdge(game, tile) {                                                 <i class="conum" data-value="1"></i><b>(1)</b>
  return tile % game.get('cols') === 0;
}

function onEEdge(game, tile) {                                                 <i class="conum" data-value="2"></i><b>(2)</b>
  return tile % game.get('cols') === game.get('cols') - 1;
}


function nw(game, tile) {                                                      <i class="conum" data-value="3"></i><b>(3)</b>
  return onWEdge(game, tile) ? null : idx(game, tile - game.get('cols') - 1);
}

function n(game, tile) {
  return idx(game, tile - game.get('cols'));
}

// etc , ommitted other directions for brevity


const directions = [nw, n, ne, e, se, s, sw, w];

function neighbours(game, tile) {
  return keep(directions, function (dir) {                                     <i class="conum" data-value="4"></i><b>(4)</b>
    return game.getIn(['tiles', dir(game, tile)]);
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Helper function to determine if a given tile is on the west edge of the board</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Helper function to determine if a given tile is on the east edge of the board</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Returns the the tile north-west of a given tile. Null if none exists to the north-west</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Keep is a helper function that maps over the collection and filters out any resulting `null`s. So the function
iterates all directions (invoking their respective function) and returns all possible tiles
neighbouring the given tile.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_elm_implementation">Elm implementation</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-elm" data-lang="elm">type Direction = W | NW | N | NE | E | SE | S | SW                                 <i class="conum" data-value="1"></i><b>(1)</b>

onWEdge : Game -&gt; Tile -&gt; Bool                                                     <i class="conum" data-value="2"></i><b>(2)</b>
onWEdge game tile =
  (tile.id % game.cols) == 0


onEEdge : Game -&gt; Tile -&gt; Bool
onEEdge game tile =
  (tile.id % game.cols) == game.cols - 1


neighbourByDir : Game -&gt; Maybe Tile -&gt; Direction -&gt; Maybe Tile                     <i class="conum" data-value="3"></i><b>(3)</b>
neighbourByDir game tile dir =
  let
    tIdx = tileByIdx game                                                          <i class="conum" data-value="4"></i><b>(4)</b>
    isWOk t = not &lt;| onWEdge game t                                                <i class="conum" data-value="5"></i><b>(5)</b>
    isEOk t = not &lt;| onEEdge game t
  in
    case (tile, dir) of                                                            <i class="conum" data-value="6"></i><b>(6)</b>
      (Nothing, _) -&gt; Nothing                                                      <i class="conum" data-value="7"></i><b>(7)</b>
      (Just t, N)  -&gt; tIdx &lt;| t.id - game.cols
      (Just t, S)  -&gt; tIdx &lt;| t.id + game.cols
      (Just t, W)  -&gt; if isWOk t then tIdx &lt;| t.id - 1             else Nothing
      (Just t, NW) -&gt; if isWOk t then tIdx &lt;| t.id - game.cols - 1 else Nothing    <i class="conum" data-value="8"></i><b>(8)</b>
      (Just t, SW) -&gt; if isWOk t then tIdx &lt;| t.id + game.cols - 1 else Nothing
      (Just t, E)  -&gt; if isEOk t then tIdx &lt;| t.id + 1             else Nothing
      (Just t, NE) -&gt; if isEOk t then tIdx &lt;| t.id - game.cols + 1 else Nothing
      (Just t, SE) -&gt; if isEOk t then tIdx &lt;| t.id + game.cols + 1 else Nothing


neighbours : Game -&gt; Maybe Tile -&gt; List Tile
neighbours game tile =
  let
    n = neighbourByDir game tile                                                   <i class="conum" data-value="9"></i><b>(9)</b>
  in
    List.filterMap identity &lt;| List.map n [W, NW, N, NE, E, SE, S, SW]             <i class="conum" data-value="10"></i><b>(10)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A type (actually a <a href="https://en.wikipedia.org/wiki/Tagged_union">tagged union</a>) describing/enumerating the possible directions</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pretty much the same as it&#8217;s JavaScript counterpart. I&#8217;ve been lazy and assumed the id of a tile
is also the index in the tiles list of our game.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Find a neighbour by a given direction. The function takes 3 arguments; a game record, a tile (that may or may not have a value) and a direction. It returns a tile (that may or may not have a value)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>tileByIdx is a functions that finds a tile by its index. (it returns a tile, &#8230;&#8203; maybe). tIdx is a local function that just curries(/binds/partially applies) the first parameter - game</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>A local function that checks if it&#8217;s okay to retrieve a westward tile for a given tile</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Pattern match on tile and direction. You might consider it a switch statement on steroids.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>If the tile doesn&#8217;t have a value (then we don&#8217;t care about the direction hence _) we return Nothing (Maybe.Nothing)</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Just t, NW matches on a tile that has value (assigned t) and a given direction of NW. The logic is for this case the same as for it&#8217;s JavaScript counterpart. Well except it returns Nothing if NW isn&#8217;t possible</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>A partially applied version of neightBourByDir to make the mapping function in 10. a bit less verbose</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>We map over all directions finding their neighbours, then <code>List.filterMap identity</code> filters out all List entries with Nothing.
Leaving us with a list of valid neighbours for the given tile.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We covered quite a bit of ground here. I could have implemented all the direction functions as in the JavaScript implementation,
but opted for a more generic function using pattern matching. It&#8217;s not that I dislike short functions, quite the contrary but
in this case it felt like a good match (no pun intended). Once you get used to the syntax it gives a
really nice overview as well.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Think of &lt;| as one way to avoid parenthesis. It&#8217;s actually a backwards function application
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When testing this function I got my first runtime error in Elm complaining that my case wasn&#8217;t
exhaustive. Rumors has it that the next version of elm might handle this at compile time as well :-)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="http://rundis.github.io/blog/2015/elm_case_error.png" alt="elm case error">
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_threat_count">Threat count</h3>
<div class="sect3">
<h4 id="_javascript">JavaScript</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">function getMineCount(game, tile) {                                             <i class="conum" data-value="1"></i><b>(1)</b>
  var nbs = neighbours(game, tile);
  return nbs.filter(prop('isMine')).length;
}

function addThreatCount(game, tile) {                                           <i class="conum" data-value="2"></i><b>(2)</b>
  return game.setIn(['tiles', tile, 'threatCount'], getMineCount(game, tile));
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Gets the number of neighbouring tiles that are mines for a given tile. (prop is a helper function for retrieving a named property on a js object)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the threatCount property on a given tile in the game</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_elm">Elm</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-elm" data-lang="elm">mineCount : Game -&gt; Maybe Tile -&gt; Int                                           <i class="conum" data-value="1"></i><b>(1)</b>
mineCount game tile =
  List.length &lt;| List.filter .isMine &lt;| neighbours game tile

revealThreatCount : Game -&gt; Tile -&gt; Tile                                        <i class="conum" data-value="2"></i><b>(2)</b>
revealThreatCount game tile =
  {tile | threatCount &lt;- Just (mineCount game &lt;| Just tile)
        , isRevealed  &lt;- True}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Same as for it&#8217;s JavaScript counterpart, but using a . syntax for dynamic property access</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Almoust the same as addThreatCount, but since once we add it the tile would also always be revealed
I opted for a two in one function.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<div class="title">For mine count, both implementations are potentially flawed.</div>
<ul>
<li>
<p>For JavaScript you might get 0 for a non-existent tile, which isn&#8217;t too bad. But maybe you&#8217;ll get
a null pointer somewhere deeper down the call stack. To be sure you have to crawl through all function calls this function makes and
apply your JavaScript foo to know things like null &lt; 1 is obviously true, but null &lt; 0 is false. &#8230;&#8203; and so on.</p>
</li>
<li>
<p>The elm implementation won&#8217;t have any null pointer exceptions, but really it should return Maybe Int to guard
against giving 0 back for a Nothing tile !</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_revealing_safe_adjacent_tiles">Revealing safe adjacent tiles</h3>
<div class="sect3">
<h4 id="_javascript_2">JavaScript</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">function revealAdjacentSafeTiles(game, tile) {
  if (isMine(game, tile)) {
    return game;
  }
  game = addThreatCount(game, tile).setIn(['tiles', tile, 'isRevealed'], true);
  if (game.getIn(['tiles', tile, 'threatCount']) === 0) {
    return keep(directions, function (dir) {
      return dir(game, tile);
    }).reduce(function (game, pos) {
      return !game.getIn(['tiles', pos, 'isRevealed']) ?
        revealAdjacentSafeTiles(game, pos) : game;
    }, game);
  }
  return game;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_elm_2">Elm</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-elm" data-lang="elm">revealAdjacentSafeTiles :  Game -&gt; Int -&gt; Game
revealAdjacentSafeTiles game tileId =
  case tileByIdx game tileId of
    Nothing -&gt; game
    Just t -&gt;
      if t.isMine then game else
        let
          updT   = revealThreatCount game t
          updG   = {game | tiles &lt;- updateIn tileId (\_ -&gt; updT) game.tiles}
          fn t g = if not t.isRevealed then revealAdjacentSafeTiles g t.id else g
        in
          if not (updT.threatCount == Just 0) then
            updG
          else
            List.foldl fn updG &lt;| neighbours updG &lt;| Just updT</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_a_brief_comparison">A brief comparison</h4>
<div class="paragraph">
<p>The most noteworthy difference is really the explicit handling of an illegal tile index in the Elm implementation.
If I didn&#8217;t have the JavaScript code to look at, I&#8217;m guessing the difference would have been more noticable. Not necessarily for the better.
We&#8217;ll never know.</p>
</div>
<div class="paragraph">
<p>Anyways, enough about the game logic. Let&#8217;s move on to the view part.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comparing_the_view_rendering">Comparing the view rendering</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_javascript_3">JavaScript</h3>
<div class="paragraph">
<p>The React part for rendering the UI is found in <a href="https://github.com/cjohansen/react-sweeper/blob/master/immutable-es6/src/ui.js">ui.js</a>
Below I&#8217;ve picked out the most interesting parts</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">export function createUI(channel) {                                            <i class="conum" data-value="1"></i><b>(1)</b>
  const Tile = createComponent((tile) =&gt; {                                     <i class="conum" data-value="2"></i><b>(2)</b>
    if (tile.get('isRevealed')) {
      return div({className: 'tile' + (tile.get('isMine') ? ' mine' : '')},
                 tile.get('threatCount') &gt; 0 ? tile.get('threatCount') : '');
    }
    return div({
      className: 'tile',
      onClick: function () {
        channel.emit('reveal', tile.get('id'));                                <i class="conum" data-value="3"></i><b>(3)</b>
      }
    }, div({className: 'lid'}, ''));
  });

  const Row = createComponent((tiles) =&gt; {
    return div({className: 'row'}, tiles.map(Tile).toJS());
  });

  const Board = createComponent((game) =&gt; {
    return div({
      className: 'board'
    }, partition(game.get('cols'), game.get('tiles')).map(Row).toJS());
  });

  const UndoButton = createComponent(() =&gt; {                                  <i class="conum" data-value="4"></i><b>(4)</b>
    return button({
      onClick: channel.emit.bind(channel, 'undo')
    }, 'Undo');
  });

  const Game = createComponent((game) =&gt; {
    return div({}, [Board(game), UndoButton()]);
  });

  return (data, container) =&gt; {                                               <i class="conum" data-value="5"></i><b>(5)</b>
    render(Game(data), container);
  };
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This function returns a function for creating the react component tree for the game. It takes a channel
param, which is an event emitter. So when components need to notify the "controller" about user actions they can just emit messages to this channel
A neat way to avoid using callbacks!</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>createComponent is a handy helper function that avoids some react boiler plate and provides an optimized shouldComponentUpdate function for each react component used.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When a user clicks on a tile a reveal message with the tile id is emitted</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The game also supports undo previous move :)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Returns a function that when called starts the react rendering of the game in the given container element</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_elm_3">Elm</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-elm" data-lang="elm">threatCount : Maybe Int -&gt; List Html
threatCount count =
  case count of
    Nothing -&gt; []
    Just t  -&gt; [text (if t &gt; 0 then toString t else "")]


tileView : Signal.Address Action -&gt; Game.Tile -&gt; Html                               <i class="conum" data-value="1"></i><b>(1)</b>
tileView address tile =
  if tile.isRevealed then
    div [class ("tile" ++ (if tile.isMine then " mine" else ""))]
        &lt;| threatCount tile.threatCount

  else
    div [class "tile", onClick address (RevealTile tile.id)]                        <i class="conum" data-value="2"></i><b>(2)</b>
        [div [class "lid"] []]                                                      <i class="conum" data-value="3"></i><b>(3)</b>


rowView : Signal.Address Action -&gt; List Game.Tile -&gt; Html
rowView address tiles =
  div [class "row"] (List.map (tileView address) tiles)


statusView: Game -&gt; Html
statusView game =
  let
    (status, c) = case game.status of
                    SAFE          -&gt; (" -  You won", "status-won")
                    DEAD          -&gt; (" - You lost", "status-lost")
                    IN_PROGRESS   -&gt; ("", "")
  in
    span [class c] [text status]


view : Signal.Address Action -&gt; Game -&gt; Html                                       <i class="conum" data-value="4"></i><b>(4)</b>
view address game =
  let
    rows = Utils.partitionByN game.cols game.tiles
  in
    div [id "main"] [
      h1 [] [text "Minesweeper", statusView game],
      div [class "board"] (List.map (rowView address) rows),
      div [] [button [class "button", onClick address NewGame] [text "New game"]]
    ]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The function responsible for rendering a single tile. Very much comparable to the React tile component
in the JavaScript implementation. Similar to  React, we aren&#8217;t returning actual dom elments, Elm also has
a virtual dom implementation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When a tile is clicked a message is sent to a given address (we&#8217;ll get back to that a little bit later).
Well actually it doesn&#8217;t happen right away, rather think of it as creating an envelope with content and a known address. The Elm runtime receives a signal back
that will take care of sending the message to it&#8217;s rendering function when appropriate.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>div here is actually a function from the HTML module in Elm. It takes two lists as arguments, the first
is a list of attributes and the second is a list of child elements</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Our main entry function for creating our view. It takes an address and game as parameter and returns a virtual dom node (Html)</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>Signal.Address Action</code> : Address points to a particular type of Signal, in our case the Signal is an <code>Action</code>
we&#8217;ll come back to that shortly. But the short story is that this is what enables us to talk back to the main application.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wiring_it_all_together">Wiring it all together</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_javascript_4">JavaScript</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">const channel = new EventEmitter();
const renderMinesweeper = createUI(channel);
let game = createGame({cols: 16, rows: 16, mines: 48});
let history = List([game]);

function render() {                                                         <i class="conum" data-value="1"></i><b>(1)</b>
  renderMinesweeper(game, document.getElementById('board'));
}

channel.on('undo', () =&gt; {                                                  <i class="conum" data-value="2"></i><b>(2)</b>
  if (history.size &gt; 1) {
    history = history.pop();
    game = history.last();
    render();
  }
});

channel.on('reveal', (tile) =&gt; {                                            <i class="conum" data-value="3"></i><b>(3)</b>
  if (isGameOver(game)) { return; }

  const newGame = revealTile(game, tile);

  if (newGame !== game) {
    history = history.push(newGame);
    game = newGame;
  }

  render();

  if (isGameOver(game)) {
    // Wait for the final render to complete before alerting the user
    setTimeout(() =&gt; { alert('GAME OVER!'); }, 50);
  }
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The react render entry point for the game. Called whenever the game state is changed</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The JavaScript implementation keeps a history of all game states. I forgot to mention that <a href="https://facebook.github.io/immutable-js/">immutable-js</a> is for collections.
Undo just gets the previous game state and rerenders. Nice and simple</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Event listener for reveal messages. It invokes reveal tile, adds to history (and potentially ends the game).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is all very neat and tidy and works so great because the game state is managed in one place and is passed through
 the ui component tree as an immutable value. The fact that the state is immutable also makes the undo implementation a breeze.
 I really like this approach !</p>
</div>
</div>
<div class="sect2">
<h3 id="_elm_4">Elm</h3>
<div class="paragraph">
<p>If you don&#8217;t know Elm at all, this part might be the most tricky to grasp. To simplify things I&#8217;ll split it into
two parts.</p>
</div>
<div class="sect3">
<h4 id="_start_app_approach">Start-app approach</h4>
<div class="paragraph">
<p><a href="https://github.com/evancz/start-app">Start-app</a> is a small elm package that makes it easy to get started
with an elm Model-View-Update structure. This is a great place to start for your first elm app.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-elm" data-lang="elm">type Action = RevealTile Int                                             <i class="conum" data-value="1"></i><b>(1)</b>


init : Game                                                              <i class="conum" data-value="2"></i><b>(2)</b>
init =
  Game.createGame 15 15 5787345


update : Action -&gt; Game -&gt; Game                                          <i class="conum" data-value="3"></i><b>(3)</b>
update Action game =
  case action of
    RevealTile id -&gt; if not (game.status == IN_PROGRESS) then game else  <i class="conum" data-value="4"></i><b>(4)</b>
                      Game.revealTile game id

main =                                                                   <i class="conum" data-value="5"></i><b>(5)</b>
  StartApp.Simple.start                                                  <i class="conum" data-value="6"></i><b>(6)</b>
    { model = init
    , update = update
    , view = view
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Type describing the actions the game supports. Currently just revealing tiles, and you can see that
we also specify that the RevealTile action expects an Int paramater. That would be the tile id.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The init function provides the initial state for our application. <code>createGame</code> is a helper function for creating
a game with x cols and y rows. The 3.rd param is a seed for randomizing tiles. We&#8217;ll return to that seed thing in the next chapter!</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Update is the function that handles the actual update of state, or rather the transformation to the next state
based on some action. It&#8217;s quite simple in this case, just reveal a given tile and return the updated game</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>No point in revealing more tiles when the game is already over :)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>main</code> is the entry point into our application. If you use elm-reactor this will be automatically invoked for you, which is handy for getting started quickly</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>StartApp.Simple.start</code> takes care of wiring things up and start your application</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_trouble_in_paradise_we_get_the_same_board_every_time">Trouble in paradise, we get the same board every time</h4>
<div class="paragraph">
<p>Do you remember the 3rd param to createGame in the previous chapter? That is the initial seed to a random generator (<a href="http://package.elm-lang.org/packages/elm-lang/core/2.1.0/Random">Random</a>) to randomize the
occurence of mines. The problem is that using the same seed produces the same result. Calling an elm random
generator will return a new seed, so of course I could/should have stored that and used that for the next game.
But I still need an initial seed that&#8217;s different every time I start the app. Current time would be a good candidate
for an initial seed. But there is no getCurrentTime function in Elm. Why ? It&#8217;s impure, and Elm doesn&#8217;t like impure functions.
By "pure", we mean that if you call a function with the same arguments, you get the same result.
There are several reasons why pure functions is a great thing (testing is one), but I won&#8217;t go into that, let&#8217;s just accept the fact
that this is the case, so how can we deal with it ?</p>
</div>
<div class="paragraph">
<p>Well the elm-core package has a <a href="http://package.elm-lang.org/packages/elm-lang/core/2.1.0/Time">Time module</a> with a timestamp function that looks useful.
To use that we have to change a few things though, most notably we can&#8217;t use the simple start app approach any more.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-elm" data-lang="elm">type Action =
  NewGame                                                                 <i class="conum" data-value="1"></i><b>(1)</b>
  | RevealTile Int



update : (Float, Action) -&gt; Game -&gt; Game                                  <i class="conum" data-value="2"></i><b>(2)</b>
update (time, action) game =
  case action of
    NewGame -&gt; Game.createGame 15 15  (truncate time)                     <i class="conum" data-value="3"></i><b>(3)</b>
    RevealTile id -&gt; if not (game.status == IN_PROGRESS) then game else
                       Game.revealTile game id


actions: Signal.Mailbox Action                                            <i class="conum" data-value="4"></i><b>(4)</b>
actions =
  Signal.mailbox NewGame

model: Signal Game                                                        <i class="conum" data-value="5"></i><b>(5)</b>
model =
  Signal.foldp update init (Time.timestamp actions.signal)

main : Signal Html                                                        <i class="conum" data-value="6"></i><b>(6)</b>
main =
  Signal.map (view actions.address) model

port initGame : Task.Task x ()                                            <i class="conum" data-value="7"></i><b>(7)</b>
port initGame =
  Signal.send actions.address NewGame</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We introduce a new action <code>NewGame</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Our update function now takes a tuple of time and action + game as input parameters</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We use the elm core function <code>truncate</code> to convert the time(stamp) float into an integer and use that as our seed to <code>createGame</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We construct a mailbox for our Action messages manually, with an initial value of NewGame</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Our model is a fold (reduce) of all state changes sent to our mailbox (from the app started to the current moment of time).
This is where we introduce the Time.timestamp function, which wraps our action signal and produces a tuple of (timestamp, action)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>main is just a map over our view function with our current model. Since view also expects an (mailbox) address we curry/partially apply that to our view function</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Unfortunately I couldn&#8217;t figure out how to get the timestamp passed to the init function. The creation
step (4) of the mailbox doesn&#8217;t actually cause the NewGame action to be executed either. So this is a little hack
that fires off a task to execute the NewGame action. This is run after initialization so when you load the game you&#8217;ll not see state 0 for the game, but actually state 1.
If any elm-ers out there reads this, feel free to comment on how this could be done in a more idiomatic fashion!</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
I found <a href="https://yobriefca.se/blog/2015/08/02/deconstructing-your-first-elm-app/">this</a> blogpost
very illuminating for deconstructing start-app.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_but_what_about_undo">But what about undo ?</h4>
<div class="paragraph">
<p>There is an elm-package I think would help us do that quite simply;
<a href="https://github.com/TheSeamau5/elm-undo-redo">elm-undo-redo</a>. However if you are using <a href="https://github.com/elm-lang/elm-reactor">elm-reactor</a>
you pretty much get undo-redo and more out of the box. Great for development, but maybe not so much for production!</p>
</div>
<iframe width="420" height="315" src="https://www.youtube.com/embed/P3B4ldi1cmc" frameborder="0" allowfullscreen></iframe>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Getting into Elm has been a really pleasurable experience so far. It&#8217;s quite easy to get up and running without
knowing all that much about the language. I&#8217;ve found the elm compiler to be a really nice and friendly companion.
The error messages I get are really impressive and I can truly say I&#8217;ve never experienced anything quite like it.
Working with types (at least for this simple application) hasn&#8217;t felt like a burden at all. I still feel I should have
had some tests, but I think I would feel more comfortable refactoring this app with a lot less tests than I would in say JavaScript.</p>
</div>
<div class="paragraph">
<p>If my intention for this post had been to bash JavaScript I chose a poor example to compare with. But then again
that was never my intention. I wanted to show how a well written JavaScript app might compare to an Elm implementation
written by an Elm noob. Hopefully I&#8217;ve also managed to demonstrate that it&#8217;s not all that difficult getting started with Elm and perhaps
peeked your interest enough to give it a try !</p>
</div>
<div class="sect2">
<h3 id="_resources">Resources</h3>
<div class="paragraph">
<p>These are some of the resources that have helped me getting up to speed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://pragmaticstudio.com/elm">Elm: Building Reactive Web Apps</a> - A really nice step-by-step tutorial with videos and examples to get you up to speed. You get great value for $29 I think.</p>
</li>
<li>
<p><a href="https://pragmaticstudio.com/elm-signals">Elm: Signals, Mailboxes &amp; Ports</a> - Elm signals in depth. Really useful for getting into more detail on what Signals are, how they work and how to use them.</p>
</li>
<li>
<p><a href="https://github.com/evancz/elm-architecture-tutorial/">Elm Architecture Tutorial</a> - Tutorial outlining "the Elm Architecture"</p>
</li>
<li>
<p><a href="http://elm-lang.org/">elm-lang.org</a> - The official site for the elm language</p>
</li>
<li>
<p><a href="https://github.com/rundis/elm-light">elm-light</a> - My elm plugin for Light Table, or if you use another editor it might be listed <a href="http://elm-lang.org/get-started#configure-your-editor">here</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_addendum_potential_improvements">Addendum - Potential improvements</h3>
<div class="ulist">
<ul>
<li>
<p>Initialize game with seed without adding an extra state</p>
</li>
<li>
<p>Perhaps I should/could have used <a href="http://elm-lang.org/docs/records#record-types">extensible records</a> to model the game</p>
</li>
<li>
<p>Maybe Array would be a better choice than List for holding tiles ?</p>
</li>
</ul>
</div>
</div>
</div>
</div></p>
  			<a href="/blog/2015/elm_light.html"><h1>Elm plugin for Light Table</h1></a>
  			<p>30 October 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/elm.html">elm</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Elm plugin for Light Table"
           data-url="http://rundis.github.io/blog/2015/elm_light.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="sect1">
<h2 id="_background">Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;ve just started playing around a little bit with <a href="http://elm-lang.org/">elm</a>.
This weekend I&#8217;m going to <a href="http://www.codemesh.io/">codemesh</a> where I&#8217;ll be attending an Elm workshop
with the author of Elm, Evan Czaplicki.</p>
</div>
<div class="paragraph">
<p>To ensure I have an editor I&#8217;m familiar with and to get me started a little, I figured I&#8217;d create an Elm language plugin
for Light Table. However lately I&#8217;ve been a little busy helping out  getting <a href="https://github.com/LightTable/LightTable" class="bare">https://github.com/LightTable/LightTable</a> version 0.8
released. Last weekend we got an 0.8 alpha out. I needed some of the features from Electron. So now with Light Table using
Electron under the hoods I could finally complete an intial plugin release. It&#8217;s rough, but it&#8217;s an ok start I suppose !</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_demo">Demo</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://youtu.be/B_eZw_GcM-4">ScreenCast demo</a></p>
</div>
<iframe width="420" height="315" src="https://www.youtube.com/embed/B_eZw_GcM-4" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="sect1">
<h2 id="_the_plugin">The plugin</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can find the plugin repo on github <a href="https://github.com/rundis/elm-light" class="bare">https://github.com/rundis/elm-light</a>
</td>
</tr>
</table>
</div>
</div>
</div></p>
  			<a href="/blog/2015/clojurescript_performance_tuning.html"><h1>ClojureScript - Performance tuning rewrite-cljs</h1></a>
  			<p>04 August 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/clojure.html">clojure</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      
		      <a href="/blog/tags/javascript.html">javascript</a>
	      
		      <a href="/blog/tags/performance.html">performance</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="ClojureScript - Performance tuning rewrite-cljs"
           data-url="http://rundis.github.io/blog/2015/clojurescript_performance_tuning.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>How would you go about performance tuning a ClojureScript Library or a ClojureScript application ? Before I started
my summer holidays I started to investigate how I should go about doing that for one of my ClojureScript libraries: <a href="https://github.com/rundis/rewrite-cljs">rewrite-cljs</a>
I didn&#8217;t find a whole lot of info from my trusted old friend Google, so I thought I&#8217;d share some bits and bobs I&#8217;ve learned so far.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;ve previously blogged about how I used rewrite-cljs for two of my Light Table plugins; <a href="https://github.com/rundis/clj-light-refactor/">clj-light-refactor</a> and  <a href="https://github.com/rundis/parembrace">parembrace</a>
The library is a ClojureScript port of the awesome <a href="https://github.com/xsc/rewrite-clj/">rewrite-clj</a> library by Yannick Scherer.
A lot of the porting was just plain sailing with a few adaptations here and there. It&#8217;s truly great that Clojure and ClojureScript are so much aligned.
After the port I also made some changes and adaptations that I knew I needed in my plugins and that I though might be useful for other use cases as well.</p>
</div>
<div class="paragraph">
<p>However one limitation that seriously nagged me was that rewrite-cljs wasn&#8217;t performant enough to be able to handle
rewriting of medium to large sized files (as strings currently mind you) from Light Table.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
One of my sample ClojureScript files (about 600 lines / 20K characters) took about 250 ms to parse and build a zip for before
I started looking at performance tuning. At the time of writing this blog post it&#8217;s down to 50-60 ms. Pretty good, but
still need shave it down a quite a bit further to do some of the things I have in mind !
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_opposing_forces">Opposing forces</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I guess I could have started blindly changing a lot of the implementation to be closer to native JavaScript. However for
several reasons I&#8217;d like to keep it as Clojur&#8217;y as possible and ideally I don&#8217;t want to stray to far away from it origins (rewrite-clj).
How to balance and where to begin ?</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tools">Tools</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To get some idea of where to bottlenecks were and what/if any of my optimzations had any effect I really need some tools
to help me out. Fortunately Light Table ships with the chrome developer tools. The profiler is quite helpful, in addition
I used a small benchmark script to see how it perfomed over a slightly longer timespan.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tuning">Tuning</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_first_quickwin_moving_away_from_multimethods">First quickwin - Moving away from multimethods</h3>
<div class="paragraph">
<p>Before I profiled anything I came accross a google group discussion about multimethod performance vs protocols for
dispatching. The <a href="https://github.com/xsc/rewrite-clj/blob/master/src/rewrite_clj/parser/core.clj">core</a> of the parser in rewrite-cljs was pretty much a 1-1 port of the one from rewrite-clj.
I decided to try to just dispatch using a cond or case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn- dispatch
  [c]
  (cond (nil? c)                        parse-eof
        (identical? c *delimiter*)      reader/ignore
        (reader/whitespace? c)          parse-whitespace
        (identical? c \^)               parse-meta
        (identical? c \#)               parse-sharp
        (identical? c \()               parse-list
        (identical? c \[)               parse-vector
        (identical? c \{)               parse-map
        (identical? c \})               parse-unmatched
        (identical? c \])               parse-unmatched
        (identical? c \))               parse-unmatched
        (identical? c \~)               parse-unquote
        (identical? c \')               parse-quote
        (identical? c \`)               parse-syntax-quote
        (identical? c \;)               parse-comment
        (identical? c \@)               parse-deref
        (identical? c \")               parse-string
        (identical? c \:)               parse-keyword
        :else                           parse-token))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result was that I shaved of somewhere between 30-50 ms. I can&#8217;t remember the exact number, but it was substantial.
So eventhough multimethods are nice, for this use case I don&#8217;t think they added that much value and the performance overhead (due to indirection?) just wasn&#8217;t justified.
I did try using both a map and case for char tests, but found that a simple cond outperformed both (on my machine running on an old ClojureScript version in Light Table)</p>
</div>
</div>
<div class="sect2">
<h3 id="_some_random_pickings">Some random pickings</h3>
<div class="paragraph">
<p>When working with Light Table I&#8217;ve previously found that in some cases I could gain some nice performance improvements
by changing from clojure datastructures to native js.
I&#8217;ll show a couple of samples</p>
</div>
<div class="sect3">
<h4 id="_checking_for_token_boundaries">Checking for token boundaries</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn boundary?
  [c]
  "Check whether a given char is a token boundary."
  (contains?
    #{\" \: \; \' \@ \^ \` \~
      \( \) \[ \] \{ \} \\ nil}
    c))</code></pre>
</div>
</div>
<div class="paragraph">
<p>was rewritten to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(def js-boundaries                                     <i class="conum" data-value="1"></i><b>(1)</b>
  #js [\" \: \; \' \@ \^ \` \~
      \( \) \[ \] \{ \} \\ nil])


(defn boundary?
  [c]
  "Check whether a given char is a token boundary."
  (&lt; -1 (.indexOf js-boundaries c)))                   <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Figured the list of boundaries only needs to be defined once</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Using JavaScript Array.indexOf proved to be quite efficient. More so than a ClojureScript map lookup in this case.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>I used a similar approach for other kinds of boolean tests for characters (whitespace?, linebreak? etc).</p>
</div>
</div>
<div class="sect3">
<h4 id="_testing_characters_for_equality">Testing characters for equality</h4>
<div class="paragraph">
<p>Tests like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(when (= c "\")
  ... )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Performs better using identical? (same object):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(when (identical? c "(")
  ... )</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_still_far_from_satisfied_swanodette_to_the_rescue">Still far from satisfied - swanodette to the rescue</h3>
<div class="paragraph">
<p>In the end of june/beginning of july I noticed that Davin Nolen was tweeting about promising performance improvments
with regards to cljs-bootstrap. This made me curious and eventually I found some very inspiring commits on a cljs-bootstrap branch of a fork of tools.reader.
Hey, surely this guy nows a thing or two about what really might help and still keep the code nice and clojury.</p>
</div>
<div class="paragraph">
<p>So I just started picking from relevant commits on this <a href="https://github.com/swannodette/tools.reader/commits/cljs-bootstrap">branch</a></p>
</div>
<div class="paragraph">
<p>A few highlights:</p>
</div>
<div class="sect3">
<h4 id="_avoiding_protocol_indirection">Avoiding protocol indirection</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn peek
  "Peek next char."
  [^not-native reader]     <i class="conum" data-value="1"></i><b>(1)</b>
  (r/peek-char reader))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>not-native is a type hint that inline calls directly to protocol implementations</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_type_hinting">Type hinting</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn ^boolean whitespace?   <i class="conum" data-value="1"></i><b>(1)</b>
  [c]
  (r/whitespace? c))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The boolean type hint allows the  cljs compiler to avoid emitting a call to <code>cljs.core/truth_</code>. The type hint is really for true boolean values (true/false), but if we know for sure that the value
isn&#8217;t one of <code>0, "" (empty-string) and NaN</code> we can coerce the compiler to do our bidding !</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_satisfies_implements">satisfies? &#8658; implements?</h4>
<div class="paragraph">
<p>Changing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(if (satisfies? IWithMeta o)
  ...)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(if (implements? IWithMeta o)
  ...)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Helps quite a bit.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2x_performance_increase_what_now">2X+ performance increase, what now ?</h3>
<div class="paragraph">
<p>We&#8217;ve achieve quite a bit, but it&#8217;s still between 100-120 ms for my sample. I need more. More I tell you !</p>
</div>
<div class="paragraph">
<p>So back to the profiler to try and pick out some suspicious candidates.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2015//lt_profiler.png" alt="lt profiler">
</div>
</div>
<div class="ulist">
<div class="title">I made various micro-improvements like changing</div>
<ul>
<li>
<p><strong>str</strong> to <strong>goog.stringbuffer</strong> for concatinating strings</p>
</li>
<li>
<p><strong>aget</strong> to <strong>.charAt</strong> for getting a character at a position in a string</p>
</li>
<li>
<p>Stringbuffer initialization to occur once and using clear inside functions (felt a bit like global variables (: )</p>
</li>
<li>
<p><strong>count</strong> to <strong>.length</strong> for string length</p>
</li>
<li>
<p>etc</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It all helped a bit, steadily shaving of a millisecond here and a millisecond there (even had some setbacks along the way !).</p>
</div>
<div class="sect3">
<h4 id="_do_s_and_don_ts">Do&#8217;s and Don&#8217;ts</h4>
<div class="paragraph">
<p>A couple of function showed a lot of own-time in the profiler. I really couldn&#8217;t figure out why though. They didn&#8217;t
seem to do much, but delegate to other functions.
I tried a range of things until I stumbled accross this <a href="http://stuartsierra.com/2015/06/01/clojure-donts-optional-arguments-with-varargs">blogpost</a> by Stuart Sierra.
Both of the methods was using the following pattern for handling a single var-arg:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn token-node
  "Create node for an unspecified EDN token."
  [value &amp; [string-value]]                       <i class="conum" data-value="1"></i><b>(1)</b>
  (-&gt;TokenNode
    value
    (or string-value (pr-str value))))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>&amp; [string-value]</code> destructures the sequence of arguments</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This constructor method was called a lot. So not only was this perhaps not ideal stylewise, but it turns out
it has some pretty bad performance characteristics as well. (Not knowing the details, I can only speculate on why&#8230;&#8203;)</p>
</div>
<div class="paragraph">
<p>So I changed the above code to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn token-node
  "Create node for an unspecified EDN token."
  ([value]
   (token-node value (pr-str value)))
  ([value string-value]
  (-&gt;TokenNode value string-value)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Yay! Changing two frequently called functions to use method overloading had a huge impact on performance.
Not only that, but I noticed that the garbage collector was using substantially less time as well.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Performance tuning is fun, but really hard. Not knowing anything about the inner wokings of ClojureScript and the closure compiler doesn&#8217;t help.
There wasn&#8217;t much to be found in terms of help using my normal search foo, and the book "Performance tuning ClojureScript" hasn&#8217;t been seen quite yet.
That beeing said, this is probably the first time in over a year and half playing/working with ClojureScript that I&#8217;ve even thought about performance issues with ClojureScript. Mostly it&#8217;s a non issue for
my use cases.</p>
</div>
<div class="paragraph">
<p>Quite a few of the tweaks didn&#8217;t really make the code that much less idiomatic, however there were a couple of cases where the host language
seeps out.</p>
</div>
<div class="paragraph">
<p>Feel free to share you experiences with performance tuning ClojureScript. I&#8217;d really like to learn more about it
and hopefully make some additional shavings in rewrite-cljs !</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://github.com/rundis/rewrite-cljs">rewrite-cljs</a> 0.3.1 was just released. Snappier than ever <span class="icon green"><i class="fa fa-smile-o"></i></span>
</td>
</tr>
</table>
</div>
</div>
</div></p>
  			<a href="/blog/2015/parembrace.html"><h1>Showcasing rewrite-cljs - Parembrace for Light Table</h1></a>
  			<p>12 June 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/clojure.html">clojure</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Showcasing rewrite-cljs - Parembrace for Light Table"
           data-url="http://rundis.github.io/blog/2015/parembrace.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Wow! Implementing my own paredit plugin for Light Table. How (and why) on earth did I end up doing that ?</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A few months back I set forth on a mission trying to bring some proper Clojure refactoring support to Light Table through
the <a href="https://github.com/rundis/clj-light-refactor/">clj-light-refactor</a> plugin. One of the first features I implemented
was a <a href="http://rundis.github.io/blog/2015/clj_light_thread.html">threading refactoring</a> using clojure.zip and cljs.reader.
It quickly became evident that both clojure.zip and cljs.reader put severe limitations on what I would be able to implement.
The reader is quite limited in terms of the syntaz it allows and using a plain zipper would make it incredibly tedious in terms of
handling formatting (whitespace, newlines and comments etc).</p>
</div>
<div class="paragraph">
<p>The experience of using a zipper for refactoring was really appealing to me, but I needed something way better to be able
to do anything really useful. I put the whole thing on the backburner for a while, until I stumbled upon
<a href="https://github.com/xsc/rewrite-clj/">rewrite-clj</a>. It looked like just the thing I needed, however it had no ClojureScript
support though. After weeks of deliberation I decided to write a ClojureScript port, aptly named <a href="https://github.com/rundis/rewrite-cljs">rewrite-cljs</a>.</p>
</div>
<div class="paragraph">
<p>The ParEdit support in Light Table is somewhat limited, a few plugins to remedy that has been implemented none of which
are actively maintained or easily extendable. They all focus on the editor, text and moving braces around.</p>
</div>
<div class="paragraph">
<p>Could I make something a lot more structured for Light Table, where the focus is on navigating and moving proper clojure code nodes in a virtual AST ?
If Light Table falls over and dies, will all my efforts have been in vain ?</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Well I present to you <a href="https://github.com/rundis/parembrace"><strong>parembrace</strong></a> a slightly different take on implementing
a paredit plugin for Light Table using rewrite-cljs for most of it&#8217;s heavy lifting
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2015//wrap_slurping.gif" alt="wrap slurping">
</div>
<div class="title">Figure 1. Wrap forward slurping</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_challenges">Implementation challenges</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_a_more_powerful_reader">A more powerful reader</h3>
<div class="paragraph">
<p>My first challenge was that the default reader in ClojureScript, cljs.reader, only supports a subset of
of valid clojure code. Things like anonymous functions and other reader macros are not supported.
I had to address that before I could even consider trying to do a port of rewrite-clj.</p>
</div>
<div class="paragraph">
<p>Luckily I found most of what I needed in the <a href="https://github.com/lazerwalker/clojurescript-in-clojurescript">clojurescript-in-clojurescript</a> project.
It even supported a IndexingPUshBackReader which was essential for retaining source positional information about the nodes in a zipper.
I had to hack around it a little bit, but nearly everything I needed was in place. Yay !</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I ended up bundling the modded reader in rewrite-cljs btw.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_porting_rewrite_clj">Porting rewrite-clj</h3>
<div class="paragraph">
<p>I won&#8217;t bore you with the details here, but it was mostly pretty straight forward. While I was at it, I opted
for extending its' features somewhat:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>I added bounds meta information for all nodes (start - end coordinates)</p>
</li>
<li>
<p>Finder functions to locate nodes by a given position in the underlying source</p>
</li>
<li>
<p>A paredit namespace</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The paredit namespace should probably be factored out to a separate lib. I really shouldn&#8217;t  bloat rewrite-cljs unnecessarily.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Whan creating(/aka porting) rewrite-cljs my intention was always to ensure that it was reusable from many other contexts than
my own client libs/apps. Whether I&#8217;ve succeeded with that I guess is yet to be proven !</p>
</div>
<div class="paragraph">
<p>It&#8217;s used from parembrace and clj-light-refactor, but I see no reason why you wouldn&#8217;t be able to reuse it
from say the Atom editor or your somewhat overly ambitious fully structural ClojureScript SPA editor project.</p>
</div>
</div>
<div class="sect2">
<h3 id="_performance">Performance</h3>
<div class="paragraph">
<p>It quickly became evident that parsing all code in an editor to a rewrite-cljs zipper structure
for every paredit editor action wouldn&#8217;t be usable for files beyond 100-200 lines of code.
For now I have to settle for the inconvenience of working within the context of top level forms.
Having used the plugin during it&#8217;s development for a couple of weeks now, that&#8217;s not really a problem
99 % if the time (at least for me that is).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_smattering_of_code">A smattering of code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let me run you through an example. Paredit raise-sexpr</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(dynamic-wind in (lambda () |body) out) ; -&gt;
(dynamic-wind in |body out) ; -&gt;
body</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_rewrite_cljs">rewrite-cljs</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn raise [zloc]                               <i class="conum" data-value="1"></i><b>(1)</b>
  (if-let [containing (z/up zloc)]
    (z/replace containing (z/node zloc))         <i class="conum" data-value="2"></i><b>(2)</b>
    zloc))                                       <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>zloc is a the zipper node we wish to raise. From the example above the body token node</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If zloc has a parent node (seq), then we replace the parent node with the node at zloc</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If zloc has no parent, we can&#8217;t raise we just return zloc</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Trying it out</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(ns foo-bar
  (:require [rewrite-clj.zip :as z]
            [rewrite-clj.paredit :as pe])

(-&gt; (z/of-string "(dynamic-wind in (lambda () body) out)")    <i class="conum" data-value="1"></i><b>(1)</b>
    (pe/find-by-pos {:row 1 :col 29})                         <i class="conum" data-value="2"></i><b>(2)</b>
    pe/raise                                                  <i class="conum" data-value="3"></i><b>(3)</b>
    pe/raise
    z/root-string)                                            <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a clojure zipper with rewrite nodes for the initial code</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Locate zloc, a pointer to the <strong>body</strong> node in our instance</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Raise (twice to produce the end result)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Wrap up the zipper and return it&#8217;s stringified representation</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_light_table">Light Table</h3>
<div class="paragraph">
<p>The generic function for invoking paredit commands in parembrace looks something like the this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn paredit-cmd [ed f]
  (let [pos (editor/-&gt;cursor ed)
        form (u/get-top-level-form ed)                                         <i class="conum" data-value="1"></i><b>(1)</b>
        zloc (positioned-zip pos form)]                                        <i class="conum" data-value="2"></i><b>(2)</b>
    (when zloc
      (editor/replace ed (:start form) (:end form) (-&gt; zloc f z/root-string))  <i class="conum" data-value="3"></i><b>(3)</b>
      (editor/move-cursor ed pos)                                              <i class="conum" data-value="4"></i><b>(4)</b>
      (format-keep-pos ed))))                                                  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the top-level form at given position</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Given form an position in LT terms, create a zipper and position it at node with given position</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace the form in editor with the rewritten form after applying paredit/zipper function <strong>f</strong></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The positioning isn&#8217;t quite as trivial as this with depth changing commands</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Format the form nicely</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For raise, f would in our example be a reference to <code>pe/raise</code>, but really it could be
something really whacky like :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">#(-&gt; % pe/raise pe/kill z/leftmost)</code></pre>
</div>
</div>
<div class="paragraph">
<p>which would given you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(|dynamic-wind in)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let me know if that is something you would find useful <span class="icon green"><i class="fa fa-smile-o"></i></span></p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Behaviors and commands</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::raise!                                                   <i class="conum" data-value="1"></i><b>(1)</b>
          :triggers #{:parembrace.raise!}
          :reaction (fn [ed]
                      (paredit-cmd ed pe/raise)))



(cmd/command {:command :parembrace.raise                             <i class="conum" data-value="2"></i><b>(2)</b>
              :desc "Parembrace: Raise"
              :exec (fn []
                      (when-let [ed (pool/last-active)]
                        (object/raise ed :parembrace.raise!)))})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The behavior here strictly speaking isn&#8217;t needed, but it provides a means to scope the feature
to only be available for editors tagged as clojure editors</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The commands are there for you to be able to either execute from the command bar, or for mapping a keyboard shortcut</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_current_state_and_future_plans_for_parembrace">Current state and future plans for Parembrace ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A large percentage of the features in the <a href="http://pub.gajendra.net/src/paredit-refcard.pdf">paredit reference card</a> has been
implemented. Some features behave slightly different, and there are a couple of novel nuggets there as well.
All is not well though. Cursor positioning needs improving and performance needs to be tweaked.</p>
</div>
<div class="paragraph">
<p>What does the future hold ? Well I&#8217;m planning on implementing the missing features and I&#8217;m sure I&#8217;ll add a few more
useful nuggets too. The most important thing I aim to provide is a clear pluggable way of extending and modifying features
to allow you to customize parembrace to your liking.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I believe rewrite-cljs already has paid off multiple times. I can&#8217;t thank <a href="https://github.com/xsc">xsc</a> enough
for writing <a href="https://github.com/xsc/rewrite-clj/">rewrite-clj</a>. It&#8217;s really awesome and without it I&#8217;d still be fumbling around with parsers and what-not.
I can reuse rewrite-cljs from both parembrace and clj-light-refactor. In the latter not only can I start implementing cool code refactoring features, but
I can do things like structurally traverse and  rewrite the project.clj file. I can&#8217;t wait to get started&#8230;&#8203; well I have to wait because I&#8217;m moving to a new house, but after that&#8230;&#8203;</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you are a Light Table user, do take <a href="https://github.com/rundis/parembrace">Parembrace</a> for a spin and let me know what you think !
</td>
</tr>
</table>
</div>
</div>
</div></p>
  			<a href="/blog/2015/lt_react.html"><h1>Implementing a Clojure ns-browser in Light Table with React</h1></a>
  			<p>22 April 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/clojure.html">clojure</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      
		      <a href="/blog/tags/react.html">react</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Implementing a Clojure ns-browser in Light Table with React"
           data-url="http://rundis.github.io/blog/2015/lt_react.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;ve long been looking for better ways to navigate between code in Clojure projects in Light Table.
The workspace navigator isn&#8217;t particularily keyboard friendly. For navigating files <a href="https://github.com/joshuafcole/claire">claire</a>
is a better option. Coming from IntelliJ I have been used to navigating to classes/resources in java projects in a breeze.</p>
</div>
<div class="paragraph">
<p>I needed something more clojure project aware, so I decided to implement a namespace browser.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lately I&#8217;ve been working on the <a href="https://github.com/rundis/clj-light-refactor">clj-light-refactor</a> plugin, providing
better Clojure support in Light Table. It made sense to me to add a namespace browser feature to the plugin at some point.
Through experience with integrating the <a href="https://github.com/clojure-emacs/cider-nrepl">cider-nrepl</a> middleware
I found that I had most of the tools necessary to implement a simple namespace browser.</p>
</div>
<div class="paragraph">
<p>A namespace browser obviously needs a bit of UI, and this is where the power of having an editor framework
based on node-webkit/atom-shell opens up for a range of opportunities. I could use the std dom lib that ships
with Light Table, but I decided I&#8217;d rather have a go at implementing the UI part using React. Just for fun.</p>
</div>
<div class="paragraph">
<p>There are a range of ClojureScript wrappers for React, but I decided to opt for one of the least opinionated ones : <a href="https://github.com/levand/quiescent">quiescent</a>.
Let&#8217;s have a look at how I did it !</p>
</div>
<div class="openblock float-group">
<div class="content">
<div class="imageblock left">
<div class="content">
<img src="/blog/2015//ns_list.png" alt="ns list" width="400">
</div>
<div class="title">Figure 1. Namespace list</div>
</div>
<div class="imageblock left">
<div class="content">
<img src="/blog/2015//ns_vars.png" alt="ns vars" width="400">
</div>
<div class="title">Figure 2. Public vars for selected namespace</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_react_and_quiescent">Setting up React and quiescent</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you&#8217;ll see, this part is pretty easy.</p>
</div>
<div class="sect2">
<h3 id="_quiescent_dependency_project_clj">Quiescent dependency - project.clj</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defproject clj-light-refactor "0.1.5"
  :dependencies [[org.clojure/clojure "1.5.1"]
                 [quiescent "0.1.4"]])               <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To include quiescent, just add it as a dependency. I opted for an older version because the ClojureScript version currently supported by LT is fairly old.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_react_dependency_plugin_behaviours_file">React dependency - plugin behaviours file</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">[:app :lt.objs.plugins/load-js ["react.min.js"                       <i class="conum" data-value="1"></i><b>(1)</b>
                                "clj-light-refactor_compiled.js"]]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Just add the react js using the load-js behavior for plugins. It needs to load before quiescent, so it&#8217;s added before the transpiled js for the plugin project.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_state_bot_and_such">State, BOT and such</h2>
<div class="sectionbody">
<div class="paragraph">
<p>My namespace browser will need to have state. The namespace browser will retrieve it&#8217;s data
from a cider-nrepl middleware op. Continuously invoking this backend for the data would kill the performance.
State in Light Table is typically stored in objects. Objects are basically a map of data stored in an ClojureScript atom.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To learn more about BOT (Behaviors, Objects and Tags), check out <a href="http://www.chris-granger.com/2013/01/24/the-ide-as-data/">The IDE as a value</a> by Chris Granger.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Quiescent has no opinions with regards to state, you just feed quiescent components with data, so using LT objects shouldn&#8217;t be of any concern.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defui wrapper [this]                                             <i class="conum" data-value="1"></i><b>(1)</b>
  [:div.outer
   [:div {:id "nsbrowser-wrapper"} "Retrieving namespaces..."]])

(object/object* ::nsbrowser
                :tags #{:clojure.nsbrowser}                       <i class="conum" data-value="2"></i><b>(2)</b>
                :label "Clojure ns browser"
                :order 2
                :init (fn [this]                                  <i class="conum" data-value="3"></i><b>(3)</b>
                        (wrapper this)))

(def ns-bar (object/create ::nsbrowser))                          <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>React needs a container element to mount in. We just create a wrapper (nsbrowser-wrapper), using the LT defui macro.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We add a custom tag to our object. Using this tag we can attach behaviors, i.e reaction to events, to our object.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Objects have an init function that can return a UI representation. Initially thats just our wrapper div. The actual content we will provide through behaviors.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Instantiate the object</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rendering_the_nsbrowser_ui_using_quiescent_and_react">Rendering the nsbrowser UI using quiescent and react</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(declare render)

(defn handle-keypress [props ev]                                           <i class="conum" data-value="6"></i><b>(6)</b>
  (let [kk (.-which ev)]
    (case kk
      38 (do (.preventDefault ev) ((:on-up props)))
      40 (do (.preventDefault ev) ((:on-down props)))
      13 (do (.preventDefault ev) ((:on-select props)))
      27 (do (.preventDefault ev) ((:on-escape props)))
      :default)))

(q/defcomponent SearchInput [props]                                        <i class="conum" data-value="5"></i><b>(5)</b>
  (d/input {:placeholder "search"
            :value (:search-for props)
            :onKeyDown (partial handle-keypress props)
            :onChange  #((:on-change props) (aget % "target" "value"))
            :autoFocus (:focus props)}))

(q/defcomponent ResultItem [item]                                          <i class="conum" data-value="4"></i><b>(4)</b>
  (d/li {:className (when (:selected item) "selected")} (:name item)))

(q/defcomponent ResultList [props]                                         <i class="conum" data-value="3"></i><b>(3)</b>
  (apply d/ul {:className (when (:selected-ns props) " nsselection")}
               (map ResultItem (:items props))))

(q/defcomponent Searcher [props]                                           <i class="conum" data-value="2"></i><b>(2)</b>
  (d/div {:className "filter-list"}
         (SearchInput props)
         (when-let [sel-ns (:selected-ns props)]
           (d/div {:className "nstitle"} sel-ns))
         (ResultList (select-keys props [:items :selected-ns]))))


(defn render [props]                                                       <i class="conum" data-value="1"></i><b>(1)</b>
  (q/render (Searcher (merge {:on-down #(object/raise ns-bar :move-down!)
                              :on-up #(object/raise ns-bar :move-up!)
                              :on-select #(object/raise ns-bar :select!)
                              :on-escape #(object/raise ns-bar :escape!)
                              :on-change (fn [search-for]
                                           (object/raise ns-bar :search! search-for))}
                             props))
            (.getElementById js/document "nsbrowser-wrapper")))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The render function is where we initially mount our react components and subsequently
rerender our UI upon any change in our data. The function takes a map (containing the data to render) and we merge in some properties
for handling events we wish to handle in our ui. More on that later.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is the root component for our UI. It basically contains a search input and a result list (with a optional heading, when a namespace has been selected)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Subcomponent for the result list</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Subcomponent for a result list item, applies a <em>.selected</em> class if this item is selected</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Subcomponent for the search input. This is used for filtering and navigating our result list.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Handler for keyboard events in the search input</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are not familiar with react, it might seem inefficient to render the entire UI everytime. But
react is quite clever with its DOM operations, using a virtual dom it only performs the DOM operations necessary to
represent the diff since the last render. Further optimization is provided by quiescent as any quiescent component
will check whether the first param have changed using a clojure equality test (fast). If no props have changed, it will tell React that
the component doesn&#8217;t need to rerender. Short story, you don&#8217;t need to worry about render speed. It&#8217;s more than fast enough.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The benefits of this approach might not be immediatly visible, but believe me it makes it very simple to reason about the UI.
When some state changes, rerender the entire UI. You don&#8217;t need to worry about making the individual dom updates needed to
represent the change. This part is handled by react.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_working_with_data">Working with data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When implementing the logic for changing which items is selected it made sense to extract the core
of that to immutable helper functions. Nothing new here, but it&#8217;s a whole lot easier when no state is represented
in the dom, but rather in data structures somewhere else (like in an atom).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn move-down [items]
  (let [curr-idx (selected-idx items)]
    (if-not (&lt; curr-idx (dec (count items)))
      items
      (-&gt; items
          (assoc-in  [curr-idx :selected] false)
          (assoc-in  [(inc curr-idx) :selected] true)))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementing then move up/down logic are just simple functions. Testing them interactivly in Light Table
is dead easy using the inbuild repl with inline results.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_behaviors_for_filter_navigation_and_selection">Behaviors for filter, navigation and selection</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::move-up!                                                     <i class="conum" data-value="1"></i><b>(1)</b>
          :triggers #{:move-up!}
          :reaction (fn [this]
                      (let [moved (move-up (:filtered-items @this))]
                        (object/merge! this {:filtered-items moved})
                        (render {:items moved
                                 :selected-ns (:selected-ns @this)
                                 :search-for (:search-for @this)})
                        (sidebar-cmd/ensure-visible this))))            <i class="conum" data-value="2"></i><b>(2)</b>

(behavior ::select!                                                     <i class="conum" data-value="3"></i><b>(3)</b>
          :triggers #{:select!}
          :reaction (fn [this]
                      (when-let [sel-idx (selected-idx (:filtered-items @this))]
                        (when-let [ed (pool/last-active)]
                          (let [item-name (:name (nth (:filtered-items @this) sel-idx))]
                            (if-not (:selected-ns @this)
                              (do
                                (object/merge! this {:search-for ""
                                                     :selected-ns item-name})
                                (object/raise ed :list-ns-vars item-name))
                              (let [sym (str (:selected-ns @this) "/" item-name)]
                                (object/raise ed :editor.jump-to-definition! sym)
                                (object/raise this :clear!))))))))


(behavior ::search!                                                    <i class="conum" data-value="4"></i><b>(4)</b>
          :triggers #{:search!}
          :reaction (fn [this search-for]
                      (let [items (if (:selected-ns @this) (:vars @this) (:items @this))
                            filtered
                            (-&gt;&gt; items
                                 (filter-items search-for)
                                 maybe-select-first
                                 vec)]
                        (object/merge! this {:filtered-items filtered
                                             :search-for search-for})
                        (render {:items filtered
                                 :selected-ns (:selected-ns @this)
                                 :search-for search-for}))))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>All the move up behavior basically does is updating the state holding which item (in our filtered list of items)
is selected and then rerenders the UI with the updated item list</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When scrolling down the list (an UL element), we need to make sure the item is visible so we need to scroll. I
couldn&#8217;t figure out a react-way to do this, so I reused a function from LT&#8217;s command browser to achieve this.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The select behavior does one of two things. If the item selected is an namespace item it triggers
a behavior for retrieving (and subsequently later render) a list of public vars for that namespace. If the item is a var
it triggers a behavior for jumping to the definition of that var. The latter is a behavior already present in the Light Table Clojure plugin.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The search behavior filters the list of items to show based on what the user has entered in the search input.
It stores that filtered list in our object and rerenders the ui.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <em>this</em> argument for our behavior reaction function is the ns-bar object instance we defined earlier.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure"> [:clojure.nsbrowser :lt.plugins.cljrefactor.nsbrowser/move-up!]
 [:clojure.nsbrowser :lt.plugins.cljrefactor.nsbrowser/select!]
 [:clojure.nsbrowser :lt.plugins.cljrefactor.nsbrowser/search!]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hooking up our behaviors to our object can be done inline using code, or declaratively using
a behaviors definition file. I&#8217;ve opted for the latter and hooked them up in the plugin behaviors file.
What we say here is that objects with the given tag <em>:clojure.nsbrowser</em> responds to the behavior defined in the second arg for the vectors.
Should you find that you&#8217;d like to override one or more of the behaviors (or disable them alltogether) you can easily
do that.</p>
</div>
<div class="sect2">
<h3 id="_a_silly_example_overriding_the_move_behavior">A silly example - overriding the move behavior</h3>
<div class="paragraph">
<p>Let&#8217;s say you have a better idea for how the move behavior should work. You override that
in your Light Table user plugin (everyone has one !).</p>
</div>
<div class="sect3">
<h4 id="_providing_your_own_behavior">Providing your own behavior</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(ns lt.plugins.user                                                    <i class="conum" data-value="1"></i><b>(1)</b>
  (:require [lt.object :as object]
            [lt.plugins.nsrefactor.nsbrowser :as nsbrowser])           <i class="conum" data-value="2"></i><b>(2)</b>
  (:require-macros [lt.macros :refer [behavior]]))

(behavior ::user-move-up!
          :triggers #{:move-up!}                                       <i class="conum" data-value="3"></i><b>(3)</b>
          :reaction (fn [this]
                      (println "Add my custom version here...")))      <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You&#8217;ll find the user plugin in $LT_HOME/User. It ships with a default $LT_HOME/User/src/plugins/user.cljs file for your convenience</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Require any namespace you need, for the purpose of this override you might need to have access to functions
in the namespace where the nsbrowser is implemented</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This is the really important bit. Triggers (together with tags) tells LT which behavior reaction functions to invoke
when an event is triggered (through <em>object/raise</em>)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Implementation for the overriding behavior</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_replacing_the_default_behavior_with_our_own">Replacing the default behavior with our own</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure"> [:clojure.nsbrowser :-lt.plugins.cljrefactor.nsbrowser/move-up!]   <i class="conum" data-value="1"></i><b>(1)</b>
 [:clojure.nsbrowser :lt.plugins.user/user-move-up!]                <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First we turn off the default behavior from the plugin <em>:-</em> disable a given behavior)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The we hook up our new custom made override behavior</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>I think you now can start to the see the power of the BOT model in Light Table. It&#8217;s very flexible,
but the price you pay is that it can be difficult to grasp at first sight. Once you do grock it, you&#8217;ll realize that
you have an incredibly customizable editor at your disposal.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_the_namespace_data">Getting the namespace data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So how do we go about getting the list of namespaces and vars for each namespace ?
This is where cider-nrepl comes into play. The ops we wish to call are in the <a href="https://github.com/clojure-emacs/cider-nrepl/blob/master/src/cider/nrepl/middleware/ns.clj">ns middleware</a> for cider-nrepl.</p>
</div>
<div class="sect2">
<h3 id="_interacting_with_cider_nrepl">Interacting with cider-nrepl</h3>
<div class="paragraph">
<p>A precondition for this to work is that the cider-nrepl is added as a plugin dependency for your project.
You could do this on a project level, or you could do it globally for all your projects in profiles.clj.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">  :user {:plugins [[cider/cider-nrepl "0.9.0-SNAPSHOT"]]}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::list-ns
          :triggers #{:list-ns}
          :reaction (fn [ed]
                      (object/raise ed
                                    :eval.custom                                 <i class="conum" data-value="1"></i><b>(1)</b>
                                    (mw/create-op {:op "ns-list"})               <i class="conum" data-value="2"></i><b>(2)</b>
                                    {:result-type :refactor.list-ns-res          <i class="conum" data-value="3"></i><b>(3)</b>
                                     :verbatim true})))


(behavior ::list-ns-res
          :triggers #{:editor.eval.clj.result.refactor.list-ns-res}              <i class="conum" data-value="4"></i><b>(4)</b>
          :reaction (fn [ed res]
                      (let [[ok? ret] (mw/extract-result res                     <i class="conum" data-value="5"></i><b>(5)</b>
                                                         :singles
                                                         [:ns-list :results])]
                        (if-not ok?
                          (object/raise ed
                                        :editor.exception
                                        (:err ret)
                                        {:line (-&gt; ret :meta :line)})

                          (do
                            (object/raise sidebar/rightbar :toggle ns-bar)       <i class="conum" data-value="6"></i><b>(6)</b>
                            (object/raise ns-bar
                                          :update-ns-list!                       <i class="conum" data-value="7"></i><b>(7)</b>
                                          (-&gt;&gt; (:ns-list ret)
                                               (maybe-exclude (:exclusions @ns-bar))
                                               (map #(hash-map :name %)))))))))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To evaluate arbitrary clojure code in LT you can use the <em>eval.custom</em> behavior</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is a helper method that creates the code to invoke the cider-nrepl middleware</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We can tell LT that the trigger for the response should end with <em>refactor.list-ns-res</em>. So when
the operation completes in will trigger a behavior named as defined in <strong>4</strong></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The trigger for our behavior to handle the response</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Helper function to extract the result from cider-nrepl op</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Our nsbrowser is displayed in a predefined UI component which is a sidebar. We tell it to display</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>We raise a behavior for displaying the list of namespaces found (see the <a href="https://github.com/rundis/clj-light-refactor/blob/master/src/lt/plugins/cljrefactor/nsbrowser.cljs">full source</a> for how this behavior is defined)</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The code eval behavior is triggered on an ed object. This is an LT editor object. This means that
we need to have a clojure editor open for our namespace browser to work (hoping to remedy that in the near future).
The editor object contains information about which project we are connected to (and if not connected, prompts you to do so).
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_providing_a_command_to_show_the_namespace_browser">Providing a command to show the namespace browser</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The final piece of the puzzle is to provide a command to allow us to trigger when the namespace browser should be displayed.
Commands in Light Table are typically the user actions. Commands are actions that can be tied to keyboard shortcuts. They are also displayed
in the Light Table command browser (open by pressing ctrl + space).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(cmd/command {:command :show-nsbrowser                          <i class="conum" data-value="1"></i><b>(1)</b>
              :desc "Clojure refactor: Show ns-browser"         <i class="conum" data-value="2"></i><b>(2)</b>
              :exec (fn []
                      (when-let [ed (pool/last-active)]         <i class="conum" data-value="3"></i><b>(3)</b>
                        (object/raise ed :list-ns)))})          <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The name of the command</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The description for our command, this text is shown in the command browser</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Get the currently active editor object (if one is open)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Trigger the behavior for retrieving the initial namespace list and ultimately display the namespace browser</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_defining_a_keyboard_shortcut">Defining a keyboard shortcut</h3>
<div class="paragraph">
<p>In your user keymap (ctrl + space, find "Setting: User keymap" and select it)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure"> [:editor.clj "ctrl-alt-n" :show-nsbrowser]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we&#8217;ve scoped the shortcut to only trigger when we invoke it having an active clojure editor open</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_some_final_sugaring_custom_filtering">Some final sugaring - Custom filtering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To provide some customization for our nsbrowser we&#8217;ve defined a user configurable behavior
for that purpose. Currently you can define a list of regex&#8217;s for namespaces you wish to exclude from the listing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::set-nsbrowser-filters
          :triggers #{:object.instant}                                   <i class="conum" data-value="1"></i><b>(1)</b>
          :desc "Clojure Refactor: Configure filter for nsbrowser"
          :type :user
          :params [{:label "exclusions" :type :list}]                    <i class="conum" data-value="2"></i><b>(2)</b>
          :exclusive true
          :reaction (fn [this exclusions]
                      (object/merge! this {:exclusions exclusions})))    <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This particular behavior is triggered when the ns-bar object is instatiated</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can provide param descriptions which show up in .behaviors files to assist user configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We store the user provided setting in our object</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2015//nsconfig_beh.png" alt="nsconfig beh">
</div>
</div>
<div class="paragraph">
<p>The default behavior adds a few exclusions by default. You can easily override those by configuring the behavior
in your own user.behaviors. (ctrl + space, find "Settings: User behavior" and select)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Having an editor that is basically a web browser with node-js integration provides the foundation to do an incredible amount of
cool stuff. In this post I have shown you how to use React (with quiescent on top) for rendering view items in Light Table.
I have walked you through how that may fit in with the BOT architecture Light Table is based on.
I hope I have managed to give you a glimpse of the power of the BOT architecture and the facilities it provides for extending and customizing
your editor. I haven&#8217;t gone into great detail on how I&#8217;ve interacted with cider-nrepl to provide the namespace data, that belongs in a separate blogpost.</p>
</div>
<div class="paragraph">
<p><em>Some of you might have noticed that the Light Table project and it&#8217;s progress has stalled somewhat (ref <a href="https://groups.google.com/d/msg/light-table-discussion/2csnnNA1pfo/693EWDJVhuwJ">this post from Chris Granger</a> on the LT discussion forum.
I&#8217;m still hoping that this situation can be remedied. I firmly believe it&#8217;s possible and with just a wee bit more community effort Light Table can still have a future
as a great Open Source IDE alternative.</em></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For improved Clojure support in Light Table, you really should try out the <a href="https://github.com/rundis/clj-light-refactor">clj-light-refactor</a> plugin !
</td>
</tr>
</table>
</div>
</div>
</div></p>
  			<a href="/blog/2015/clojure_light_love.html"><h1>A pinch of Clojure love to Light Table</h1></a>
  			<p>14 April 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/clojure.html">clojure</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="A pinch of Clojure love to Light Table"
           data-url="http://rundis.github.io/blog/2015/clojure_light_love.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The Clojure Refactoring plugin for Light Table has finally been released !
You&#8217;ll find the plugin in the LIght Table plugin manager. Alternatively you
can clone the repo to the plugin folder of LIght Table if you know what you are doing :)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You will need to check out the readme <a href="https://github.com/rundis/clj-light-refactor" class="bare">https://github.com/rundis/clj-light-refactor</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To celebrate the launch of the plugin I&#8217;ve made a small demo of some of the features in the plugin.
You might also be interrested in the pre-release <a href="http://rundis.github.io/blog/2015/clj_light_refactor.html">demo</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_demo">Demo</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://youtu.be/1yk8nsjJxb0">ScreenCast demo</a></p>
</div>
<iframe width="420" height="315" src="https://www.youtube.com/embed/1yk8nsjJxb0" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="sect1">
<h2 id="_feature_highlights">Feature highlights</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Simple form refactoring (cycle if, cycle col, introduce threading etc)</p>
</li>
<li>
<p>Extract function</p>
</li>
<li>
<p>Dependency completion and hotloading of dependencies</p>
</li>
<li>
<p>Find usages and rename</p>
</li>
<li>
<p>Namespace cleanup</p>
</li>
<li>
<p>Resolve mising requires/imports</p>
</li>
<li>
<p>Some cider features like: test support, smarter autocompletion and better formatting</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Most of the features are currently Clojure only, but some of the simpler ones also works in ClojureScript.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Pre release demo: <a href="http://rundis.github.io/blog/2015/clj_light_refactor.html" class="bare">http://rundis.github.io/blog/2015/clj_light_refactor.html</a></p>
</li>
<li>
<p>Plugin repo: <a href="https://github.com/rundis/clj-light-refactor" class="bare">https://github.com/rundis/clj-light-refactor</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_credits">Credits</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/clojure-emacs/refactor-nrepl">refactor-nrepl</a> - nREPL middleware to support refactorings in an editor agnostic way. This awesome middleware
has enable most of the advanced refactoring features in the plugin</p>
</li>
<li>
<p><a href="https://github.com/clojure-emacs/cider-nrepl">cider-nrepl</a> - A collection of nREPL middleware designed to enhance CIDER. Additional cool
features have been enabled by this middleware, and there are more to come !</p>
</li>
<li>
<p><a href="https://github.com/clojure-emacs/clj-refactor.el">clj-refactor.el</a> - Emacs Clojure Refactor plugin. The source of inspiration for my Light Table plugin.
It provides a long list of really cool refactoring features for emacs users.</p>
</li>
</ul>
</div>
</div>
</div></p>
  			<a href="/blog/2015/clojure_dates.html"><h1>Taming those pesky datetimes in a clojure stack</h1></a>
  			<p>27 March 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/clojure.html">clojure</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      
		      <a href="/blog/tags/date.html">date</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Taming those pesky datetimes in a clojure stack"
           data-url="http://rundis.github.io/blog/2015/clojure_dates.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Have you ever faced frustrating issues when using dates in your clojure stack ? If I mention java.util.Date, java.sql.Date/java.sql.Timestamp
clj-time, json/ISO-8601 and UTC/Timezones, does your bloodpressure rise slightly ?</p>
</div>
<div class="paragraph">
<p>This is the blog post I wished I had several weeks back to save me from some of the date pains my current project has been through.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A little while back date handling started to become a nightmare in my current project. We have a stack with
a ClojureScript frontend, a clojure WebApp and a couple of clojure microservices apps using Oracle as a data store.</p>
</div>
<div class="paragraph">
<p>We decided pretty early on to use <a href="https://github.com/clj-time/clj-time">clj-time</a>. It&#8217;s a really quite nice wrapper on top of <a href="http://www.joda.org/joda-time/">joda-time</a>.
But we didn&#8217;t pay much attention to how dates should be read/written to Oracle or how we should transmit dates across process boundaries.
Timezones is another issue we didn&#8217;t worry to much about either.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You will probably not regret using an UTC timezone for your Servers and Database. This <a href="http://yellerapp.com/posts/2015-01-12-the-worst-server-setup-you-can-make.html">post</a> puts it succinctly.
Your webclient(s) though is out of your control !
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>I&#8217;m sure some of the measures we have taken can be solved more elegantly, but hopefully you might find some of them useful.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reading_from_writing_to_the_database">Reading from/writing to the database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We use <a href="https://github.com/clojure/java.jdbc">clojure/java.jdbc</a> for our database integration. Here&#8217;s how we managed to
simplify reading and writing dates/datetimes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(ns acme.helpers.db
  (:import [java.sql PreparedStatement])
  (:require [acme.util.date :as du]
            [clj-time.coerce :as c]
            [clojure.java.jdbc :as jdbc]))


(extend-protocol jdbc/IResultSetReadColumn                                <i class="conum" data-value="1"></i><b>(1)</b>
  java.sql.Date
  (result-set-read-column [v _ _] (c/from-sql-date v))                    <i class="conum" data-value="2"></i><b>(2)</b>

  java.sql.Timestamp
  (result-set-read-column [v _ _] (c/from-sql-time v)))

(extend-type org.joda.time.DateTime                                       <i class="conum" data-value="3"></i><b>(3)</b>
  jdbc/ISQLParameter
  (set-parameter [v ^PreparedStatement stmt idx]
    (.setTimestamp stmt idx (c/to-sql-time v))))                          <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We extend the protocol for reading objects from the java.sql.ResultSet.
In our case we chose to treat java.sql.Date and java.sql.Timestamp in the same manner</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>clj-time provides some nifty coercion functions including the facility to coerce from sql dates/times to DateTime</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We extend the DateTime class (which is final btw!) with the ISQLParameter protocol. This is a protocol for setting SQL parameters in statement objects.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We explicitly call setTimestamp on the prepared statement with a DateTime coerced to a java.sqlTimestamp as our value</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we can interact with oracle without being bothered with java.sql.Date and java.sql.Timestamp malarkey.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
It&#8217;s vital that you require the namespace you have the above incantations, before doing any db interactions. Might be evident, but it&#8217;s worth emphasizing.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Clojure <a href="http://clojure.org/protocols">protocols</a> are pretty powerful stuff. It&#8217;s deffo on my list of clojure things I need
to dig deeper into.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dates_across_process_boundaries">Dates across process boundaries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our services unsurpringly uses JSON as the data exchange format. I suppose the defacto standard date format is <a href="http://www.iso.org/iso/home/standards/iso8601.htm">ISO-8601</a>,
it makes sence to use that. It so happens this is the standard format for DateTime when you stringify it.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You might want to look into <a href="https://github.com/cognitect/transit-format">transit</a>. It would probably have been very useful for us :)
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_outbound_dates">Outbound dates</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(ns acme.core
  (:require [clojure.data.json :as json]
            [clj-time.coerce :as c]))


(extend-type org.joda.time.DateTime           <i class="conum" data-value="1"></i><b>(1)</b>
  json/JSONWriter
  (-write [date out]
    (json/-write (c/to-string date) out)))    <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Another extend of DateTime, this time with the JSONWriter protocol.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When serializing DateTime to json we coerce it to string. clj-time.coerce luckily uses the ISO-8601 format as default</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_inbound_dates">Inbound dates</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(ns acme.util.date
  (:require [clj-time.core :as t]
            [clj-time.format :as f]
            [clj-time.coerce :as c]))


(def iso-date-pattern (re-pattern "^\\d{4}-\\d{2}-\\d{2}.*"))


(defn date? [date-str]                                                         <i class="conum" data-value="1"></i><b>(1)</b>
  (when (and date-str (string? date-str))
    (re-matches iso-date-pattern date-str)))


(defn json-&gt;datetime [json-str]
  (when (date? json-str)
    (if-let [res (c/from-string json-str)]                                     <i class="conum" data-value="2"></i><b>(2)</b>
      res
      nil))) ;; you should probably throw an exception or something here !

(defn datetimeify [m]
  (let [f (fn [[k v]]
            (if (date? v)
              [k (json-&gt;datetime v)]                                           <i class="conum" data-value="3"></i><b>(3)</b>
              [k v]))]
    (clojure.walk/postwalk (fn [x] (if (map? x) (into {} (map f x)) x)) m)))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A crude helper function to check if a given value is a date. There is a lot that passes through as valid ISO-8601
we settled for atleast a minimum of YYYY-MM-DD</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Coerces a string to a DateTime, the coercion will return nil if it can&#8217;t be coerced, that&#8217;s probably worth an exception</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Traverse a arbitrary nested map and coerce values that (most likely) are dates</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Hook up middleware</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn wrap-date [handler]                                     <i class="conum" data-value="1"></i><b>(1)</b>
  (fn [req]
    (handler (update-in req [:params] (datetimeify %)))))


def app (-&gt; routes
            auth/wrap-auth
            wrap-date                                         <i class="conum" data-value="2"></i><b>(2)</b>
            wrap-keyword-params
            wrap-json-params
            wrap-datasource
            wrap-params
            wrap-config))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Middleware that calls our helper function to coerce dates with the request map as input</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hook up the middleware</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_handling_dates_in_the_webclient">Handling dates in the webclient</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have a ClojureScript based client so it made sense for us to use <a href="https://github.com/andrewmcveigh/cljs-time">cljs-time</a>.
It&#8217;s very much inspired by clj-time, but there are some differences. The most obvious one is that there is no jodatime, so
<a href="http://docs.closure-library.googlecode.com/git/namespace_goog_date.html">Google Closure goog.date</a> is used behind the scenes.</p>
</div>
<div class="paragraph">
<div class="title">So how do we convert to and from the iSO-8601 string based format in our client ?</div>
<p>Surprisingly similar to how we do it on the server side as it happens !</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">;; require similar to the ones on the server side. cljs-time. rather than clj-time.


(defn datetimes-&gt;json [m]                                                       <i class="conum" data-value="1"></i><b>(1)</b>
  (let [f (fn [[k v]]
            (if (instance? goog.date.Date v)                                    <i class="conum" data-value="2"></i><b>(2)</b>
              [k (c/to-string v)]
              [k v]))]
    (clojure.walk/postwalk (fn [x] (if (map? x) (into {} (map f x)) x)) m)))


;; AJAX/HTTP Utils

(defn resp-&gt;view [resp]                                                         <i class="conum" data-value="3"></i><b>(3)</b>
  (-&gt; resp
      (update-in [:headers] #(keywordize-keys %))
      (assoc-in [:body] (-&gt; resp datetimeify :body))))                          <i class="conum" data-value="4"></i><b>(4)</b>

(defn view-&gt;req [params]                                                        <i class="conum" data-value="5"></i><b>(5)</b>
  (-&gt; params
      datetimes-&gt;json))                                                         <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Function that traverses a nested map and converts from DateTime to ISO-8601</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Almost an instanceOf check to decide if the value is eligible for coercion</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Handy function to transform an ajax response to something appropriate for use in our client side logic</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>datetimeify is identical to our server side impl</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Handy function to take a map, typically request params, and transform to something appropriate for communication
with a backend server. If you are using something like <a href="https://github.com/r0man/cljs-http">cljs-http</a> it might be appropriate to hook it in as a middleware.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Coerce any DateTime values to ISO-8601 date strings</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
What about timezones on the client ? The default for the datetime constructor in cljs-time is to use UTC. So when displaying
time and/or accepting date with time input from the client you need to convert to/from the appropriate timezone.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(ns acme.client
  (:require [cljs-time.format :as f]
            [cljs-time.core :as t]))


(def sample (t/now)) ;; lets say 2015-03-27T00:53:38.950Z


(-&gt;&gt; sample
     t/to-default-time-zone                          ; UTC+1 for me
     (f/unparse (f/formatter "dd.MM.yyyy hh:mm")))   ; =&gt; 27.03.2015 01:53</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Using clojure protocols we managed to simplify reading and writing date(times) to the database. Protocols also helped us serialize
date(times) to json. For reading json we had to hack it a little bit. By using fairly similar libs for dates on both the client and our server apps
we managed to reuse quite a bit. In addition We have reasonable control of where we need to compensate for timezones.
Most importantly though, our server-side and client-side logic can work consistently with a sensible and powerful date implementation.</p>
</div>
</div>
</div></p>
  			<a href="/blog/2015/buddy_auth_part4.html"><h1>Securing Clojure Microservices using buddy - Part 4: Secure and liberate a service app</h1></a>
  			<p>25 March 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/clojure.html">clojure</a>
	      
		      <a href="/blog/tags/buddy.html">buddy</a>
	      
		      <a href="/blog/tags/security.html">security</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Securing Clojure Microservices using buddy - Part 4: Secure and liberate a service app"
           data-url="http://rundis.github.io/blog/2015/buddy_auth_part4.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Part 4 in my blog series about securing clojure web services using <a href="https://github.com/funcool/buddy">buddy</a>.
The time has finally come to demonstrate how you may secure a REST based microservice application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="ulist">
<div class="title">Previous episodes in this series:</div>
<ul>
<li>
<p><a href="http://rundis.github.io/blog/2015/buddy_auth_part1.html">Securing Clojure Microservices using buddy - Part 1: Creating Auth Tokens</a></p>
</li>
<li>
<p><a href="http://rundis.github.io/blog/2015/buddy_auth_part2.html">Securing Clojure Microservices using buddy - Part 2: WebApp authentication and authorization</a></p>
</li>
<li>
<p><a href="http://rundis.github.io/blog/2015/buddy_auth_part3.html">Securing Clojure Microservices using buddy - Part 3: Token revocation</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Sample code (tagged for each blog post) can be found on <a href="https://github.com/rundis/acme-buddy">github</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before I discovered buddy my first attempt at prototyping a clojure web app with security tried to combine
the use of <a href="https://github.com/cemerick/friend">Friend</a> and <a href="http://clojure-liberator.github.io/liberator">Liberator</a>.
To complicate matters I tried to make an app that both served user content (html) and provided a REST api.
I had a hard time figuring out how to make the two play nicely together. If it hadn&#8217;t been for the brilliant article:
<a href="http://sritchie.github.io/2014/01/17/api-authentication-with-liberator-and-friend/">API Authentication with Liberator and Friend</a> by Sam Ritchie,
I wouldn&#8217;t have gotten very far.</p>
</div>
<div class="paragraph">
<p>In this episode I will try to demonstrate how you may use buddy in combination with Liberator
to secure a REST-oriented microservice application. We are going to build upon the token based
authentication and authorization from the previous episodes and create the <strong>acme-catalog</strong> service app.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_small_contribution_to_buddy">A small contribution to buddy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The primary buddy lib to help you secure ring based web apps is <a href="https://github.com/funcool/buddy-auth">buddy-auth</a>.
Unfortunately when I first wanted to use buddy-auth for authentication and authorization, it didn&#8217;t provide
out of the box support for jws tokens. What to do ? Well I decided to do what any good open citizen should do.
I submitted a pull request. My first clojure lib contribution got accepted. Yay !</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_relevant_code_snippets_for_acme_catalog">Relevant code snippets for acme-catalog</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_wrap_authentication_middleware">Wrap authentication middleware</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(ns acme-catalog.core
  (:require [compojure.core :refer [defroutes ANY]]
            [ring.middleware.params :refer [wrap-params]]
            [ring.middleware.keyword-params :refer [wrap-keyword-params]]
            [ring.middleware.json :refer [wrap-json-params]]
            [clojure.java.io :as io]
            [buddy.auth.backends.token :refer [jws-backend]]
            [buddy.auth.middleware :refer [wrap-authentication]]
            [buddy.core.keys :as ks]
            [acme-catalog.resources :as r]))

(defroutes app-routes
  (ANY "/products" [] r/products)
  (ANY "/products/:id" [id] (r/product id)))


(def auth-backend (jws-backend {:secret (ks/public-key (io/resource "auth_pubkey.pem"))  <i class="conum" data-value="1"></i><b>(1)</b>
                                :token-name "Acme-Token"}))

(def app
  (-&gt; app-routes
      (wrap-authentication auth-backend)                                                 <i class="conum" data-value="2"></i><b>(2)</b>
      wrap-keyword-params
      wrap-json-params))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Buddy auth backend that supports jws tokens. We provide the public key for the certifacate used by
acme-auth to create our tokens. In addition we can optionally provide a custom name for our token</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Apply middleware that uses backend to read the token, unsign it and populate request map with the token info</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="olist arabic">
<div class="title">What does the wrap-authentication middleware do ?</div>
<ol class="arabic">
<li>
<p>Retrieves the <em>Authorization</em> header (if one exist) from the request headers</p>
</li>
<li>
<p>Looks for the token param (default "Token", but in our case "Acme-Token")</p>
</li>
<li>
<p>If found reads the token and unsigns it using the secret (in our case the public key)</p>
</li>
<li>
<p>The contents of the unsigned token is added to an :identity key in your request map</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Sample request map</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">{:identity
  {:user
    {:user-roles [{:role-id 10, :application-id 10}
                  {:role-id 41, :application-id 40}],
     :username test, :id 1},
 :exp 1427285979},
 ;; etc...
 }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_authorizing_liberator_resources">Authorizing liberator resources</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Liberator routes your request through a graph of decisions and actions. <a href="http://clojure-liberator.github.io/liberator/assets/img/decision-graph.svg">This graph</a>
provides a useful context in case you are not familiar with what decisions kicks in when !
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>I initially tripped on the difference between HTTP status 401 and 403. <a href="http://stackoverflow.com/questions/3297048/403-forbidden-vs-401-unauthorized-http-responses">Stackoverflow</a>
provides a pretty clear explanation.</p>
</div>
<div class="sect3">
<h4 id="_helper_functions_for_role_access">Helper functions for role access</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(def acme-catalog-roles
  {:customer 41 :catalog-admin 40})                                       <i class="conum" data-value="1"></i><b>(1)</b>

(defn any-granted? [ctx roles]                                            <i class="conum" data-value="2"></i><b>(2)</b>
  (seq
   (clojure.set/intersection
    (set (map :role-id (-&gt; ctx :request :identity :user :user-roles)))
    (set (vals (select-keys acme-catalog-roles roles))))))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hardcoded definition of roles applicable for the acme-catalog app</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Helper function to check if the user has been granted one or more of the applicable roles</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_liberator_resource_commons">Liberator resource commons</h4>
<div class="paragraph">
<p>Liberator resources are composable, so to avoid too much repetion across resources we&#8217;ve created
a small helper function to define behavior for the two key decision points with regards to
authentication and authorization checks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn secured-resource [m]
  {:authorized?    #(authenticated? (:request %))                                       <i class="conum" data-value="1"></i><b>(1)</b>
   :allowed?       (fn [ctx]
                     (let [default-auth? (any-granted? ctx (keys acme-catalog-roles))]  <i class="conum" data-value="2"></i><b>(2)</b>
                       (if-let [auth-fn (:allowed? m)]
                         (and default-auth? (auth-fn ctx))                              <i class="conum" data-value="3"></i><b>(3)</b>
                         default-auth?)))})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>:authorized?</strong> corresponds to 401. Here we check if the user is authenticated. We use a buddy function: <em>authenticated?</em>
to do the check. If the user isn&#8217;t authentication this function will return false</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>:allowed?</strong> corresponds to 403. We provide a default impl here that says that the user must atleast have
one of the acme-catalog roles to be authorized to access a secured resource</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>In addition we provide an optional facility to specify a custom function for more fine grained authorization checks. See below for example.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_securing_products_resources">Securing products resources</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defresource product-categories
  (secured-resource {})                                                                   <i class="conum" data-value="1"></i><b>(1)</b>
  :available-media-types ["application/json"]
  :allowed-methods       [:get]
  :handle-ok             (fn [ctx] "List of categories"))

(defresource products
  (secured-resource {:allowed? (by-method {:get true                                      <i class="conum" data-value="2"></i><b>(2)</b>
                                           :post #(any-granted? % [:catalog-admin])})})
  :available-media-types ["application/json"]
  :allowed-methods       [:get :post]
  :handle-ok             (fn [ctx] "List of products coming your way honey"))


(defresource product [id]
  (secured-resource {:allowed? (by-method {:get true
                                           :delete #(any-granted? % [:catalog-admin])
                                           :put #(any-granted? % [:catalog-admin])})})
  :available-media-types ["application/json"]
  :allowed-methods       [:get :put :delete]
  :handle-ok             (fn [ctx]                                                        <i class="conum" data-value="3"></i><b>(3)</b>
                           (if (and (= "99" id)
                                    (not (any-granted? ctx [:catalog-admin])))
                             (ring-response {:status 403
                                             :headers {}
                                             :body "Only admins can access product 99"})
                             "A single product returned")))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For the product-categories service anybody with a acme-catalog role may access</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For products we restrict access by request method. Only catalog admins may add new products, while anyone can list products.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Silly example, but demonstrates that you can always bypass the defaults and do custom authorization
further down in the liberator decision chain.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_trying_it_all_out_commando_style">Trying it all out - commando style</h3>
<div class="listingblock">
<div class="title">Get a valid token</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">acme-auth: lein ring server-headless

# In another terminal
curl -i -X POST -d '{"username": "test", "password":"secret"}' -H "Content-type: application/json" http://localhost:6001/create-auth-token

# Responds with something like:
HTTP/1.1 201 Created
Date: Wed, 25 Mar 2015 11:49:39 GMT
Content-Type: application/json; charset=utf-8
Content-Length: 1057
Server: Jetty(7.6.13.v20130916)

{"token-pair":{"auth-token":"eyJ0eXAiOiJKV1MiLCJhbGciOiJSUzI1NiJ9.eyJ1c2VyIjp7InVzZXItcm9sZXMiOlt7InJvbGUtaWQiOjEwLCJhcHBsaWNhdGlvbi1pZCI6MTB9LHsicm9sZS1pZCI6NDEsImFwcGxpY2F0aW9uLWlkIjo0MH1dLCJ1c2VybmFtZSI6InRlc3QiLCJpZCI6MX0sImV4cCI6MTQyNzI4NTk3OX0.eNTNG8Hu8a4OD9xWSoEZgwGUd15Oytj-GQZY4RgmTEdx9OjkLDRBefU89GNlEEq19Bsd3ciuWzTXKg3B0qvAk4F4-najY_erPGypSlBvRUI0Fa1_wA2PRYxT-zCTiSIxD-oM0oq_3Z61QlN0k-Sf7shel42-x9z7r8RQeNMr-iMk-hOI_v7moQogN08FiZnctcQdE8qKg_DEhwO3l780eBta_vr3tGSd174IRthz59G61P-XqV8wC4HZymbe8TCMc-3uniIvQeoG_rC3oRqNfjkxZlTB_h6mOjs1p3h_cUmrsOhSk0mQe5mrwSzuCiunMcKQ1jsb88daWkvjMrwRUg","refresh-token":"eyJ0eXAiOiJKV1MiLCJhbGciOiJSUzI1NiJ9.eyJ1c2VyLWlkIjoxLCJleHAiOjE0Mjk4NzYxODAsImlhdCI6MTQyNzI4NDE4MH0.FH2xooPoGnrSEbcU17Tr8ls9A-Noc3n9ZzLWGrblrI0bbIIFz25eJLcJbVGT3dLs7syc0KG3v4O0LAwQ6URvgl0aV2IT366KpmOiMUpsYmgqDCuE45FlSB2IBQKOLBTb6j18jpIsy0Kev6iHUCpvgKyNPcglElnVLFFahVwk_DDyrWusPcX-Di3AqSJdyz6ruBuPGzbzS6DMNkasTFNI1TLwjuokzVCdIYSNiQmgc1IozBFjHdeqQ_5kUdinv_tiW7yho0CwqiGSa9i56b328aZR5lADXR6gom5Oy4XTDDR6eMoDcvZKBncLV3YO29HC58EmZLghbX6832i0J7jfGw"}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Calling acme-catalog</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">acme-catalog: lein ring server-headless

#in another terminal
curl -i -H "Authorization: Acme-Token eyJ0eXAiOiJKV1MiLCJhbGciOiJSUzI1NiJ9.eyJ1c2VyIjp7InVzZXItcm9sZXMiOlt7InJvbGUtaWQiOjEwLCJhcHBsaWNhdGlvbi1pZCI6MTB9LHsicm9sZS1pZCI6NDEsImFwcGxpY2F0aW9uLWlkIjo0MH1dLCJ1c2VybmFtZSI6InRlc3QiLCJpZCI6MX0sImV4cCI6MTQyNzI4NTk3OX0.eNTNG8Hu8a4OD9xWSoEZgwGUd15Oytj-GQZY4RgmTEdx9OjkLDRBefU89GNlEEq19Bsd3ciuWzTXKg3B0qvAk4F4-najY_erPGypSlBvRUI0Fa1_wA2PRYxT-zCTiSIxD-oM0oq_3Z61QlN0k-Sf7shel42-x9z7r8RQeNMr-iMk-hOI_v7moQogN08FiZnctcQdE8qKg_DEhwO3l780eBta_vr3tGSd174IRthz59G61P-XqV8wC4HZymbe8TCMc-3uniIvQeoG_rC3oRqNfjkxZlTB_h6mOjs1p3h_cUmrsOhSk0mQe5mrwSzuCiunMcKQ1jsb88daWkvjMrwRUg" http//localhost:6003/products/1

# reponds with something like
HTTP/1.1 200 OK
Date: Wed, 25 Mar 2015 13:47:50 GMT
Vary: Accept
Content-Type: application/json;charset=UTF-8
Content-Length: 25
Server: Jetty(7.6.13.v20130916)

A single product returned</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integration_with_acme_webstore">Integration with acme-webstore</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Calling acme-catalog from acme-webstore should now be a pretty simple matter. We just need to make
sure we pass on the token.</p>
</div>
<div class="sect2">
<h3 id="_calling_acme_catalog">Calling acme-catalog</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(ns acme-webstore.catalog
  (:require [clj-http.client :as http]))


(defn get-from-catalog [path token]
  (http/get path {:headers {"Authorization" (str "Acme-Token " token)}}))       <i class="conum" data-value="1"></i><b>(1)</b>

(defn get-products [req]
  (let [auth-token (-&gt; req :session :token-pair :auth-token)                    <i class="conum" data-value="2"></i><b>(2)</b>
        resp (get-from-catalog "http://localhost:6003/products" auth-token)]
    (:body resp)))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We make sure we pass the token in the <em>Authorization</em> header with the given token name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The auth-token for the logged in user is found under the session key for the request</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The rest is just a matter of hooking up the appropriate route and view. I&#8217;ll leave that part up to you !</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most of the hard work was already done in the previous episodes. Providing authentication and authorization
for our REST services was pretty simple. We also demonstrated that integrating with Liberator was mostly
a matter of hooking into the appropriate decision points for our resource definitions.
We didn&#8217;t utilize all that much of buddy-auth here, but your app might find use for some of its more advanced features.</p>
</div>
<div class="paragraph">
<p>I think this episode demonstrates some of the benefits of using a library like buddy. It&#8217;s not very opnionated which leaves you with a lot of decisions to make.
But it does have the building blocks you need and it provides you with great flexibility when it comes to integrating with other libraries.</p>
</div>
<div class="paragraph">
<p>At the moment I&#8217;m not sure if there is going to be any further episodes in the near future. But the again it might.
Feel free to leave suggestions in the commenting section though.</p>
</div>
</div>
</div></p>
  			<a href="/blog/2015/clj_light_thread.html"><h1>Implementing a Clojure threading refactoring in ClojureScript using Light Table</h1></a>
  			<p>16 March 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/clojure.html">clojure</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Implementing a Clojure threading refactoring in ClojureScript using Light Table"
           data-url="http://rundis.github.io/blog/2015/clj_light_thread.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>About a week ago I blogged and did a ScreenCast about <a href="http://rundis.github.io/blog/2015/clj_light_refactor.html">Clojure refactoring in Light Table</a>.
I introduced some clojure refactorings enabled by the not yet released <a href="https://github.com/rundis/clj-light-refactor">plugin</a> I&#8217;m currently
working on. In this post I thought I&#8217;d walk you through a feature I&#8217;ve added since then in a little more detail.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Clj-Light-Refactor plugin on github <a href="https://github.com/rundis/clj-light-refactor" class="bare">https://github.com/rundis/clj-light-refactor</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Again <a href="https://github.com/clojure-emacs/clj-refactor.el">clj-refactor.el</a> provided me with a great list of potential
refactoring candidates. I decided I&#8217;d start with the threading refactoring, mostly because I&#8217;ve missed something like that
for Light Table on a daily basis.</p>
</div>
<div class="listingblock">
<div class="title">Goal</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">; Turn something like this;
(map #(+ % 1) (filter even? [1 2 3 4 5]))

;into
(-&gt;&gt; [1 2 3 4 5]
     (filter even?)
     (map #(+ % 1)))</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>I&#8217;d like the refactorings to work for both Clojure and ClojureScript</p>
</li>
<li>
<p>I think it would be the best option if I could implement it in the lt plugin client code (using clojurescript)</p>
</li>
<li>
<p>Use third party lib if that saves me time and provides a great platform for future refactorings</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_analysis_paralysis">Analysis paralysis</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
..the state of over-analyzing (or over-thinking) a situation so that a decision or action is never taken, in effect paralyzing the outcome..
</blockquote>
<div class="attribution">
&#8212; WIKIPEDIA
</div>
</div>
<div class="paragraph">
<p>Before I could get started on the implementation I had to do a bit of research. I tried to find
a clojurescript compatible lib that would make it easy to read/"parse" clojure and clojurescript code
and make it easy to navigate and manipulate it. I looked at parser libs like <a href="https://github.com/lbradstreet/instaparse-cljs">Instaparse-cljs</a> and <a href="https://github.com/cgrand/parsley" class="bare">https://github.com/cgrand/parsley</a> [parsley]
but both seemed like a little bit to much effort to get me started. <a href="https://github.com/xsc/rewrite-clj">rewrite-clj</a> seemed
very promising, but unfortunately no ClojureScript port (feel free to vote for or contribute to this <a href="https://github.com/xsc/rewrite-clj/issues/4">issue</a>)</p>
</div>
<div class="paragraph">
<div class="title">What to do ?</div>
<p>After much deliberation it dawned on my that maybe I should have a go at it without using any libs.
ClojureScript ships with <em>cljs.reader</em>. That should get me started right ? Next step is to get the code
into something easily navigable and modifiable (immutably of course). Another look at xlj-rewrite provided the necessary neuron kickstart: zipper of course.
Good job there is a <a href="https://github.com/clojure/clojurescript/blob/master/src/cljs/clojure/zip.cljs">ClojreScript version</a> already at hand !</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There are many resources out there on zippers in clojure. <a href="http://www.ibm.com/developerworks/library/j-treevisit/">This article</a> is pretty thorough
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_thread_last_step_by_step_overview">Thread last step by step overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To really get to grips with what I had to achieve I sat down and sketched up something like the illustration
below. Quite helpful when your in-brain tree visualizer has gotten somewhat rusty.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2015//thread_first.png" alt="thread first">
</div>
</div>
<div class="olist arabic">
<div class="title">Steps</div>
<ol class="arabic">
<li>
<p>First we wrap our form in a thread-last if we haven&#8217;t done so already</p>
</li>
<li>
<p>We take the last argument of the list node right of the threading operator and promote that node
to become the first argument to the threading ("function/"macro)</p>
</li>
<li>
<p>Same as above, now the node we promote is a vector</p>
</li>
<li>
<p>When the first node next to the threading operator node isn&#8217;t a list (or a list of just one arg), we are done.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Thread first isn&#8217;t much different, so I&#8217;ll leave that excersize up to you !</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some of you might raise your finger at the way I skipped breaking down the <strong>#(+ % 1)</strong> node.
We&#8217;ll get back to that later, but I&#8217;ll give you a hint :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">Could not find tag parser for (+ in ("inst" "uuid" "queue" "js")</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_code_essential">Code essential</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_reading_code_from_a_string">Reading code from a string</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn str-&gt;seq-zip [form-str]
  (when (seq form-str)
    (-&gt; form-str
        rdr/read-string        <i class="conum" data-value="1"></i><b>(1)</b>
        z/seq-zip)))           <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using cljs.reader to read(/parse) code.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a sequence zipper from the parsed form</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please note that cljs.reader only a subset (edn) of clojure. That means that several reader macros like #(), '() etc will croak
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_thread_one_promote_one_pass">Thread one / promote one pass</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn do-thread-one [cand cand-fn]
  (if-not (further-threadable? cand)                         <i class="conum" data-value="1"></i><b>(1)</b>
    cand
    (let [promote (-&gt; cand cand-fn z/node)                   <i class="conum" data-value="2"></i><b>(2)</b>
          therest (-&gt; cand cand-fn z/remove)]                <i class="conum" data-value="3"></i><b>(3)</b>
      (-&gt; therest
          z/up
          (z/insert-left promote)                            <i class="conum" data-value="4"></i><b>(4)</b>
          (#(z/replace % (unwrap-list-if-one (z/node %))))   <i class="conum" data-value="5"></i><b>(5)</b>
          z/up))))                                           <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First we need to check if the form is further threadable, if it isn&#8217;t then just return the zipper (cand) with it&#8217;s current position</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the node that should be promoted using <strong>cand-fn</strong>. cand-fn basically handles navigating the zipper to find the last argument to the function call (thread-last) or the first argument (thread-first)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Gently rip out the node to be promoted, so you are left with the rest sans this node</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Insert the node to be promoted as the first sibling to the threading operator node</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>If the node at the position of the rest node is a list with just one item, it should be the function and we can leave out the parens</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Move the zipper "cursor" up to the first arg of the thread operator function (for potentially further threading)</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_thread_fully">Thread fully</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn- do-thread [orig cand-fn t]
  (when (seq orig)
    (let [root (if (threaded? orig) orig (wrap-in-thread orig t))]  <i class="conum" data-value="1"></i><b>(1)</b>
      (loop [cand root]
        (if-not (further-threadable? cand)                          <i class="conum" data-value="2"></i><b>(2)</b>
          cand
          (recur (do-thread-one cand cand-fn)))))))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If not already wrapped in a form with a threading operator, do so (just for convenience)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Keep promoting until isn&#8217;t possible to promote further</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_zip_it_up">Zip it up</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn zip-&gt;str [zipnode]
  (-&gt; zipnode
      z/root
      pr-str))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_orchestration">Orchestration</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn thread [form-str]
  (let [node (str-&gt;seq-zip form-str)
        threading (when node (threaded? node))]
    (when (and node threading)
      (-&gt; node
          (do-thread (threading-locator threading) threading)
          zip-&gt;str))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Entry point function to read form string, do threading and return result as string again</p>
</div>
</div>
<div class="sect2">
<h3 id="_hooking_it_into_light_table">Hooking it into Light Table</h3>
<div class="sect3">
<h4 id="_replace_helper_function">Replace helper function</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">defn replace-cmd [ed replace-fn]
  (cmd/exec! :paredit.select.parent)                                       <i class="conum" data-value="1"></i><b>(1)</b>
  (when-let [candidate  (editor/selection ed)]
    (let [bounds (editor/selection-bounds ed)]
      (when-let [res (replace-fn candidate)]                               <i class="conum" data-value="2"></i><b>(2)</b>
        (editor/replace-selection ed res))                                 <i class="conum" data-value="3"></i><b>(3)</b>
      (editor/move-cursor ed (-&gt; bounds :from (update-in [:ch] inc))))))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using paredit command to select parent expression</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Execute threading function on selected expression</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace selection with given the refactored result</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_behavior_and_commands">Behavior and commands</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::thread-fully!                                           <i class="conum" data-value="1"></i><b>(1)</b>
          :triggers #{:refactor.thread-fully!}
          :reaction (fn [ed]
                      (replace-cmd ed thread)))

(cmd/command {:command ::thread-fully                               <i class="conum" data-value="2"></i><b>(2)</b>
              :desc "Clojure refactor: Thread fully"
              :exec (fn []
                      (when-let [ed (pool/last-active)]
                        (object/raise ed :refactor.thread-fully!)))})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We create behaviors for each refactor feature so that we can target the feature to a given set of editor tags</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Commands are what the user sees in the LIght Table command pane, and which can be assigned to keyboard shortcuts</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_behaviors">Configuring behaviors</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">  [:editor.clj :lt.plugins.cljrefactor.threading/thread-fully!]
  [:editor.cljs :lt.plugins.cljrefactor.threading/thread-fully!]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We enable the behaviors for both Clojure and ClojureScript tagged editor objects.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_problems">Problems ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Well the limitations of cljs.reader is a problem. The anonymous function literal is something
I use all the time. I did quickly look at <em>cljs.reader/register-tag-parser!</em> but couldn&#8217;t really come up
with a workable strategy here. So if anyone have suggestions for a more complete parsing of clojure code in ClojureScript
please give me a ping ! I ended up escaping it as a string for now. Not exactly great if you&#8217;d like to apply the refactoring
inside an anonymous function literal block.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Actually I also had some issues using clojure.zip from Light Table, but a restart seemed to solve it
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once I managed to make a decision on which route to pursue, the rest was mainly just a blast.
it´s really awesome how much of Clojure it&#8217;s possible to use in ClojureScript and digging into
zippers was a real eyeopener for me. I believe I now have a foundation to provide a range
of useful client side refactoring features and I&#8217;ve already started pondering on what to address next.</p>
</div>
<div class="paragraph">
<p>Some thorny issues remain, and some icing like customizable formatting etc still remains.
The complete list of threading refactorings are listed <a href="https://github.com/rundis/clj-light-refactor#threading">here</a></p>
</div>
<div class="paragraph">
<p>The main takeaway for me is that I keep learning more and more about Clojure, and as a bonus I get
new nifty features for my current editor of choice !</p>
</div>
</div>
</div></p>
  			<a href="/blog/2015/clj_light_refactor.html"><h1>Clojure refactoring in Light Table</h1></a>
  			<p>08 March 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/clojure.html">clojure</a>
	      
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Clojure refactoring in Light Table"
           data-url="http://rundis.github.io/blog/2015/clj_light_refactor.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="sect1">
<h2 id="_background">Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A colleague of mine, the emacs wizard <a href="https://github.com/magnars">Magnar</a> has on multiple occations demonstrated
some of the cool refactoring features for Clojure he has at his disposal in emacs.</p>
</div>
<div class="paragraph">
<p>I&#8217;m currently a <a href="https://github.com/LightTable/LightTable">Light Table</a> user and plugin author. Surely it should
be possible to add some refactoring support to Light Table ? I started looking at <a href="https://github.com/clojure-emacs/clj-refactor.el">clj-refactor.el</a> and
I couldn&#8217;t initially figure out where to start. But I found that some of the cool features were actually enabled
by an nrepl middleware <a href="https://github.com/clojure-emacs/refactor-nrepl">refactor-nrepl</a>.</p>
</div>
<div class="quoteblock">
<blockquote>
nREPL middleware to support refactorings in an editor agnostic way.
</blockquote>
<div class="attribution">
&#8212; refactor-nrepl
</div>
</div>
<div class="paragraph">
<p>Yay, now that&#8217;s what I call a great initiative. I decided to give it a go, and here&#8217;s a taste of what I managed to come up with so far.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_demo">Demo</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://youtu.be/xlGpRTVIkYQ">ScreenCast demo</a></p>
</div>
<iframe width="420" height="315" src="https://www.youtube.com/embed/xlGpRTVIkYQ" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="sect1">
<h2 id="_the_plugin">The plugin</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can find the plugin repo on github <a href="https://github.com/rundis/clj-light-refactor" class="bare">https://github.com/rundis/clj-light-refactor</a>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_taste_of_implementation">A taste of implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I won&#8217;t go into to much details in this blogpost, but I thought I&#8217;d give you a little teaser
on how I&#8217;ve gone about interacting with the middleware. Light Table supports calling arbitrary clojure code through it&#8217;s custom nrepl middleware.
So getting started wasn&#8217;t really that difficult.</p>
</div>
<div class="sect2">
<h3 id="_middleware_invocation">Middleware invocation</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn artifact-list-op []
  (str "(do (require 'refactor-nrepl.client) (require 'clojure.tools.nrepl)"
       "(def tr (refactor-nrepl.client/connect))"
       "(clojure.tools.nrepl/message (clojure.tools.nrepl/client tr 10000) {:op \"artifact-list\"}))"))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above code is an example of the code necessary to connect to and invoke an operation on then refactor-nrepl
middleware for listing clojare artifacts.</p>
</div>
</div>
<div class="sect2">
<h3 id="_behaviour_in_light_table">Behaviour in Light Table</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::trigger-artifact-hints
          :triggers #{:artifact.hints.update!}
          :debounce 500
          :reaction (fn [editor res]
                      (when-let [default-client (-&gt; @editor :client :default)]                  <i class="conum" data-value="1"></i><b>(1)</b>
                          (notifos/set-msg! (str "Retrieving clojars artifacts"))
                          (object/raise editor                                                  <i class="conum" data-value="2"></i><b>(2)</b>
                                        :eval.custom                                            <i class="conum" data-value="3"></i><b>(3)</b>
                                        (artifact-list)
                                        {:result-type :refactor.artifacts :verbatim true}))))   <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For this particular operation (autocompletion of deps) we require that the user has already got a connection to a lein project</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We raise an event on the editor instance (in this case it&#8217;s an editor with a project.clj file)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>:eval.custom is a behavior for evaluate arbitrary clojure code</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We set the result type to something custom so that we can define a corresponding custom behavior
to handle the results</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::finish-artifact-hints
          :triggers #{:editor.eval.clj.result.refactor.artifacts}                                 <i class="conum" data-value="1"></i><b>(1)</b>
          :reaction (fn [editor res]
                      (let [artifacts (-&gt; res :results first :result first :value (s/split #" "))
                            hints (create-artifact-hints editor artifacts)]                       <i class="conum" data-value="2"></i><b>(2)</b>
                        (object/merge! editor {::dep-hints hints})                                <i class="conum" data-value="3"></i><b>(3)</b>
                        (object/raise auto-complete/hinter :refresh!))))                          <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The important part here is that the <em>editor.eval.clj.result</em> is assumed by the Light Table client
whilst <em>refactor.artifacts</em> is appended, given the corresponding param we supplied above. So by naming
our trigger like this, our behaviour will be triggered</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We pick out the results from the refactor-nrepl operation and transform it into a datastructure that&#8217;s suitable
for whatever we need to do (in this case providing autocompletion hints)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We store the list of artifacts in the editor (atom) so that our autocomplete hinter doesn&#8217;t go bananas invoking
the middleware like crazy</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Finally we tell the autocomplete hinter to refresh itself to include the list of artifacts</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The autocomplete part is skimpily explained here, but the important bit I&#8217;m trying to get across is how to
invoke the middleware and how to pick up the results. Autocompletion in Light Table deserves a blog post of it&#8217;s own at some point in the future
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_middleware_preconditions">Middleware preconditions</h3>
<div class="paragraph">
<p>For any of the features in the plugin to work we have to set up the middleware.
So you need to add something like this to your ~/.lein/profiles.clj</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">:plugins [[refactor-nrepl "X.Y.Z"]       <i class="conum" data-value="1"></i><b>(1)</b>
          [cider/cider-nrepl "A.B.C"]]   <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the core dependency that does all the heavy lifting for the features currently implemented</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The Cider nrepl middleware is used by refactor-nrepl. However the cider middleware on it&#8217;s own provides several cool
features that might come handy to the clj-light-refactor plugin in the near future :)</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The version indentifiers are intentionally left out, because it&#8217;s currently a little in flux.
This plugin won&#8217;t be released until the refactor-nrepl comes with it&#8217;s next official release.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_road_ahead">The road ahead</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is just the beginning, but it feels like I&#8217;m on to something. The clj-refactor.el project provides
an huge list of potential features to implement, the refactor-nrepl middleware will surely continue to evolve
and last but not least the cider middleware has plenty of useful stuff to harvest from.</p>
</div>
<div class="paragraph">
<p>I&#8217;ll keep plugin(g) along and hopefully others might get inspired to contribute as well. At some point in the future maybe parts
of this plugin will be ported to the official Light Table Clojure plugin. Who knows !?</p>
</div>
</div>
</div></p>
  			<a href="/blog/2015/buddy_auth_part3.html"><h1>Securing Clojure Microservices using buddy - Part 3: Token revocation</h1></a>
  			<p>19 February 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/clojure.html">clojure</a>
	      
		      <a href="/blog/tags/buddy.html">buddy</a>
	      
		      <a href="/blog/tags/security.html">security</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Securing Clojure Microservices using buddy - Part 3: Token revocation"
           data-url="http://rundis.github.io/blog/2015/buddy_auth_part3.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Part 3 in my blog series about securing clojure web services using <a href="https://github.com/funcool/buddy">buddy</a>.
In this episode we&#8217;ll be looking at how we might handle revocation of previously issued auth tokens.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="ulist">
<div class="title">Previous episodes in this series:</div>
<ul>
<li>
<p><a href="http://rundis.github.io/blog/2015/buddy_auth_part1.html">Securing Clojure Microservices using buddy - Part 1: Creating Auth Tokens</a></p>
</li>
<li>
<p><a href="http://rundis.github.io/blog/2015/buddy_auth_part2.html">Securing Clojure Microservices using buddy - Part 2: WebApp authentication and authorization</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Sample code (tagged for each blog post) can be found on <a href="https://github.com/rundis/acme-buddy">github</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In part 2 I said that my next post would be about authorization using tokens in a service application.
Well my conscience got the better of me and I decided I had to address the slightly thorny issue of how to handle
token revocation first. In part 2 I left you in a state where you&#8217;d have a really hard time locking a user out or changing
access rights. You would have to trust that the user re-authenticated (or change the key-pair for token signing/unsigning).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_opposing_forces">Opposing forces</h2>
<div class="sectionbody">
<div class="ulist">
<div class="title">Some of the things we are trying to achieve with our auth design are:</div>
<ul>
<li>
<p>Avoiding session state for authentication and authorization. Hence the introduction of self contained auth tokens</p>
</li>
<li>
<p>The auth service shouldn&#8217;t become a huge dependency magnet, ideally only client facing apps should have to call the auth-service, whilst the service apps would only use the auth-token for authenticating and authorizing requests</p>
</li>
<li>
<p>The user shouldn&#8217;t be prompted for his/her credentials more than necessary</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">The reality though is that:</div>
<ul>
<li>
<p>We have to be able to lock down a user (malicious or whatever reason)</p>
</li>
<li>
<p>We should be able to change a users rights without forcing a re-authentication</p>
</li>
<li>
<p>Checking whether a token has been revoked would be impossible without storing state about that fact somewhere</p>
</li>
<li>
<p>Continuously checking with the auth-service whether a token has been revoked and/or rights have changed with the auth service would negate
the use of tokens in the first place</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_refresh_tokens">Refresh tokens</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I briefly started reading up on <a href="http://tools.ietf.org/html/draft-ietf-oauth-v2-22#section-6">Oath2 Refresh tokens</a>. It have to admin I didn&#8217;t quite get it until I read a farily explanatory post on <a href="http://stackoverflow.com/questions/3487991/why-does-oauth-v2-have-both-access-and-refresh-tokens">stackoverflow</a>.</p>
</div>
<div class="paragraph">
<p>The gist of it that we issue two tokens upon authentication. An authentication token (or access token if you like) and a refresh token.
This allows us to set a shorter expiry for the auth token, and we can use the refresh-token to request a new auth token when a previous one has expired.
The sole purpose of refresh tokens is to be able to request new auth tokens.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_solution_outline">Solution outline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The diagram below (UML with liberties) illustrates how refresh-tokens might work for us.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2015//refresh-token.png" alt="refresh token">
</div>
</div>
<div class="olist arabic">
<div class="title">Steps</div>
<ol class="arabic">
<li>
<p>User logs in with username/password</p>
</li>
<li>
<p>The web app invokes the create-auth-token service in acme-auth. This in turn</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>authenticates the user</p>
</li>
<li>
<p>creates an auth-token</p>
</li>
<li>
<p>creates a refresh token</p>
</li>
</ol>
</div>
</li>
<li>
<p>The refresh token is stored in a refresh_tokens table</p>
</li>
<li>
<p>Both the auth-token and refresh-token is returned to the web-app</p>
</li>
<li>
<p>The web app stores the tokens in a cookie which is returned to the browser</p>
</li>
<li>
<p>User makes a request (with a valid auth token)</p>
</li>
<li>
<p>The web app might make a call to a resource server/service app (providing the auth-token as a auth-header in the request)</p>
</li>
<li>
<p>At some point later after the auth-token has expired (say 30 minutes) the user makes another request</p>
</li>
<li>
<p>The web app finds that the auth-token has expired and request a new auth-token using the refresh-token (from the cookie)</p>
</li>
<li>
<p>We retrieve the stored refresh-token to check if it still valid (ie not revoked)</p>
</li>
<li>
<p>We invalidate the existing refresh token in the db (will explain this bit when we look at the implementation)</p>
</li>
<li>
<p>We create a new auth token and a new refresh token. The new refresh token is stored in db</p>
</li>
<li>
<p>A new token-pair is returned to the web-app</p>
</li>
<li>
<p>The web app can now make a request to a resource server/service with a valid auth-token</p>
</li>
<li>
<p>Finally the cookie is updated with the new token-pair</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_where_is_the_code_man">Where is the code man ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Well that was a long intro, so if you are still following along it&#8217;s time to have a look at what changes and additions
are needed from part 1 and 2.</p>
</div>
<div class="sect2">
<h3 id="_changing_token_creation_in_acme_auth">Changing token creation in acme-auth</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-cloure" data-lang="cloure">(defn- unsign-token [auth-conf token]
  (jws/unsign token (pub-key auth-conf)))

(defn- make-auth-token [auth-conf user]                                        <i class="conum" data-value="1"></i><b>(1)</b>
  (let [exp (-&gt; (t/plus (t/now) (t/minutes 30)) (jws/to-timestamp))]
    (jws/sign {:user (dissoc user :password)}
              (priv-key auth-conf)
              {:alg :rs256 :exp exp})))

(defn- make-refresh-token! [conn auth-conf user]                               <i class="conum" data-value="2"></i><b>(2)</b>
  (let [iat (jws/to-timestamp (t/now))
        token (jws/sign {:user-id (:id user)}
                        (priv-key auth-conf)
                        {:alg :rs256 :iat iat :exp (-&gt; (t/plus (t/now) (t/days 30)) (jws/to-timestamp))})]

    (store/add-refresh-token! conn {:user_id (:id user)                        <i class="conum" data-value="3"></i><b>(3)</b>
                                    :issued iat
                                    :token token})
    token))

(defn make-token-pair! [conn auth-conf user]                                   <i class="conum" data-value="4"></i><b>(4)</b>
  {:token-pair {:auth-token (make-auth-token auth-conf user)
                :refresh-token (make-refresh-token! conn auth-conf user)}})


(defn create-auth-token [ds auth-conf credentials]                             <i class="conum" data-value="5"></i><b>(5)</b>
  (jdbc/with-db-transaction [conn ds]
    (let [[ok? res] (auth-user conn credentials)]
      (if ok?
        [true (make-token-pair! conn auth-conf (:user res))]
        [false res]))))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The auth token store user and role info as in part 1, but we now have the option of shortening the expiry</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For simplicity we have created the refresh token using the same key-pair as for the auth token. The refresh token
contains only user-id and issued at time (iat). This allows us retrieval of the db stored token info later on. The expiry for this token can be as long as you are comfortable with (30 days in this instance)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We store the token in the refresh_token table with some fields extracted for ease of querying</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We now return a map with both the auth-token and our shiny new refresh-token</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The entry point service for token creation</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_refreshing_tokens">Refreshing tokens</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn refresh-auth-token [ds auth-conf refresh-token]
  (if-let [unsigned (unsign-token auth-conf refresh-token)]                                               <i class="conum" data-value="1"></i><b>(1)</b>
    (jdbc/with-db-transaction [conn ds]
      (let [db-token-rec (store/find-token-by-unq-key conn (:user-id unsigned) (:iat unsigned))           <i class="conum" data-value="2"></i><b>(2)</b>
            user (store/find-user-by-id conn (:user_id db-token-rec))]
        (if (:valid db-token-rec)                                                                         <i class="conum" data-value="3"></i><b>(3)</b>
          (do
            (store/invalidate-token! conn (:id db-token-rec))                                             <i class="conum" data-value="4"></i><b>(4)</b>
            [true (make-token-pair! conn auth-conf user)])                                                <i class="conum" data-value="5"></i><b>(5)</b>
          [false {:message "Refresh token revoked/deleted or new refresh token already created"}])))
    [false {:message "Invalid or expired refresh token provided"}]))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We unsign the refresh-token to ensure it is valid (not tampered with or expired)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We use information from the refresh token to retrieve it&#8217;s db stored representation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This test could return false for 3 cases; token deleted, token has been revoked or the token has been invalidated because a new refresh token has been created</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The existing refresh token is invalidated in the database</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We create a new token pair (where the newly created refresh token is stored in a new db row in the refrest_token table)</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Why creating a new refresh token every time ?</div>
<div class="paragraph">
<p>Imagine that someone gets hold of a users refresh token. Lets say the user requests a token refresh first, now if the hijacker
is making a refresh-request with the hijacked request token we detect that a refresh is attempted on a token that is already invalid.
We can&#8217;t tell if the user or the hijacker is first, but either way we could take action (trigger warning/lock user account etc)
In the code above we can&#8217;t tell the diffence between why a refresh token is invalid, so you might wish to have a separate flag for this particular check.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_middleware_changes_in_the_acme_webstore">Middleware changes in the acme-webstore</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn wrap-auth-cookie [handler cookie-secret]                                    <i class="conum" data-value="1"></i><b>(1)</b>
  (-&gt; handler
      (wrap-session
       {:store (cookie-store {:key cookie-secret})
        :cookie-name "acme"
        :cookie-attrs {:max-age (* 60 60 24 30)}}))) ;; you should probably add :secure true to enforce https


(defn unsign-token [token]
  (jws/unsign token (ks/public-key (io/resource "auth_pubkey.pem"))))


(defn wrap-auth-token [handler]                                                  <i class="conum" data-value="2"></i><b>(2)</b>
  (fn [req]
    (let [auth-token (-&gt; req :session :token-pair :auth-token)
          unsigned-auth (when auth-token (unsign-token auth-token))]
      (if unsigned-auth
        (handler (assoc req :auth-user (:user unsigned-auth)))
        (handler req)))))

(defn- handle-token-refresh [handler req refresh-token]
  (let [[ok? res] (refresh-auth-token refresh-token)                             <i class="conum" data-value="4"></i><b>(4)</b>
        user (:user (when ok? (unsign-token (-&gt; res :token-pair :auth-token))))]
    (if user
      (-&gt; (handler (assoc req :auth-user user))                                  <i class="conum" data-value="5"></i><b>(5)</b>
          (assoc :session {:token-pair (:token-pair res)}))
      {:status 302
       :headers {"Location " (str "/login?m=" (:uri req))}})))                   <i class="conum" data-value="6"></i><b>(6)</b>

(defn wrap-authentication [handler]
  (fn [req]
    (if (:auth-user req)
      (handler req)
      (if-let [refresh-token (-&gt; req :session :token-pair :refresh-token)]
        (handle-token-refresh handler req refresh-token)                         <i class="conum" data-value="3"></i><b>(3)</b>
          {:status 302
           :headers {"Location " (str "/login?m=" (:uri req))}}))))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The only change we made to the cookie middleware is increase the ttl.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The wrap-auth-token middleware just needed to change to handle that auth-token is found as part of a token pair
(not shown: the login handler adds the token pair to the session upon successful authentication)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If the auth token has expired and refresh token exists we initiate an attempt to refresh the token pair</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Invokes the acme-auth service for requesting token refresh</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>If a refreshing the token pair was successful we invoke the next handler in the chain and assoc the new token pair with the session key in the response
(which in turn ends up in the cookie)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>We give up, you have to log in again</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
It might not be a great ideat to store the auth token and the refresh token in the same cookie. Haven&#8217;t really
thought that bit through tbh.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A lot of thinking and not a lot of code this time. But I feel we have come up with a solution that might provide a suitable
balance between risk and statelessless with regards to revoking tokens/user access. Refresh tokens
allows us to stay clear of sessions and avoid asking the usere for their credentials.  <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet">CSRF</a>
is obviously still an issue, but we have taken some small steps to detect when the users cookie might have been hijacked.</p>
</div>
<div class="paragraph">
<p>The next episode will definately be about authentication and authorization in a service app.</p>
</div>
</div>
</div></p>
  			<a href="/blog/2015/asciilight.html"><h1>Scratching my AsciiDoc itch</h1></a>
  			<p>15 February 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      
		      <a href="/blog/tags/node.html">node</a>
	      
		      <a href="/blog/tags/javascript.html">javascript</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Scratching my AsciiDoc itch"
           data-url="http://rundis.github.io/blog/2015/asciilight.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="sect1">
<h2 id="_background">Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So I have been writing my previous blog posts in <a href="http://asciidoctor.org/">AsciiDoc</a> using <a href="https://github.com/LightTable/LightTable">Light Table</a>.
AsciiDoc is really great and I haven&#8217;t regretted using it for my blog at any point in time. To create my blog site
I&#8217;m using <a href="http://jbake.org/">Jbake</a> and its all published to github (gh-pages). To preview my blog posts while writing I either
had to start a separate browser window (with a AsciiDoc browser plugin) or I had to set up a gradle watch task and
use something like SimpleHttpServer to serve my "baked" site locally.</p>
</div>
<div class="paragraph">
<p>I&#8217;m probably still going to test my site locally, but I really felt a need for something similar to the <a href="https://github.com/MarcoPolo/lt-markdown" class="bare">https://github.com/MarcoPolo/lt-markdown</a>
plugin.</p>
</div>
<div class="quoteblock">
<blockquote>
I wish I had an editor where I could easily program my own extensions.
</blockquote>
<div class="attribution">
&#8212; Magnus Rundberget<br>
<cite>A few years back</cite>
</div>
</div>
<div class="paragraph">
<p>I guess I&#8217;m just lucky, but whacking something together wasn&#8217;t really that hard. I thought I&#8217;d share my experience.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_technology">Technology</h2>
<div class="sectionbody">
<div class="paragraph">
<p>AsciiDoctor comes with JavaScript support through <a href="https://github.com/asciidoctor/asciidoctor.js">asciidoctor.js</a>. It even comes
with support for node. Light Table runs on Node (node webkit, soon Atom Shell ?). Light Table plugins are written in
ClojureScript, I much prefer ClojureScript to JavaScript or CoffeeScript for that matter. Anyways I&#8217;m digressing, calling
node modules from a Light Table is no big deal.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_solution">Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The end result became a new plugin for Light Table. <a href="https://github.com/rundis/AsciiLight">AsciiLight</a></p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2015//asciilight_preview.png" alt="asciilight preview">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I pretty much nicked most of the ClojureScript code from <a href="https://github.com/MarcoPolo/lt-markdown" class="bare">https://github.com/MarcoPolo/lt-markdown</a>. Cheers Marco Polo !
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_calling_asciidoctor_js">Calling asciidoctor.js</h3>
<div class="paragraph">
<p>For reasons unknown to me I had some troubles calling the Objects/functions needed from asciidoctor.js
directly from ClojureScript so I had to make a thing JavaScript wrapper my self. No big deal, but
I&#8217;d be interested to find out why it croaked.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">var asciidoctor = require('asciidoctor.js')();
var processor = asciidoctor.Asciidoctor(true);     <i class="conum" data-value="1"></i><b>(1)</b>
var opal = asciidoctor.Opal;


var doConvert = function(content, baseDir) {
  var opts = opal.hash2(
      ['base-dir', 'safe', 'attributes'],
      {'base-dir': baseDir,
       'safe': 'secure',
        attributes: ['icons=font@', 'showtitle']});

    return  processor.$convert(content, opts);     <i class="conum" data-value="2"></i><b>(2)</b>
};

module.exports = {
  convert: function(content, baseDir) {
    return doConvert(content, baseDir);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Load Node module and configure AsciiDoctor to support extensions</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The function where we actually call asciidoctor</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There was a lot of trial and error to figure out what to call the options and how to pass
these options to asciidoctor. Some seemed to work others seemed to have no effect. To be improved
in a future release for sure. The most painful part here was that I couldn&#8217;t figure out how to reload
my custom node module &#8230;&#8203; hence a lot of Light Table restarts. Surely there must be a better way.</p>
</div>
</div>
<div class="sect2">
<h3 id="_plugin_code">Plugin code</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">defn setAdocHTML! [ed obj]
  (let [html (-&gt;
              (adoc-&gt;html (.getValue (editor/-&gt;cm-ed ed))
                          (files/parent (-&gt; @ed :info :path)))                     <i class="conum" data-value="1"></i><b>(1)</b>
              (s/replace #"class=\"content\"" "class=\"adoc-content\""))]
    (set! (.-innerHTML (object/-&gt;content obj)) html)))                             <i class="conum" data-value="2"></i><b>(2)</b>

(defn get-filename [ed]
  (-&gt; @ed :info :name))

(defui adoc-skeleton [this]
  [:div {:class "adoc"}
   [:h1 "Asciidoc content coming here"]])

(object/object* ::asciilight                                                       <i class="conum" data-value="3"></i><b>(3)</b>
                :tags [:asciilight]
                :name "markdown"
                :behaviors [::on-close-destroy]
                :init (fn [this filename]
                        (object/update! this [:name] (constantly (str filename " - Live")))
                        (adoc-skeleton this)))

(behavior ::on-close-destroy                                                       <i class="conum" data-value="4"></i><b>(4)</b>
          :triggers #{:close}
          :reaction (fn [this]
                      (when-let [ts (:lt.objs.tabs/tabset @this)]
                        (when (= (count (:objs @ts)) 1)
                          (tabs/rem-tabset ts)))
                      (object/raise this :destroy)))

(behavior ::read-editor                                                            <i class="conum" data-value="5"></i><b>(5)</b>
          :triggers [:change ::read-editor]
          :desc "AsciiLight: Read the content inside an editor"
          :reaction (fn [this]
                      (let [adoc-obj (:adoc @this)]
                        (setAdocHTML! this adoc-obj))))

(cmd/command {:command ::watch-editor                                              <i class="conum" data-value="6"></i><b>(6)</b>
              :desc "AsciiLight: Watch this editor for changes"
              :exec (fn []
                      (let [ed (pool/last-active)
                            filename (get-filename ed)
                            adoc-obj (object/create ::asciilight filename)]
                        (tabs/add-or-focus! adoc-obj)
                        (object/update! ed [:adoc] (fn [] adoc-obj))
                        (object/add-behavior! ed ::read-editor)
                        (object/raise ed ::read-editor)))})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retrieve whatever is in the given editor ed and request ascidoctor.js to make nice html from it.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Insert the generated html into the preview viewer</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>An atom that holds the markup used for the preview. Destroyed when its owning tab is closed.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Behavior that is triggered when the tab (or LightTable) is closed. Performs cleanup as one should !</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Behavior that is triggered whenever the user changes the content of the editor being watched. For large documents
we might want to introduce a throttle on this behaviour.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>This i the command you see in the command bar in Light Table. It&#8217;s the entry point for the plugin currently and
is responsible for adding a new tab and setting up the link between the editor to be watched and the preview tab.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s pretty manageable for something quite usable.</p>
</div>
</div>
<div class="sect2">
<h3 id="_behaviors_and_a_note_on_css">Behaviors and a note on CSS</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">[[:app :lt.objs.plugins/load-js "asciilight_compiled.js"]
 [:app :lt.objs.plugins/load-css "css/font-awesome.css"]
 [:app :lt.objs.plugins/load-css "css/adoc.css"]]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we load the transpiled javascript for our plugin, css icon support throught font-awesome and
a slightly customized css for our asciidoc preview.</p>
</div>
<div class="sect3">
<h4 id="_css_the_cascading_part_you_know">CSS, the cascading part you know.</h4>
<div class="paragraph">
<p>AsciiDoc ships with a default CSS you may use (it even has a <a href="https://github.com/asciidoctor/asciidoctor-stylesheet-factory">stylesheet factory</a>)
That&#8217;s cool. Light Table also has styles, hey it even has lots of skins.
So I had to spend some time ensuring that the css I added through the plugin didn&#8217;t mess up the
user selected styles from Light Table. For instance both LIght Table and AsciiDoc found good use for a css class called content.</p>
</div>
<div class="paragraph">
<p>Lost a few hairs (not many left tbh)</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s very early days for this plugin, and it has many snags. But its a decent start considering
I used maybe 6-8 hours in total, most of which was time struggling with css. It just feels
great writing this blogpost with a preview of what I&#8217;m writing using a plugin of my own creation.</p>
</div>
<div class="paragraph">
<p>One itch scratched !</p>
</div>
</div>
</div></p>
  			<a href="/blog/2015/buddy_auth_part2.html"><h1>Securing Clojure Microservices using buddy - Part 2: WebApp authentication and authorization</h1></a>
  			<p>02 February 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/clojure.html">clojure</a>
	      
		      <a href="/blog/tags/buddy.html">buddy</a>
	      
		      <a href="/blog/tags/security.html">security</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Securing Clojure Microservices using buddy - Part 2: WebApp authentication and authorization"
           data-url="http://rundis.github.io/blog/2015/buddy_auth_part2.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In <a href="/blog/2015/buddy_auth_part1.html">Part 1</a> of this blog series we learned how to create tokens that could be used for authentication
and authorization. In this episode we will create a sample web app called <a href="https://github.com/rundis/acme-buddy/tree/master/acme-webstore">acme-webstore</a>.
The acme-webstore will make use of the tokens generated from the <a href="https://github.com/rundis/acme-buddy/tree/master/acme-auth">acme-auth</a> service.
The app will implement a simple login and logout flow and demonstrate how you may employ role based authorization.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_disclaimer">Disclaimer</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There are many concerns to be addressed with regards to securing a web app. Be sure to do proper research
for what your needs and potential risks are. A good starting point might be to check out <a href="https://www.owasp.org/index.php/Category:OWASP_Top_Ten_Project#tab=OWASP_Top_10_for_2013">OWASP</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_buddy_support">Buddy support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Buddy provides support for authentication and authorization of web applications through <a href="https://github.com/funcool/buddy-auth">buddy-auth</a>.
I believe that version 0.3.0 of this lib doesn&#8217;t provide support for key-pair signed jws tokens out of the box.
Buddy auth does provide a flexible mechanism for creating your own backends and it also provides what looks to be
a fairly flexible scheme for authorization.</p>
</div>
<div class="paragraph">
<p>For this episode I chose not to go down that route though. Actually the app won&#8217;t be using buddy-auth at all. We are going to
plunge into the abyss and see how far we get on our own. The end result might be that me or someone else
makes a contribution to buddy-auth to save us from some of the steps here !</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_login">Login</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first thing to implement is a login flow to authenticate our users against the acme-auth service.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2015//acme_login.png" alt="acme login">
</div>
<div class="title">Figure 1. Sample login screen</div>
</div>
<div class="sect2">
<h3 id="_calling_acme_auth">Calling acme-auth</h3>
<div class="paragraph">
<p>To perform the REST calls to acme-auth our app will use the excellent <a href="https://github.com/dakrone/clj-http">clj-http</a> library</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn create-token [req]                                                           <i class="conum" data-value="1"></i><b>(1)</b>
  (http/post "http://localhost:6001/create-auth-token"
             {:content-type :json
              :accept :json
              :throw-exceptions false
              :as :json
              :form-params (select-keys (:params req) [:username :password])}))

(defn do-login [req]
  (let [resp (create-token req)]
    (condp = (:status resp)
      201 (-&gt; (response/redirect (if-let [m (get-in req [:query-params "m"])] m "/dashboard"))    <i class="conum" data-value="2"></i><b>(2)</b>
              (assoc :session {:token (-&gt; resp :body :token)}))                                   <i class="conum" data-value="3"></i><b>(3)</b>
      401 (show-login req ["Invalid username or password"])                                       <i class="conum" data-value="4"></i><b>(4)</b>
      {:status 500 :body "Something went pearshape when trying to authenticate"})))               <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Helper function that invokes acme-auth using clj-http</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The default behaviour is redirecting the user to a dashboard page after successful login, however if a query param "m"
is set it will redirect to the url provided in m. Redirection will be covered explicitly later on.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Upon successful authentication we add the token to the users session. Sessions will also be discussed explicitly later on.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If authentication failed, display the login screen again with an error message</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Lazy error handling&#8230;&#8203;</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Logging out</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn logout [req]
  (assoc (response/redirect "/") :session nil))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Logging out is just a matter of clearing the user session.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rewind_middleware_overview">Rewind: Middleware overview</h3>
<div class="paragraph">
<div class="title">web.clj</div>
<p>Before plunging deeper into the details its useful to get a highlevel view of the various middlewares applied to the
routes in the sample application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defroutes public-routes
  (route/resources "/")
  (GET "/" []       show-index)
  (GET "/login" []  sec/show-login)
  (POST "/login" [] sec/do-login)
  (GET "/logout" [] sec/logout))


(defroutes secured-routes
  (GET "/accounts/:id" [] show-account)
  (GET "/accounts" []     (sec/wrap-restrict-by-roles show-accounts [:store-admin]))   <i class="conum" data-value="1"></i><b>(1)</b>
  (GET "/dashboard" []    show-dashboard))


(defroutes app-routes
  (-&gt; public-routes
      sec/wrap-auth-token)                                                             <i class="conum" data-value="2"></i><b>(2)</b>
  (-&gt; secured-routes
      sec/wrap-authentication                                                          <i class="conum" data-value="3"></i><b>(3)</b>
      sec/wrap-auth-token))                                                            <i class="conum" data-value="4"></i><b>(4)</b>

(def app (-&gt; app-routes
             wrap-keyword-params
             wrap-params
             wrap-absolute-redirects                                                   <i class="conum" data-value="5"></i><b>(5)</b>
             sec/wrap-authorized-redirects                                             <i class="conum" data-value="6"></i><b>(6)</b>
             (sec/wrap-auth-cookie "SoSecret12345678")))                               <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Custom middleware for restricting access based on role(s)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Custom middleware for picking out user info from a users token (if logged in)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Custom middleware to verify that user is authenticated for given route(s)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Duplication, cop out to ensure we have user info both for secured and unsecured routes</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Redirects should really should use absolute urls (most browsers support relative though)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Custom middleware to prevent redirect attacks</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Custom middleware wrapping a ring session using a cookie store. Obviously you wouldn&#8217;t define the cookie secret here !</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_sessions_and_cookies">Sessions and cookies</h3>
<div class="paragraph">
<p>For a single-page web app or a REST client I would probably have been completely feasible using our auth token directly.
However if we have a web app with a nice mix of server side generated html and chunks of client side scripting with ajax,
we need to consider whether/how to use sessions.</p>
</div>
<div class="paragraph">
<p>Out of the box ring comes with session support in two flavours. Sessions based on a memory store or a cookie based store.
In both cases a cookie will be used, but for the in memory store the cookie is only used to uniquely identify the server side cached
data for that user session. When using the cookie store, the users session data is stored in the cookie (encrypted and <a href="http://en.wikipedia.org/wiki/Message_authentication_code">MAC&#8217;ed</a>) which is passed back and
forth between the server and the client.</p>
</div>
<div class="paragraph">
<p>The article <a href="http://www.lispcast.com/clojure-web-security">clojure web security</a> by Eric Normand provides some very valuable insights into session
handling (amoung other things) in Clojure.</p>
</div>
<div class="paragraph">
<p>Regardless of the article just mentioned the Security Architect of Acme corp instructed me to pursue the cookie based session store.
To make matters worse, the Architect insisted on using a long-lived cookie. He went on about the benefits of avoiding
clustered sessions stores, that the usability of the web store would be hopeless with short lived sessions and that surely
there had to be measures to mitigate some of the additional risks involved.</p>
</div>
<div class="paragraph">
<p>Who am I to argue (I&#8217;m no expert by any means) let us see where the cookie store option takes us.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>I suppose one of the biggest risk with the cookie approach is "man in the middle attacks". First mitigating step is to use SSL (and not just partially).
Secondly there is the obvious risk of someone having taken control over the device you used for your logged in session. Maybe you should implement
<a href="http://en.wikipedia.org/wiki/Two_factor_authentication">two factor authentication</a> and require reauthentication for any critical operations ?
Setting a long expiry for both the token and cookie might be far to risky for your scenario, maybe you need to implement something
akin to <a href="http://stackoverflow.com/questions/3487991/why-does-oauth-v2-have-both-access-and-refresh-tokens">oauth refresh tokens</a>.
Also revocation of a token is definitely an interesting scenario we will need to handle in a later blog post !</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enough analysis/paralysis for now, I guess the bottom line is you&#8217;ll need to figure out what is secure enough for you.</p>
</div>
<div class="sect3">
<h4 id="_cookie_store">Cookie store</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn wrap-auth-cookie [handler cookie-secret]
  (-&gt; handler
      (wrap-session
       {:store (cookie-store {:key cookie-secret})  <i class="conum" data-value="1"></i><b>(1)</b>
        :cookie-name "acme"
        :cookie-attrs {:max-age (* 60 60 24)}})))   <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The cookie content (session data ) is encrypted and a MAC signature added. For storing our token this may or may not be overkill. Our token is already MAC&#8217;ed, however it&#8217;s content is possible to extract quite easily as it is.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Only shown setting the max age here, but you definitely should set the :secure attribute to true (and put up something like nginx infront of your app to terminate ssl).</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A big win with the cookie approach is that a server restart is no big deal. The user stays logged in. If you are using staged deploys, no session synchronization is needed.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_unsigning_the_token">Unsigning the token</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn unsign-token [token]
  (jws/unsign token (ks/public-key (io/resource "auth_pubkey.pem")) {:alg :rs256}))     <i class="conum" data-value="1"></i><b>(1)</b>


(defn wrap-auth-token [handler]
  (fn [req]
    (let [user (:user (when-let [token (-&gt; req :session :token)]                        <i class="conum" data-value="2"></i><b>(2)</b>
                   (unsign-token token)))]
      (handler (assoc req :auth-user user)))))                                          <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Unsign the jws token using the public key from acme-auth</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If the user has logged in, the token should be stored in session. Unsign if it exists.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add the user info from the token to an explicit key in the request-map</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_ensuring_that_the_user_is_logged_in_for_a_given_route">Ensuring that the user is logged in for a given route</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn wrap-authentication [handler]
  (fn [req]
    (if (:auth-user req)
      (handler req)
      {:status 302
       :headers {"Location " (str "/login?m=" (:uri req))}})))</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the user hasn&#8217;t logged in, we redirect to the login page. To allow the user to return to the url he/she originally tried
to access, we provide the url as a query param to the login handler.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authorization">Authorization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have implemented login, now lets see how we can implement a simple mechanism for authorizing what a user may or may not
do once authenticated. We&#8217;ll cover role based authorization for now. Your app might require more fine-grained control and
various other mechanisms for authorization.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(def acme-store-roles                                                     <i class="conum" data-value="1"></i><b>(1)</b>
  {:customer 10 :store-admin 11})

(defn any-granted? [req roles]                                            <i class="conum" data-value="2"></i><b>(2)</b>
  (seq
   (clojure.set/intersection
    (set (map :role-id (-&gt; req :auth-user :user-roles)))
    (set (vals (select-keys acme-store-roles roles))))))


(defn wrap-restrict-by-roles [handler roles]                              <i class="conum" data-value="3"></i><b>(3)</b>
  (fn [req]
    (if (any-granted? req roles)
      (handler req)
      {:status 401 :body "You are not authorized for this feature"})))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A hardcoded set of roles we care about in this app</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Function to verify if authed user has any of the roles given</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Middleware for declaratively restricting routes based on role privileges</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_showing_elements_based_on_role_privileges">Showing elements based on role privileges</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn- render-menu [req]
  (let [user (:auth-user req)]
    [:nav.menu
     [:div {:class "collapse navbar-collapse bs-navbar-collapse navbar-inverse"}
      [:ul.nav.navbar-nav
       [:li [:a {:href (if user "/dashboard" "/")} "Home"]]
       (when user
         [:li [:a {:href (str "/accounts/" (:id user))} "My account"]])
       (when <strong>(any-granted? req [:store-admin])</strong>
         [:li [:a {:href "/accounts"} "Account listing"]])]
      [:ul.nav.navbar-nav.navbar-right
       (if user
         [:li [:a {:href "/logout"} "Logout"]]
         [:li [:a {:href "/login"} "Login"]])]]]))</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2015//acme_admin_dash.png" alt="acme admin dash">
</div>
<div class="title">Figure 2. Sample Dashboard screen with the Account listing menu option for admins</div>
</div>
<div class="paragraph">
<p>As you can see, you can easily use the any-granted? function for providing granular restrictions on UI elements.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_preventing_redirect_attacks">Preventing redirect attacks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the login handler we added a feature for redirecting the user to the url he/she tried to access before redirected to the login page.
We don&#8217;t want to open up for redirect attacks so we added a simple middleware to help us prevent that from happening.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Lets say someone sends you a link like this <a href="http://localhost:6002/login?m=http%3A%2F%2Fwww.robyouonline.bot" class="bare">http://localhost:6002/login?m=http%3A%2F%2Fwww.robyouonline.bot</a> You probably don&#8217;t want your users to end up there upon successfully login.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(def redirect-whitelist
  [#"http://localhost:6002/.*"])

(defn wrap-authorized-redirects [handler]
  (fn [req]
    (let [resp (handler req)
          loc (get-in resp [:headers "Location"])]
      (if (and loc (not (some #(re-matches % loc) redirect-whitelist)))
        (do
            ;; (log/warning "Possible redirect attack: " loc)
            (assoc-in resp [:headers "Location"] "/"))
        resp))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Obviously you&#8217;d need to use the proper host and scheme etc once you put a proxy with a proper domain name in front etc.
You get the general idea though.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In part 1 we were creating a backend service for creating auth tokens. In this post you have seen how you could use that
token service to implement authentication and role based authorization in a public facing web app. Long lived tokens are
not without issues, and we have glossed over some big ones. Token revocation is a candidate for a near future blog post, but
before that I&#8217;d like to cover usage of the token in a service application.</p>
</div>
<div class="paragraph">
<p>The next blog post will be about acme-orders and/or acme-catalog.</p>
</div>
</div>
</div></p>
  			<a href="/blog/2015/buddy_auth_part1.html"><h1>Securing Clojure Microservices using buddy - Part 1: Creating Auth Tokens</h1></a>
  			<p>27 January 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/clojure.html">clojure</a>
	      
		      <a href="/blog/tags/buddy.html">buddy</a>
	      
		      <a href="/blog/tags/security.html">security</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Securing Clojure Microservices using buddy - Part 1: Creating Auth Tokens"
           data-url="http://rundis.github.io/blog/2015/buddy_auth_part1.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="sect1">
<h2 id="_disclaimer">Disclaimer</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There is much more to securing web apps and microservices than just authentication and authorization.
This blog series will almost exclusively focus on those two aspects.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s say you have decided to go down the microservices path with Clojure. How would
you go about implementing authentication and authorization for your various apps and services ?</p>
</div>
<div class="paragraph">
<p>In this blog series I&#8217;ll take you through my stumblings through how you might address
some of the concerns. At this point I have no idea how it might turn out, but I&#8217;m pretty
sure I&#8217;ll learn quite a bit along the way.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sample_architecture">Sample architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To illustrate various aspects I&#8217;ll be using the following sample high-level architecture
as a starting point. It&#8217;s just a sketch,  so don&#8217;t get too hung up on the dependency arrows, that might change.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2015//auth_fun.png" alt="auth fun">
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll find the evolving code examples at <a href="https://github.com/rundis/acme-buddy" class="bare">https://github.com/rundis/acme-buddy</a>. A tag will be created
for each blog posting.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_initial_selection_of_technologies">Initial selection of technologies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The most known and used library in clojure for securing your ring webapps is <a href="https://github.com/cemerick/friend">friend</a>.
To my knowledge it&#8217;s a great library, and you should seriously consider using it for your apps as well.</p>
</div>
<div class="paragraph">
<p>A little while back I did a small spike on using friend and <a href="http://clojure-liberator.github.io/liberator/">liberator</a>. Liberator
is a super library for rest enabling your applications/services. I came across the blog post <a href="http://sritchie.github.io/2014/01/17/api-authentication-with-liberator-and-friend/">API Authentication with Liberator and Friend</a>.
I tried to implement something similar but couldn&#8217;t quite get it working and I have to admit I had problems groking what
was actually going on.</p>
</div>
<div class="paragraph">
<p>So for this blog series I decided to start off with something less opinionated. Hopefully that will enable me to understand
more about the concerns involved. In <a href="https://github.com/funcool/buddy">buddy</a> I found an a la carte menu of building blocks
that looked very promising as a starting point.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_token_based_authentication">Token based authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal for this first post is to create a service that allows a caller to authenticate a user by credentials
and receive an authentication token upon successful authentication. That token can then be used by services and apps
to authenticate and authorize requests for the duration of defined lifespan for the token. The service
will be implemented in the acme-auth service app.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="http://stackoverflow.com/questions/1592534/what-is-token-based-authentication">What is token based authentication ?</a>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_database">Database</h3>
<div class="paragraph">
<p>For this sample app we&#8217;ll use a plain old boring rdbms. The schema will be as follows.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2015//acme_user_db.png" alt="acme user db">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_password_hashing">Password hashing</h3>
<div class="paragraph">
<p>We need to store our passwords securely hashed in the user table. Buddy provides <a href="https://github.com/funcool/buddy-hashers">buddy-hashers</a>.</p>
</div>
<div class="listingblock">
<div class="title">Adding a user</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(ns acme-auth.service
  (:require [buddy.hashers :as hs]
            [acme-auth.store :as store]))

(defn add-user! [ds user]
  (store/add-user! ds (update-in user [:password] #(hs/encrypt %))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>hs/encrypt - Hashes the password using bcrypt+sha512 (default, others available). Buddy generates a
random <a href="http://en.wikipedia.org/wiki/Salt_%28cryptography%29">salt</a> if you don&#8217;t provide one as an option param.</p>
</div>
<div class="listingblock">
<div class="title">Sample hash</div>
<div class="content">
<pre><sup>1</sup>bcrypt+sha512$<sup>2</sup>32da7e602406d818c6768194$<sup>3</sup>12$<sup>4</sup>243261243132246c32674a576d514c75585255434f64444f4c59414b653843357a4e645547397279616c304a696f525656393166434862347a2e564b</pre>
</div>
</div>
<div class="paragraph">
<p>The password hash we store to the database consists of 4 parts concatinated with $.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Algorithm</p>
</li>
<li>
<p>Salt       - In our case the randomly generated by buddy</p>
</li>
<li>
<p>Iterations - Number of iterations used for hashing the pwd</p>
</li>
<li>
<p>Encrypted password hash</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Authenticating a user</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn auth-user [ds credentials]
  (let [user (store/find-user ds (:username credentials))
        unauthed [false {:message "Invalid username or password"}]]
    (if user
      (if (hs/check (:password credentials) (:password user))            <i class="conum" data-value="1"></i><b>(1)</b>
        [true {:user (dissoc user :password)}]                           <i class="conum" data-value="2"></i><b>(2)</b>
        unauthed)
      unauthed)))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Verify provided plain text password credential against the hashed password in the db</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You probably don&#8217;t want to ship the password in the token !</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Bcrypt is intentionally relatively slow. It&#8217;s a measure to help prevent brute force attacks.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_creating_a_signed_token">Creating a signed token</h3>
<div class="paragraph">
<p>With the user store in place we can turn our attention to creating our (signed) token. Buddy provides us with <a href="https://github.com/funcool/buddy-sign">buddy-sign</a>.
We could have opted for a <a href="http://en.wikipedia.org/wiki/Hash-based_message_authentication_code">HMAC</a> based algorithm,
but we&#8217;ll take it up one notch and use an algorithm that requires a public/private key-pair.
Not only that, but we&#8217;ll serialize our token content in a json format following the <a href="https://tools.ietf.org/html/draft-ietf-jose-json-web-signature-41">jws</a>
draft spec.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/rundis/acme-buddy/tree/master/acme-auth">acme-auth</a> will own the private key and use that for signing
whilst the other apps will have the public key for unsigning the token.</p>
</div>
<div class="sect3">
<h4 id="_creating_a_key_pair">Creating a key-pair</h4>
<div class="paragraph">
<p>You&#8217;ll be asked to enter a passphrase in both steps below. Keep it safe !</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">openssl genrsa -aes128 -out auth_privkey.pem 2048</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You should probably use something stronger than -aes128. You&#8217;ll need to fiddle with your JVM, but might be worth it
unless it&#8217;s important for you that your government agencies have access to decrypting your token signatures.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">openssl rsa -pubout -in auth_privkey.pem -out auth_pubkey.pem</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_signing">Signing</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(ns acme-auth.service
  (:require [buddy.sign.generic :as sign]
            [buddy.sign.jws :as jws]
            [buddy.core.keys :as ks]
            [clj-time.core :as t]
            [clojure.java.io :as io]))


(defn- pkey [auth-conf]                                             <i class="conum" data-value="1"></i><b>(1)</b>
  (ks/private-key
   (io/resource (:privkey auth-conf))
   (:passphrase auth-conf)))

(defn create-auth-token [ds auth-conf credentials]
  (let [[ok? res] (auth-user ds credentials)
        exp (-&gt; (t/plus (t/now) (t/days 1)) (jws/to-timestamp))]   <i class="conum" data-value="2"></i><b>(2)</b>
    (if ok?
      [true {:token (jws/sign res                                  <i class="conum" data-value="3"></i><b>(3)</b>
                              (pkey auth-conf)
                              {:alg :rs256 :exp exp})}]
      [false res])))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Helper function to read the private key we generated above</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Sets a timestamp for when the token expires</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creates a signed token</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">The token consists of 3 parts concatenated using "."</div>
<ul>
<li>
<p>Base64 encoded string with header data (algorithm and other optional headers you might have set)</p>
</li>
<li>
<p>Base64 encoded json string with your message (claims in jws speak). Expiry ie. :exp is also a claim btw.</p>
</li>
<li>
<p>Base64 encoded MAC (Message Authentication Code) signature for our message (header + claims)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With that knowledge in mind, you see why it might be a good idea to leave the password out of the token (even though it would have been the hashed pwd we&#8217;re talking about).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exposing_our_service">Exposing our service</h3>
<div class="listingblock">
<div class="title">handler</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn create-auth-token [req]
  (let [[ok? res] (service/create-auth-token (:datasource req)
                                           (:auth-conf req)
                                           (:params req))]
    (if ok?
      {:status 201 :body res}
      {:status 401 :body res})))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Ring / Compojure wrap-up</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defroutes app-routes
  (POST "/create-auth-token" [] handlers/create-auth-token))


(defn wrap-datasource [handler]
  (fn [req]
      (handler (assoc req :datasource (get-ds)))))

(defn wrap-config [handler]
  (fn [req]
    (handler (assoc req :auth-conf {:privkey "auth_privkey.pem"
                                    :passphrase "secret-key"}))))

(def app
  (-&gt; app-routes
      wrap-datasource
      wrap-config
      wrap-keyword-params
      wrap-json-params
      wrap-json-response))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_invoking">Invoking</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">curl -i -X POST -d '{"username": "test", "password":"secret"}' -H "Content-type: application/json" http://localhost:6001/create-auth-token</code></pre>
</div>
</div>
<div class="paragraph">
<p>Would yield something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{"token":"eyJ0eXAiOiJKV1MiLCJhbGciOiJSUzI1NiJ9.eyJ1c2VyIjp7InVzZXItcm9sZXMiOlt7InJvbGUtaWQiOjEwLCJhcHBsaWNhdGlvbi1pZCI6MTB9LHsicm9sZS1pZCI6MTEsImFwcGxpY2F0aW9uLWlkIjoxMH1dLCJ1c2VybmFtZSI6InRlc3QiLCJpZCI6MX0sImV4cCI6MTQyMjMxNDk3MH0.bKB3fh2CcPWqP85CK18U_IITxkRce8Xuj8fZGvhqjAaq1dWeiDMKOAGfSlg6GGJi-CrRepMaLOEfAVN23R7yoYb543wgm1Tv_pOYuNQ02tYRQMRJXSxVKS1m9zMEWlszLVet8Q3kfrLBaOxjdvjSp8exjsPeOcfCaqdcXPn9mwWSz0X8k1iaLbnY2fRL0mWbbG8rz4bSUSE0KX0xnKH3LqrtJcZE3BDHSr7tVqaxcHaFt4ivRpk3EYBzMtwRSCQ4jwAMibsh1XhvJMo4QeDwil-et70qJMV5XCJOsAr3SF4FVlNeUsNx2Aj1lORGIN7c8xKq-MDaTaGYV2O7L_0mGA"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unsigning the token is quite similar to the signing. However when unsigning you must have the
public key we generated earlier.</p>
</div>
<div class="paragraph">
<p>For the token above, the claims part of the message would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{"user":{"user-roles":[{"role-id":10,"application-id":10},
                       {"role-id":11,"application-id":10}],
         "username":"test",
         "id":1},
 "exp":1422314970}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have created a small clojure app with a user database and a rest service that authenticates a
user and returns a signed token with information about the user and his/her role+app/service authorizations.
We&#8217;ve briefly covered password hashing and message signing using buddy.</p>
</div>
<div class="paragraph">
<p>The auth-token service will serve as a building block for the next step. How do we make use of token
for authentication and authorization purposes in the acme-webstore ? That&#8217;s the topic of my next blog
post in this series. Stay tuned !</p>
</div>
</div>
</div></p>
  			<a href="/blog/2015/gr_lt_status_jan2015.html"><h1>A Groovy Light Table client - Not dead (yet)</h1></a>
  			<p>25 January 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      
		      <a href="/blog/tags/groovy.html">groovy</a>
	      
		      <a href="/blog/tags/gradle.html">gradle</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="A Groovy Light Table client - Not dead (yet)"
           data-url="http://rundis.github.io/blog/2015/gr_lt_status_jan2015.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="sect1">
<h2 id="_background">Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In 2014 I blogged about the process of evolving a groovy(/gradle) plugin for Light Table from scratch.</p>
</div>
<div class="ulist">
<div class="title">Posts so far:</div>
<ul>
<li>
<p><a href="/blog/2014/gr_lt_part1.html">A Groovy Light Table client - Step 1: Connecting the client</a></p>
</li>
<li>
<p><a href="/blog/2014/gr_lt_part2.html">A Groovy Light Table client - Step 2: Evaluating Code</a></p>
</li>
<li>
<p><a href="/blog/2014/gr_lt_part3.html">A Groovy Light Table client - Step 3: Running out of quick wins</a></p>
</li>
<li>
<p><a href="/blog/2014/gr_lt_part4.html">A Groovy Light Table client - Step 4: Exploring new avenues with Gradle</a></p>
</li>
<li>
<p><a href="/blog/2014/gr_lt_part5.html">A Groovy Light Table client - Step 5: Gradle dependencies in Light Table with dagre-D3</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I even did a <a href="/blog/2014/groovy_repl.html">screen cast</a> showing off some of the features so far.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_so_what_happened">So what happened ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After the summer holidays my Open Source mojo was drained, I needed a break and I went into uphill cycling mode.</p>
</div>
<div class="sect2">
<h3 id="_light_table_doubts">Light Table doubts</h3>
<div class="paragraph">
<p>First of all. I haven&#8217;t given up on Light Table I somehow even feel strongly obliged to hang in there longer
than most people given that I&#8217;ve contributed. I still use Light Table, actually more than ever because I&#8217;m currently
hacking on a clojure/clojurescript project.</p>
</div>
<div class="paragraph">
<p>In October the founder of Light Table annouced Eve and released this <a href="http://www.chris-granger.com/2014/10/01/beyond-light-table/">blog post</a>
Obviously there was initial fears that this would be the end of Light Table. However 3 of the most active contributors
to Light Table stepped up. There was a lot of visible activity initially (proper spring cleaning of the issues log).
However visible activity from Light Table has been in steady decline and the last release was 21. november of last year.</p>
</div>
<div class="paragraph">
<p>I believe they are working on moving from node-webkit to atom shell, the layout system is being revised. There is also a hack night planned
in a few days time.</p>
</div>
<div class="paragraph">
<p>I guess I just wished someone stepped up and outlined a clear road-map for Light Table and that
a steady stream of releases towards a version 1.0 started coming out :)</p>
</div>
</div>
<div class="sect2">
<h3 id="_possibilites_for_further_developments">Possibilites for further developments</h3>
<div class="paragraph">
<p>Great things are happening with gradle I believe in terms of performance and also in terms of whats possible
to achieve with the Tooling API. This opens up a whole range of oportunities to provide IDE support for languages that gradle supports.</p>
</div>
<div class="paragraph">
<p>The groovy and gradle parts of the currenty groovy plugin should probably be split with a generic gradle
plugin and specific language plugins (scala, java&#8230;&#8203;) depending on that.</p>
</div>
<div class="ulist">
<div class="title">How about things like ?:</div>
<ul>
<li>
<p>Continuous unit testing - utilizing gradle builds incremental nature and the coming watcher tasks.
Couple that with showing results inline in Light Table</p>
</li>
<li>
<p>Compilation - Same story here, show compilation errors inline</p>
</li>
<li>
<p>run webapp - Run apropriate gradle task to start your webapp and fire up a browser window inline in lighttable
, maybe even hook it up with a browser debug/repl connection</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_help_needed">Help needed</h3>
<div class="paragraph">
<p>I&#8217;d love to hear if anyone has actually used the plugin and if so which parts of it.</p>
</div>
<div class="paragraph">
<p>I&#8217;m currently fully engaged in a clojure/clojurescript project, which takes all of my day time and quite a few evenings.
It puts me in a better shape to contribute to Light Table, but currently leaves me little time to do so.</p>
</div>
<div class="olist arabic">
<div class="title">That might change though, but I guess I need 2 things to happen before I pick up work on this plugin:</div>
<ol class="arabic">
<li>
<p>Some visible progress from Light Table to show that it&#8217;s intending to survive</p>
</li>
<li>
<p>Hopefully someone feels inspired to help contribute progressing the plugin (pull requests are welcome)</p>
</li>
</ol>
</div>
</div>
</div>
</div></p>
  			<a href="/blog/2015/bootify-ring.html"><h1>Bootifying my ring app</h1></a>
  			<p>19 January 2015</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/clojure.html">clojure</a>
	      
		      <a href="/blog/tags/boot.clj.html">boot.clj</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Bootifying my ring app"
           data-url="http://rundis.github.io/blog/2015/bootify-ring.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="sect1">
<h2 id="_a_little_background">A little background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A few weeks back I noticed a tweet about <a href="https://github.com/boot-clj/boot">boot-clj</a>. This weekend I finally had some time to look into whether it could
be a viable alternative to <a href="https://github.com/technomancy/leiningen">Leiningen</a> for our apps or not.
We have a couple of ring based apps running as uberjars, so I decided to try to make a boot build for one of the projects. For the purpose of this blogpost however
I&#8217;ve created a sample app. Source available on <a href="https://github.com/rundis/boot-sample">github</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_bother_with_an_alternative_when_there_is_leiningen">Why bother with an alternative when there is Leiningen ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I haven&#8217;t been in the clojuresphere all that long.
I do have a history as java and groovy developer and have been through a history of using <a href="http://ant.apache.org/">ant</a>,
<a href="http://maven.apache.org/">maven</a> and lately <a href="https://www.gradle.org/">gradle</a> for my builds.
In terms of development experience Leiningen is definately a step up from all of them. However I feel Leiningen has left me longing
as soon as my builds have become a bit more elaborate (testing javascript, transpiling, create artifacts, upload to repo, run migrations
deploy to different environments etc). I&#8217;m sure all of this is achievable with Lein, but is it really architected to excel for that purpose ?
TBH I&#8217;d love to see gradle get some serious clojure love, but it doesn&#8217;t seem to be coming anytime soon. Maybe boot will be my next build tooling love :)</p>
</div>
<div class="ulist">
<div class="title">Reading up a bit on boot checked a few boxes for some of my longings though:</div>
<ul>
<li>
<p>Your build doesn&#8217;t have to be all declarative</p>
</li>
<li>
<p>Sensible abstractions and libraries to allow you to compose and extend your build using the full power of clojure</p>
</li>
<li>
<p>Compose build pipelines somewhat similar to how you would compose middlewares in ring</p>
</li>
<li>
<p>Task is the fundamental building block</p>
</li>
<li>
<p>Tasks typically works on immutable filesets (files treated as values, you never touch the filesystem directly yourself !)</p>
</li>
<li>
<p>Possibility of complete classpath isolation at task level</p>
</li>
<li>
<p>Great repl and commandline support.</p>
</li>
<li>
<p>&#8230;&#8203; and surely a lots more</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lein_boot">Lein &#8594; Boot</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_leningen_project">Leningen project</h3>
<div class="paragraph">
<p>project.clj</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defproject boot-sample "0.1.0"
  :description "Boot sample application"
  :url "https://github.com/rundis/boot-sample"
  :min-lein-version "2.0.0"
  :dependencies [[org.clojure/clojure "1.6.0"]
                 [compojure "1.2.1"]
                 [liberator "0.12.2"]
                 [ring/ring-jetty-adapter "1.3.1"]
                 [ring/ring-json "0.3.1"]
                 [bouncer "0.3.1"]
                 [io.aviso/pretty "0.1.14"]]
  :ring {:handler boot-sample.core/app                       <b class="conum">(1)</b>
         :port 3360}
  :profiles {:dev {:plugins [[lein-ring "0.8.13"]]
                   :test-paths ^:replace []}
             :test {:dependencies [[midje "1.6.3"]]
                    :plugins [[lein-midje "3.1.3"]]
                    :test-paths ["test"]
                    :resource-paths ["test/resources"]}})</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The entry point for my ring app</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The above project is a really simple project definition. To run my app I just have to execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">lein ring uberjar
java -jar target/boot-sample-0.1.0-standalone.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>core.clj</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(ns boot-sample.core
  (:require [ring.middleware.params :refer [wrap-params]]
            [ring.middleware.keyword-params :refer [wrap-keyword-params]]
            [ring.middleware.json :refer [wrap-json-params]]
            [compojure.core :refer [defroutes ANY GET]]
            [liberator.core :refer [defresource resource]]))

(defn index-handler [req]
  "Hello Boot sample (or maybe Lein still)")

(defresource booters
  :available-media-types       ["application/json"]
  :allowed-methods             [:get]
  :handle-ok                   (fn [ctx] [{:id "Pod1"} {:id "Pod 2"}]))

(defroutes app-routes
  (ANY "/" [] index-handler)
  (ANY "/booters" [] booters))


(def app (-&gt; app-routes
             wrap-keyword-params
             wrap-json-params
             wrap-params))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hey. Hang on. There is no main method here, how can the java -jar command work without one ?
Well, because the ring plugin creates one for us.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">cat target classes/boot_sample/core/main.clj</code></pre>
</div>
</div>
<div class="paragraph">
<p>gives us</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(do
  (clojure.core/ns boot-sample.core.main
   (:require ring.server.leiningen)
                   (:gen-class))
  (clojure.core/defn -main []
    (ring.server.leiningen/serve
     (quote {:ring {:auto-reload? false,
                    :stacktraces? false,
                    :open-browser? false,
                    :port 3360,
                    :handler boot-sample.core/app}}))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s useful to know in case boot-clj doesn&#8217;t happen to have a ring task that does something similar.</p>
</div>
</div>
<div class="sect2">
<h3 id="_boot_me_up">Boot me up</h3>
<div class="paragraph">
<p>Boot comes with a range of predefined tasks that I can compose to get quite close to the Leiningen build above.
I&#8217;ll focus on getting that uberjar up and running.</p>
</div>
<div class="paragraph">
<p>I could have done it all on the command line or in the boot repl, but lets just be a little declarative (still functions don&#8217;t worry!).</p>
</div>
<div class="paragraph">
<p>build.boot</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(set-env!
 :resource-paths #{"src"}                                <b class="conum">(1)</b>
 :dependencies '[[org.clojure/clojure "1.6.0"]
                 [compojure "1.2.1"]
                 [liberator "0.12.2"]
                 [ring/ring-jetty-adapter "1.3.1"]
                 [ring/ring-json "0.3.1"]
                 [bouncer "0.3.1"]
                 [io.aviso/pretty "0.1.14"]])

(task-options!
 pom {:project 'boot-Sample
      :version "0.1.0"}
 aot {:namespace '#{boot-sample.core}}                  <b class="conum">(2)</b>
 jar {:main 'boot_sample.core                           <b class="conum">(3)</b>
      :manifest {"Description" "Sample boot app"
                 "Url" "https://github.com/rundis/boot-sample"}})


(deftask build
  "Build uberjar"
  []
  (comp (aot) (pom) (uber) (jar)))</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>To bundle your sources in the output jar, you have to specify src as a resource-path. A small gotcha there.</p>
</li>
<li>
<p>We need to aot our core.clj namespace so that java -jar can invoke it&#8217;s main method</p>
</li>
<li>
<p>We need to help java -jar with the location of our main class in the jar</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>However you might remember from above that there is no main method in core.clj.
So the last piece of the puzzle is to add one. It&#8217;t not that hard.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(ns boot-sample.core
  (:require [ring.middleware.params :refer [wrap-params]]
            [ring.middleware.keyword-params :refer [wrap-keyword-params]]
            [ring.middleware.json :refer [wrap-json-params]]
            [compojure.core :refer [defroutes ANY GET]]
            [liberator.core :refer [defresource resource]]
            [ring.adapter.jetty :as jetty])                                <b class="conum">(1)</b>
  (:gen-class))                                                            <b class="conum">(2)</b>


;; ... the other stuff

(defn -main []
  (jetty/run-jetty app {:port 3360}))                                     <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Using the jetty ring adapter</p>
</li>
<li>
<p>The :gen-class directive generates the necessary stuff for our main method to be invokable from java
during aot compilation</p>
</li>
<li>
<p>Fire away</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>At the time of writing there was a regression in boot that caused aot to fail.
I needed to build boot from source, should be fixed in the next release though.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">git clone git@github.com:boot-clj/boot.git
cd boot/boot/core
lein install</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now all is set to try it out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">boot build
java -jar target/boot-sample-0.1.0.jar</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_all_is_well_then">All is well then ?</h3>
<div class="paragraph">
<p>Unfortunately not quite. For uberjar projects it seems boot-clj at the time of writing has some serious
performance challenges.</p>
</div>
<div class="ulist">
<div class="title">On my machine generating the uberjar takes:</div>
<ul>
<li>
<p>Leiningen : 12 seconds</p>
</li>
<li>
<p>boot-clj  : 46 seconds !</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It&#8217;s not like Leiningen is lightning fast in the first place. But for this scenario boot just doesn&#8217;t cut it.
I reported an <a href="https://github.com/boot-clj/boot/issues/94">issue</a> and got prompt responses from the developers
which can only be a good sign.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_concluding_remarks">Concluding remarks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>My initial question of whether or not I feel we could use boot for our current projects gets a thumbs down for now.</p>
</div>
<div class="paragraph">
<p>I think boot-clj carries a lot of promise and have some really great ideas. It&#8217;s going to be interesting to
see if boot-clj becomes a viable alternative to leiningen. I suppose a porting and/or interop story with lein
and lein plugins might be needed in addition to maturing both the model and obviously its performance characteristics.</p>
</div>
<div class="paragraph">
<p>I&#8217;m certainly keen on trying it out more. I might try out the clojurescript support next and maybe churn out some custom tasks
just for fun.</p>
</div>
</div>
</div></p>
  			<a href="/blog/2014/gr_lt_part5.html"><h1>A Groovy Light Table client - Step 5: Gradle dependencies in Light Table with dagre-D3</h1></a>
  			<p>18 June 2014</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      
		      <a href="/blog/tags/groovy.html">groovy</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      
		      <a href="/blog/tags/gradle.html">gradle</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="A Groovy Light Table client - Step 5: Gradle dependencies in Light Table with dagre-D3"
           data-url="http://rundis.github.io/blog/2014/gr_lt_part5.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="sect1">
<h2 id="_background">Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is the fifth post in my series "A Groovy Light Table client". A blog series about steps I take when trying to build a Groovy plugin for Light Table.</p>
</div>
<div class="sect2">
<h3 id="_tapping_more_into_the_potential_of_light_table">Tapping more into the Potential of Light Table</h3>
<div class="paragraph">
<p>So far the Groovy Light Table plugin hasn&#8217;t really showcased the real power of the Light Table Editor. What feature could showcase more of Light Table and at the same time prove useful in many scenarios ? For most projects I have worked on, the number of dependencies and their relationships have usually been non trivial. A couple of years back I wrote a post about showing gradle dependencies as a graphwiz png. Wouldn&#8217;t it be cool if I could show my gradle dependencies  inline in Light Table ? It would be even cooler if the graph was interactive and provided more/different value than the default dependency reporting you got from Gradle itself</p>
</div>
</div>
<div class="sect2">
<h3 id="_dagre_d3">dagre-D3</h3>
<div class="paragraph">
<p>So what library should I choose for laying out my planned dependency diagram ? My first instinct was something related to D3. However laying out a dot-graph sensibly on my own didn&#8217;t seem like a challenge I was quite up to. Luckily I found dagre-D3 and it looked to be just the thing I needed.  Of course I would have loved to have found something more clojurish and ideally something that supported an immediate mode ui (akin to Facebook React, but for graphing).  Maybe I didn&#8217;t look long or well enough but I couldn&#8217;t find anything obvious so I settled for <a href="https://github.com/cpettitt/dagre-d3">dagre-D3</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_gradle_dependencies">Gradle dependencies</h3>
<div class="paragraph">
<p>The second challenge I faced before even getting started was: How would I go about retrieving rich dependency information for my gradle projects using the tooling-api ? The information about dependencies default provided through the tooling api is fairly limited and wouldn&#8217;t have produced a very informative graph at all. Luckily I found through dialog with the Gradle guys that it should be possible to achieve what I wanted through a custom gradle model.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_it_s_all_about_the_data">It&#8217;s all about the data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When I initially started developing the custom gradle model for retrieving dependency information I designed a data structure that resembled the dependency modelling in Gradle. However after prototyping with dagre and later trying to display multi project dependency graphs I decided to change the design. I ended up with a data structure more similar to that of a graph with nodes and edges.</p>
</div>
<div class="sect2">
<h3 id="_custom_gradle_model">Custom Gradle Model</h3>
<div class="paragraph">
<p>To create a Custom Gradle Model you need to create a Gradle Plugin. My plugin got the very informative name "Generic Gradle Model" (naming is hard!).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class GenericGradleModelPlugin implements Plugin {
    final ToolingModelBuilderRegistry registry;

    @Inject
    public GenericGradleModelPlugin(ToolingModelBuilderRegistry registry) {
        this.registry = registry;
    }

    @Override
    void apply(Project project) {
        registry.register(new CustomToolingModelBuilder())
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The important bit above is registering my custom tooling builder to make it available to the tooling api !</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">private static class CustomToolingModelBuilder implements ToolingModelBuilder {

// .. other private methods left out for brevity

Map confDiGraph(Configuration conf) {
  def nodeTree = conf.allDependencies
    .findAll {it instanceof ProjectDependency}
    .collect {getProjectDepInfo(it as ProjectDependency)} +
    conf.resolvedConfiguration
        .firstLevelModuleDependencies
        .collect { getDependencyInfo(it) }

    def nodes = nodeTree.collect {collectNodeEntry(it)}.flatten().unique {nodeId(it)}
    def edges = nodeTree.collect {
      collectEdge(conf.name, it)
    }.flatten().unique()

    [nodes: nodes, edges: edges]
  }

  Map projectDeps(Project project) {
    [
      name: project.name,
      group: project.group,
      version: project.version,
      configurations: project.configurations.collectEntries{Configuration conf -&gt;
          [conf.name, confDiGraph(conf)]
      }
    ]
  }

  public boolean canBuild(String modelName) {
    modelName.equals(GenericModel.class.getName())
  }

  public Object buildAll(String modelName, Project project) {
    new DefaultGenericModel(
      rootDependencies: projectDeps(project),
      subprojectDependencies: project.subprojects.collect {projectDeps(it)}
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The custom tooling model builder harvests information about all dependencies for all defined configurations in the project. If the project is a multi-project It will collect the same information for each subproject in addition to collect information about interdependencies between the sub projects.</p>
</div>
</div>
<div class="sect2">
<h3 id="_applying_the_plugin_to_gradle_projects_we_connect_to">Applying the plugin to gradle projects we connect to</h3>
<div class="paragraph">
<p>Before we can retrieve our custom gradle model, we need to apply the plugin to the project in question. I could ask the users to do it themselves, but that wouldn&#8217;t be particularly user friendly.
Luckily Gradle provides init scripts that you can apply to projects and the tooling api supports doing so. Init scripts allows you to do&#8230;&#8203; well &#8230;&#8203; init stuff for your projects. Applying a plugin from the outside falls into that category.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">initscript {
  repositories {
    maven { url 'http://dl.bintray.com/rundis/maven' }
  }
  dependencies { classpath "no.rundis.gradle:generic-gradle-model:0.0.2" }
}

allprojects {
  apply plugin: org.gradle.tooling.model.generic.GenericGradleModelPlugin
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_the_model">Retrieving the model</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def genericModel = con.action(new GetGenericModelAction())
                            .withArguments("--init-script", new File("lib/lt-project-init.gradle").absolutePath)
                            .addProgressListener(listener)
                            .run()

private static class GetGenericModelAction implements Serializable, BuildAction {
  @Override
  GenericModel execute(BuildController controller) {
    controller.getModel(GenericModel)
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To retrieve the model we use a custom build action and applies the plugin implementing the custom model using the --init-script command line argument for gradle.</p>
</div>
<div class="paragraph">
<p>Voila we have the data we need and we return the dependency info (async) after you have connected to a gradle project.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_show_me_a_graph">Show me a graph</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The dependency graph and associated logic was separated out to a separate namespace (graph.cljs).
We&#8217;ll quickly run through some of the highlights of the LightTable clojurescript parts for displaying the dependency graph.</p>
</div>
<div class="sect2">
<h3 id="_graph_object">Graph object</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defui dependency-graph-ui [this]
  [:div.graph
   [:div.dependency-graph
    [:svg:svg {:width "650" :height "680"}
     [:svg:g {:transform "translate(20,20)"}]]]])

(object/object* ::dependency-graph
                :tags [:graph.dependency]
                :name "Dependency graph"
                :init (fn [this]
                        (load/js (files/join plugin-dir "js/d3.v3.min.js") :sync)
                        (load/js (files/join plugin-dir "js/dagre-d3.js") :sync)
                        (let [content (dependency-graph-ui this)]
                          content)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first step was to create and object that represents the view (and is able to hold the dependency data). The init method is responsible for loading the required graphing libs and then it creates the initial placeholder markup for the graph.</p>
</div>
</div>
<div class="sect2">
<h3 id="_some_behaviours">Some behaviours</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::on-dependencies-loaded
          :desc "Gradle dependencies loaded for selected project"
          :triggers #{:graph.set.dependencies}
          :reaction (fn [this rootDeps subDeps]
                      (object/merge! this {:rootDeps rootDeps
                                           :subDeps subDeps})))


(behavior ::on-show-dependencies
          :desc "Show dependency graph"
          :triggers #{:graph.show.dependencies}
          :reaction (fn [this root-deps]
                      (tabs/add-or-focus! dependency-graph)
                      (default-display this)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first behavior is triggered when the groovy backend has finished retrieving the project info, and more specifically the dependencies. If the project is a single project only the rootDeps will contain data.</p>
</div>
<div class="paragraph">
<p>The second behavior is triggered (by a command) when the user wishes to view the dependency graph for a connected gradle project.</p>
</div>
</div>
<div class="sect2">
<h3 id="_render_multiproject_graph_hightlighs">Render Multiproject graph Hightlighs</h3>
<div class="paragraph">
<p>For multi projects the plugin renders an overview graph where you can see the interdependencies between you sub projects.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn create-multiproject-graph [this]
  (let [g (new dagreD3/Digraph)]
    (doseq [x (:nodes (multi-proj-deps this))]
      (.addNode g (dep-id x) #js {:label (str "&lt;div class='graph-label clickable' data-proj-name='"
                                              (:name x) "' title='"
                                              (dep-id x) "'&gt;"
                                              (:name x) "&lt;br/&gt;"
                                              (:version x)
                                              "&lt;/div&gt;")}))
    (doseq [x (:edges (multi-proj-deps this))]
      (.addEdge g nil (:a x) (:b x) #js {:label ""}))
    g))

(defn render-multi-deps [this]
  (let [renderer (new dagreD3/Renderer)
        g (dom/$ :g (:content @this))
        svg (dom/$ :svg (:content @this))
        layout (.run renderer (create-multiproject-graph this) (d3-sel g))
        dim (dimensions this)]
    (unbind-select-project this)
    (bind-select-project this)
    (.attr (d3-sel svg) "width" (+ (:w dim) 20))
    (.attr (d3-sel svg) "height" (+ (:h dim) 20))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first function shows how we use dagre-D3 to create a logical dot graph representation. We basically add nodes and edges (dep&#8594;dep). Most of the code is related to what&#8217;s rendered inside each node.</p>
</div>
<div class="paragraph">
<p>The second function shows how we actually layout and display the graph.  In addition we bind click handlers to our custom divs inside the nodes. The click handlers allows for drill down into a detailed graph about each dependency configuration.</p>
</div>
</div>
<div class="sect2">
<h3 id="_end_results">End results</h3>
<div class="imageblock">
<div class="content">
<img src="/blog/2014//ratpack_multi.png" alt="ratpack multi">
</div>
<div class="title">Figure 1. Multiproject sample : Ratpack</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2014//ratpack_reactor.png" alt="ratpack reactor">
</div>
<div class="title">Figure 2. Project configuration dependencies</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I think we achieved some pretty cool things. Maybe not a feature that you need everyday, but its certainly useful to get an overview of your project dependencies. For troubleshooting transitive dependency issues and resolution conflicts etc you might need more details though.</p>
</div>
<div class="paragraph">
<p>We have certainly showcased that you can do some really cool things with Light Table that you probably wouldn&#8217;t typically do (easily) with a lot of other editors and IDE&#8217;s. We have also dug deeper into the gradle tooling api. The gradle tooling api when maturing even more will provide some really cool new options for  JVM IDE integrations. A smart move by gradleware that opens up for integrations from a range of editors, IDE&#8217;s and specialised tools and applications.</p>
</div>
<div class="paragraph">
<p>The end result of the dependency graph integration became the largest chunk of the 0.0.6 release.</p>
</div>
</div>
</div></p>
  			<a href="/blog/2014/gr_lt_part4.html"><h1>A Groovy Light Table client - Step 4: Exploring new avenues with Gradle</h1></a>
  			<p>26 May 2014</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      
		      <a href="/blog/tags/groovy.html">groovy</a>
	      
		      <a href="/blog/tags/gradle.html">gradle</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="A Groovy Light Table client - Step 4: Exploring new avenues with Gradle"
           data-url="http://rundis.github.io/blog/2014/gr_lt_part4.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="sect1">
<h2 id="_background">Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is the fourth post in my series "A Groovy Light Table client". A blog series about steps I take when trying to build a Groovy plugin for Light Table.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_initial_ponderings">Initial ponderings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Gradle ships with a Tooling API that makes it fairly easily to integrate with your Gradle projects. Initially I thought that Gradle integration should be a separate plugin that other jvm language plugins could depend on, starting with the Groovy plugin. However after much deliberation I decided to start out with bundling the gradle integration with the Groovy plugin. There is certainly a degree of selecting the easy option to that decision. However I still consider the integration exploratory and I&#8217;m not sure how it will pan out. I&#8217;ve settled for a strategy of keeping it logically fairly separate, with a mind to separating gradle specifics out to its own plugin when things become clearer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_classpath_integration_for_groovy_repl">Classpath Integration for Groovy "REPL"</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In part 3 I talked about some REPL like features where variables that result in bindings are stored in a editor session and used as input to the next evaluation. Since then I&#8217;ve also added the feature of caching method definitions (albeit as closures so I&#8217;m sure there are gotchas to that approach as well).</p>
</div>
<div class="paragraph">
<p>Anyways wouldn&#8217;t it be nice If I could also explore my project classes and my projects third party library dependencies in a REPL like fashion ? Hence the idea of providing a Gradle integration. With the Tooling API I should be able to retrieve a class path. So this is where i started.
Before anyone potentially asking; I will not bother with maven or ant at any point in time, I&#8217;ll leave that to someone else.</p>
</div>
<div class="sect2">
<h3 id="_retrieving_the_class_path_as_a_list_from_a_gradle_project">Retrieving the class path as a list from a Gradle project</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">// Step 1: Connecting to project
def con = GradleConnector.newConnector()
  .forProjectDirectory(projectDir)
  .connect()

// Step 2: Get hold of a project model, for now a IdeaModel provides what we need
def ideaProject = con.model(IdeaProject)
  .addProgressListener(listener)
  .get()

// Step 3: Get list of dependencies
def deps = ideaProject.children
  .dependencies
  .flatten()
  .findAll { it.scope.scope == "COMPILE" }
  .collect {
    [
      name   : it.gradleModuleVersion?.name,
      group  : it.gradleModuleVersion?.group,
      version: it.gradleModuleVersion?.version,
      file   : it.file?.path,
      source : it.source?.path,
      javadoc: it.javadoc?.path
    ]
  }

def classpathList = deps.file + [new File(projectDir, "build/classes/main").path]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above code is actually wrapped in a class. Connection and model instances are cached for performance reasons.
We connect to our gradle project. If the project ships with a gradle wrapper (which it should IMO), the gradle connector will use that version (download the distribution even if need be). Otherwise it will use the gradle version of the tooling-api. At the time of writing that&#8217;s 1.12
The tooling api doesn&#8217;t really expose as much information by default as you might wish. However it ships with an IdeaModel and an EclipseModel that provides what we need for the purposes of creating a class path. As an Idea user the IdeaModel seemed the right choice ! There is also added a progress listener, which is a callback from the api reporting progress. The progress listener returns each progress event as a string to Light Table so that we can display progress information
We basically navigate the model and extract information about dependencies and put it in a list of maps for ease of jsonifying (useful later !). The location of our projects custom compiled classes are added manually to the class path list (ideally should have been retrieved from the model as well&#8230;&#8203;)
Adding the class path list to our groovy shell before code invocation</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">private GroovyShell createShell(Map params) {
def transform = new ScriptTransform()
def conf = new CompilerConfiguration()
  conf.addCompilationCustomizers(new ASTTransformationCustomizer(transform))
  conf.addCompilationCustomizers(ic)

  if(params.classPathList) {
    conf.setClasspathList(params.classPathList)
  }

  new GroovyShell(conf)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Its basically just a matter of adding the class path list to the CompilerConfiguration we initialise our GroovyShell with. Sweet !
Voila your groovy scripts can invoke any class in your project´s class path.</p>
</div>
<div class="paragraph">
<p>This addition basically resulted in version 0.0.4</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reporting_progress">Reporting progress</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_groovy">Groovy</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class ProgressReporter implements LTProgressReporter {
    final LTConnection ltCon

    ProgressReporter(LTConnection ltCon) { this.ltCon = ltCon }

    @Override
    void statusChanged(ProgressEvent event) {
        if (event.description?.trim()) {
            reportProgress(event.description)
        }
    }

    void reportProgress(String message) {
        ltCon.sendData([null, "gradle.progress",[msg: message]])
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Notes</div>
<ul>
<li>
<p>statusChanges is called by gradle (LTProgressReporter extends the Gradle ProgressListener interface)</p>
</li>
<li>
<p>reportProgress sends the progress information to Light Table</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_light_table">Light Table</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::on-gradle-progress
  :desc "Reporting of progress from gradle related tasks"
  :triggers #{:gradle.progress}
  :reaction (fn [this info]
              (notifos/msg* (str "Gradle progress: " (:msg info)) {:timeout 5000})))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The progress behaviour just prints a message to the Light Table status bar.</p>
</div>
</div>
<div class="sect2">
<h3 id="_executing_gradle_tasks">Executing Gradle Tasks</h3>
<div class="paragraph">
<p>There are two parts to this puzzle. One is to retrieve information about what tasks are actually available for the given project. The other is to actually invoke the task (tasks in the future).
Listing tasks Groovy/Server</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy"> // Step 1: Retrieve generic Gradle model
def gradleProject = con.model(GradleProject)
  .addProgressListener(listener)
  .get()

// Step 2: Get list of available tasks
gradleProject.tasks.collect{
  [
    name: it.name,
    displayName: it.displayName,
    description: it.description,
    path: it.path
  ]
}

// Step 3: Send task list to client (omitted, you get the general idea by now !)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_listing_tasks_in_light_table">Listing tasks in Light Table</h3>
<div class="paragraph">
<p>The list of tasks is actually retrieved by the Light Table plugin once you select to connect to a gradle project. Furthermore the list is cached in an atom.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::on-gradle-projectinfo
  :desc "Gradle project model information"
  :triggers #{:gradle.projectinfo}
  :reaction (fn [this info]
              (object/merge! groovy {::gradle-project-info info})
              (object/assoc-in! cmd/manager [:commands :gradle.task.select :options] (add-selector))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the groovy server has finished retrieving the tasks (and other project info) the above behaviour is triggered in Light Table:</p>
</div>
<div class="paragraph">
<p>We store the project info in our Groovy object (an atom)
We also update the command for selecting tasks with the new list of tasks. See the section below for details.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::set-selected
  :triggers #{:select}
  :reaction (fn [this v]
              (scmd/exec-active! v)))

(defn selector [opts]
  (doto (scmd/filter-list opts)
    (object/add-behavior! ::set-selected)))

(defn get-tasks []
  (-&gt;@groovy ::gradle-project-info :tasks))

(defn add-selector []
  (selector {:items (get-tasks)
             :key :name
             :transform #(str "&lt;p&gt;" (:name %4) "&lt;/p&gt;"
                              "&lt;p class='binding'&gt;" (:description %4) "&lt;/p&gt;")}))

(cmd/command {:command :gradle.task.select
              :desc "Groovy: Select Gradle task"
              :options (add-selector)
              :exec (fn [item]
                      (object/raise groovy :gradle.execute item))})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above code adds a sub panel to the default sidebar command panel. When you select the command :gradle.task.select it will show a child panel listing the tasks from the get-tasks function.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2014//lt_gr_tasks.png" alt="lt gr tasks">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">;; Behavior to actually trigger execution of a selected task from the list above
(behavior ::on-gradle-execute
  :desc "Gradle execute task(s)"
  :triggers #{:gradle.execute}
  :reaction (fn [this task]
              (clients/send
                (clients/by-name "Groovy")
                :gradle.execute
                {:tasks [(:name task)]})))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have selected a task the above behaviour is triggered. We get hold of an editor agnostic groovy client and send an execute task message with a list of task (currently always just one). The data we send will be extended in the future to support multiple tasks and build arguments.</p>
</div>
<div class="paragraph">
<p>Server side Task execution</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">// Generic execute task function
def execute(Map params, Closure onComplete) {
    def resultHandler = [
        onComplete: {Object result -&gt;
            onComplete status: "OK"
        },
        onFailure: {GradleConnectionException failure -&gt;
            onComplete status: "ERROR", error: failure
        }
    ] as ResultHandler


    con.newBuild()
    .addProgressListener(listener)
    .forTasks(params.tasks as String[])
    .run(resultHandler)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we use the asynch features of the Gradle Tooling API. Executing a task may actually take a while so it certainly makes sense. Callers of the execute method will receive a callback (onComplete) once task execution is completed successfully (of failed).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">projectConnection.execute(params) {Map result -&gt;
    ltConnection.sendData([
        null,
        result.status == "ERROR" ? "gradle.execute.err" : "gradle.execute.success",
        result
    ])
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We invoke the execute method with a closure argument and return the results (success/failure) back to Light Table.</p>
</div>
<div class="paragraph">
<p>This brings us pretty much up to version 0.0.5</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Well we covered a lot of ground here. We can now call any class that&#8217;s in your Gradle project&#8217;s class path from a groovy editor in Light Table. We&#8217;ve also started on providing Gradle features that are language agnostic. Starting with support for listing and executing tasks in your gradle project.
We&#8217;ve added decent progress reporting and performance seems to be pretty good too. Looks like we have something we can build further upon !</p>
</div>
<div class="paragraph">
<p>I have lots of ideas; Infinitesting,  single test with inline results, compile single file, grails integration ? etc etc. I also really want to show project dependencies in a graph. However before I can do any of those things I need to extend the tooling api with custom models &#8230;&#8203; and/or maybe I should see if I can contribute to the gradle project in extending the tooling-api with a richer generic project model.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll have to wait and see. Next week I&#8217;m off to gr8conf.eu in Copenhagen. Really looking forward to meeting up with all the great Groovy dudes/dudettes.  And who knows maybe the hackergarten evening will result in something new and exciting !</p>
</div>
</div>
</div></p>
  			<a href="/blog/2014/groovy_repl.html"><h1>Groovy Light Table Plugin</h1></a>
  			<p>19 May 2014</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      
		      <a href="/blog/tags/groovy.html">groovy</a>
	      
		      <a href="/blog/tags/screencast.html">screencast</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Groovy Light Table Plugin"
           data-url="http://rundis.github.io/blog/2014/groovy_repl.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="paragraph">
<p>A short demonstration of the repl like capabilities of my Light Table Groovy plugin (<a href="https://github.com/rundis/LightTable-Groovy" class="bare">https://github.com/rundis/LightTable-Groovy</a>)</p>
</div>
<iframe width="560" height="315" src="http://www.youtube.com/embed/5ji8RR2A4gQ" frameborder="0" allowfullscreen></iframe></p>
  			<a href="/blog/2014/gr_lt_part3.html"><h1>A Groovy Light Table client - Step 3: Running out of quick wins</h1></a>
  			<p>12 May 2014</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      
		      <a href="/blog/tags/groovy.html">groovy</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="A Groovy Light Table client - Step 3: Running out of quick wins"
           data-url="http://rundis.github.io/blog/2014/gr_lt_part3.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="sect1">
<h2 id="_background">Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is the third post in my series "A Groovy Light Table client". A blog series about steps I take when trying to build a Groovy plugin for Light Table.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_out_of_quick_wins">Running out of quick wins</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After 0.0.2 of the plugin was released I was pretty happy. I had something that I could actually use as an alternative Groovy Console. However I was keen to keep up the flow so I figured I would try to implement an autocomplete feature. The task proved rather daunting. Not so much from the Light Table side of things, but rather from the Groovy side. First I tried to see if I could reuse anything from GroovySh, but that didn&#8217;t look to promising. After that I tried to get my head around whether I could somehow reuse something from IntelliJ or Eclipse. I failed to see the light so I gave up that endeavour. Secondly I tried to see if there was an easy way to provide an inline documentation feature. Sadly I couldn&#8217;t find much reusable and something with a small foot print here either. Someone should make a REST based doc search feature for Groovy Docs one day !</p>
</div>
<div class="paragraph">
<p>I turned my attention to a couple of other plugins that I thought would be useful for Light Table. I created a Buster.JS plugin <a href="https://github.com/busterjs/lt-instabuster">InstaBuster</a> for easily running JavaScript tests. I also created a snippets/code templates plugin <a href="https://github.com/rundis/lt-snippets">lt-snippets</a> and some snippet collections, among them a small collection of <a href="https://github.com/rundis/lt-groovy-snippets">groovy snippets</a>.</p>
</div>
<div class="paragraph">
<p>There is just no way I could ever compete with the mainstream IDE&#8217;s, but then again that was never really the original intention. But even with limited capacity it should still be possible to provide useful groovy support and maybe even something fairly unique within the super hackable framework of Light Table.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_small_step_towards_a_groovy_repl">A (small) step towards a Groovy REPL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After working with Light Table and the Clojure/ClojureScript REPL I have grown very fond of that exploratory nature of working. Is there anything I could do with the plugin to give a more REPL like feel ? Well a small but helpful step would be to be able to remember what I previously have evaluated &#8230;&#8203;</p>
</div>
<div class="sect2">
<h3 id="_groovy_bindings">Groovy Bindings</h3>
<div class="paragraph">
<p>A simple but still useful mechanism would be to cache bindings from script execution between evals.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">// from the evalGroovy method
def evalResult = scriptExecutor.execute(data.code, clientSessions.get(currentClientId))
clientSessions.put(currentClientId, evalResult.bindings)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each editor in Light Table gets it&#8217;s own unique Id. So I just created a simple cache "ClientSessions" that hold a map of binding variables, mapped my that Id. When executing a script the current binding variables are applied to the script and after the script has executed the resulting binding variables are added/replaced in the cache. Dead simple really.</p>
</div>
</div>
<div class="sect2">
<h3 id="_clearing_bindings_light_table">Clearing bindings - Light Table</h3>
<div class="paragraph">
<p>I figured it would be handy to be able to clear any stored bindings. So a new command and behaviour was created in Light Table</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">;; Behavior for clearing bindings
(behavior ::on-clear-bindings
          :desc "Clear cached bindings for this editor"
          :triggers #{:on.clear.bindings}
          :reaction (fn [editor]
                      (let [info (:info @editor)
                            cl (eval/get-client! {:command :editor.clear.groovy
                                                    :origin editor
                                                    :info info
                                                    :create try-connect})]
                          (clients/send cl
                                        :editor.clear.groovy info
                                        :only editor))))

;; Command that allows a new keyboard bindable action for invoking the behaviour above
(cmd/command {:command :clear-bindings
              :desc "Groovy: Clear bindings for current editor"
              :exec (fn []
                      (when-let [ed (pool/last-active)]
                        (object/raise ed :on.clear.bindings)))})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command retrieves the currently active editor and triggers the behaviour. The behaviour retrieves a client connection (or creates one if one shouldn&#8217;t exist) and calls the server (groovy).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">// Wiring up the behaviour in groovy.behaviors
:editor.groovy [:lt.plugins.groovy/on-eval
                     :lt.plugins.groovy/on-eval.one
                     :lt.plugins.groovy/on-clear-bindings
                     :lt.plugins.groovy/groovy-res
                     :lt.plugins.groovy/groovy-err
                     [:lt.object/add-tag :watchable]]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The final piece of the puzzle from the Light Table side is to attach the behavior to the :editor.groovy tag. This enables the behavior to be available from any editor that is tagged with this tag.</p>
</div>
</div>
<div class="sect2">
<h3 id="_clearing_bindings_groovy">Clearing bindings - Groovy</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">// The command dispatch got a new command
case "editor.clear.groovy":
   clientSessions.clear(currentClientId)
   break;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code above will just nuke any stored binding variables.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusions">Conclusions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A tiny step that allows you to eval groovy expressions step by step. Anything that results in a binding is stored between evals. Obviously it&#8217;s a bit limited in that you&#8217;ll run into the familiar trap of trying to use def and be surprised(/annoyed) that it won&#8217;t remember that or if you define a class it won&#8217;t remember that either. It&#8217;s probably possible to cater for some of these traps, but maybe not within the realms of a quick win.</p>
</div>
<div class="paragraph">
<p>Anyways the end result is Version 0.0.3 !</p>
</div>
<div class="paragraph">
<p>Next steps</p>
</div>
<div class="paragraph">
<p>Firstly there is a Screencast brewing. After that I think a Light Table Gradle plugin is coming before the Groovy plugin gets any further updates. A pluggable Gradle plugin would enable the Groovy plugin to quite easily get the class path for you project. This would allow you to  explore your projects code in a REPL (-like) way. Exploratory testing FTW !</p>
</div>
</div>
</div></p>
  			<a href="/blog/2014/lt-snippets.html"><h1>Creating and using snippets in Light Table</h1></a>
  			<p>06 May 2014</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      
		      <a href="/blog/tags/plugin.html">plugin</a>
	      
		      <a href="/blog/tags/clojure.html">clojure</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      
		      <a href="/blog/tags/screencast.html">screencast</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Creating and using snippets in Light Table"
           data-url="http://rundis.github.io/blog/2014/lt-snippets.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="paragraph">
<p>A short introduction to my Light Table Snippets plugin (<a href="https://github.com/rundis/lt-snippets" class="bare">https://github.com/rundis/lt-snippets</a>).</p>
</div>
<iframe width="560" height="315" src="http://www.youtube.com/embed/I6iuXOw3HDQ" frameborder="0" allowfullscreen></iframe></p>
  			<a href="/blog/2014/instabuster_part2.html"><h1>JavaScript testing with Light Table and Buster.JS</h1></a>
  			<p>21 April 2014</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      
		      <a href="/blog/tags/javascript.html">javascript</a>
	      
		      <a href="/blog/tags/screencast.html">screencast</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="JavaScript testing with Light Table and Buster.JS"
           data-url="http://rundis.github.io/blog/2014/instabuster_part2.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="paragraph">
<p>Second part of the intro to the Light Table Buster plugin (<a href="https://github.com/busterjs/lt-instabuster" class="bare">https://github.com/busterjs/lt-instabuster</a>)
This time demonstrating some of the more advanced features.</p>
</div>
<iframe width="560" height="315" src="http://www.youtube.com/embed/jYDiAVbPL8I" frameborder="0" allowfullscreen></iframe></p>
  			<a href="/blog/2014/instabuster_part1.html"><h1>JavaScript testing with Light Table and Buster.JS</h1></a>
  			<p>17 March 2014</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      
		      <a href="/blog/tags/javascript.html">javascript</a>
	      
		      <a href="/blog/tags/screencast.html">screencast</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="JavaScript testing with Light Table and Buster.JS"
           data-url="http://rundis.github.io/blog/2014/instabuster_part1.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="paragraph">
<p>Intro to the Light Table Buster plugin (<a href="https://github.com/busterjs/lt-instabuster" class="bare">https://github.com/busterjs/lt-instabuster</a>)</p>
</div>
<iframe width="560" height="315" src="http://www.youtube.com/embed/WKHWazblpbc" frameborder="0" allowfullscreen></iframe></p>
  			<a href="/blog/2014/gr_lt_part2.html"><h1>A Groovy Light Table client - Step 2: Evaluating Code</h1></a>
  			<p>23 February 2014</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      
		      <a href="/blog/tags/groovy.html">groovy</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="A Groovy Light Table client - Step 2: Evaluating Code"
           data-url="http://rundis.github.io/blog/2014/gr_lt_part2.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="sect1">
<h2 id="_background">Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is the second post in my series "A Groovy Light Table client". A blog series about steps I take when trying to build a Groovy plugin for Light Table.</p>
</div>
<div class="paragraph">
<p>In this post I will take you through some of the steps I went through to get Light Table to evaluate groovy (script) code and show results inline in the editor.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2014//lt_groovy_eval.png" alt="lt groovy eval">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_did_we_get_here">How did we get here ?</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_evaluate_contents_of_editor_cmd_ctrl_shift_enter">Evaluate contents of editor (cmd/ctrl + shift + enter)</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::on-eval
          :desc "Groovy: Eval current editor"
          :triggers #{:eval}
          :reaction (fn [editor]
                      (object/raise groovy :eval! {:origin editor
                                                   :info (assoc (@editor :info)
                                                           :code (ed/-&gt;val editor)
                                                           :meta {:start 0, :end (ed/last-line editor)})})))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This behavior triggers on ":eval", which is triggered to any editor (on cmd/ctrl + shift + enter in default key mapping). We just get hold of the text from the editor and gather some meta info  and trigger a ":eval!" behavior on the groovy "mother" object defined in the previous blog post.</p>
</div>
</div>
<div class="sect2">
<h3 id="_evaluate_current_line_selection">Evaluate current line/selection</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::on-eval.one
          :desc "Groovy: Eval current selection"
          :triggers #{:eval.one}
          :reaction (fn [editor]
                      (let [pos (ed/-&gt;cursor editor)
                            info (conj (:info @editor)
                                  (if (ed/selection? editor)
                                    {:code (ed/selection editor) :meta {:start (-&gt; (ed/-&gt;cursor editor "start") :line)
                                                                        :end (-&gt; (ed/-&gt;cursor editor "end") :line)}}
                                    {:pos pos :code (ed/line editor (:line pos)) :meta {:start (:line pos) :end (:line pos)}}))]
                        (object/raise groovy :eval! {:origin editor :info info}))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The only difference here is that we gather the code for the current line or current selection. Then we trigger the same behavior as for evaluating the whole editor.</p>
</div>
</div>
<div class="sect2">
<h3 id="_our_groovy_eval">Our groovy Eval!</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::eval!
          :triggers #{:eval!}
          :reaction (fn [this event]
                      (let [{:keys [info origin]} event
                            client (-&gt; @origin :client :default)]
                        (notifos/working "Evaluating groovy...")
                        (clients/send (eval/get-client! {:command :editor.eval.groovy
                                                         :origin origin
                                                         :info info
                                                         :create try-connect})
                                      :editor.eval.groovy info
                                      :only origin))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This behavior is what actually sends off a eval request to the groovy client. Quite a lot happens under the hood (by help of inbuilt LightTable behaviors):</p>
</div>
<div class="paragraph">
<p>It tries to find a client (connection) for the editor
If no connection exists it will try to create a new one. On create it will invoke the try-connect function that we defined for the gui connect/connect bar behavior in the previous blog post
Once connected it will jsonify our parameters and send them off to our groovy client</p>
</div>
<div class="listingblock">
<div class="title">The JSON might look something like:</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[89,
"editor.eval.groovy",
  {"line-ending":"\n",
   "name":"sample.groovy",
   "type-name":"Groovy",
   "path":"/Users/mrundberget/Library/Application Support/LightTable/plugins/Groovy/sample.groovy",
   "mime":"text/x-groovy",
   "tags":["editor.groovy"],
   "code":"println \"hello\"",
   "meta":{"start":22,"end":22}}]</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Notes</div>
<ul>
<li>
<p>The first param is the client id for the editor that triggered the behavior. This client Id doesn&#8217;t represent the same as a connection id (ref previous blog post). Many editors may share the same connection !</p>
</li>
<li>
<p>The second param is the command (our groovy client will of course support many different commands, this is one of them)</p>
</li>
<li>
<p>The third and last parameter is our info. The code is the essential bit, but some of the meta information, like line info comes in handy when handling the response later on</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_the_actual_groovy_evaluation">The actual groovy evaluation</h3>
<div class="sect3">
<h4 id="_command_dispatch">Command dispatch</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">ltClient.withStreams { input, output -&gt;
  try {
    input.eachLine { line -&gt;
    def (currentClientId, command, data) = new JsonSlurper().parseText(line)
    switch (command) {
    case "client.close":
      stop()
      break
    case "editor.eval.groovy":
      evalGroovy(data, currentClientId)
      break
   default:
     log "Invalid command: $command"
  }
  // ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>We parse any lines received from Light Table and based on the command received invokes the appropriate handler. In this case evalGroovy.</p>
</div>
</div>
<div class="sect3">
<h4 id="_eval_groovy">Eval groovy</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">private void evalGroovy(data, currentClientId) {
  def evalResult = scriptExecutor.execute(data.code)

  def resultParams = [meta: data.meta]
  if (evalResult.out) {
    resultParams &lt;&lt; [out: evalResult.out]
  }
  if(evalResult.exprValues) {
    resultParams &lt;&lt; [result: convertToClientVals(evalResult.exprValues)]
  }

  if (!evalResult.err) {
    data = [currentClientId?.toInteger(), "groovy.res", resultParams]
  } else {
    data = [currentClientId?.toInteger(), "groovy.err", [ex: evalResult.err] + resultParams]
  }
  sendData data
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first and most significant line is where we evaluate the groovy code received. This post would be too long if we went into all the details of what it does, but here&#8217;s a high-level summary:</p>
</div>
<div class="paragraph">
<p>We basically create a GroovyShell and compile our code to a script. Normally that would just compile a Script class. However we  wish to collect a lot more information than you typically would get from default groovy script execution. So we do an AST transformation on the script class and add a custom abstract script class as a base class for the compiled script class.  This allows us to inject behavior and wrap statement execution (all compiled into the script for optimal performance).  That way we are able to collect information about values for most types of statements. We collect line number and value (each line could end up having many values :-) )
We run the script (capturing system.out and system.err).</p>
</div>
<div class="ulist">
<div class="title">The function returns:</div>
<ul>
<li>
<p>Anything written to standard out (println etc)</p>
</li>
<li>
<p>Errors if any and line number for error where possible</p>
</li>
<li>
<p>A list for of maps with line number and value(s)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Most of the AST stuff is not something I&#8217;ve written. It&#8217;s been contributed by Jim White after I posted a question on the groovy-user mailing list. I asked for advice on which way to proceed and the response from the groovy community was awesome. Jim in particular was more than eager to contribute to the plugin. OpenSource rocks ! So when I say we, I sometimes mean we literally.</p>
</div>
<div class="paragraph">
<p>Anyways, based on the results of the script execution we notify Light Table to trigger either a ":groovy.res" behavior or a "groovy.err" behavior.</p>
</div>
<div class="paragraph">
<p>The json response for sendData for a successful execution might look something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[89,
 "groovy.res",
 {"meta":{"start":22,"end":23},"out":"hello\nmama\n","result":[{"line":1,"values":["null"]},{"line":2,"values":["null"]}]}]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_handling_the_evaluation_results_in_light_table">Handling the evaluation results in Light Table</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn notify-of-results [editor res]
  (doseq [ln (:result res)]
    (let [lineNo (+ (:line ln) (-&gt; res :meta :start) -1)]
      (object/raise editor :editor.result (clojure.string/join " " (:values ln)) {:line lineNo :start-line lineNo}))))

(behavior ::groovy-res
          :triggers #{:groovy.res}
          :reaction (fn [editor res]
                      (notifos/done-working)
                      (when-let [o (:out res)] (.log js/console o))
                      (notify-of-results editor res)))

(defn notify-of-error [editor res]
  (let [lineNo (+ (-&gt; res :ex :line) (-&gt; res :meta :start) -1)]
    (object/raise editor :editor.exception (:ex res) {:line lineNo :start-line lineNo'})))

(behavior ::groovy-err
          :triggers #{:groovy.err}
          :reaction (fn [editor res]
                      (object/raise editor :groovy.res res)
                      (notify-of-error editor res)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>These are the behavior definitions that handles either successful or evaluation of scripts with errors. Basically we:
Print to the Light Table Console anything that was captured to system.out/system.err by our groovy evaluation
Show inline results for each line, multiple results for a line are space separated. For showing inline results we are using a predefined Light Table behavior (:editor.result)
If the behavior is to handle an error, we show evaluation results up until the script exception. In addition we display details (stack trace) for the exception at the line in the script it occurred</p>
</div>
</div>
<div class="sect2">
<h3 id="_wiring_it_all_up">Wiring it all up</h3>
<div class="sect3">
<h4 id="_groovy_behaviors">groovy.behaviors</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">{:+ {:app [(:lt.objs.plugins/load-js ["codemirror/groovy.js", "groovy_compiled.js"])]
     :clients []
     :editor.groovy [:lt.plugins.groovy/on-eval
                     :lt.plugins.groovy/on-eval.one
                     :lt.plugins.groovy/groovy-res
                     :lt.plugins.groovy/groovy-err
                     [:lt.object/add-tag :watchable]]
     :files [(:lt.objs.files/file-types
              [{:name "Groovy" :exts [:groovy] :mime "text/x-groovy" :tags [:editor.groovy]}])]
     :groovy.lang [:lt.plugins.groovy/eval!
                   :lt.plugins.groovy/connect]}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The eval and results/err behaviors are defined for the editor tag. So they are only applicable for editors marked as groovy editors. Any editor open with a file name ending in .groovy will automatically be attached to a editor.groovy tag. (You can also set it manually cmd+space &#8594; "Editor: Set current editor syntax").
The ":eval!" behavior is defined for the :groovy.lang tag. Its tied to our groovy mother object just like the connect behavior. These behaviors are totally groovy client specific, whilst the other behaviors are less so (although not exactly generic as they are now…)</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wrap_up">Wrap up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A little bit of plumbing was needed to get this set up. But the hard parts was really coming up with the groovy AST transformation stuff. I guess by now you might have started getting an inkling that Light Table is fairly composable ? It really is super flexible. You don&#8217;t like the behavior for handling inline results for the groovy plugin ? You could easily write your own and wire it up in your user.behaviors file in Light Table. It&#8217;s wicked cool, actually it really is your editor !</p>
</div>
<div class="paragraph">
<p>Yesterday I released version 0.0.2 of the Groovy LightTable plugin. Its available through the Light Table plugin manager, or if you wish to play with the code or maybe feel like contributing feel free to fork the repo at : <a href="https://github.com/rundis/LightTable-Groovy" class="bare">https://github.com/rundis/LightTable-Groovy</a>. Pull requests are welcome.</p>
</div>
<div class="paragraph">
<p>So where to next ? I&#8217;d really like to try and create an InstaRepl editor for the plugin. A groovy script editor that evaluates code as you type. There&#8217;s gotta be one or two challenges related to that. A quick win might be to provide groovy api documentation from inside Light Table. I&#8217;ll let you know what happens in the next post.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Disclaimer: I might have misunderstood some nuances of Light Table, but hopefully I&#8217;m roughly on track. If you see anything glaringly wrong, do let me know.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div></p>
  			<a href="/blog/2014/gr_lt_part1.html"><h1>A Groovy Light Table client - Step 1: Connecting the client</h1></a>
  			<p>16 February 2014</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/lighttable.html">lighttable</a>
	      
		      <a href="/blog/tags/groovy.html">groovy</a>
	      
		      <a href="/blog/tags/clojurescript.html">clojurescript</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="A Groovy Light Table client - Step 1: Connecting the client"
           data-url="http://rundis.github.io/blog/2014/gr_lt_part1.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="sect1">
<h2 id="_building_a_plugin_in_light_table">Building a plugin in Light Table</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is the first post in (hopefully) a series of blog posts about the various steps I go through when trying to create a plugin for Light Table. I have decided to try to create a Groovy plugin. I chose Groovy to ensure there was at least one technology fairly familiar to me. I have just started using Light Table, I have no previous experience with ClojureScript and I have just recently started writing some Clojure beyond the basic tutorials.</p>
</div>
<div class="paragraph">
<p>The short term goal is for the plugin to provide inline results and maybe an instarepl of some sort for groovy scripts.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/rundis/LightTable-Groovy">LightTable-Groovy</a> is the name of my plugin project and you can find the latest source there. It might be a couple of steps ahead of the blog posts though !</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_documentation">Documentation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Light Table was made <a href="http://www.chris-granger.com/2014/01/07/light-table-is-open-source/">open source</a> in january and documentation for plugin developers is a little sparse.</p>
</div>
<div class="ulist">
<div class="title">So to have something to go by I decided to use some of the other language plugins as inspiration:</div>
<ul>
<li>
<p><a href="https://github.com/LightTable/Python">Python plugin</a> (comes bundled/under the light table umbrella)</p>
</li>
<li>
<p><a href="https://github.com/existentialmutt/lt-ruby">Ruby Instarepl</a></p>
</li>
<li>
<p><a href="https://github.com/jetaggart/light-haskell">Haskell plugin</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I haven&#8217;t worked with any of the above mentioned languages, but they did provide enough inspiration to deduce how a Light Table client might interact.</p>
</div>
<div class="paragraph">
<p>BTW. A quick starter just to get you up an running with a hello world plugin could be this screen cast by Mike Haney.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_connecting_a_client_process_overview">Connecting a client - Process overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we dwelve into the code It&#8217;s a good idea to have a high level understanding of what we are trying to achieve !</p>
</div>
<div class="ulist">
<div class="title">A couple of use cases that needs to be supported:</div>
<ul>
<li>
<p>Evaluate current selection or current line of groovy code and present results (preferably inline)</p>
</li>
<li>
<p>Evaluate contents of current editor and present results</p>
</li>
<li>
<p>Provide as much info about the results of each statement as possible</p>
</li>
<li>
<p>(Maybe need to evaluate line/statement by statement)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For a future instarepl, any change in the editor will trigger an evaluation
It becomes evident that our plugin needs to provide some kind of process that reacts to events from light table.</p>
</div>
<div class="olist arabic">
<div class="title">A default pattern for achieving this has been devised for Light Table and roughly equates to the following steps:</div>
<ol class="arabic">
<li>
<p>A connect event is triggered from Light Table (you need to set up your plugin to trigger that event…). Typically the connect event can be invoked manually from the connect bar in light table, or it can be triggered implicetly when evaluating code.</p>
</li>
<li>
<p>You fire of a process - Using inbuilt support from Light Table you start a process either a shell script or whatever really. I created a shell script that sets some environment stuff and then basically kicks off a groovy script. Light table provides a tcp/ip port and a unique client id which you need to forward to the process.</p>
</li>
<li>
<p>Create a tcp client: In your process you create a tcp client using the given port</p>
</li>
<li>
<p>Send ack message: Send a json message with client id and an event name (behavior) to Light Table (through the tcp connection!)</p>
</li>
<li>
<p>Confirm handshake for process: In your process (i.e. not the tcp connection!) write "Connected" to standard out. ("Connected" is just what the other plugins use, you could use  anything you like as long as it matches the connect behaviors(handlers) you provide inside light table.)</p>
</li>
<li>
<p>Listen for events: Now you are connected and given you have set up your behaviors in Light Table correctly, your new connection should be reported as connected and shown in the Light Table connect bar. Now you listen for events on your tcp client and provides appropriate responses back to Light Table accordingly. (Handling this is the subject of a future blog post)</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_behaviors_for_connecting_from_groovy_cljs">Behaviors for connecting (from groovy.cljs):</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn run-groovy[{:keys [path name client] :as info}]
  (let [obj (object/create ::connecting-notifier info)
        client-id (clients/-&gt;id client)
        project-dir (files/parent path)]
    (object/merge! client {:port tcp/port
                           :proc obj})
    (notifos/working "Connecting..")
    (proc/exec {:command binary-path
                :args [tcp/port client-id project-dir]
                :cwd plugin-dir
                :env {"GROOVY_PATH" (files/join (files/parent path))}
                :obj obj})))

(defn check-groovy[obj]
  (assoc obj :groovy (or (::groovy-exe @groovy)
                         (.which shell "groovy"))))

(defn check-server[obj]
  (assoc obj :groovy-server (files/exists? server-path)))

(defn handle-no-groovy [client]
  (clients/rem! client)
  (notifos/done-working)
  (popup/popup! {:header "We couldn't find Groovy."
                 :body "In order to evaluate in Groovy files, Groovy must be installed and on your system PATH."
                 :buttons [{:label "Download Groovy"
                            :action (fn []
                                      (platform/open "http://gvmtool.net/"))}
                           {:label "ok"}]}))

(defn notify [obj]
  (let [{:keys [groovy path groovy-server client]} obj]
    (cond
     (or (not groovy) (empty? groovy)) (do (handle-no-groovy client))
     :else (run-groovy obj))
    obj))

(defn check-all [obj]
  (-&gt; obj
      (check-groovy)
      (check-server)
      (notify)))

(defn try-connect [{:keys [info]}]
  (.log js/console (str "try connect" info))
  (let [path (:path info)
        client (clients/client! :groovy.client)]
    (check-all {:path path
                :client client})
    client))


(object/object* ::groovy-lang
                :tags #{:groovy.lang})


(def groovy (object/create ::groovy-lang))

(scl/add-connector {:name "Groovy"
                    :desc "Select a directory to serve as the root of your groovy project... then again it might not be relevant..."
                    :connect (fn []
                               (dialogs/dir groovy :connect))})
(behavior ::connect
                  :triggers #{:connect}
                  :reaction (fn [this path]
                              (try-connect {:info {:path path}})))</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Notes:</div>
<ul>
<li>
<p>scl/add-connector: This statement adds a connect dialog to our groovy plugin. You select a root directory and upon selection the ::connect behavior is triggered</p>
</li>
<li>
<p>::connect basically responds with invoking a method for connecting. This does some sanity checks and if all goes well ends up invoking  run-groovy.</p>
</li>
<li>
<p>run-groovy : Fires up our groovy (server) process</p>
</li>
<li>
<p>def groovy   is basically the "mother" object of our plugin. It helps us scope behaviors and commands</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_the_server_part_ltserver_groovy">The server part (LTServer.groovy)</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">import groovy.json.*

params = [
  ltPort:   args[0].toInteger(),
  clientId: args[1].toInteger() // light table generated id for the client (connection)
]

logFile = new File("server.log")

def log(msg) {
  logFile &lt;&lt; "${new Date().format('dd.MM.yyyy mm:hh:sss')} - $msg\n"
}

client = null
try {
  client = new Socket("127.0.0.1", params.ltPort)
} catch (Exception e) {
  log "Could not connect to port: ${params.ltPort}"
  throw e
}

def sendData(data) {
  client &lt;&lt; new JsonBuilder(data).toString() + "\n"
}
// ack to Light Table
sendData (
  [
    name: "Groovy",
    "client-id": params.clientId,
    dir: new File("").absolutePath,
    commands: ["editor.eval.groovy"],
    type: "groovy"
  ]
)
println "Connected" // tells lighttable we're good

client.withStreams {input, output -&gt;
  while(true) {
  // insert code to listen for events from light table and respond to those (eval code etc)
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_notification_of_successful_connection">Notification of successful connection</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::on-out
          :triggers #{:proc.out}
          :reaction (fn [this data]
                      (let [out (.toString data)]
                        (object/update! this [:buffer] str out)
                        (if (&gt; (.indexOf out "Connected") -1)
                          (do
                            (notifos/done-working)
                            (object/merge! this {:connected true}))
                          (object/update! this [:buffer] str data)))))

(behavior ::on-error
          :triggers #{:proc.error}
          :reaction (fn [this data]
                      (let [out (.toString data)]
                        (when-not (&gt; (.indexOf (:buffer @this) "Connected") -1)
                          (object/update! this [:buffer] str data)
                          ))
                      ))

(behavior ::on-exit
          :triggers #{:proc.exit}
          :reaction (fn [this data]
                      ;(object/update! this [:buffer] str data)
                      (when-not (:connected @this)
                        (notifos/done-working)
                        (popup/popup! {:header "We couldn't connect."
                                       :body [:span "Looks like there was an issue trying to connect
                                              to the project. Here's what we got:" [:pre (:buffer @this)]]
                                       :buttons [{:label "close"}]})
                        (clients/rem! (:client @this)))
                      (proc/kill-all (:procs @this))
                      (object/destroy! this)
                      ))

(object/object* ::connecting-notifier
                :triggers []
                :behaviors [::on-exit ::on-error ::on-out]
                :init (fn [this client]
                        (object/merge! this {:client client :buffer ""})
                        nil))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above behaviors basically handles signaling success, error or connection exits for our groovy client. As you can see in ::on-out this is where we check standard out from the process for the string "Connected", to signal success.</p>
</div>
</div>
<div class="sect2">
<h3 id="_wiring_up_behaviors_behaviors_groovy">Wiring up behaviors (behaviors.groovy)</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">{:+ {:app [(:lt.objs.plugins/load-js ["codemirror/groovy.js", "groovy_compiled.js"])]
     :clients []
     :editor.groovy []
     :files [(:lt.objs.files/file-types
              [{:name "Groovy" :exts [:groovy] :mime "text/x-groovy" :tags [:editor.groovy]}])]
     :groovy.lang [:lt.plugins.groovy/connect]}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The important part in terms on the connection is the wiring of the connect behavior to ":groovy.lang". This is needed for groovy to appear as a connection item in the light table connect bar.</p>
</div>
<div class="paragraph">
<p>"codemirror/groovy.js" deserves a special mention. This is what provides syntax highlighting for our groovy files (defined in the :files vector). The syntax highlighting is provided by the groovy mode module from CodeMirror.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wrapping_up">Wrapping up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So what have we achieved. Well we now have a connection to Light Table from an external process that can listen and respond to events from Light Table. For the purposes of this blog post series, its a Groovy client that hopefully pretty soon will be able to evaluate groovy scripts and respond with evaluation results. We didn&#8217;t pay much attention to it, but we also got syntax highlighting of our Groovy files complements of CodeMirror.</p>
</div>
<div class="paragraph">
<p>It took a while to grok how the connection part worked. Once I did understand roughly what was needed I was a bit annoyed with myself for messing about so much. I&#8217;m hoping this post might help others to avoid some of the mistakes I stumbled into.</p>
</div>
</div>
</div></p>
  			<a href="/blog/2013/buster-plugin.html"><h1>Javascript testing in your JVM projects using Gradle and BusterJS</h1></a>
  			<p>19 August 2013</p>
        <p><em>Tags: </em>
		      <a href="/blog/tags/gradle.html">gradle</a>
	      
		      <a href="/blog/tags/groovy.html">groovy</a>
	      
		      <a href="/blog/tags/javascript.html">javascript</a>
	      
		      <a href="/blog/tags/buster.html">buster</a>
	      
		      <a href="/blog/tags/screencast.html">screencast</a>
	      </p>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-text="Javascript testing in your JVM projects using Gradle and BusterJS"
           data-url="http://rundis.github.io/blog/2013/buster-plugin.html"
           data-via="mrundberget" data-lang="en">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  			<p><div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When I first started looking at testing in javascript land a while back I quickly felt lost in space.</p>
</div>
<div class="ulist">
<div class="title">Filled with questions like;</div>
<ul>
<li>
<p>which framework(s) to choose ?</p>
</li>
<li>
<p>how do I get framework x to work from my IDE ?</p>
</li>
<li>
<p>more importantly how to I manage to include the javascript tests in my CI builds ?</p>
</li>
<li>
<p>how can I avoid repetitive setup pain across projects ?</p>
</li>
<li>
<p>why is it such a hassle getting started ?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I can&#8217;t say I have answered any of the questions above fully, but I have taken some strides in the right direction.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_buster_js">Buster.JS</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://docs.busterjs.org/en/latest/">Buster</a> is a flexible and modularized framework for writing and running your JavaScript tests.
There are others out there, but from what I could gather and based on advice from my frontend wizard colleagues I decided to give it a good go. It&#8217;s still in beta, but from my experiences so far its more than mature enough for proper use in projects.</p>
</div>
<div class="sect2">
<h3 id="_a_few_important_aspects_about_buster_js">A few important aspects about Buster.JS:</h3>
<div class="paragraph">
<p>Tests are run in real browsers (phantomjs for headless). No emulation bull
You can run tests in multiple browsers in parallell
Its really really fast
Write tests in the fashion that suits you (xUnit or spec)
Nice assertion library and integrated with Sinon.JS (powerful stubbing and spying)
&#8230;&#8203; and lots more</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_gradle_buster_plugin">Gradle buster plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For my jvm project builds I use Gradle. Maven and Ant projects that spend time with me a few weeks tend to find themselves converted. So I set out to create a buster plugin for gradle, aptly named gradle-buster-plugin. Still early days, but already it has started to prove quite valuable.</p>
</div>
<div class="ulist">
<div class="title">The plugin has two high-level goals;</div>
<ul>
<li>
<p>Allow you to easily run javascripts as part of your CI builds</p>
</li>
<li>
<p>Provide you with a smooth development experience by adding value on top of whats already present in Buster.JS.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The homepage for the pluging is here: <a href="https://github.com/rundis/gradle-buster-plugin" class="bare">https://github.com/rundis/gradle-buster-plugin</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_do_i_have_to_do_aka_getting_started">What do I have to do ? (aka getting started)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_installing_preconditions">Installing preconditions</h3>
<div class="ulist">
<ul>
<li>
<p>Install node.js/npm - Mac: $ brew install node</p>
</li>
<li>
<p>Install Buster.JS  - $ npm install buster -g</p>
</li>
<li>
<p>Install Phantom.JS  - Mac: $ brew install phantomjs</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_set_up_the_buster_plugin_in_your_gradle_config">Set up the buster plugin in your gradle config</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">buildscript {
    repositories { jcenter() }
    dependencies {
        classpath  'org.gradle.buster:gradle-buster-plugin:0.2.4.1'
    }
}

apply plugin: 'war' // just assuming you have a war project
apply plugin: 'buster'

build.dependsOn busterTest // hook up javascript task in the build</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_set_up_a_buster_js_configuration_file">Set up a buster.js configuration file</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">var config = module.exports;

config["Sample JSTests"] = {
    environment: "browser",

    libs: ["src/main/webaapp/js/libs/jquery-1.10.2.js"],
    sources: ["src/main/web-app/js/app/**/*.js"],
    tests: ["src/test/js/**/*-test.js"]
};</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sample_unit">Sample unit</h3>
<div class="paragraph">
<p>So you could create a file like src/main/webapp/js/app/dummy-service.js</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">var myapp = this.myapp || {};
myapp.services = app.services || {};
(function () {
    myapp.services.DummyService = function (my) {
        my.listTodos = function(success, error) {
            $.get('/todos/list')
               .done(function(data) {
                  success(data);
               })
               .fail(function(jqXHR, textStatus, errorThrown) {
                  error("Error getting todos")
               });
        };
        return my;
    }(myapp.services.DummyService || {});
}());</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sample_unit_test">Sample unit test</h3>
<div class="paragraph">
<p>Create a corresponding unit test in src/test/js/app/dummy-service-test.js</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">(function () {
    buster.testCase("DummyService", {
        setUp: function() {
            this.service = myapp.services.DummyService;
            this.server = sinon.fakeServer.create();
            this.success = this.spy();
            this.error = this.spy();
        },
        tearDown: function () {
            this.server.restore();
        },
        "should successfully list todos": function () {
            this.service.listTodos(this.success, this.error);
            this.server.requests[0].respond(
                200,
                { "Content-Type": "application/json" },
                JSON.stringify([{ id: 1, text: "Provide examples", done: true }])
            );

            assert.calledOnce(this.success);
        },
        "should invoke error callback on errors": function () {
            this.service.listTodos(this.success, this.error);
            this.server.requests[0].respond(
                500,
                { "Content-Type": "application/json" },
                JSON.stringify([{ id: 1, text: "dummy", done: true }])
            );

            assert.calledOnce(this.error);
        }
    });
}());</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_tests_locally">Running the tests locally</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ gradle busterTest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test results are found in : build/busterTest-results/bustertests.xml</p>
</div>
<div class="paragraph">
<p>Autotesting
When doing your tdd cycles its quite useful to use the autotest feature (kinda like infinitest).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ gradle busterAutoTest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Will leave the server running and listen for file changes in the patterns specified by the buster.js file above. So if I change the test or unit above a test run will automatically be fired off and results reported to the console. Its pretty fast so you should be able to keep a good flow going !
Just do Ctrl + C to kill the autotesting.</p>
</div>
<div class="paragraph">
<p>Multiple browsers
Its quite easy to set up just see the readme for the plugin</p>
</div>
<div class="paragraph">
<p>CI Server
Obviously you will need to set up the preconditions. If you&#8217;re server isn&#8217;t headless you have the option of testing with a few proper browsers(firefox and chrome on linux, safari if your server is mac&#8230;&#8203; which I doubt).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Its certainly not perfect, but with the above you have a pretty good start. Once you get over the hurdle of setting up the preconditions it really is quite pleasant to work with. You should be amazed by the performance of the tests runs if you are from a jvm background.
What about IDE integration ? With the autotest feature I can&#8217;t say I have missed it much. I have my IDE and a visible console available and get instant feedback on saves in my IDE.</p>
</div>
<div class="paragraph">
<p>Smooth !</p>
</div>
</div>
</div></p>

	<hr />

	<p>Older posts are available in the <a href="/blog/archive.html">archive</a>.</p>

		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2015 Magnus Rundberget
          <a class="pull-right btn btn-xs" href="https://twitter.com/mrundberget"><i class="fa fa-twitter"></i></a>
          <a class="pull-right btn btn-xs" href="https://github.com/rundis"><i class="fa fa-github"></i></a>
          <a class="pull-right btn btn-xs" href="http://no.linkedin.com/in/mrundberget"><i class="fa fa-linkedin"></i></a>
        </p>
      </div>
    </div>

    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/prettify.js"></script>
  </body>
</html>
