<?xml version="1.0"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>The Rundis Blog</title>
    <link>http://rundis.github.io/blog</link>
    <atom:link href="http://rundis.github.io/blog/feed.xml" rel="self" type="application/rss+xml" />
    <description>JBake Bootstrap Template</description>
    <language>en-gb</language>
    <pubDate>Mon, 13 Jun 2016 23:05:26 +0200</pubDate>
    <lastBuildDate>Mon, 13 Jun 2016 23:05:26 +0200</lastBuildDate>

    <item>
      <title>Oh no! Learning Elm has gotten me confused about static vs dynamic typing.</title>
      <link>http://rundis.github.io/blog/2016/type_confused.html</link>
      <pubDate>Mon, 13 Jun 2016 00:00:00 +0200</pubDate>
      <guid isPermaLink="false">2016/type_confused.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The last few years I&amp;#8217;ve worked on projects using Groovy and Clojure/ClojureScript.
In 2016 I&amp;#8217;ve spent quite a bit of pastime trying to get to grips
with statically typed functional languages. In particular I&amp;#8217;ve deep dived into Elm. I&amp;#8217;ve also dipped
my toes into Haskell. It&amp;#8217;s been a great learning experience and has changed my view of static typing.
Does this mean I&amp;#8217;m a static typing zealot now ? Nah, but there is no doubt I&amp;#8217;m much more open to the benefits of static typing.
I guess would characterize myself more like undecided or confused than convinced either way.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_background&quot;&gt;Background&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A couple of years ago I started working with Groovy (and Grails). I fell in love
and felt I became way more productive than I had ever been when working with Java. I rarely
missed the added type safety of Java. Groovy also gave me a gentle introduction to functional programming related concepts in a way Java never encouraged me to.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In 2014 I started dabbling with Clojure(Script), but it took until 2015 before I got a chance
to use it for real in a project. It was a blast and I finally started to understand why more and more people
are turning towards functional programming. Clojure/ClojureScript became a big part of my life
both at work and evenings and nights. I was hooked.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;At the end of last year I was back on a Groovy/Grails project. I was perfectly ok with that, but it wasn&amp;#8217;t
a shiny new thing any longer, so I guess that&amp;#8217;s partially why I was looking for something new to learn on the side.
Elm really caught my attention. When I watched &lt;a href=&quot;http://www.elmbark.com/2016/03/16/mainstream-elm-user-focused-design&quot;&gt;Let&amp;#8217;s be mainstream! User focused design in Elm&lt;/a&gt;
I finally found a statically typed functional language that looked approachable to me.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_first_signs_of_functional_immutable_damage&quot;&gt;First signs of functional immutable damage&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;My time with Clojure (and gradually Elm) had changed me. I started to change how I coded Groovy. I tried to be more
functional and whenever I declared a variable that I later mutated I was left feeling dirty somehow.
It&amp;#8217;s hard to try to enforce immutability in Groovy when the language, libraries and idioms don&amp;#8217;t make immutability
a first class citizen. I had to bite the bullet quite a few times, and yeah I could still get things done.
The thing is, I started to pay more attention to what kind of errors and bugs I introduced as a result of careless mutation.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;One particular example springs to mind. I was doing validation of a master/detail form.
To validate the detail rows of the form I needed to make sure they were sorted.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Easy peasy ?&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;master.detailRows.sort {it.date}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;However this had the nasty side-effect
of reordering the detail rows in my UI which was rendered from this object.
I was puzzled at first, but then I remembered that immutability is not something you
can take for granted in the Groovy collection API (some things are, others are just bolted on top of Java).
The fix was easy enough. &lt;code&gt;collection.sort&lt;/code&gt; has an overloaded version that takes a boolean parameter &lt;code&gt;mutate&lt;/code&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;So I was left with&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;master.details.sort(false) {it.date}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;My eyes hurt: &lt;strong&gt;&lt;code&gt;sort false&lt;/code&gt;&lt;/strong&gt;, but but I &lt;strong&gt;do&lt;/strong&gt; want to sort.
2 years ago I wouldn&amp;#8217;t think much of this, it&amp;#8217;s just a thing I was used to deal with and spend cycles on.
Now I get annoyed both with myself for forgetting and the language for making me feel dumb for not remembering.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_adding_types&quot;&gt;Adding types&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;After having spent some time with Elm (and Haskell) I noticed I started to add more
type information in my Groovy code. I felt it improved the readability of my functions and methods.
It also made IntelliJ more happy and helpful in many cases.
The frontend of the application is written in JavaScript with a fair chunk of jQuery. Introducing something like Flow
might be helpful, but I&amp;#8217;m convinced there are other more fundemental issues that needs to be addressed before considering that.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;m pretty sure I&amp;#8217;ll be using something like &lt;a href=&quot;https://github.com/plumatic/schema&quot;&gt;Schema&lt;/a&gt; more actively when writing Clojure/ClojureScript
going forward. When I have the chance Clojure Spec will probably be the preferred option. I know it&amp;#8217;s not static typing, but my hunch is
that it will have a huge positive impact on documentation, error messages, runtime checks, testing and probably many other things too.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_functionally_dynamic_but_statically_aware&quot;&gt;Functionally dynamic, but statically aware&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This week I was back to a Clojure/ClojureScript project again. I&amp;#8217;m quite excited and I&amp;#8217;m convinced I&amp;#8217;m going to have a blast.
However I&amp;#8217;ve decided to use this opportunity to reflect more on where I feel Clojure/ClojureScript with it&amp;#8217;s dynamic typing shines and where I think
static typing might have been helpful. After spending so much time with Elm and very much enjoying it, I might be susceptible to confirmation bias that static typing only carries benefits.
I&amp;#8217;m going to try real hard to stay as objective or rather true to myself as I can when reflecting on positives of static vs dynamic.
Of course there&amp;#8217;s a lot more to languages than static vs dynamic typing. I do find it interesting to reflect about it though, especially
since so many people seem to have such strong opinions about type safety. I myself am mostly confused or largely undecided at the moment.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_first_week_reflections&quot;&gt;First week reflections&lt;/h3&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Undoubtably with some Elm tinted glasses
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;The good&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/bhauman/lein-figwheel&quot;&gt;Figwheel&lt;/a&gt; how I&amp;#8217;ve missed you ! With the latest release, error messages has gotten way better too. Maybe Elm with it&amp;#8217;s suberb error messages has been an inspiration ?&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;I haven&amp;#8217;t gotten my tooling set up right yet, but know that once I&amp;#8217;ve got the REPL stuff set up right I&amp;#8217;m going to be a happier puppy&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The app is really cool, and there are lots of exciting techs to dig into&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Paredit rocks for editing&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Unsure/unknowns&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/Day8/re-frame&quot;&gt;re-frame&lt;/a&gt; - When I first read about it several months ago I was initially convinced that this
small but very powerful framework was a fantastic thing. Maybe it really is to. But having experienced Elms departure from FRP, I&amp;#8217;m wondering whether it might have some drawbacks at scale that I am not aware of yet.
I&amp;#8217;ve barely gotten a chance to work with it, but I&amp;#8217;ve so far found it hard to internalize all the reactive dataflows going on in the client app. I obviously need to spend more time before making any judgment.
Maybe I&amp;#8217;ll write a blog post comparing The Elm Architecture to re-frame in the future.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Have I become dumber ?&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;I genuinly found it harder than before to understand what various functions did by looking at their signature.
That could very well be down to naming and lack of documentation and or something like schema, but it was initially frustrating to see functions with map parameters and having to read through
the whole of the implementation to get an understanding of what they might contain. &lt;code&gt;println&lt;/code&gt; to the rescue&amp;#8230;&amp;#8203; sort of.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;I made silly mistakes, some of these resulted in things just not happening and others resulted in stacktraces that wasn&amp;#8217;t helpful in anyway at all.
I can&amp;#8217;t help but think about the fact that  static types and a helpful compiler would have prevented me from making many of those mistakes. Sure I should have tested more, both through the use of the REPL and probably more proper tests too.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;I was faced with a few refactorings, that didn&amp;#8217;t really go as well as I feel it should have. Again more tests would have helped, but then again a lot of those tests I just wouldn&amp;#8217;t have needed to write in Elm.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_an_attempt_to_summarize&quot;&gt;An attempt to summarize&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;m convinced that functional programming vs imperative programming is a much more important concern than
static vs dynamic typing. I&amp;#8217;m also in no doubt that I think functional programming is by far superior.
A year ago I was solidly in the dynamic typing camp. My impression of statically typed functional languages was that they were way to hard to get started with.
None of the languages I had heard about seemed particularily approachable and I had doubts about their practicality for the problems
I typically encounter in my projects. I&amp;#8217;ve tried Haskell a couple of times, but I guess I was never commited enough.
Learning Elm has not only been great fun, but It has clearly opened my mind to the possibility that static type checking can be very beneficial.
It&amp;#8217;s hard to describe the experience of doing a major refactoring, having a really helpful and friendly compiler guide you along step by step and when finally
everything compiles it just works. Having had that experience many times with Elm (and to a degree Haskell) certainly changed something fundementally in my thinking.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Until I have used Elm, Haskell or another statically typed functional language in a real project I&amp;#8217;m in no position to pass any proper (personal) judgement. Maybe
I&amp;#8217;m just going to remain confused, or maybe I&amp;#8217;m never going to have a particularily strong preference.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Typed up CRUD SPA with Haskell and Elm - Part 5: Elm 0.17 Upgrade</title>
      <link>http://rundis.github.io/blog/2016/haskel_elm_spa_part5.html</link>
      <pubDate>Mon, 30 May 2016 00:00:00 +0200</pubDate>
      <guid isPermaLink="false">2016/haskel_elm_spa_part5.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Elm version 0.17 was released a few weeks back. If haven&amp;#8217;t already, you should read the annoucement post
&lt;a href=&quot;http://elm-lang.org/blog/farewell-to-frp&quot;&gt;A Farewell to FRP&lt;/a&gt;. So what does that mean for the Albums app ?
Sounds like we&amp;#8217;re in for a massive rewrite. It turns out, since we were already using The Elm Architecture to
structure our application, the impact isn&amp;#8217;t that big after all. Most of it is mechanical, and actually the biggest change
is that we can no longer use the 3.rd party routing library we depended on.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Useful resources&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Check out the other &lt;a href=&quot;http://rundis.github.io/blog/tags/haskellelmspa.html&quot;&gt;episodes&lt;/a&gt; in this blog series.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The accompanying &lt;a href=&quot;https://github.com/rundis/albums&quot;&gt;Albums&lt;/a&gt; sample app is on github, and there is a tag
for each episode&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div id=&quot;toc&quot; class=&quot;toc&quot;&gt;
&lt;div id=&quot;toctitle&quot; class=&quot;title&quot;&gt;Table of Contents&lt;/div&gt;
&lt;ul class=&quot;sectlevel1&quot;&gt;
&lt;li&gt;&lt;a href=&quot;#_introduction&quot;&gt;Introduction&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_upgrade_steps&quot;&gt;Upgrade steps&lt;/a&gt;
&lt;ul class=&quot;sectlevel2&quot;&gt;
&lt;li&gt;&lt;a href=&quot;#_upgrading_packages&quot;&gt;Upgrading packages&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_mechanical_changes&quot;&gt;Mechanical changes&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_routes_and_route_parsing_ehh_urls_if_you_like&quot;&gt;Routes and Route parsing (ehh&amp;#8230;&amp;#8203; URLs if you like)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_dealing_with_http&quot;&gt;Dealing with Http&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_nesting_components&quot;&gt;Nesting Components&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_wiring_it_all_together_in_frontend_src_main_elm&quot;&gt;Wiring it all together in frontend/src/Main.elm&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_summary&quot;&gt;Summary&lt;/a&gt;
&lt;ul class=&quot;sectlevel2&quot;&gt;
&lt;li&gt;&lt;a href=&quot;#_appendix&quot;&gt;Appendix&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I would have done the upgrade to 0.17 sooner, but the Album application depended on a 3rd party package
called &lt;a href=&quot;https://github.com/etaque/elm-transit-router&quot;&gt;elm-transit-router&lt;/a&gt;. It served us well and we even got some nice
transition animations when changing pages. However as all the routing libraries that we&amp;#8217;re available for 0.16, it
depended on a community package called elm-history. That package was never going to updated to support 0.17, in fact
all support for the Web Platform APIs will eventually supported by the Elm language.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Last week &lt;a href=&quot;https://github.com/elm-lang/navigation&quot;&gt;Navigation&lt;/a&gt; was announced. This is library for managing navigation in a SPA. It provides nice abstractions over the History API.
In tandem Evan released &lt;a href=&quot;https://github.com/evancz/url-parser&quot;&gt;URL Parser&lt;/a&gt; which is a simple parser for turning URLs into structured data.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;With that in place I felt confident we should be able to do the upgrade. Let&amp;#8217;s walk through the highlights !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_upgrade_steps&quot;&gt;Upgrade steps&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_upgrading_packages&quot;&gt;Upgrading packages&lt;/h3&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;caption class=&quot;title&quot;&gt;Table 1. /frontend/elm-package.json&lt;/caption&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-JavaScript&quot; data-lang=&quot;JavaScript&quot;&gt;&quot;dependencies&quot;: {
  &quot;elm-community/elm-json-extra&quot;: &quot;1.0.0 &amp;lt;= v &amp;lt; 2.0.0&quot;,
  &quot;elm-community/list-extra&quot;: &quot;2.0.0 &amp;lt;= v &amp;lt; 3.0.0&quot;,
  &quot;elm-lang/core&quot;: &quot;4.0.0 &amp;lt;= v &amp;lt; 5.0.0&quot;,
  &quot;elm-lang/html&quot;: &quot;1.0.0 &amp;lt;= v &amp;lt; 2.0.0&quot;,
  &quot;elm-lang/navigation&quot;: &quot;1.0.0 &amp;lt;= v &amp;lt; 2.0.0&quot;,
  &quot;evancz/elm-http&quot;: &quot;3.0.1 &amp;lt;= v &amp;lt; 4.0.0&quot;,
  &quot;evancz/url-parser&quot;: &quot;1.0.0 &amp;lt;= v &amp;lt; 2.0.0&quot;
},
&quot;elm-version&quot;: &quot;0.17.0 &amp;lt;= v &amp;lt; 0.18.0&quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-JavaScript&quot; data-lang=&quot;JavaScript&quot;&gt;&quot;dependencies&quot;: {
    &quot;circuithub/elm-list-extra&quot;: &quot;3.9.0 &amp;lt;= v &amp;lt; 4.0.0&quot;,   &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
    &quot;elm-lang/core&quot;: &quot;3.0.0 &amp;lt;= v &amp;lt; 4.0.0&quot;,
    &quot;etaque/elm-route-parser&quot;: &quot;2.1.0 &amp;lt;= v &amp;lt; 3.0.0&quot;,
    &quot;etaque/elm-transit-router&quot;: &quot;1.0.1 &amp;lt;= v &amp;lt; 2.0.0&quot;,   &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    &quot;etaque/elm-transit-style&quot;: &quot;1.0.1 &amp;lt;= v &amp;lt; 2.0.0&quot;,
    &quot;evancz/elm-effects&quot;: &quot;2.0.1 &amp;lt;= v &amp;lt; 3.0.0&quot;,          &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
    &quot;evancz/elm-html&quot;: &quot;4.0.2 &amp;lt;= v &amp;lt; 5.0.0&quot;,             &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
    &quot;evancz/elm-http&quot;: &quot;3.0.0 &amp;lt;= v &amp;lt; 4.0.0&quot;,
    &quot;evancz/start-app&quot;: &quot;2.0.2 &amp;lt;= v &amp;lt; 3.0.0&quot;             &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
},
&quot;elm-version&quot;: &quot;0.16.0 &amp;lt;= v &amp;lt; 0.17.0&quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;https://github.com/elm-community/&quot;&gt;Elm Community&lt;/a&gt; have taken over this package&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;elm-transit-router&lt;/code&gt;, &lt;code&gt;elm-route-parser&lt;/code&gt;, &lt;code&gt;elm-transit-style&lt;/code&gt; have been replaced by &lt;code&gt;elm-lang/navigation&lt;/code&gt; and &lt;code&gt;evancz/url-parser&lt;/code&gt;
(pls note you can still use &lt;code&gt;etaque/elm-route-parser&lt;/code&gt; with the navigation package if you need more advanced route parsing)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This package has been baked into core of Elm for 0.17, so this package is no longer needed&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This package has moved under the &lt;code&gt;elm-lang&lt;/code&gt; umbrella. So has it&amp;#8217;s low level &lt;a href=&quot;https://github.com/elm-lang/virtual-dom&quot;&gt;virtual-dom&lt;/a&gt; transitive dependency&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This package has basically been moved into &lt;code&gt;elm-lang/html&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_mechanical_changes&quot;&gt;Mechanical changes&lt;/h3&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_module_declarations&quot;&gt;Module declarations&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In 0.16 we had&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;module Main (..) where&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In 0.17 we have&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;module Main exposing (..)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Luckily &lt;a href=&quot;https://github.com/avh4/elm-format&quot;&gt;Elm Format&lt;/a&gt; handles this conversion automatically for us when we do format of an 0.16 .elm file !
So we can just run elm-format on the &lt;code&gt;src&lt;/code&gt; directory.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_effects_are_now_named_code_cmd_code&quot;&gt;Effects are now named &lt;code&gt;Cmd&lt;/code&gt;&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The new name for Effects are now &lt;code&gt;Cmd&lt;/code&gt; shorthand for Command. &lt;code&gt;Cmd&lt;/code&gt; is part of &lt;code&gt;elm-lang/core&lt;/code&gt;
and lives in the &lt;a href=&quot;http://package.elm-lang.org/packages/elm-lang/core/4.0.1/Platform-Cmd&quot;&gt;Platform.Cmd&lt;/a&gt; module.&lt;/p&gt;
&lt;/div&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;caption class=&quot;title&quot;&gt;Table 2. Changes to a typical update function&lt;/caption&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type Msg
    = SomeMsg
    | SomeOtherMsg


update : Msg -&amp;gt; Model -&amp;gt; ( Model, Cmd Msg )         &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
update msg model =
    case msg of
       SomeMsg -&amp;gt;
           ( { model | count = model.count + 1 }
           , Cmd.none                               &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
           )
       -- etc...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;You&amp;#8217;ll also notice that &lt;code&gt;Action&lt;/code&gt; has changed to &lt;code&gt;Msg&lt;/code&gt;. It&amp;#8217;s just a naming convention change
, but it better conveys what it actually is. You&amp;#8217;ll see later when we get to the view function why it&amp;#8217;s probably a good idea for you to
follow that convention.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;As you see, here it&amp;#8217;s just a naming change in practice&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type Action
    = SomeAction
    | SomeOtherAction


update : Action -&amp;gt; Model -&amp;gt; ( Model, Effects Action )
update action model =
    case action of
        SomeAction -&amp;gt;
            ( { model | count = model.count + 1 }
            , Effects.none
            )
        -- etc...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Making these changes is also fairly trivial with a good old search/replace.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_mailbox_and_address_are_gone_in_0_17&quot;&gt;Mailbox and address are gone in 0.17&lt;/h4&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;caption class=&quot;title&quot;&gt;Table 3. Changes to a typical view function&lt;/caption&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;view : Model -&amp;gt; Html Msg           &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
view model =
    button
        [ onClick SomeMsg ]        &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
        [ text &quot;DoStuff&quot; ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;view : Signal.Address Action -&amp;gt; Model -&amp;gt; Html
view address model =
    button
        [ onClick address SomeMsg ]
        [ text &quot;DoStuff&quot;]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class=&quot;olist arabic&quot;&gt;
&lt;ol class=&quot;arabic&quot;&gt;
&lt;li&gt;
&lt;p&gt;The address parameter is gone, you no longer need to concern yourself with the intricacies of mailboxes.
But you&amp;#8217;ll also notice that the return value type &lt;code&gt;Html&lt;/code&gt; takes a tag which in this case is our &lt;code&gt;Msg&lt;/code&gt; type. So if we have any event handlers
in our view code, we are telling it that those should result in a message of type &lt;code&gt;Msg&lt;/code&gt;. We&amp;#8217;ll come back to this in a bit more detail when we go through a nesting example.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;We no longer need to deal with an address for our event handler, we just tell Elm that when the user clicks the button, it should
trigger our update function with the given &lt;code&gt;Msg&lt;/code&gt; &lt;code&gt;SomeMsg&lt;/code&gt;. The Elm runtime will take care of routing the message to our update function without any address mumbojumbo !&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Again making this change is largely a matter of search/replace. There are a few exceptions though.&lt;/p&gt;
&lt;/div&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;caption class=&quot;title&quot;&gt;Table 4. on &quot;input&quot; is now luckily onInput !&lt;/caption&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;[ input
  [ class &quot;form-control&quot;
  , value model.name
  , onInput SetAlbumName
  ]
  []
]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;[ input
  [ class &quot;form-control&quot;
  , value model.name
  , on &quot;input&quot;
        targetValue
        (\str -&amp;gt; Signal.message address (SetAlbumName str))
  ]
  []
]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;But let&amp;#8217;s say you actually do need a custom decoder it would still be simpler than in 0.16&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;import Json.Decode as Json

-- ...

[ input
  [ class &quot;form-control&quot;
  , value model.name
  , on &quot;input&quot; (Json.map SetArtistName targetValue) &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  ]
  []
]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Here we just map over the targetValue, and call SetArtistName with the value. &lt;code&gt;targetValue&lt;/code&gt; is a Json decoder which picks out the value from our input field when the event is triggered&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_routes_and_route_parsing_ehh_urls_if_you_like&quot;&gt;Routes and Route parsing (ehh&amp;#8230;&amp;#8203; URLs if you like)&lt;/h3&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;caption class=&quot;title&quot;&gt;Table 5. Route definitions&lt;/caption&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type Route
    = Home
    | ArtistListingPage
    | ArtistDetailPage Int
    | NewArtistPage
    | AlbumDetailPage Int
    | NewArtistAlbumPage Int&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type Route
  = Home
  | ArtistListingPage
  | ArtistDetailPage Int
  | NewArtistPage
  | AlbumDetailPage Int
  | NewAlbumPage               &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  | NewArtistAlbumPage Int
  | EmptyRoute                 &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We never used this page, we always navigate through artist, so no point in keeping it until we need it.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;EmptyRoute was used for handling route parser failures, we&amp;#8217;ll deal with that in another manner.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;caption class=&quot;title&quot;&gt;Table 6. Route parsing&lt;/caption&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17 (url-parser)&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16 (elm-route-parser)&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;routeParser : Parser (Route -&amp;gt; a) a
routeParser =
    oneOf
        [ format Home (s &quot;&quot;)
        , format NewArtistPage (s &quot;artists&quot; &amp;lt;/&amp;gt; s &quot;new&quot;)
        , format NewArtistAlbumPage
                 (s &quot;artists&quot; &amp;lt;/&amp;gt; int &amp;lt;/&amp;gt; s &quot;albums&quot; &amp;lt;/&amp;gt; s &quot;new&quot;)
        , format ArtistDetailPage (s &quot;artists&quot; &amp;lt;/&amp;gt; int)
        , format ArtistListingPage (s &quot;artists&quot;)
        , format AlbumDetailPage (s &quot;albums&quot; &amp;lt;/&amp;gt; int)
        ]


decode : Location -&amp;gt; Result String Route
decode location =
    parse identity routeParser (String.dropLeft 1 location.pathname)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;routeParsers : List (Matcher Route)
routeParsers =
  [ static Home &quot;/&quot;
  , static ArtistListingPage &quot;/artists&quot;
  , static NewArtistPage &quot;/artists/new&quot;
  , dyn1 ArtistDetailPage &quot;/artists/&quot; int &quot;&quot;
  , dyn1 AlbumDetailPage &quot;/albums/&quot; int &quot;&quot;
  , static NewAlbumPage &quot;/albums/new&quot;
  , dyn1 NewArtistAlbumPage &quot;/artists/&quot; int &quot;/albums/new&quot;
  ]



decode : String -&amp;gt; Route
decode path =
  RouteParser.match routeParsers path
    |&amp;gt; Maybe.withDefault EmptyRoute&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The parsing syntax is slightly different, but the transition was fairly trivial in our case.
The observant reader will notice that we&amp;#8217;ve skipped over the case when there is not matching route.
We&amp;#8217;ll get back to that when we wire it all together. Also, we&amp;#8217;ll see later where our decode function comes into play when we wire up the app.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
To learn more about the new url-parser and it&amp;#8217;s functions check out the &lt;a href=&quot;http://package.elm-lang.org/packages/evancz/url-parser/latest&quot;&gt;package docs&lt;/a&gt;.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Encoding&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;encode : Route -&amp;gt; String
encode route =
    case route of
        Home -&amp;gt;
            &quot;/&quot;

        ArtistListingPage -&amp;gt;
            &quot;/artists&quot;

        NewArtistPage -&amp;gt;
            &quot;/artists/new&quot;

        ArtistDetailPage i -&amp;gt;
            &quot;/artists/&quot; ++ toString i

        AlbumDetailPage i -&amp;gt;
            &quot;/albums/&quot; ++ toString i

        NewArtistAlbumPage i -&amp;gt;
            &quot;/artists/&quot; ++ (toString i) ++ &quot;/albums/new&quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Encoding routes is pretty much exactly the same as before.&lt;/p&gt;
&lt;/div&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;caption class=&quot;title&quot;&gt;Table 7. Handy helpers&lt;/caption&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17 (url-parser)&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16 (elm-route-parser)&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;navigate : Route -&amp;gt; Cmd msg                     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
navigate route =
    Navigation.newUrl (encode route)


linkTo : Route -&amp;gt; List (Attribute msg) -&amp;gt; List (Html msg) -&amp;gt; Html msg
linkTo route attrs content =                    &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    a ((linkAttrs route) ++ attrs) content


linkAttrs : Route -&amp;gt; List (Attribute msg)
linkAttrs route =
    let
        path =
            encode route
    in
        [ href path
        , attribute &quot;data-navigate&quot; path       &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
        ]


catchNavigationClicks : (String -&amp;gt; msg) -&amp;gt; Attribute msg
catchNavigationClicks tagger =                 &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
    onWithOptions &quot;click&quot;
        { stopPropagation = True
        , preventDefault = True
        }
        (Json.map tagger (Json.at [ &quot;target&quot; ] pathDecoder))


pathDecoder : Json.Decoder String              &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
pathDecoder =
    Json.oneOf
        [ Json.at [ &quot;data-navigate&quot; ] Json.string
        , Json.at [ &quot;parentElement&quot; ] (lazy (\_ -&amp;gt; pathDecoder))
        , Json.fail &quot;no path found for click&quot;
        ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;A couple of places in the Album app we wish to be able to navigate to a new page as a result of some logic
in the update function of some component. We might actually be better off inlining this to be honest.
in the relevant update functions.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This is a handy convenience function for creating a link to one of our defined routes (aka pages in our App).&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;In addition to the href attribute we define a &lt;code&gt;data-navigate&lt;/code&gt; attribute which we can use for a catch all handler we&amp;#8217;ll come to in a second.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This function allows us to catch all link clicks for a given element and all its child elements.
It prevents the browser from making the url request and rather allows us to provide a custom tagger function that receives the Url in question and can create a message as a result.
It will make more sense to you when you see how it&amp;#8217;s used in our Main module later on.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;A Json parser which will recursivly walk up the element tree for the node receiving the event and try to find an element with the &lt;code&gt;data-navigage&lt;/code&gt; attribute defined.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;redirect : Route -&amp;gt; Effects ()
redirect route =
  encode route
    |&amp;gt; Signal.send TransitRouter.pushPathAddress
    |&amp;gt; Effects.task


clickAttr : Route -&amp;gt; Attribute
clickAttr route =
  on &quot;click&quot; Json.value (\_ -&amp;gt;  Signal.message TransitRouter.pushPathAddress &amp;lt;| encode route)


linkAttrs : Route -&amp;gt; List Attribute
linkAttrs route =
  let
    path = encode route
  in
    [ href path
    , onWithOptions
        &quot;click&quot;
        { stopPropagation = True, preventDefault = True }
        Json.value
        (\_ -&amp;gt;  Signal.message TransitRouter.pushPathAddress path)
    ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
I borrowed most of this code from &lt;a href=&quot;https://github.com/etaque/tacks&quot;&gt;The tacks application from @etaque&lt;/a&gt;. Kudos to @etaque for coming up with this !
You might be wondering why we need &lt;code&gt;catchNavigationClicks&lt;/code&gt; at all ? Well if you click on a href, the browser will (to my knowledge) change the window location
and trigger a server request which causes the page to reload. In an SPA we typically don&amp;#8217;t want that to happen.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock warning&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-warning&quot; title=&quot;Warning&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Please be advised that these helpers do make a compromise in terms of type safety. Note in particular the use of &lt;code&gt;msg&lt;/code&gt; (basically anything) rather than a component specific &lt;code&gt;Msg&lt;/code&gt; type.
I&amp;#8217;m sure in due time, more type safe patterns will emerge.  An obvious alternative to this approach is to
have a custom message in each update function that handles navigation. I&amp;#8217;m going to try that out in the near future and see how it plays out.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_sample_usage&quot;&gt;Sample usage&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Let&amp;#8217;s have a quick look at a few examples on how we are using the &lt;code&gt;navigate&lt;/code&gt; and &lt;code&gt;linkTo&lt;/code&gt; helper functions
in the Albums app. How it all fits together will hopefully be apparent when we describe how we wire everything together in our &lt;code&gt;Main&lt;/code&gt; module a little later on&lt;/p&gt;
&lt;/div&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;caption class=&quot;title&quot;&gt;Table 8. artistRow function in frontend/src/ArtistDetails.elm&lt;/caption&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;artistRow : Artist -&amp;gt; Html Msg
artistRow artist =
    tr []
        [ td [] [ text artist.name ]
        , td []
            [ Routes.linkTo (Routes.ArtistDetailPage artist.id) &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
                [ class &quot;btn btn-sm btn-default&quot; ]
                [ text &quot;Edit&quot; ]
            ]
        , td []
            [ button
                [ class &quot;btn btn-sm btn-danger&quot;
                , onClick &amp;lt;| DeleteArtist (.id artist)          &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
                ]
                [ text &quot;Delete!&quot; ]
            ]
        ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Here we are creating a normal link using the helper function described earlier. The result of clicking it should just be navigation, so sending a message to the ArtistListing &lt;code&gt;update&lt;/code&gt; function which then creates the navigation effect feels like it might be to much work/boilerplate.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Here the primary thing we want to handle is not navigation, the primary concern is handling deletion so we follow the normal pattern of returning a Msg which will be routed to our update function for handling.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;artistRow : Signal.Address Action -&amp;gt; Artist -&amp;gt; Html
artistRow address artist =
  tr
    []
    [ td [] [ text artist.name ]
    , td
        []
        [ button
            [ class &quot;btn btn-sm btn-default&quot;
            , Routes.clickAttr
                &amp;lt;| Routes.ArtistDetailPage artist.id
            ]
            [ text &quot;Edit&quot; ]
        ]
    , td
        []
        [ button
            [ class &quot;btn btn-sm btn-danger&quot;
            , onClick address (DeleteArtist (.id artist))
            ]
            [ text &quot;Delete!&quot; ]
        ]
    ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;caption class=&quot;title&quot;&gt;Table 9. update function in frontend/src/ArtistDetail.elm&lt;/caption&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;-- ...

HandleSaved artist -&amp;gt;
    ( { model
        | id = Just artist.id
        , name = artist.name
      }
      , Routes.navigate Routes.ArtistListingPage &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
    )
-- ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Upon successfully saving an artist to our backend service, we create a Cmd (aka request for an effect to be performed), using our util function, to route the user to the
ArtistListingPage.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;HandleSaved maybeArtist -&amp;gt;
  case maybeArtist of
    Just artist -&amp;gt;
      ( { model
          | id = Just artist.id
          , name = artist.name
        }
      , Effects.map (\_ -&amp;gt; NoOp)
                    (Routes.redirect Routes.ArtistListingPage)
      )

    Nothing -&amp;gt;
      Debug.crash &quot;Save failed... we&apos;re not handling it...&quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_dealing_with_http&quot;&gt;Dealing with Http&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So in our Album app we separated all HTTP requests to a separate module we called &lt;code&gt;ServerApi&lt;/code&gt;.
The changes from 0.16 to 0.17 isn&amp;#8217;t massive, but since we&amp;#8217;re at it we might as well make some small improvements
to be better prepared for error handling in future episodes.&lt;/p&gt;
&lt;/div&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;getArtist :
  Int
  -&amp;gt; (Http.Error -&amp;gt; msg)
  -&amp;gt; (Artist -&amp;gt; msg)
  -&amp;gt; Cmd msg
getArtist id errorMsg msg =
    Http.get artistDecoder
            (baseUrl ++ &quot;/artists/&quot; ++ toString id)
        |&amp;gt; Task.perform errorMsg msg&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;getArtist : Int -&amp;gt; (Maybe Artist -&amp;gt; a) -&amp;gt; Effects.Effects a
getArtist id action =
  Http.get artistDecoder (baseUrl ++ &quot;/artists/&quot; ++ toString id)
    |&amp;gt; Task.toMaybe
    |&amp;gt; Task.map action
    |&amp;gt; Effects.task&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The http methods haven&amp;#8217;t really changed, but the manner in which we request the runtime to perform them have changed.
We no longer have the Effects package, so we need to use &lt;code&gt;Task.perform&lt;/code&gt; to do it now. Our 0.16 implementation used
Maybe to signal success or failure, in 0.17 we have opted to give a different message for success or failure.
So if &lt;code&gt;getArtist&lt;/code&gt; fails the error result of or http action will be passed to our update function wrapped in the provided Msg given by our &lt;code&gt;errorMsg&lt;/code&gt; param,
if it succeeds the response will be json decoded and passed to our update function wrapped in the provided Msg given by our &lt;code&gt;msg&lt;/code&gt; param.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Separating out all our http requests in one module gives flexibility in usage from multiple modules, but comes with a price of reduced type safety though.
&lt;strong&gt;You&lt;/strong&gt; might (depending on context of course) want to localize http stuff with your components to make them more self-contained.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_usage_comparison&quot;&gt;Usage Comparison&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;frontend/src/AlbumDetail.elm 0.16&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;update : Action -&amp;gt; Model -&amp;gt; ( Model, Effects Action )
update action model =
  case action of
    NoOp -&amp;gt;
      ( model, Effects.none )

    GetAlbum id -&amp;gt;
      ( model
      , Effects.batch
          [ getAlbum id ShowAlbum
          , getArtists HandleArtistsRetrieved
          ]
      )

    ShowAlbum maybeAlbum -&amp;gt;
      case maybeAlbum of
        Just album -&amp;gt;
          ( createAlbumModel model album, Effects.none )

        Nothing -&amp;gt; -- TODO: This could be an error if returned from api !
          ( maybeAddPristine model, getArtists HandleArtistsRetrieved )

    HandleArtistsRetrieved xs -&amp;gt;
      ( { model | artists = (Maybe.withDefault [] xs) }
      , Effects.none
      )&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Our use of Maybe to signal failure in our 0.16 implementation clearly muddles what&amp;#8217;s going on in terms of potential failures.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;frontend/src/AlbumDetail.elm 0.17&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;mountAlbumCmd : Int -&amp;gt; Cmd Msg                                    &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
mountAlbumCmd id =
    Cmd.batch
        [ getAlbum id FetchAlbumFailed ShowAlbum
        , getArtists FetchArtistsFailed HandleArtistsRetrieved
        ]


mountNewAlbumCmd : Cmd Msg                                        &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
mountNewAlbumCmd =
    getArtists FetchArtistsFailed HandleArtistsRetrieved


update : Msg -&amp;gt; Model -&amp;gt; ( Model, Cmd Msg )
update msg model =
    case msg of
        -- TODO: show error
        FetchAlbumFailed err -&amp;gt;                                   &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
            ( model, Cmd.none )

        ShowAlbum album -&amp;gt;                                        &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
            ( createAlbumModel model album, Cmd.none )

        HandleArtistsRetrieved artists&apos; -&amp;gt;
            ( { model | artists = artists&apos; }
            , Cmd.none
            )

        -- TODO: show error
        FetchArtistsFailed err -&amp;gt;
            ( model, Cmd.none )

        -- rest left out for brevity&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This command has been separated out as an exposed function for the module. The reason is that we need to perform this
when we navigate to a `/albums/&amp;lt;id&amp;gt;. I.e when that particular url is mounted. You&amp;#8217;ll see how when we cover the Main module.
We are actually running two http requests here.. hopefully/presumably in the order they are listed :-)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Similar to the above, but this is for handling when the user navigates to the url for creating a &lt;em&gt;new&lt;/em&gt; album&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;if getAlbum should fail this is where we should handle that (And we will eventually in a future episode)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If getAlbum succeeds we set the model up for displaying the retrieved artist&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_nesting_components&quot;&gt;Nesting Components&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The way you handle nesting of components in 0.17 has changed (for the better) with the removal of Mailboxes.
If you didn&amp;#8217;t do to much fancy stuff with addresses the transition to 0.17 should be quite straight forward.
We&amp;#8217;ll illustrate by showing a simple/common transition and then we will show how you might handle a more complex
nesting scenario (based on actual examples from the Albums App)&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_the_common_scenario&quot;&gt;The common scenario&lt;/h4&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;caption class=&quot;title&quot;&gt;Table 10. update function in frontend/src/Main.elm&lt;/caption&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;update : Msg -&amp;gt; Model -&amp;gt; ( Model, Cmd Msg )
update msg model =
    case msg of
        HomeMsg m -&amp;gt;
            let
                ( subMdl, subCmd ) =
                    Home.update m model.homeModel
            in
                { model | homeModel = subMdl }
                    ! [ Cmd.map HomeMsg subCmd ]   &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
        -- ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;So rather than using &lt;code&gt;Effects.map&lt;/code&gt; to map the result action(s) of effects from a child component, we use &lt;code&gt;Cmd.map&lt;/code&gt; to map result msg(s) from a child component
to a Msg that is known to the parent module.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;update : Action -&amp;gt; Model -&amp;gt; ( Model, Effects Action )
update action model =
  case action of
    HomeAction homeAction -&amp;gt;
      let
        ( subMdl, effects ) =
          Home.update homeAction model.homeModel
      in
        ( { model | homeModel = subMdl }
        , Effects.map HomeAction effects
        )

    -- ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I think you&amp;#8217;ll agree this change is pretty simple to deal with. Let&amp;#8217;s see how nesting of view functions
for components have changed&lt;/p&gt;
&lt;/div&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;caption class=&quot;title&quot;&gt;Table 11. contentView function in frontend/src/Main.elm&lt;/caption&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;contentView : Model -&amp;gt; Html Msg
contentView model =
    case model.route of                             &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
        Home -&amp;gt;
            App.map HomeMsg                         &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
                    &amp;lt;| Home.view model.homeModel

        -- ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;As we did in 0.16 we keep track of the current route in our model.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;App.map is shorthand for Html.App.map. So we need to map between the &lt;code&gt;Msg&lt;/code&gt; type returned from the view function in the Home module
to a &lt;code&gt;Msg&lt;/code&gt; type that is known to our Main module. In this instance it&amp;#8217;s &lt;code&gt;HomeMsg&lt;/code&gt;. We need to do this mapping so that when the msg is passed
pack into our root update function we know which msg we should forward to which subcomponent.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;contentView : Signal.Address Action -&amp;gt; Model -&amp;gt; Html
contentView address model =
  case (TransitRouter.getRoute model) of
    Home -&amp;gt;
      Home.view (Signal.forwardTo address HomeAction)  &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
                model.homeModel&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Signal.forwardTo essentially achieved the same effect, but it&amp;#8217;s way less intuitive to grasp. It&amp;#8217;s unlikely you&amp;#8217;ll miss it much !&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This change isn&amp;#8217;t quite search/replace (well with regex perhaps), but it&amp;#8217;s quite trivial too.
Ok let&amp;#8217;s move onto something a bit more complex.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_a_more_complex_scenario_album_and_tracks&quot;&gt;A more complex scenario - Album and tracks&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;If you wish to see the Album and Tracks solution in action, you can check it out here:&lt;/p&gt;
&lt;/div&gt;
&lt;iframe width=&quot;420&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/RU0NB2xaQIg&quot; frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;caption class=&quot;title&quot;&gt;Table 12. update function in frontend/src/TrackRow.elm&lt;/caption&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type Msg
    = SetTrackName String
    | SetMinutes String
    | SetSeconds String
    | Dispatch DispatchMsg                             &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;


type DispatchMsg                                       &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    = MoveUp
    | MoveDown
    | Remove


update : Msg -&amp;gt; Model -&amp;gt; ( Model, Maybe DispatchMsg )  &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
update msg model =
    case msg of
        SetTrackName v -&amp;gt;
            ( { model | name = v, status = Modified }
            , Nothing                                  &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
            )

        SetMinutes str -&amp;gt;
            -- ...

        SetSeconds str -&amp;gt;
            -- ...

        Dispatch dispatchMsg -&amp;gt;                        &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
            ( model, Just dispatchMsg )&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We add a new Msg tag called &lt;code&gt;Dispatch&lt;/code&gt; which has a payload of type &lt;code&gt;DispatchMsg&lt;/code&gt; to model
messages we would like to notify the parent of this component to handle.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;DispatchMsg becomes part of the public Api for our component so we need to expose it from our module.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The way we notify the parent in this solution is to add a return value, so now we return a tuple of Model and Maybe a DispatchMsg the parent
should respond to.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;For the component internal messages there is nothing extra the parent should respond to, so we simply return &lt;code&gt;Nothing&lt;/code&gt; as a DispatchMsg.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;For all dispatch messages we return the concrete dispatch message tag that we want the parent to handle.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type Action
  = SetTrackName String
  | SetMinutes String
  | SetSeconds String


update : Action -&amp;gt; Model -&amp;gt; Model
update action model =
  case action of
    SetTrackName v -&amp;gt;
      { model | name = v, status = Modified }

    SetMinutes str -&amp;gt;
      -- ..


    SetSeconds str -&amp;gt;
      -- ..&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;There is no magic involved here, we are just returning an additional piece of info in the return value of
our update function.&lt;/p&gt;
&lt;/div&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;caption class=&quot;title&quot;&gt;Table 13. view function in frontend/src/TrackRow.elm&lt;/caption&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;view : Model -&amp;gt; Html Msg
view model =
    tr []
        [ td [] [ statusView model ]
        , td [] [ moveView model ]
        , td [] [ nameView model ]
        , td [] [ durationView model ]
        , td [] [ removeView model ]
        ]

removeView : Model -&amp;gt; Html Msg
removeView model =
    button
        [ onClick (Dispatch Remove)           &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
        , class
            &amp;lt;| &quot;btn btn-sm btn-danger &quot;
            ++ if isPristine model then
                &quot;disabled&quot;
               else
                &quot;&quot;
        ]
        [ text &quot;Remove&quot; ]

-- ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When the user clicks the remove button, we simply return a Msg with the tag &lt;code&gt;Dispatch&lt;/code&gt; carrying a &lt;code&gt;DispatchMsg&lt;/code&gt; with the tag &lt;code&gt;Remove&lt;/code&gt;
This msg will be routed through the top-level update function, through the update function in &lt;code&gt;AlbumDetailPage&lt;/code&gt; and finally to the update function in &lt;code&gt;TrackRow&lt;/code&gt;.
There it will be handled by the &lt;code&gt;Dispatch dispatchMsg &amp;#8594;&lt;/code&gt; case and simply returned to the parent (&lt;code&gt;AlbumDetailPage&lt;/code&gt;).&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type alias Context =                          &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  { actions : Signal.Address Action
  , remove : Signal.Address ()
  , moveUp : Signal.Address ()
  , moveDown : Signal.Address ()
  }


view : Context -&amp;gt; Model -&amp;gt; Html
view context model =
  tr
    []
    [ td [] [ statusView model ]
    , td [] [ moveView context model ]
    , td [] [ nameView context model ]
    , td [] [ durationView context model ]
    , td [] [ removeView context model ]
    ]


removeView : Context -&amp;gt; Model -&amp;gt; Html
removeView context model =
  button
    [ onClick context.remove ()             &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    , class &amp;lt;| &quot;btn btn-sm btn-danger &quot;
            ++ if isPristine model then
                  &quot;disabled&quot;
               else &quot;&quot;
    ]
    [ text &quot;Remove&quot; ]

-- ..&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;In our 0.16 implementation we used this funny type and made it part of the public Api
as an extra param to the view function.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This looks super-weird to someone who doesn&amp;#8217;t intuitively know that &lt;code&gt;()&lt;/code&gt; is &lt;code&gt;Unit&lt;/code&gt;.
 &lt;code&gt;onClick&lt;/code&gt; takes 2 parameters an address and an Action. In this case context.remove is the first param and &lt;code&gt;()&lt;/code&gt; is the second !
There is little point in explaining further, let&amp;#8217;s just agreed that this isn&amp;#8217;t very intuitive ?&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;0.16 implementation of update function in frontend/src/AlbumDetail.elm&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;update : Action -&amp;gt; Model -&amp;gt; ( Model, Effects Action )
update action model =
  case action of
    -- ...

    RemoveTrack id -&amp;gt;
      ( { model \| tracks = List.filter (\( rowId, _ ) -&amp;gt; rowId /= id) model.tracks }
      , Effects.none
      )

    MoveTrackUp id -&amp;gt;
      -- ...
    MoveTrackDown id -&amp;gt;
      -- ...

    ModifyTrack id trackRowAction -&amp;gt;
      let
        updateTrack ( trackId, trackModel ) =
          if trackId == id then
            ( trackId, TrackRow.update trackRowAction trackModel )
          else
            ( trackId, trackModel )
      in
        ( maybeAddPristine { model | tracks = List.map updateTrack model.tracks }
        , Effects.none
        )&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;0.17 implementation of update function in frontend/src/AlbumDetail.elm&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;update : Msg -&amp;gt; Model -&amp;gt; ( Model, Cmd Msg )
update msg model =
    case msg of
        -- ...

        RemoveTrack id -&amp;gt;                                      &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
            ( { model \| tracks = List.filter (\( rowId, _ ) -&amp;gt; rowId /= id) model.tracks
              }
            , Cmd.none
            )

        MoveTrackUp id -&amp;gt;
            -- ...

        MoveTrackDown id -&amp;gt;
            -- ...

        ModifyTrack id trackRowMsg -&amp;gt;
            case (modifyTrack id trackRowMsg model) of        &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
                Just ( updModel, Nothing ) -&amp;gt;                 &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
                    ( model, Cmd.none )

                Just ( updModel, Just dispatchMsg ) -&amp;gt;        &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
                    handleDispatch id dispatchMsg updModel

                _ -&amp;gt;
                    ( model, Cmd.none )                       &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;


modifyTrack : TrackRowId -&amp;gt; TrackRow.Msg -&amp;gt; Model -&amp;gt; Maybe ( Model, Maybe TrackRow.DispatchMsg )
modifyTrack id msg model =                                    &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
    ListX.find (\( trackId, _ ) -&amp;gt; id == trackId) model.tracks
        \|&amp;gt; Maybe.map (\( _, trackModel ) -&amp;gt; TrackRow.update msg trackModel)
        \|&amp;gt; Maybe.map
            (\( updTrack, dispatchMsg ) -&amp;gt;
                ( maybeAddPristine
                    { model
                        \| tracks =
                            ListX.replaceIf (\( i, _ ) -&amp;gt; i == id)
                                ( id, updTrack )
                                model.tracks
                    }
                , dispatchMsg
                )
            )


handleDispatch : TrackRowId -&amp;gt; TrackRow.DispatchMsg -&amp;gt; Model -&amp;gt; ( Model, Cmd Msg )
handleDispatch id msg model =                                &lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;(7)&lt;/b&gt;
    case msg of
        TrackRow.MoveDown -&amp;gt;
            update (MoveTrackDown id) model

        TrackRow.MoveUp -&amp;gt;
            update (MoveTrackUp id) model

        TrackRow.Remove -&amp;gt;
            update (RemoveTrack id) model&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The parent, ie AlbumDetail, logic for deleting on of it&amp;#8217;s track rows.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We delegate updating the track row and consequently the AlbumDetail model to a helper function.
We pattern match on the result from that function.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If it was a &quot;normal&quot; update with no dispatch message returned we simply return the updated model and a no op Cmd.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If the update of the track row got a dispatch message in return from TrackRow.update we delegate the handling of the
dispatch message to another helper function.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Since we are dealing with Maybe values we have to handle this case, but it really shouldn&amp;#8217;t ever happen ! (Famous last words).&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This might look a bit scary, but in summary it; locates the correct track row, performs the update of that row by delegating to TrackRow update,
updates the track row in the model with the updated track row and finally returns a tuple of the updated model and the dispatch message (which is Maybe you remember).&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;7&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Here we simply pattern match on the dispatch message and invokes the update function with the appropriate corresponding &lt;code&gt;Msg&lt;/code&gt;.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
The pattern we used here is just one of many possible ways of solving this problem. Maybe someday a common preferred pattern will emerge,
but the bottom line is that it will most likely be some variation of return values from update functions and/or input params to the view function in the parent/child communucation.
The days of &quot;magic&quot; juggling with mailboxes are gone. Simple input/output FTW !
Oh, and finally, for this particular case I think there might be a good case for arguing that perhaps remove/moveup/movedown doesn&amp;#8217;t really belong in &lt;code&gt;TrackRow&lt;/code&gt; at all, it might
actually make more sence to use a decorator-kind of approach instead.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock warning&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-warning&quot; title=&quot;Warning&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Some flavors of using &quot;global&quot; or dummy effects (using say dummy tasks) for communicating between components have briefly surfaced. Pls think really carefully
before adopting such an approach. Have a chat with the nice and very knowledgable people in the community to discuss
if there isn&amp;#8217;t a better solution for your problem !
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_wiring_it_all_together_in_frontend_src_main_elm&quot;&gt;Wiring it all together in frontend/src/Main.elm&lt;/h3&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;caption class=&quot;title&quot;&gt;Table 14. main&lt;/caption&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;main : Program Never
main =
    Navigation.program                       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
      (Navigation.makeParser Routes.decode)
        { init = init
        , view = view
        , update = update
        , urlUpdate = urlUpdate              &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
        , subscriptions = \_ -&amp;gt; Sub.none     &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
        }&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Rather that start-app we are using the program function from Navigation. The first
param is a function to creates a parser- So bootstrap it with our Routes.decode function.
The second param is a config record similar to the one in start-app but not quite.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Hey what&amp;#8217;s this fellow, it seems we need to provide a function to handle URL updates in our application !&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We don&amp;#8217;t have any subscriptions in our app, so we can just return Sub.none for that function.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;app : StartApp.App Model
app =
  StartApp.start
    { init = init initialPath
    , update = update
    , view = view
    , inputs = [ actions ]                  &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
    }


main : Signal Html
main =
  app.html


port tasks : Signal (Task.Task Never ())   &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
port tasks =
  app.tasks

port initialPath : String                  &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Inputs was sort of like subscriptions. We needed that in our 0.16 because of elm-transit-router which used elm-history which again provided a signal for url changes.
All of that is gone and handled by navigation, but slightly differently.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Just a thing you had to define if you had effects in your App in 0.16. We&amp;#8217;re happy it&amp;#8217;s gone !&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We had to provide the initialPath (url) through a port in 0.16.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;caption class=&quot;title&quot;&gt;Table 15. Model and init stuff&lt;/caption&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type alias Model =
    { route : Routes.Route
    , homeModel : Home.Model
    , artistListingModel : ArtistListing.Model
    , artistDetailModel : ArtistDetail.Model
    , albumDetailModel : AlbumDetail.Model
    }

initialModel : Model
initialModel =
    { route = Home
    , homeModel = Home.init
    , artistListingModel = ArtistListing.init
    , artistDetailModel = ArtistDetail.init
    , albumDetailModel = AlbumDetail.init
    }


init : Result String Route -&amp;gt; ( Model, Cmd Msg )  &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
init result =
    urlUpdate result initialModel&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;init&lt;/code&gt; is called for us by Navigation.program using our provided parser so
we get a result from the parsing of the initial url. We pass that on to the yet to be described
urlUpdate function along with our initial model.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type alias Model =
  WithRoute
    Routes.Route
    { homeModel : Home.Model
    , artistListingModel : ArtistListing.Model
    , artistDetailModel : ArtistDetail.Model
    , albumDetailModel : AlbumDetail.Model
    }

initialModel : Model
initialModel =
  { transitRouter = TransitRouter.empty Routes.EmptyRoute
  , homeModel = Home.init
  , artistListingModel = ArtistListing.init
  , artistDetailModel = ArtistDetail.init
  , albumDetailModel = AlbumDetail.init
  }


init : String -&amp;gt; ( Model, Effects Action )
init path =
  let
    usePath = if path == &quot;/index.html&quot; then &quot;/&quot; else path
  in
    TransitRouter.init routerConfig usePath initialModel&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I don&amp;#8217;t think it&amp;#8217;s much point in describing the other slight differences, since they mostly pertain to
details about elm-transit-router.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_url_updates_mounting_routes&quot;&gt;Url updates / Mounting routes&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;mounting routes in 0.16&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;mountRoute : Route -&amp;gt; Route -&amp;gt; Model -&amp;gt; ( Model, Effects Action )
mountRoute prevRoute route model =
  case route of
    Home -&amp;gt;
      ( model, Effects.none )

    ArtistListingPage -&amp;gt;
      ( model, Effects.map ArtistListingAction (ServerApi.getArtists ArtistListing.HandleArtistsRetrieved) )

    ArtistDetailPage artistId -&amp;gt;
      ( model
      , Effects.map ArtistDetailAction (ServerApi.getArtist artistId ArtistDetail.ShowArtist) )

    NewArtistPage -&amp;gt;
      ( { model | artistDetailModel = ArtistDetail.init }, Effects.none )

    -- etc ..

    EmptyRoute -&amp;gt;                &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
      ( model, Effects.none )&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This is how we handled route parse failures in our 0.16 implementation btw.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;urlUpdate in 0.17&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;urlUpdate : Result String Route -&amp;gt; Model -&amp;gt; ( Model, Cmd Msg )
urlUpdate result model =
    case result of
        Err _ -&amp;gt;                                                            &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
            model ! [ Navigation.modifyUrl (Routes.encode model.route) ]

        Ok (ArtistListingPage as route) -&amp;gt;                                  &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
            { model | route = route }
                ! [ Cmd.map ArtistListingMsg ArtistListing.mountCmd ]

        -- rest left out for brevity

        Ok ((NewArtistAlbumPage artistId) as route) -&amp;gt;                      &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
            { model
                | route = route
                , albumDetailModel = AlbumDetail.initForArtist artistId
            }
                ! [ Cmd.map AlbumDetailMsg AlbumDetail.mountNewAlbumCmd ]

        Ok route -&amp;gt;                                                         &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
            { model | route = route } ! []&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If url parsing for a new url fails we just change the url back to url for the current route(/page)
It might be  appropriate to show an error of some sort error.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When the we change url to the artist listing page we wish to initiate the http request for retrieving
artists from our backend. That&amp;#8217;s where ArtistListing.mountCmd comes into the picture.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;In addition to providing an effect, we need to ensure that the albumDetailModel starts with a clean slate
when the page for adding a new album is displayed. It might have been a good idea to separate this out to it&amp;#8217;s own component to avoid quite a bit of coniditional logic.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;For any other url changes we just update the route field in our model.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;strong&gt;What&amp;#8217;s up with the &lt;code&gt;! []&lt;/code&gt; thing ?&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;code&gt;!&lt;/code&gt; is a shorthand infix function with the following signature &lt;code&gt;(!) : model &amp;#8594; List (Cmd msg) &amp;#8594; (model, Cmd msg)&lt;/code&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;model ! [someCmd, someOtherCmd] == (model, Cmd.batch [someCmd, SomeOtherCmd])&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_just_a_little_more_on_the_main_update_function_related_to_navigation&quot;&gt;Just a little more on the main update function, related to navigation&lt;/h4&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;update : Msg -&amp;gt; Model -&amp;gt; ( Model, Cmd Msg )
update msg model =
    case msg of

        -- other actions left out

        Navigate url -&amp;gt;
            model ! [ Navigation.newUrl url ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The navigate message triggers a call to the Navigation.newUrl function. That will step to a new url
and update the browser history. You&amp;#8217;ll see in the next chapter were we trigger this message.&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;update : Action -&amp;gt; Model -&amp;gt; ( Model, Effects Action )
update action model =
  case action of

    -- other actions left out

    RouterAction routeAction -&amp;gt;
      TransitRouter.update routerConfig routeAction model&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This is a elm-transit-router specific handler that takes care of starting and stopping animation transitions
+ updating the route field of our model.&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_view&quot;&gt;View&lt;/h4&gt;
&lt;table class=&quot;tableblock frame-all grid-all spread&quot;&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;col style=&quot;width: 50%;&quot;&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.17&lt;/th&gt;
&lt;th class=&quot;tableblock halign-left valign-top&quot;&gt;0.16&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;view : Model -&amp;gt; Html Msg
view model =
    div
        [ class &quot;container-fluid&quot;
        , Routes.catchNavigationClicks Navigate  &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
        ]
        [ menu model
        , div [ class &quot;content&quot; ]
            [ contentView model ]                &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
        ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Here our catch all navigation related clicks helper function comes into play. So for any navigation related clicks, we return a &lt;code&gt;Navigate&lt;/code&gt; msg with a payload of the url to navigate to.
This is will be handled in our top level update function as outlined in the previous chapter.
I&amp;#8217;m not sold on it being a good solution, but it works !&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;we have already shown how the &lt;code&gt;contentView&lt;/code&gt; function pattern matches on the route field of our model to render the appropriate page view.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&quot;tableblock halign-left valign-top&quot;&gt;&lt;div&gt;&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;view : Signal.Address Action -&amp;gt; Model -&amp;gt; Html
view address model =
  div
    [ class &quot;container-fluid&quot; ]
    [ menu address model
    , div
        [ class &quot;content&quot;
        , style (TransitStyle.fadeSlideLeft     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
                  100
                  (getTransition model))
        ]
        [ contentView address model ]
    ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This is particulars related to animations performed when making page transtions from the elm-transit-* packages.
That part got lost in our upgrade adventure, but should be possible to plug back in in the future should we want to.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_summary&quot;&gt;Summary&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Most of the changes went really smoothly and quickly. I did have to spend a little bit of time to get familiar with the new navigation and url-parser package, but they are pretty intuitive.
I wouldn&amp;#8217;t be lying if I said I spent much more time on writing this blog post than doing the upgrade.
I also did quite a few changes to the implementation of details I haven&amp;#8217;t shown you, just because I&amp;#8217;ve become more confident with Elm than I was when writing the previous episodes.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;It was quite a bit of changes in terms of LOC&amp;#8217;s and I have to be honest and tell you it&amp;#8217;t didn&amp;#8217;t work once everything compiled. But you can hardly blame Elm for that,
it was all my bad. I hadn&amp;#8217;t tested the route parsing properly and ended up implementing a loop. Kind of like a redirect loop, but all in js and out of reach for the browser.
Firing up the inline repl in Light Table and interactively testing the parser quickly showed me the errors of my ways.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;All in all I have to say the upgrade was a really fun and enjoyable ride. I can definately say that
0.17 made the App turn out much nicer.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;div class=&quot;title&quot;&gt;What&amp;#8217;s next ?&lt;/div&gt;
&lt;p&gt;Hard to say for sure, but my current thinking is to start looking at auth using JWT web tokens.
Time will tell if that&amp;#8217;s what it&amp;#8217;ll be.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_appendix&quot;&gt;Appendix&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Unfortunately the 0.17 release left elm-reactor a bit behind in terms of what it supports.
From my past experience with ClojureScript, I have gotten used to the feeback  loop you get by using the wonderful &lt;a href=&quot;https://github.com/bhauman/lein-figwheel&quot;&gt;figwheel&lt;/a&gt;.
elm-reactor unfortunately doesn&amp;#8217;t come close to that currently, so I had to turn to JS land for alternatives. After some evalutation and trials I ended up using
&lt;a href=&quot;https://github.com/fluxxu/elm-hot-loader&quot;&gt;elm-hot-loader&lt;/a&gt;. It has worked out really nicely even though I ended up pulling down a fair chunk of the npm package repo.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;m sure elm-reactor will be back with a vengeance in the not so distant future, packing some really cool and unique features.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Elm Maybe - Dealing with null/Nothing</title>
      <link>http://rundis.github.io/blog/2016/elm_maybe.html</link>
      <pubDate>Thu, 7 Apr 2016 00:00:00 +0200</pubDate>
      <guid isPermaLink="false">2016/elm_maybe.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;If you have worked with JavaScript (or quite a few other languages that embrace null) I bet you have had one or two errors that can be
traced back to an unexpected null reference. Some of them are obvious, but others are really tricky to
track down. I&amp;#8217;m sure most of you are well aware that quite a few other languages banishes null and introduces a Maybe or Option type to handle nothingness.
Elm is one of those languages. Before I started looking at Elm I hadn&amp;#8217;t really worked with Maybe types. In this blogpost
I thought I&amp;#8217;d share a little more insight on how to work with them in Elm. I&amp;#8217;ll also briefly cover how they might be (or not) used in JavaScript for reference.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_elm_maybe&quot;&gt;Elm Maybe&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Elm is a statically typed language which compiles down to JavaScript. Types is a core ingredient of Elm, that&amp;#8217;s not the case with JavaScript obviously.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type Maybe a = Just a | Nothing&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The Maybe type in Elm looks deceivingly simple. And actually it is.
The type is parameterized and the &lt;code&gt;&lt;strong&gt;a&lt;/strong&gt;&lt;/code&gt; is a placeholder for a concrete type in your program.
So &lt;code&gt;&lt;strong&gt;a&lt;/strong&gt;&lt;/code&gt; here means any type (Int, String, Float etc). A Maybe can have one of two values; either &lt;code&gt;Just&lt;/code&gt; some value of type &lt;code&gt;a&lt;/code&gt; or it is &lt;code&gt;Nothing&lt;/code&gt;.
Where does &lt;code&gt;Just&lt;/code&gt; and &lt;code&gt;Nothing&lt;/code&gt; come from ? Are they defined somewhere else ? They are part of the type definition, think of them as tags. The name of these &quot;tags&quot;
must start with an upper case letter in Elm.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;x = Just 0.0 -- Just 0.0 : Maybe.Maybe Float   &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;

y = Nothing  -- Nothing : Maybe.Maybe a        &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The variable x Maybe with the tag Just and the Float value 0.0 (Maybe lives in a namespace or rather module in Elm called Maybe, that&amp;#8217;s why the actual type definitions states &lt;strong&gt;Maybe.&lt;/strong&gt;Maybe)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The variable y becomes a Maybe with the tag Nothing. Nothing has no value, and hence no value type associated. Nothing is Nothing, but it&amp;#8217;s still a Maybe though :-)&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_quick_detour_type_annotations&quot;&gt;Quick detour - Type annotations&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Elm is a statically typed language, everything is represented through types. So before
we carry on I&amp;#8217;d like to briefly cover the concept of type annotations.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Since JavaScript doesn&amp;#8217;t have types, I&amp;#8217;ll use Java as a comparable example&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Sample Java functions&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;public int increment(int value) {
  return value++;
}

public int add (int x, int y) {
  return x + y;
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Type annotated equivalents in Elm&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;increment : Int -&amp;gt; Int         &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
increment value =
  value = value + 1


add : Int -&amp;gt; Int -&amp;gt; Int        &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
add x y =
  x + y&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The type annotation for increment tells us it is a function which takes an argument of type &lt;code&gt;Int&lt;/code&gt; and returns an &lt;code&gt;Int&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;add takes two arguments of type Int and returns a an &lt;code&gt;Int&lt;/code&gt;. So think of the last one as return type.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Type annotations in Elm are optional, because the compiler is able to infer the types statically.
Most people tend to use type annotations because they provide very useful documentation.
When working with Elm it&amp;#8217;s really something you quickly have to learn, because most documentation will use them
and the Elm compiler will most certainly expose you to them.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_getting_the_actual_values_from_a_maybe&quot;&gt;Getting the actual values from a Maybe&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Ok so I have this maybe thing which can be a Just some value or Nothing. But how do I get
hold of the value so I can work with it ?&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Pattern matching&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;myList : List String                      &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
myList = [&quot;First&quot;, &quot;Second&quot;]              &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;


-- List.head : List a -&amp;gt; Maybe.Maybe a    &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;


case List.head myList of                  &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
  Nothing -&amp;gt;                              &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
    &quot;So you gave me an empty list!&quot;

  Just val -&amp;gt;                             &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
    val

-- returns &quot;First&quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Type annotation for myList. It is a List of String. It&amp;#8217;s just a value, so that&amp;#8217;s why there is no arrows in the type annotation&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We are using a list literal to define our list. Each list item must be separated by a comma. It&amp;#8217;s also worth noting, that every item in the list must be of the same type. You can&amp;#8217;t mix Strings with Ints etc. The Elm compiler will yell at you if you try&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;I&amp;#8217;ve added the type annotation for the List.head function. Given a List of values with type &lt;code&gt;a&lt;/code&gt; it will return a Maybe of type &lt;code&gt;a&lt;/code&gt;. &lt;code&gt;List.head&lt;/code&gt; returns the first item of a List. The reason it returns a Maybe is because the List might be empty.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;You can think of &lt;code&gt;case&lt;/code&gt; as a switch statement on stereoids. Since List.head return a Maybe we have to possible case&amp;#8217;s we need to handle&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;In this instance we can see from the code this case will never happen, we know myList contains items. The Elm compiler is really smart, but not that smart so it doesn&amp;#8217;t know the list is empty.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This case unwraps the value in our Just so that we can use it. We just return the value, which would be &quot;First&quot;.
The value is unwrapped using something called pattern matching. In JavaScript terms you might think of it as destructuring&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;div class=&quot;title&quot;&gt;The Maybe module&lt;/div&gt;
&lt;p&gt;The Maybe type is defined in a module called &lt;code&gt;Maybe&lt;/code&gt;. In addition to the Maybe type it also includes a collection
of handy functions that makes it handy to work with Maybe types in various scenarios.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Some sample data setup&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;myList = [&quot;First&quot;, &quot;Second&quot;, &quot;Third&quot;]

first = List.head myList
second = List.head (List.drop 1 myList)
tail = List.tail myList -- Just [&quot;Second&quot;,&quot;Third&quot;] : Maybe (List String)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Handling defaults&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;-- Maybe.withDefault : a -&amp;gt; Maybe a -&amp;gt; a                                         &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
Maybe.withDefault &quot;No val&quot; first -- -&amp;gt; &quot;First&quot;                                   &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
Maybe.withDefault &quot;No val&quot; (List.head []) -- -&amp;gt; &quot;No val&quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Maybe.withDefault&lt;/code&gt; takes a default value of type &lt;code&gt;a&lt;/code&gt; a Maybe of type &lt;code&gt;a&lt;/code&gt;. It returns the value of the maybe if it has a value (tagged &lt;code&gt;Just&lt;/code&gt;) otherwise it returns the provided default value&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;In the first example first is &lt;code&gt;Just &quot;First&quot;&lt;/code&gt; so it unwraps the value and returns that. In the second example there is no value so it returns the provided default&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Mapping&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;-- Maybe.map : (a -&amp;gt; b) -&amp;gt; Maybe a -&amp;gt; Maybe b                                    &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
Maybe.map String.toUpper first -- -&amp;gt; Just &quot;FIRST&quot;                                &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
Maybe.map String.toUpper Nothing -- -&amp;gt; Nothing


-- Maybe.map2 (a -&amp;gt; b -&amp;gt; c) -&amp;gt; Maybe a -&amp;gt; Maybe b -&amp;gt; Maybe c                     &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
Maybe.map2 (\a b -&amp;gt; a ++ &quot;, &quot; b) first second -- -&amp;gt; Just &quot;First, Second&quot;         &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
Maybe.map2 (\a b -&amp;gt; a ++ &quot;, &quot; b) first Nothing -- -&amp;gt; Nothing
Maybe.map2 (++) first second -- -&amp;gt; Just &quot;First, Second&quot;                          &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Maybe.map&lt;/code&gt; takes a function which has the signature (a &amp;#8594; b), that means a function that takes any value of type a and return a value of type b (which can be the same type or a completely different type). The second argument is a Maybe (of type &lt;code&gt;a&lt;/code&gt;). The return value is a Maybe of type &lt;code&gt;b&lt;/code&gt;. So Maybe.map unwraps the second argument, applies the provided function and wraps the result of that in a Maybe which in turn is returned.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;String.toUpper takes a String (&lt;code&gt;a&lt;/code&gt; if you like) and returns a String (&lt;code&gt;b&lt;/code&gt; if you like). String.toUpper doesn&amp;#8217;t understand Maybe values, so to use it on a Maybe value we can use Maybe.map&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Maybe.map2&lt;/code&gt; is similar to &lt;code&gt;Maybe.map&lt;/code&gt; but the function in the first argument takes two in parameters. In addition to the function param we provide two Maybe values. These two doesn&amp;#8217;t need to be of the same type, but happens to be so in our example. There is also map3, map4 etc up to map8&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If any or both of the two Maybe params are &lt;code&gt;Nothing&lt;/code&gt; the result will be Nothing.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;In the example above we used an anonymous function (lambda). However &lt;code&gt;++&lt;/code&gt; is actually a function that takes two arguments so we can use that as the function argument&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Piping&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;-- Maybe.andThen Maybe.Maybe a -&amp;gt; (a -&amp;gt; Maybe b) -&amp;gt; Maybe b                      &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
Maybe.andThen tail List.head  -- -&amp;gt; Just &quot;Second&quot;                                &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
tail `Maybe.andThen` List.head -- -&amp;gt; Just &quot;Second&quot;                               &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;

tail
  `Maybe.andThen` List.head
  `Maybe.andThen` (\s -&amp;gt; Just (String.toUpper s))   -- -&amp;gt; Just &quot;SECOND&quot;          &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;


Just []
  `Maybe.andThen` List.head
  `Maybe.andThen` (\s -&amp;gt; Just (String.toUpper s))   -- -&amp;gt; Nothing                &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Maybe.andThen&lt;/code&gt; resembles &lt;code&gt;Maybe.map&lt;/code&gt; but there are two vital differences. The function argument comes as the second param (we&amp;#8217;ll come back to why), secondly the function in the function argument must return a Maybe rather than a plain value.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The first argument &lt;code&gt;tail&lt;/code&gt; is a Maybe, the second argument is List.head which is a function that takes a list as an argument and returns a Maybe, so that conforms to the function params signature required by Maybe.andThen&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;In this version we use the infix version of &lt;code&gt;andThen&lt;/code&gt; (marked by backticks before and after). This is the reason the function argument comes second, so you typically use &lt;code&gt;Maybe.andThen&lt;/code&gt; when you you need to work with maybes in a pipeline sort of fashion.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This is an example of piping values when dealing with Maybe values. We start with the tail of our list and then we pick out the head of that list and then we convert the value of that to uppercase&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;You can almost think of &lt;code&gt;andThen&lt;/code&gt; as a callback. If any step of the chain returns Nothing, the chain is terminated and Nothing is returned&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Don&amp;#8217;t like the way Maybe sound, how about rolling your own ?&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type Perhaps a = Absolutely a | NotSoMuch&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Of course interop with others will be an issue and &lt;code&gt;Maybe&lt;/code&gt; has some advantages being part of the core library. But still
if you really really want to&amp;#8230;&amp;#8203;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_javascript_null_undefined&quot;&gt;JavaScript null/undefined&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;function headOfList(lst) {
 if (lst &amp;amp;&amp;amp; lst.length &amp;gt; 0) {
   return lst[0];
 } else {
   // hm... not sure. let&apos;s try null
   return null;
 }
}

function tailOfList(lst) {
 if (lst &amp;amp;&amp;amp; lst.length &amp;gt; 1) then
   return lst.slice(0);
 } else {
   // hm... not sure. let&apos;s try null
   return null;
 }
}



var myList = [&quot;First&quot;, &quot;Second&quot;, &quot;Third&quot;];
var first =  headOfList(myList);  // &quot;First&quot;
var second = headOfList(tailOfLIst(myList))   // &quot;Second&quot;
var tail = tailOfList(lst); // [&quot;First&quot;, &quot;Second&quot;]


first  // &quot;First&quot;

headOfList([]) // null                                                                     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;

first.toUpperCase() // &quot;FIRST&quot;
headOfList([]).toUpperCase() // Type Error: Cannot read property &apos;toUpperCase&apos; of null     &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;

first + &quot;, &quot; + second // &quot;First, Second&quot;
first + &quot;, &quot; + null // &quot;First, null&quot;                                                       &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;


headOfList(tail).toUpperCase() // &quot;SECOND&quot;
headOfList([]).toUpperCase() // Type Error: Cannot read property &apos;toUpperCase&apos; of null     &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;An empty list obviously doesn&amp;#8217;t have a first item.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If this was in a function you might guard against this. But what would you return ? Would you throw a exception ?&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Doesn&amp;#8217;t look to cool, so you would have to make sure you guarded against this case. Let&amp;#8217;s hope you tested that code path, otherwise it&amp;#8217;s lurking there waiting to happen !&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Same as 2&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Okay so most of this cases are pretty silly, we would have to come up with something more real life
with functions calling functions calling functions etc. The bottom line is that you have to deal with it,
but it&amp;#8217;s up to you all the time to make sure nulls or undefined doesn&amp;#8217;t sneak in. In most cases there are simple non verbose
solutions to deal with them, but it&amp;#8217;s also quite easy to miss handling them. If you do it can sometimes be quite a challenge tracking down
the root cause.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;It&amp;#8217;s undoubtably a little more ceremony in Elm, but in return you will not ever get nullpointer exceptions.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_introducing_maybe_in_javascript&quot;&gt;Introducing Maybe in JavaScript&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;If you are from a JavaScript background the blogpost &lt;a href=&quot;https://curiosity-driven.org/monads-in-javascript&quot;&gt;Monads in JavaScript&lt;/a&gt; gives you a little hint on how you could implement Maybe in JavaScript.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Let&amp;#8217;s borrow some code from there and see how some of the examples above might end up looking&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Defining Just and Nothing&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;function Just(value) {
    this.value = value;
}

Just.prototype.bind = function(transform) {
    return transform(this.value);
};

Just.prototype.map = function(transform) {
    return new Just(transform(this.value));
};


Just.prototype.toString = function() {
    return &apos;Just(&apos; +  this.value + &apos;)&apos;;
};

var Nothing = {
    bind: function() {
        return this;
    },
    map: function() {
      return this;
    },
    toString: function() {
        return &apos;Nothing&apos;;
    }
};&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;A few helper functions for dealing with JavaScript arrays&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;function listHead(lst) {
  return lst &amp;amp;&amp;amp; list.length &amp;gt; 0 ? new Just(lst[0]) : Nothing;
}

function listTail() {
  return lst &amp;amp;&amp;amp; list.length &amp;gt; 1 ? new Just(lst.slice[1]) : Nothing;
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Elm examples in JavaScript with Maybe&amp;#8217;ish support&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;var myList = [&quot;First&quot;, &quot;Second&quot;, &quot;Third&quot;];
var first =  listHead(myList);
var second = listTail(myList).bind(t =&amp;gt; listHead(t));
var tail =   listTail(myList);



// Similar to Maybe.map in Elm
first.map(a =&amp;gt; a.toUpperCase()) // Just {value: &quot;FIRST&quot;}                                        &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
Nothing.map(a =&amp;gt; a.toUpperCase()) // Nothing (object)                                           &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;

// Similar to Maybe.map2 in Elm
first.bind(a =&amp;gt; second.map( b =&amp;gt; a + &quot;, &quot; + b))  // Just { value: &apos;First, Second&apos; }             &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
first.bind(a =&amp;gt; Nothing.map( b =&amp;gt; a + &quot;, &quot; + b)) // Nothing (object)

// Similar to Maybe.andThen in Elm
tail.bind(a =&amp;gt; listHead(a)).bind(b =&amp;gt; new Just(b.toUpperCase()))   // Just { value: &apos;SECOND&apos; }  &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
new Just([]).bind(a =&amp;gt; listHead(a)).bind(b =&amp;gt; new Just(b.toUpperCase())) // Nothing (object)    &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;first&lt;/code&gt; is a Just object. Since it has a value the arrow function is run as expected&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When the value is Nothing (a Nothing object) toUpperCase is never run and the Nothing object is returned&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;In the arrow function of bind for first we ignore the unwrapped value and call map on second with a new arrow function which now has both the unwrapped value of both a and b. We concatenate the values and the map function ensures the result is wrapped up in a Just object
If you remember the elm case for map2, that was a separate function. Here map is just a convenience to wrap up the innermost value in a Just.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;tail&lt;/code&gt; is a Just object with the value [&quot;First&quot;, &quot;Second&quot;] in the first level arrow function we pick out the head which returns a &lt;code&gt;Just&lt;/code&gt; object with the value &quot;Second&quot;. In the innermost arrow level function we do upperCase on the value and wrap in it a Just which is the end result.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We are starting with Just with a value of an empty array. In the first level arrow function we try to pick out the head of the list. Since that will return a Nothing object, Nothing passes straight through the second level arrow function, never executing the toUpperCase call.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So as you can see it is possible to introduce the notion of Maybe in JavaScript. There are several libraries out there to choose from
I haven&amp;#8217;t really tried any of them. Regardless the issue you&amp;#8217;ll be facing is that the other libraries you are using probably won&amp;#8217;t be using your representation of Maybe if at all.
But hey, maybe it&amp;#8217;s better with something than nothing. Or whatever.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_wrapping_up&quot;&gt;Wrapping up&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;There is clearly a slight cost with explicitly handling nothingness everywhere. In Elm you basically don&amp;#8217;t even have a choice. The type system
and the compiler will force you into being explcit about cases when you don&amp;#8217;t have a value. You can achieve the same as with null but
you always have to handle them. In your entire program. The most obvious benefit you get, is that you simply will not get null reference related errors in Elm. When calling any function
that accepts Maybe values as input params or return Maybe values you will be made well aware of that. The compiler will let you know, but typically you would also see type annotations stating this fact too.
This explicitness is actually quite liberating once you get used to it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In JavaScript you can try to be more explicit with nulls. You can even reduce the chances of null pointers ever happening by
introducing a Maybe/Option like concept. Of course &lt;strong&gt;you&lt;/strong&gt; wouldn&amp;#8217;t introduce the possibility of null pointers in your code. However there&amp;#8217;s a pretty big chance
some bozo,responsible for one of the 59 libs you somehow ended up with from npm, have though.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;There are plenty of bigger challenges than null pointer exceptions out there, but if you could avoid them altogether,
surely that must a be of some benefit. I&amp;#8217;ll round off with the obligatory quote from Tony Hoare as you do when one pays tribute to our belowed null.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;quoteblock&quot;&gt;
&lt;blockquote&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I call it my billion-dollar mistake. It was the invention of the null reference in 1965. At that time, I was designing the first comprehensive type system for references in an object oriented language (ALGOL W). My goal was to ensure that all use of references should be absolutely safe, with checking performed automatically by the compiler. But I couldn&amp;#8217;t resist the temptation to put in a null reference, simply because it was so easy to implement. This has led to innumerable errors, vulnerabilities, and system crashes, which have probably caused a billion dollars of pain and damage in the last forty years.&lt;/p&gt;
&lt;/div&gt;
&lt;/blockquote&gt;
&lt;div class=&quot;attribution&quot;&gt;
&amp;#8212; Tony Hoare
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Elm package docs preview in Light Table</title>
      <link>http://rundis.github.io/blog/2016/elm_light_docs.html</link>
      <pubDate>Mon, 28 Mar 2016 00:00:00 +0200</pubDate>
      <guid isPermaLink="false">2016/elm_light_docs.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Maybe you are a package author for Elm packages you wish to publish to &lt;a href=&quot;http://package.elm-lang.org/&quot; class=&quot;bare&quot;&gt;http://package.elm-lang.org/&lt;/a&gt;
. Or maybe you are thinking about authoring a package. Before you publish something to the package repo
you have to write documentation for your package. Wouldn&amp;#8217;t it be sweet if you could preview the
generated documentation from the comfort of your editor ?&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The good news is that with the latest (0.3.6) edition of the &lt;a href=&quot;https://github.com/rundis/elm-light&quot;&gt;elm-light&lt;/a&gt; plugin
you can !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_demo&quot;&gt;Demo&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://youtu.be/pAwdVM888wQ&quot;&gt;Link to demo&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;iframe width=&quot;420&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/pAwdVM888wQ&quot; frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Feature highlights&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Preview how the docs will look for each individual module&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The preview is updated whenever you save your (exposed) Elm module file&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Layout pretty close to how it will look on &lt;a href=&quot;http://package.elm-lang.org/&quot; class=&quot;bare&quot;&gt;http://package.elm-lang.org/&lt;/a&gt; once published&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Fast (at least on my machine !)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Minor detail, but the entire preview UI is also implemented in Elm (ultimate dogfooding). It&amp;#8217;s
basically a modified and simplified implementation of the package preview code for &lt;a href=&quot;http://package.elm-lang.org/&quot; class=&quot;bare&quot;&gt;http://package.elm-lang.org/&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_resources&quot;&gt;Resources&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;http://package.elm-lang.org/&quot; class=&quot;bare&quot;&gt;http://package.elm-lang.org/&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/elm-lang/package.elm-lang.org&quot; class=&quot;bare&quot;&gt;https://github.com/elm-lang/package.elm-lang.org&lt;/a&gt; for most of the Elm ui code used&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Check out the plugin: &lt;a href=&quot;https://github.com/rundis/elm-light&quot;&gt;elm-light&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Elm and ClojureScript joining forces in the elm-light plugin</title>
      <link>http://rundis.github.io/blog/2016/elm_light_modules.html</link>
      <pubDate>Mon, 14 Mar 2016 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2016/elm_light_modules.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The &lt;a href=&quot;https://github.com/rundis/elm-light&quot;&gt;elm-light&lt;/a&gt; plugin provides a pretty useful
featureset for developing elm applications. Until now all features have been implemented
using a combination of ClojureScript and JavaScript. But wouldn&amp;#8217;t it be cool if the plugin
implemented Elm features using Elm where that&amp;#8217;s feasible ? Elm compiles to JavaScript and
JavaScript interop in ClojureScript is quite easy so it shouldn&amp;#8217;t be that hard really.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;If nothing else I thought it would be a fun challenge, so I set forth and decided to implemented
a simple module browser for Elm projects.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_elm_for_the_ui&quot;&gt;Elm for the UI&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In Elm it&amp;#8217;s recommended that you follow &lt;a href=&quot;https://github.com/evancz/elm-architecture-tutorial&quot;&gt;The Elm Architecture&lt;/a&gt; (AKA: TEA).
You model your Elm application and components into 3 separate parts; Model, View and Update.
The easiest way to get started with implementing something following TEA is using the &lt;a href=&quot;https://github.com/evancz/start-app&quot;&gt;start-app&lt;/a&gt; package.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_model&quot;&gt;Model&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Quite often you&amp;#8217;ll find that you start by thinking about how to design your model.
This was also the case for me when developing the module browser.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type alias Model =                     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  { allModules : List Modul
  , filteredModules : List Modul
  , searchStr : String
  , selected : Maybe Modul
  }


type alias Modul =                     &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  { name : String
  , file : String
  , packageName : String
  , version : String
  }&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The model is quite simple and contains; a list of all modules, the currently filtered modules, the search string entered by the user and the currently selected module&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Since Module is a reserved word in Elm the type used for representing a project Module is doofily named &lt;code&gt;Modul&lt;/code&gt;.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
For more info about what Elm modules are check out the &lt;a href=&quot;https://github.com/elm-guides/elm-for-js/blob/master/Modules%2C%20Exports%2C%20and%20Imports.md#modules-and-files&quot;&gt;elm-guides&lt;/a&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_update&quot;&gt;UPDATE&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Update is where we actually implement the logic of our Elm application. I won&amp;#8217;t cover
all the details, but let&amp;#8217;s walk through the most important bits.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type Action                                             &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  = NoOp
  | Filter String
  | Prev
  | Next
  | Select
  | ClickSelect String
  | Close
  | Refresh (List Modul)


update : Action -&amp;gt; Model -&amp;gt; ( Model, Effects Action )  &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
update action model =
  case action of
    NoOp -&amp;gt;                                            &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
      ( model, Effects.none )

    Filter str -&amp;gt;                                      &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
      let
        filtered =
          filterModules str model.allModules

        sel =
          List.head filtered
      in
        ( { model
            | searchStr = str
            , filteredModules = filtered
            , selected = sel
          }
        , Effects.none
        )

    Prev -&amp;gt;                                           &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
      ( { model | selected = prevModule model }
      , notifyChangeSelection
      )

    Next -&amp;gt;
      ( { model | selected = nextModule model }
      , notifyChangeSelection
      )

    Select -&amp;gt;                                         &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
      case model.selected of
        Nothing -&amp;gt;
          ( model, Effects.none )

        Just x -&amp;gt;
          ( model
          , notifySelect x.file
          )

    ClickSelect file -&amp;gt;                               &lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;(7)&lt;/b&gt;
      ( model
      , notifySelect file
      )

    Close -&amp;gt;                                          &lt;i class=&quot;conum&quot; data-value=&quot;8&quot;&gt;&lt;/i&gt;&lt;b&gt;(8)&lt;/b&gt;
      ( model, notifyClose )

    Refresh modules -&amp;gt;                                &lt;i class=&quot;conum&quot; data-value=&quot;9&quot;&gt;&lt;/i&gt;&lt;b&gt;(9)&lt;/b&gt;
      ( Model modules modules &quot;&quot; (List.head modules)
      , Effects.none
      )&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The actions that causes changes to the model is represented by a &lt;a href=&quot;https://en.wikipedia.org/wiki/Union_type&quot;&gt;Union Type&lt;/a&gt; called &lt;code&gt;Action&lt;/code&gt;.
If you&amp;#8217;re not sure what union type means, think of it as a Enum on stereoids.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The update function takes an action and the current model as parameters and returns
a tuple of an (possibly) updated model and an Effect. Effects are basically things that have side-effects (http/ajax, interacting with the browser etc).
We treat an effect like a value in the application, the Elm runtime takes care of actually executing it.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;NoOp&lt;/code&gt; is just that. It&amp;#8217;s handy when initializing the app and also for mapping effects to when there are
effects that we don&amp;#8217;t care about in the context of this update function&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Whenever the user changes the search string input the Filter action is called. It uses a  &lt;code&gt;filterModules&lt;/code&gt; helper function
to filter modules with names starting with the given search string. We default the selected
module to the first in the filtered results. The model is NOT mutated, rather we return a new updated model.
Elm keeps track of our global model state !&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Prev&lt;/code&gt; and &lt;code&gt;Next&lt;/code&gt; selects/highlights the next/previous module given the currently selected one.
The &lt;code&gt;notifyChangeSelection&lt;/code&gt; function call results in an effect that allows us to communicate with the ClojureScript part
of the module browser feature. We&amp;#8217;ll get back to that further on.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The &lt;code&gt;Select&lt;/code&gt; action is triggered when the users presses Enter. It selects the module and should
ultimately result in opening the Elm Module file. Again to make that happen we need to communicate
with our ClojureScript backend. This is achived through the &lt;code&gt;notifySelect&lt;/code&gt; helper function.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;7&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;ClickSelect&lt;/code&gt; is similar to &lt;code&gt;Select&lt;/code&gt; but handles when the user uses the mouse to select a module.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;8&quot;&gt;&lt;/i&gt;&lt;b&gt;8&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Close&lt;/code&gt; - When the user presses the escape key, the module browser should close. Again we
need to notify the ClojureScript backend&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;9&quot;&gt;&lt;/i&gt;&lt;b&gt;9&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;To populate the Module browser ui with modules the &lt;code&gt;Refresh&lt;/code&gt; action is called. This action
is actually triggered by our ClojureScript backend.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Before we dive into more details about the interop with ClojureScript, let&amp;#8217;s quickly go through
the view rendering logic.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_view&quot;&gt;VIEW&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The view part in Elm is also entirely functional and you as an application developer
never touches the DOM directly. Given the current &lt;code&gt;Model&lt;/code&gt; you tell Elm what the view should look
like, and Elm (through the use of &lt;a href=&quot;https://github.com/Matt-Esch/virtual-dom&quot;&gt;Virtual DOM&lt;/a&gt;) takes care of efficiently
updating the DOM for you.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The view for the module browser is really quite simple and consist of a search input field
and an ul for listing the modules.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;http://rundis.github.io/blog/2016/modulebrowser.png&quot; alt=&quot;modulebrowser&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;view : Signal.Address Action -&amp;gt; Model -&amp;gt; Html                                     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
view address model =
  div
    [ class &quot;filter-list&quot; ]                                                       &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    [ searchInputView address model
    , ul
        []
        (List.map (\m -&amp;gt; itemView address m model) model.filteredModules)         &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
    ]


searchInputView : Signal.Address Action -&amp;gt; Model -&amp;gt; Html                          &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
searchInputView address model =
  let
    options =
      { preventDefault = True, stopPropagation = False }

    keyActions =
      Dict.fromList [ ( 38, Prev ), ( 40, Next ), ( 13, Select ), ( 27, Close ) ] &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;

    dec =
      (Json.customDecoder                                                         &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
        keyCode
        (\k -&amp;gt;
          if Dict.member k keyActions then
            Ok k
          else
            Err &quot;not handling that key&quot;
        )
      )

    handleKeydown k =                                                             &lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;(7)&lt;/b&gt;
      Maybe.withDefault NoOp (Dict.get k keyActions) |&amp;gt; Signal.message address
  in
    input                                                                         &lt;i class=&quot;conum&quot; data-value=&quot;8&quot;&gt;&lt;/i&gt;&lt;b&gt;(8)&lt;/b&gt;
      [ value model.searchStr
      , class &quot;search&quot;
      , type&apos; &quot;text&quot;
      , placeholder &quot;search&quot;
      , on &quot;input&quot; targetValue (\str -&amp;gt; Signal.message address (Filter str))
      , onWithOptions &quot;keydown&quot; options dec handleKeydown
      ]
      []


itemView : Signal.Address Action -&amp;gt; Modul -&amp;gt; Model -&amp;gt; Html
itemView address mod model =                                                     &lt;i class=&quot;conum&quot; data-value=&quot;9&quot;&gt;&lt;/i&gt;&lt;b&gt;(9)&lt;/b&gt;
  let
    pipeM =                                                                      &lt;i class=&quot;conum&quot; data-value=&quot;10&quot;&gt;&lt;/i&gt;&lt;b&gt;(10)&lt;/b&gt;
      flip Maybe.andThen

    itemClass =                                                                  &lt;i class=&quot;conum&quot; data-value=&quot;11&quot;&gt;&lt;/i&gt;&lt;b&gt;(11)&lt;/b&gt;
      model.selected
        |&amp;gt; pipeM
            (\sel -&amp;gt;
              if (sel == mod) then
                Just &quot;selected&quot;
              else
                Nothing
            )
        |&amp;gt; Maybe.withDefault &quot;&quot;
  in
    li
      [ class itemClass
      , onClick address (ClickSelect mod.file)
      ]
      [ p [] [ text mod.name ]
      , p [ class &quot;binding&quot; ] [ text (mod.packageName ++ &quot; - &quot; ++ mod.version) ]
      ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The main &lt;code&gt;view&lt;/code&gt; function takes an Address and the current Model as input and returns
a virtual &lt;code&gt;HTML&lt;/code&gt; that represents the UI we want rendered. In Elm we use something called mailboxes
to respond to user interactions. Check out the note section below for more details if you&amp;#8217;re interested.
In short the address param is the address to a given mailbox. Elm picks up any messages in the mailbox, handles them
and ultimately the results flow back to our application through the previously described &lt;code&gt;update&lt;/code&gt; function.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;All HTML tags have a corresponding function and all follow the same pattern. The first argument is a list of attributes,
the second is a list of sub elements.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The beauty of everything being a function (as opposed to templating languages) is that you have the full power of the language
to construct your view. Map, filter, reduce etc to your heart&amp;#8217;s content.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The &lt;code&gt;searchInputView&lt;/code&gt; function renders the search input field. This is where most of the user interaction stuff happens
so it&amp;#8217;s naturally the most complex part of the UI.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We use the Dict type to represent key/values. Think map if you&amp;#8217;re from a Clojure background! The &lt;code&gt;keyActions&lt;/code&gt;
map lists the keycode and update action combo we are interested in handling.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We want to intercept just the given keyCodes everything else should flow through and update the searchStr in our model.
To support that we need to implement a custom decoder for the keydown event.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;7&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;You can read &lt;code&gt;handleKeydown&lt;/code&gt; as follows, if the keyCode lookup for the given k returns an &lt;code&gt;Action&lt;/code&gt; use that
otherwise use the default &lt;code&gt;NoOp&lt;/code&gt; action. The result from that is used as the last param of the &lt;code&gt;Signal.message&lt;/code&gt; function.
(In Clojure terms you can think of &lt;code&gt;|&amp;gt;&lt;/code&gt; as thread-last). Signal.message sends the given action to the given address.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;8&quot;&gt;&lt;/i&gt;&lt;b&gt;8&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The search input handles changes to the input by triggering the &lt;code&gt;Filter&lt;/code&gt; action with a payload
which is the current value of the input. To handle the special characters we handle the keydown event using
the local helper function we outlined in &amp;lt;7&amp;gt;.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;9&quot;&gt;&lt;/i&gt;&lt;b&gt;9&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;itemView&lt;/code&gt; constructs the view for each individual item. Most of the logic here is related to giving the
currently selected item it&amp;#8217;s own css class.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;10&quot;&gt;&lt;/i&gt;&lt;b&gt;10&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Maybe.andThen is a function to help you chain &lt;a href=&quot;http://elm-lang.org/guide/model-the-problem#banishing-null&quot;&gt;maybes&lt;/a&gt;.
(There is no such thing as null/nil in Elm !). &lt;code&gt;flip&lt;/code&gt; flips the order of the two first arguments, and we do it to allow us to chain calls using the &lt;code&gt;|&amp;gt;&lt;/code&gt; operator&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;11&quot;&gt;&lt;/i&gt;&lt;b&gt;11&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If an item is selected and the selected item is the same as the current module being rendered then the class should be &lt;code&gt;selected&lt;/code&gt; in all other cases
the class is an empty string.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
To understand more about Mailboxes, Addresses and the term Signal in Elm. You might want
to check out the relevant  &lt;a href=&quot;http://elm-lang.org/guide/reactivity&quot;&gt;Elm docs&lt;/a&gt; or maybe this &lt;a href=&quot;https://medium.com/@diamondgfx/understanding-elm-signals-mailboxes-addresses-and-actions-7932781396ef#.hsyq1b5c9&quot;&gt;nice blog post&lt;/a&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_interop_with_clojurescript_using_ports&quot;&gt;Interop with ClojureScript using Ports&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Interop with JavaScript in Elm goes through strict boundaries and use a mechanism called &lt;a href=&quot;http://elm-lang.org/guide/interop#ports&quot;&gt;ports&lt;/a&gt;.
The strict boundary is in place to ensure that you can&amp;#8217;t get runtime exceptions in Elm (due to nulls, undefined is not a function, type mismatches etc etc).
At first it feels a little bit cumbersome, but really the guarantees given from Elm makes up for it in the long run. Big time.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
The following blog post really helped me out when doing the ports stuff; &lt;a href=&quot;http://danielbachler.de/2016/02/26/ports-in-elm.html&quot;&gt;&quot;Ports in Elm&quot;&lt;/a&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;-- Inbound

modzSignal : Signal Action                     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
modzSignal =
  Signal.map Refresh modzPort


port modzPort : Signal (List Modul)            &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;



-- Outbound

selectMailbox : Signal.Mailbox String          &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
selectMailbox =
  Signal.mailbox &quot;&quot;


port select : Signal String                    &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
port select =
  selectMailbox.signal


changeSelectionMailbox : Signal.Mailbox ()     &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
changeSelectionMailbox =
  Signal.mailbox ()


port changeSelection : Signal ()               &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
port changeSelection =
  changeSelectionMailbox.signal


closeMailbox : Signal.Mailbox ()
closeMailbox =
  Signal.mailbox ()


port close : Signal ()
port close =
  closeMailbox.signal&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Signals are basically values that changes over time. A signal always has a value.
If you remember our &lt;code&gt;update&lt;/code&gt; function, it takes an &lt;code&gt;Action&lt;/code&gt; as the first argument. To allow
our incoming module list to trigger an update we need to convert the value we receive from the
&lt;code&gt;modzPort&lt;/code&gt; to a &lt;code&gt;Refresh&lt;/code&gt; action (with a payload which is a List of &lt;code&gt;Modul&lt;/code&gt; records)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;modzPort&lt;/code&gt; is a port which is a Signal that receives values from outside of Elm. Typically JavaScript
or in our instance ClojureScript. A Signal always has a value, so you will see that we need to provide an initial value
when we start the elm app from ClojureScript later on.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When using the &lt;a href=&quot;https://github.com/evancz/start-app&quot;&gt;Elm start app package&lt;/a&gt; we typically use mailboxes to
achieve (side-) effects. So to send messages to JavaScript (or ClojureScript!) we create an intermediary mailbox
to communicate through an outgoing port. When we select a module in the module browser we send the file name of the module
we wish to open and the type of the file name is &lt;code&gt;String&lt;/code&gt;. Hence the Mailbox is a mailbox for string messages.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The &lt;code&gt;select&lt;/code&gt; port is a Signal of Strings (file names) that we can subscribe to from JavaScript(/ClojureScript).
You can think of it as an Observable (in RxJs terms) or maybe simpler an event emitter if you like.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;()&lt;/code&gt; in Elm means the same as &lt;code&gt;void&lt;/code&gt; or no value.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When the user changes which module is selected/hightlighted we don&amp;#8217;t care about the value, in this instance we just need to know that the user changed their selection&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_wiring_up_elm_with_start_app&quot;&gt;Wiring up Elm with Start app&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;app : StartApp.App Model                       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
app =
  StartApp.start
    { init = init
    , update = update
    , view = view
    , inputs = [ modzSignal ]                  &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    }


main : Signal Html                             &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
main =
  app.html


port tasks : Signal (Task.Task Never ())       &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
port tasks =
  app.tasks&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;StartApp.start&lt;/code&gt; takes care of wiring up our Elm application. &lt;code&gt;init&lt;/code&gt; creates an initial empty Model, the other functions
we have already described.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;StartApp also takes an inputs argument, here we need to remember to add our &lt;code&gt;modzSignal&lt;/code&gt; so that it
is picked up and handled by StartApp.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;main&lt;/code&gt; is the entry point for any Elm application.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Elm executes side effects through something called &lt;a href=&quot;http://elm-lang.org/guide/reactivity#tasks&quot;&gt;tasks&lt;/a&gt;
I won&amp;#8217;t go into details here, but just remember to add this incantation when using StartApp.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_wrapping_up_the_elm_part&quot;&gt;Wrapping up the Elm part&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Right so that wes pretty much all there is to the Elm part. Of course we also need to remember to compile
the Elm code to JavaScript before we can use it from Light Table.
To do that we use the &lt;code&gt;elm-make&lt;/code&gt; executable that comes with the &lt;a href=&quot;http://elm-lang.org/install&quot;&gt;elm-platform installation&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I can assure you that I didn&amp;#8217;t get a single run time exception whilst developing the Elm part. It did
get lots of helpful compiler errors along the way, but as soon as the compiler was happy the Elm application ran just as expected.
It&amp;#8217;s hard to describe the experience, but trust me, it&amp;#8217;s certainly worth a try !
To be able to easily test and get visual feedback along the way I set up a dummy html page.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Ok let&amp;#8217;s move on to the ClojureScript part were we hook the ui up to the Light Table plugin.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_clojurescript_and_light_table&quot;&gt;ClojureScript and Light Table&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_generating_the_list_of_elm_modules&quot;&gt;Generating the list of Elm Modules&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Unfortunately there isn&amp;#8217;t any API AFAIK that provides the information I wished to present
(ideally all modules and for each module, all it&amp;#8217;s publicly exposed functions/types/values).
So I had to go down a route where I use a combination of the elm project file (elm-package.json) and
artifacts (files) generated when you run &lt;code&gt;elm-make&lt;/code&gt; on your elm project.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn- resolve-module-file [project-path pck-json package module version]                   &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (-&amp;gt;&amp;gt; pck-json
       :source-directories
       (map #(files/join project-path
                         &quot;elm-stuff/packages&quot;
                         package
                         version
                         %
                         (str (s/replace module &quot;.&quot; files/separator) &quot;.elm&quot;)))
       (some #(if (files/exists? %) % nil))))


(defn- get-exposed-modules [project-path {:keys [package exact]}]                          &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  (let [pck-json (u/parse-json-file (files/join project-path
                                                &quot;elm-stuff/packages&quot;
                                                package exact
                                                &quot;elm-package.json&quot;))]
    (-&amp;gt;&amp;gt; pck-json
         :exposed-modules
         (map (fn [x]
                {:name x
                 :packageName package
                 :version exact
                 :file (resolve-module-file project-path pck-json package x exact)})))))


(defn- get-package-modules [project-path]                                                 &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  (-&amp;gt;&amp;gt; (u/get-project-deps project-path)
       (filter :exact)
       (mapcat (partial get-exposed-modules project-path))
       (sort-by :name)))


(defn- deduce-module-name [root-path elm-file-path]                                       &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
  (-&amp;gt; elm-file-path
      (s/replace root-path &quot;&quot;)
      (s/replace &quot;.elm&quot; &quot;&quot;)
      (s/replace #&quot;^/&quot; &quot;&quot;)
      (s/replace files/separator &quot;.&quot;)))


(defn- get-project-modules [project-path]                                                 &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
  (let [pck-json (u/parse-json-file (files/join project-path &quot;elm-package.json&quot;))]
    (-&amp;gt;&amp;gt; (:source-directories pck-json)
         (mapcat (fn [dir]
                   (if (= dir &quot;.&quot;)
                     (-&amp;gt;&amp;gt; (files/ls project-path) ;; fixme: no nesting allowed to avoid elm-stuff etc
                          (filter #(= (files/ext %) &quot;elm&quot;))
                          (map (fn [x]
                                 {:name (deduce-module-name &quot;&quot; x)
                                  :file (files/join project-path x)})))
                     (-&amp;gt;&amp;gt; (files/filter-walk #(= (files/ext %) &quot;elm&quot;) (files/join project-path dir))
                          (map (fn [x]
                                 {:name (deduce-module-name (files/join project-path dir) x)
                                  :file x}))))))
         (map (fn [m]
                (assoc m :packageName (files/basename project-path) :version (:version pck-json))))
         (sort-by :name))))



(defn get-all-modules [project-path]                                                      &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
  (concat
    (get-project-modules project-path)
    (get-package-modules project-path)))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Helper function which tries to resolve the file for a Module from a 3rd party library&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Every 3rd party library also comes with a elm-package.json that lists which module are
publicly exposed. This helper function generates module info for all exposed modules from a 3rd party library&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Given all defined project dependencies for a project at a given project-path this function generates
module informaation for all this packages. It will only try to resolve modules which has a resolved version &lt;code&gt;:exact&lt;/code&gt;, so there is a precondition
that you have run either &lt;code&gt;elm-package&lt;/code&gt; install or &lt;code&gt;elm-make&lt;/code&gt; successfully on your project first.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;deduce-module-name&lt;/code&gt; is a helper function which tries to deduce the module name for an Elm file in your project&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Helper function that takes a simplistic approach to try to find all modules in you project and generate module information for them
It uses the &quot;source-directories&quot; key in your project&amp;#8217;s &lt;code&gt;elm-package.json&lt;/code&gt; as a starting point.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The complete list of modules is a concatination of 3rd party modules and your project modules.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock warning&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-warning&quot; title=&quot;Warning&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
There are a few simplifications in this implementation that might yield incomplete results (and sometimes erronous).
However for the majority of cases it should work fine.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_light_table_sidebar&quot;&gt;Light Table sidebar&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The module browser will live in the right sidebar in Light Table. The following code will
construct the wrapper view and a Light Table object that will allow us to wire up the appropriate
behaviors.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defui wrapper [this]                                             &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
   [:div {:id &quot;elm-module-browser&quot;} &quot;Retrieving modules...&quot;])


(object/object* ::modulebrowser                                   &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
                :tags #{:elm.modulebrowser}
                :label &quot;Elm module browser&quot;
                :order 2
                :init (fn [this]
                        (wrapper this)))

(def module-bar (object/create ::modulebrowser))                  &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;

(sidebar/add-item sidebar/rightbar module-bar)                    &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Helper function to create a wrapper div which will host our module browser&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;A Light Table object (basically an ClojureScript atom) that allows us to tag behaviors.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The object above is instantiated at start up&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We add the module bar to the right hand sidebar in Light Table&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_light_table_behaviors&quot;&gt;Light Table behaviors&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::clear!                                              &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
          :triggers #{:clear!}
          :reaction (fn [this]
                      (cmd/exec! :close-sidebar)))

(behavior ::focus!                                              &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
          :triggers #{:focus!}
          :reaction (fn [this]
                      (let [input (dom/$ &quot;#elm-module-browser input&quot;)]
                        (.focus input))))

(behavior ::ensure-visible                                      &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
          :triggers #{:ensure-visible}
          :reaction (fn [this]
                      (sidebar-cmd/ensure-visible this)))

(behavior ::show-project-modules                                &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
          :triggers #{:show-project-modules}
          :reaction (fn [this prj-path]
                      (let [modules (get-all-modules prj-path)
                            el (dom/$ &quot;#elm-module-browser&quot;)
                            mod-browser (.embed js/Elm js/Elm.ModuleBrowser el (clj-&amp;gt;js {:modzPort []}))] &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;

                        (.send (.-modzPort (.-ports mod-browser)) (clj-&amp;gt;js modules))   &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;

                        ;; set up port subscriptions

                        (.subscribe (.-changeSelection (.-ports mod-browser))          &lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;(7)&lt;/b&gt;
                                    (fn []
                                      (object/raise this :ensure-visible)))

                        (.subscribe (.-select (.-ports mod-browser))
                                    (fn [file]
                                      (cmd/exec! :open-path file)
                                      (object/raise this :clear!)))

                        (.subscribe (.-close (.-ports mod-browser))
                                    (fn []
                                      (object/raise this :clear!)))


                        (object/raise this :focus!))))



(behavior ::list-modules                                     &lt;i class=&quot;conum&quot; data-value=&quot;8&quot;&gt;&lt;/i&gt;&lt;b&gt;(8)&lt;/b&gt;
          :triggers #{:editor.elm.list-modules}
          :reaction (fn [ed]
                      (when-let [prj-path (u/project-path (-&amp;gt; @ed :info :path))]
                        (do
                          (object/raise sidebar/rightbar :toggle module-bar)
                          (object/raise module-bar :show-project-modules prj-path)))))


(cmd/command {:command :show-modulebrowser                  &lt;i class=&quot;conum&quot; data-value=&quot;9&quot;&gt;&lt;/i&gt;&lt;b&gt;(9)&lt;/b&gt;
              :desc &quot;Elm: Show module-browser&quot;
              :exec (fn []
                      (when-let [ed (pool/last-active)]
                        (object/raise ed :editor.elm.list-modules)))})&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This behavior basically closes the module browser sidebar when triggered&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We need to be able to set focus to the search input field when we open the module browser&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Helper behavior that ensures that the currently selected item in the module browser is visible
on the screen. Ie it will scroll the div contents accordingly using a LT core helper function.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This is were we hook everything up. We gather the module information for the given project
instantiate the Elm app, subscribe to outgoing messages(/signals!) and populate the module browser
with the module list.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We start the elm app here and tells it to render in the wrapper div defined previously. We provide
an initial value for the modzPort with an empty list. (Could have provided the gathered list modules here, but wanted to show how you send messages to a inbound Elm port explicitly. See next step)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;To populate the module browser we send a message to the modzPort. Elm port thinks in JavaScript so we need to convert our list of ClojureScript maps to a list of JavaScript objects&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;7&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;To listen to events from the Elm app we call subscribe with a given callback function. In this example
we trigger the ensure-visible behavior when the users moves the selection up or down, to ensure the selected item stays visible.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;8&quot;&gt;&lt;/i&gt;&lt;b&gt;8&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The behaviors above was tied(tagged) to the &lt;code&gt;module-bar&lt;/code&gt; object, however this behavior is tagged to
a currently opened and active elm editor object. Light Table has no concept of projects, so to deduce which project we should
open the module browser for we need a starting point. Any elm file in your project will do. Based on that
we can deduce the root project path. If we find a project we display the module bar view and trigger the behavior
for populating the module browser.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;9&quot;&gt;&lt;/i&gt;&lt;b&gt;9&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Commands are the user interfacing functions that responds to user actions. They can be listed in the command bar in Light Table
and you can assign shortcuts to them. The &lt;code&gt;show-modulebrowser&lt;/code&gt; command triggers the &lt;code&gt;list-modules&lt;/code&gt; behavior.
Commands are available regardless of which editor you trigger them from, this is why we introduced the intermediary &apos;list-modules` behavior
because that allows us to declaritly filter when this behavior will be triggered. You&amp;#8217;ll see how when we describe behaviors wiring in Light Table.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_wiring_up_lt_behaviors&quot;&gt;Wiring up LT behaviors&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In our plugin behaviors file we need to wire up our behaviors.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;[:editor.elm :lt.plugins.elm-light.modulebrowser/list-modules]       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
[:elm.modulebrowser :lt.plugins.elm-light.modulebrowser/clear!]      &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
[:elm.modulebrowser :lt.plugins.elm-light.modulebrowser/show-project-modules]
[:elm.modulebrowser :lt.plugins.elm-light.modulebrowser/focus!]
[:elm.modulebrowser :lt.plugins.elm-light.modulebrowser/ensure-visible]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Here we tell Light Table that only editor objects with the tag &lt;code&gt;:editor.elm&lt;/code&gt;
will respond with the list-modules behavior we described earlier&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Similaritly the other behaviors will only be triggerd by objects tagged with &lt;code&gt;:elm-modulebrowser&lt;/code&gt;.
In our case that would be the &lt;code&gt;module-bar&lt;/code&gt; object we defined.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Why all this ceremony with behaviors ?&lt;/div&gt;
&lt;p&gt;Flexibility! It allows us to easily turn on/off features while Light Table is running. If you wish you could quite easily
create your own implementation for a behavior and replace the one supplied by the plugin.
Or maybe you&amp;#8217;d like to do something in addition for a given behavior trigger.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Okay let&amp;#8217;s be honest. We haven&amp;#8217;t set the world alight with a killer feature that couldn&amp;#8217;t
be accomplished quite easily without Elm. Neither have we created an advanced demo for Elm and ClojureScript integration.
But we&amp;#8217;ve certainly proven that it&amp;#8217;s possible and it wasn&amp;#8217;t particularily difficult.
It somehow feels better with an Elm plugin that has Elm as part of it&amp;#8217;s implementation.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;You can do some pretty awesomly advanced UI&amp;#8217;s with Elm and combing it with ClojureScript is definitely feasible.
I&amp;#8217;ll leave it to you to evaluate if that would ever make sense to do though !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Typed up CRUD SPA with Haskell and Elm - Part 4: Feature creep</title>
      <link>http://rundis.github.io/blog/2016/haskel_elm_spa_part4.html</link>
      <pubDate>Tue, 1 Mar 2016 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2016/haskel_elm_spa_part4.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So the hypothesis from &lt;a href=&quot;http://rundis.github.io/blog/2016/haskel_elm_spa_part3.html&quot;&gt;episode 3&lt;/a&gt; was that it should
be relatively easy to add new features. In this episode we&amp;#8217;ll put that hypothesis to the test and add CRUD features
for Albums. There will be a little refactoring, no testing, premature optimizations and plenty of &quot;let the friendly Elm and Haskell compilers guide us along the way&quot;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Useful resources&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Check out the other &lt;a href=&quot;http://rundis.github.io/blog/tags/haskellelmspa.html&quot;&gt;episodes&lt;/a&gt; in this blog series.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The accompanying &lt;a href=&quot;https://github.com/rundis/albums&quot;&gt;Albums&lt;/a&gt; sample app is on github, and there is a tag
for each episode&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div id=&quot;toc&quot; class=&quot;toc&quot;&gt;
&lt;div id=&quot;toctitle&quot; class=&quot;title&quot;&gt;Table of Contents&lt;/div&gt;
&lt;ul class=&quot;sectlevel1&quot;&gt;
&lt;li&gt;&lt;a href=&quot;#_introduction&quot;&gt;Introduction&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_backend&quot;&gt;Backend&lt;/a&gt;
&lt;ul class=&quot;sectlevel2&quot;&gt;
&lt;li&gt;&lt;a href=&quot;#_stack&quot;&gt;Stack&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_datamodel&quot;&gt;Datamodel&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_bootstrapping&quot;&gt;Bootstrapping&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_new_endpoints_for_albums&quot;&gt;New endpoints for Albums&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_backend_summary&quot;&gt;Backend summary&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_frontend&quot;&gt;Frontend&lt;/a&gt;
&lt;ul class=&quot;sectlevel2&quot;&gt;
&lt;li&gt;&lt;a href=&quot;#_new_routes&quot;&gt;New routes&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_service_api&quot;&gt;Service API&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_the_album_page&quot;&gt;The album page&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_track_row&quot;&gt;Track row&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_main_elm_wiring_it_all_up&quot;&gt;Main.elm wiring it all up&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_frontend_summary&quot;&gt;Frontend summary&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_concluding_remarks&quot;&gt;Concluding remarks&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;When I set out to implement the features for this episode I didn&amp;#8217;t really reflect on how I would then later
go about blogging about it. It turns out I probably did way to many changes to fit nicely into a blog episode.
Let&amp;#8217;s just say I got caught up in a coding frenzy, but let me assure you I had a blast coding for this episode !
This means I wont be going into detail about every change I&amp;#8217;ve made since the last episode, but rather try to highlight
the most important/interesting ones.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;A highlevel summary of changes includes:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;http://docs.haskellstack.org/en/stable/README/&quot;&gt;Haskell stack&lt;/a&gt; has been introduced to the backend&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Implemented REST endpoints for Albums CRUD&lt;/p&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Backend now composes endpoints for Artists and Albums&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Data model changed to account for Album and Track entities&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Bootstrapping of sample data extended and refactored to a separate module&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Implemented UI for listing, deleting, creating, updating and displaying album details&lt;/p&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;In particular the the features for creating/updating Albums and associated tracks, gives a glimpse
of the compasability powers of the &lt;a href=&quot;https://github.com/evancz/elm-architecture-tutorial&quot;&gt;Elm Architecture&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;iframe width=&quot;420&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/RU0NB2xaQIg&quot; frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_backend&quot;&gt;Backend&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_stack&quot;&gt;Stack&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Working with Cabal and Cabal sandboxes is a bit of a pain. &lt;a href=&quot;http://docs.haskellstack.org/en/stable/README/&quot;&gt;Stack&lt;/a&gt; promises to alleviate some of those pains, so I figured
I&amp;#8217;d give it a go. There are probably tutorials/blog posts out there going into how you should go about migrating
to use stack in your Haskell projects, so I won&amp;#8217;t go into any details here.
Basically I installed stack and added a stack configuration file &lt;code&gt;stack.yml&lt;/code&gt;. After that I was pretty much up and running.
The instructions for running the sample app with stack can be found in the Albums &lt;a href=&quot;https://github.com/rundis/albums&quot;&gt;README&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_datamodel&quot;&gt;Datamodel&lt;/h3&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;http://rundis.github.io/blog/2016/albums_db_part4.png&quot; alt=&quot;albums db part4&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The datamodel contains a little bit of flexibility so that a track can be potentially be included in many albums
(hence the album_track entity). For this episode though, we&amp;#8217;re not using that and of course that innocent bit of flexibility
comes with a cost of added complexity. I considered removing the album_track entity, but decided against it. I figured
that in a real project this is a typical example of things you have to deal with (say you have a DBA or even more relevant&amp;#8230;&amp;#8203; and exisiting datamodel you have to live with).
Let&amp;#8217;s run with it, and try to deal with it along the way.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_bootstrapping&quot;&gt;Bootstrapping&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The code for schema creation and bootstrapping test data has been moved to a separate module.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;backend/src/Bootstrap.hs&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;bootstrapDB :: Sql.Connection -&amp;gt; IO ()
bootstrapDB conn = do
  createSchema conn
  populateSampleData conn


createSchema :: Sql.Connection -&amp;gt; IO ()
createSchema conn = do
  executeDB &quot;PRAGMA foreign_keys = ON&quot;
  executeDB &quot;create table artist (id integer primary key asc, name varchar2(255))&quot;
  executeDB &quot;create table track (id integer primary key asc, name varchar2(255), duration integer)&quot;
  executeDB &quot;create table album (id integer primary key asc, artist_id integer, name varchar2(255), FOREIGN KEY(artist_id) references artist(id))&quot;
  executeDB &quot;create table album_track (track_no integer, album_id, track_id, primary key(track_no, album_id, track_id), foreign key(album_id) references album(id), foreign key(track_id) references track(id))&quot;

  where
    executeDB = Sql.execute_ conn


-- definition of sample data omitted for brevity

populateSampleData :: Sql.Connection -&amp;gt; IO ()
populateSampleData conn = do
  mapM_ insertArtist artists
  mapM_ insertTrack tracks
  mapM_ insertAlbum albums
  mapM_ insertAlbumTrack albumTracks

  where
    insertArtist a = Sql.execute conn &quot;insert into artist (id, name) values (?, ?)&quot; a
    insertTrack t = Sql.execute conn &quot;insert into track (id, name, duration) values (?, ?, ?)&quot; t
    insertAlbum a = Sql.execute conn &quot;insert into album (id, artist_id, name) values (?, ?, ?)&quot; a
    insertAlbumTrack at = Sql.execute conn &quot;insert into album_track (track_no, album_id, track_id) values (?, ?, ?)&quot; at&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Somewhat amusing that foreign key constraints are not turned on by default in SQLite, but hey.
What&amp;#8217;s less amusing is that foreign key exceptions are very unspecific about which contraints are violated (:&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_new_endpoints_for_albums&quot;&gt;New endpoints for Albums&lt;/h3&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_model_additions&quot;&gt;Model additions&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;backend/src/Model.hs&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;data Track = Track                       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  { trackId :: Maybe Int
  , trackName :: String
  , trackDuration :: Int -- seconds
  } deriving (Eq, Show, Generic)


data Album = Album                       &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  { albumId :: Maybe Int
  , albumName :: String
  , albumArtistId :: Int
  , albumTracks :: [Track]
  } deriving (Eq, Show, Generic)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Our Track type doesn&amp;#8217;t care about the distiction between the album and album_track entities&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;It was tempting to add Artist as a property to the Album type, but opted for just the id of an Artist entity.
I didn&amp;#8217;t want to be forced to return a full artist instance for every Album returned. You gotta draw the line somewhere right ?&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_albums_crud_functions&quot;&gt;Albums CRUD functions&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In order to keep this blog post from becoming to extensive we&amp;#8217;ve only included the functions to
list and create new albums. You can view the update, findById and delete functions in the
&lt;a href=&quot;https://github.com/rundis/albums/blob/master/backend/src/Storage.hs&quot;&gt;album sample repo&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;findAlbums :: Sql.Connection -&amp;gt; IO [M.Album]                                                         &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
findAlbums conn = do
  rows &amp;lt;- Sql.query_ conn (albumsQuery &quot;&quot;) :: IO [(Int, String, Int, Int, String, Int)]
  return $ Map.elems $ foldl groupAlbum Map.empty rows


findAlbumsByArtist :: Sql.Connection -&amp;gt; Int -&amp;gt; IO [M.Album]                                          &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
findAlbumsByArtist conn artistId = do
  rows &amp;lt;- Sql.query conn (albumsQuery &quot; where artist_id = ?&quot;) (Sql.Only artistId) :: IO [(Int, String, Int, Int, String, Int)]
  return $ Map.elems $ foldl groupAlbum Map.empty rows


albumsQuery :: String -&amp;gt; SqlTypes.Query                                                              &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
albumsQuery whereClause =
  SqlTypes.Query $ Txt.pack $
    &quot;select a.id, a.name, a.artist_id, t.id, t.name, t.duration \
    \ from album a inner join album_track at on a.id = at.album_id \
    \ inner join track t on at.track_id = t.id&quot;
    ++ whereClause
    ++ &quot; order by a.id, at.track_no&quot;


groupAlbum :: Map.Map Int M.Album -&amp;gt; (Int, String, Int, Int, String, Int) -&amp;gt; Map.Map Int M.Album     &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
groupAlbum acc (albumId, albumName, artistId, trackId, trackName, trackDuration) =
  case (Map.lookup albumId acc) of
    Nothing -&amp;gt; Map.insert albumId (M.Album (Just albumId) albumName artistId [M.Track (Just trackId) trackName trackDuration]) acc
    Just _ -&amp;gt; Map.update (\a -&amp;gt; Just (addTrack a (trackId, trackName, trackDuration))) albumId acc
              where
                addTrack album (trackId, trackName, trackDuration) =
                  album {M.albumTracks = (M.albumTracks album) ++ [M.Track (Just trackId) trackName trackDuration]}



newAlbum :: Sql.Connection -&amp;gt; M.Album -&amp;gt; IO M.Album                                                  &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
newAlbum conn album = do
  Sql.executeNamed conn &quot;insert into album (name, artist_id) values (:name, :artistId)&quot; [&quot;:name&quot; := (M.albumName album), &quot;:artistId&quot; := (M.albumArtistId album)]
  albumId &amp;lt;- lastInsertRowId conn
  tracks &amp;lt;- zipWithM (\t i -&amp;gt; newTrack conn (i, fromIntegral albumId, (M.albumArtistId album), t)) (M.albumTracks album) [0..]

  return album { M.albumId = Just $ fromIntegral albumId
               , M.albumTracks = tracks
               }


newTrack :: Sql.Connection -&amp;gt; (Int, Int, Int, M.Track) -&amp;gt; IO M.Track                                 &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
newTrack conn (trackNo, albumId, artistId, track) = do
  Sql.executeNamed conn &quot;insert into track (name, duration) values (:name, :duration)&quot; [&quot;:name&quot; := (M.trackName track), &quot;:duration&quot; := (M.trackDuration track)]
  trackId &amp;lt;- lastInsertRowId conn
  Sql.execute conn &quot;insert into album_track (track_no, album_id, track_id) values (?, ?, ?)&quot; (trackNo, albumId, trackId)

  return track {M.trackId = Just $ fromIntegral trackId}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Function to list all albums&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Function to list albums filtered by artist&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Helper function to construct an album query with an optional where clause. The query returns a product
of albums and their tracks. Let&amp;#8217;s just call this a performance optimization to avoid n+1 queries :-)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Since album information is repeated for each track, we need to group tracks per album. This part was a fun challenge
for a Haskell noob. I&amp;#8217;m sure it could be done eveny more succinct, but I&amp;#8217;m reasonably happy with the way it turned out.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This is the function to create a new album with all it&amp;#8217;s tracks. We assume the tracks are sorted in the order they
should be persisted and uses zipWith to get a mapIndexed kind of function so that we can generate the appropriate track_no
for each album_track in the db.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Working with tracks we have to consider both the track and album_track entities in the db. As it is, the
album_track table is just overhead, but we knew that allready given the design decission taken earlier. Once we need to support
the fact that a track can be included in more that one album, we need to rethink this implementation.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_adding_albums_to_the_api&quot;&gt;Adding albums to the API&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;backend/src/Api.hs&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;type AlbumAPI =                                                                     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
       QueryParam &quot;artistId&quot; Int :&amp;gt; Get &apos;[JSON] [M.Album]                           &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  :&amp;lt;|&amp;gt; ReqBody &apos;[JSON] M.Album :&amp;gt; Post &apos;[JSON] M.Album
  :&amp;lt;|&amp;gt; Capture &quot;albumId&quot; Int :&amp;gt; ReqBody &apos;[JSON] M.Album :&amp;gt; Put &apos;[JSON] M.Album
  :&amp;lt;|&amp;gt; Capture &quot;albumId&quot; Int :&amp;gt; Get &apos;[JSON] M.Album
  :&amp;lt;|&amp;gt; Capture &quot;albumId&quot; Int :&amp;gt; Delete &apos;[] ()


albumsServer :: Sql.Connection -&amp;gt; Server AlbumAPI
albumsServer conn =
  getAlbums :&amp;lt;|&amp;gt; postAlbum :&amp;lt;|&amp;gt; updateAlbum :&amp;lt;|&amp;gt; getAlbum :&amp;lt;|&amp;gt; deleteAlbum

  where
    getAlbums artistId            = liftIO $ case artistId of                       &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
                                              Nothing -&amp;gt; S.findAlbums conn
                                              Just x -&amp;gt; S.findAlbumsByArtist conn x
    postAlbum album               = liftIO $ Sql.withTransaction conn $ S.newAlbum conn album
    updateAlbum albumId album     = liftIOMaybeToEither err404 $ Sql.withTransaction conn $ S.updateAlbum conn album albumId
    getAlbum albumId              = liftIOMaybeToEither err404 $ S.albumById conn albumId
    deleteAlbum albumId           = liftIO $ Sql.withTransaction conn $ S.deleteAlbum conn albumId


type API = &quot;artists&quot; :&amp;gt; ArtistAPI :&amp;lt;|&amp;gt; &quot;albums&quot; :&amp;gt; AlbumAPI                         &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;

combinedServer :: Sql.Connection -&amp;gt; Server API                                      &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
combinedServer conn = artistsServer conn :&amp;lt;|&amp;gt; albumsServer conn&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We&amp;#8217;ve added a new API type for Albums&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;For listing albums we support an optional query param to allow us to filter albums by artist&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This implementation is quite simplistic, we probably want to provide a more generic way to handle multiple
filter criteria in the future.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The API for our backend is now a composition of the api for artists and the api for albums&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;As Servant allows us to compose apis it also allows us to compose servers (ie the implementations of the apis).
We create a combined server, which is what we ultimately expose from our backend server&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
The really observant reader might have noticed that the update function for albums is a little bit more
restrictive/solid than the corresponding function for artist. Here we actually check if the given album id
corresponds to a album in the DB. If it doesn&amp;#8217;t we return a 404.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;backend/Main.hs&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;app :: Sql.Connection -&amp;gt; Application
app conn = serve A.api (A.combinedServer conn)          &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;



main :: IO ()
main = do
  withTestConnection $ \conn -&amp;gt;  do
    B.bootstrapDB conn                                  &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    run 8081 $ albumCors $ app conn&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Rather than serve the just the albumServer, we now serve the combined server.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We&amp;#8217;ve updated bootstrapping to use the the new bootstrap module&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_backend_summary&quot;&gt;Backend summary&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;That wasn&amp;#8217;t to hard now was it ? Adding additional end points was quite straightforward, the hard part
was overcoming analysis paralysis. Settling on data types and db design took some time, and in hindsight I might
have opted for a more simplistic db design. I&amp;#8217;m also curious about how the design would have been had I started top down (frontend first)
and backend last. I have a strong suspicion it would have been different.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Haskell IO&lt;/div&gt;
&lt;p&gt;The thing I probably spent most time struggling with was working with IO actions. Apparantly I shouldn&amp;#8217;t
use the term &lt;a href=&quot;http://blog.jle.im/entry/io-monad-considered-harmful&quot;&gt;IO Monad&lt;/a&gt;. Anyways I can&amp;#8217;t wrap my head around
when I&amp;#8217;m &quot;inside&quot; the IO thingie and when I&amp;#8217;m not. It&amp;#8217;s obvious that &lt;code&gt;do&lt;/code&gt;, &lt;code&gt;&amp;#8592;&lt;/code&gt;, &lt;code&gt;let&lt;/code&gt; and &lt;code&gt;return&lt;/code&gt; is something
I have to sit down and understand (in the context of IO things). My strategy of trial and error doesn&amp;#8217;t scale
all that well, and whatsmore It feels ackward not having a clue on the reasoning on why something is working or not.
Note to self, read up on Haskell IO.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;div class=&quot;title&quot;&gt;REST concerns&lt;/div&gt;
&lt;p&gt;Even with this simple example I started to run into the same old beef I have with generic rest endpoints.
They rarely fit nicely with a Single Page Application. They work ok when it comes to adding and updating data,
but when it comes to querying it all becomes much more limiting. In a SPA you typically want much more flexibility
in terms of what you query by and what you get in return.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;In an album listing for a given artist I might just want to display the name, release date, number of songs and album length
I&amp;#8217;m not interested in the tracks.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;In an album listing / album search outside of an artist context I probably want to display the artist name&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;For a mobile client I might just want to display the album name (size of payloads might actually be important for mobile&amp;#8230;&amp;#8203;)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Likewise when listing artists I might want to display number of albums&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Or when searching I might want to search album name, artist name and/or track name&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Reading about &lt;a href=&quot;https://facebook.github.io/graphql/&quot;&gt;GraphQL&lt;/a&gt;, &lt;a href=&quot;http://netflix.github.io/falcor/&quot;&gt;Falcor&lt;/a&gt;
and more recently &lt;a href=&quot;https://github.com/omcljs/om/wiki&quot;&gt;Om next&lt;/a&gt; has been an eye-opener to me.
The ideas here rings true and bodes well for the frontend, probably soonish something will materialize for Elm too.
But what to do on the server side I wonder ?
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_frontend&quot;&gt;Frontend&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_new_routes&quot;&gt;New routes&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;frontend/src/Routes.elm&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type Route                      &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  = Home
  -- ...
  | AlbumDetailPage Int
  | NewArtistAlbumPage Int
  | EmptyRoute


routeParsers =                 &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  [ static Home &quot;/&quot;
  -- ...
  , dyn1 AlbumDetailPage &quot;/albums/&quot; int &quot;&quot;
  , dyn1 NewArtistAlbumPage &quot;/artists/&quot; int &quot;/albums/new&quot;
  ]

encode route =                 &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  case route of
    Home -&amp;gt; &quot;/&quot;
    -- ...
    AlbumDetailPage   i   -&amp;gt; &quot;/albums/&quot; ++ toString i
    NewArtistAlbumPage i  -&amp;gt; &quot;/artists/&quot; ++ (toString i) ++ &quot;/albums/new&quot;
    EmptyRoute -&amp;gt; &quot;&quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We have added 2 new routes, one for edit/create albums, one for creating a new album (for a given artist)
(actually there is a 3 for creating an album without selecting an artist, but it&amp;#8217;s not wired up yet)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We need to add route matchers for the new routes.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We also need to add encoders for our new routes.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_service_api&quot;&gt;Service API&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To call our new REST api for albums we need to implement a few new functions and json decoders.
We&amp;#8217;ll only show two of the api related functions.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type alias AlbumRequest a =    &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  { a | name : String
      , artistId : Int
      , tracks : List Track
  }

type alias Album =             &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  { id : Int
  , name : String
  , artistId : Int
  , tracks : List Track
  }

type alias Track =             &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  { name : String
  , duration : Int
  }


getAlbumsByArtist : Int -&amp;gt; (Maybe (List Album) -&amp;gt; a) -&amp;gt; Effects a               &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
getAlbumsByArtist artistId action =
  Http.get albumsDecoder (baseUrl ++ &quot;/albums?artistId=&quot; ++ toString artistId)
    |&amp;gt; Task.toMaybe
    |&amp;gt; Task.map action
    |&amp;gt; Effects.task

createAlbum : AlbumRequest a -&amp;gt; (Maybe Album -&amp;gt; b) -&amp;gt; Effects.Effects b         &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
createAlbum album action =
  Http.send Http.defaultSettings
        { verb = &quot;POST&quot;
        , url = baseUrl ++ &quot;/albums&quot;
        , body = Http.string (encodeAlbum album)
        , headers = [(&quot;Content-Type&quot;, &quot;application/json&quot;)]
        }
    |&amp;gt; Http.fromJson albumDecoder
    |&amp;gt; Task.toMaybe
    |&amp;gt; Task.map action
    |&amp;gt; Effects.task

-- other functions left out for brevity. Check out the sample code or have a look at episode 2 for inspiration



-- Decoders/encoders for albums/tracks                                         &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;

albumsDecoder : JsonD.Decoder (List Album)
albumsDecoder =
  JsonD.list albumDecoder


albumDecoder : JsonD.Decoder Album
albumDecoder =
  JsonD.object4 Album
    (&quot;albumId&quot; := JsonD.int)
    (&quot;albumName&quot; := JsonD.string)
    (&quot;albumArtistId&quot; := JsonD.int)
    (&quot;albumTracks&quot; := JsonD.list trackDecoder)


trackDecoder : JsonD.Decoder Track
trackDecoder =
  JsonD.object2 Track
    (&quot;trackName&quot; := JsonD.string)
    (&quot;trackDuration&quot; := JsonD.int)


encodeAlbum : AlbumRequest a -&amp;gt; String
encodeAlbum album =
  JsonE.encode 0 &amp;lt;|
    JsonE.object
      [ (&quot;albumName&quot;, JsonE.string album.name)
      , (&quot;albumArtistId&quot;, JsonE.int album.artistId)
      , (&quot;albumTracks&quot;, JsonE.list &amp;lt;| List.map encodeTrack album.tracks)
      ]


encodeTrack : Track -&amp;gt; JsonE.Value
encodeTrack track =
    JsonE.object
      [ (&quot;trackName&quot;, JsonE.string track.name)
      , (&quot;trackDuration&quot;, JsonE.int track.duration)
      ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We use the AlbumRequest type when dealing with new albums&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The Album type represents a persisted album&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We aren&amp;#8217;t really interested in the id of tracks so we only need one Track type&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;For finding albums for an artist we can use the Http.get function with default settings&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;To implement createAlbum we need to use Http.Send so that we can provide custom settings&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Decoding/Encoding Json to/from types isn&amp;#8217;t particularily difficult, but it is a bit of boilerplate involved&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_the_album_page&quot;&gt;The album page&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We&amp;#8217;ve made some changes to the ArtistDetail page which we won&amp;#8217;t show in this episode.
These changes include:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;List all albums for an artist&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Add features to remove album and link from each album in listin to edit the album&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;A button to initation the Album detail page in &quot;Create New&quot; mode&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;http://rundis.github.io/blog/2016/albumdetails.png&quot; alt=&quot;albumdetails&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We consider an Album and it&amp;#8217;s tracks to be an aggregate. This is also reflected in the implementation
of the ArlbumDetail module in the frontend code. You&amp;#8217;ll hopefully see that it&amp;#8217;s not that hard
to implement a semi advanced page by using the composability of the elm architecture.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Ok lets look at how we&amp;#8217;ve implemented the Album detail page and it&amp;#8217;s associated track listing.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_types&quot;&gt;Types&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type alias Model =                                  &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  { id : Maybe Int
  , artistId : Maybe Int
  , name : String
  , tracks : List ( TrackRowId, TrackRow.Model )
  , nextTrackRowId : TrackRowId
  , artists : List Artist
  }


type alias TrackRowId =                             &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  Int


type Action                                         &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  = NoOp
  | GetAlbum (Int)
  | ShowAlbum (Maybe Album)
  | HandleArtistsRetrieved (Maybe (List Artist))
  | SetAlbumName (String)
  | SaveAlbum
  | HandleSaved (Maybe Album)
  | ModifyTrack TrackRowId TrackRow.Action
  | RemoveTrack TrackRowId
  | MoveTrackUp TrackRowId
  | MoveTrackDown TrackRowId&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The model kind of reflects the Album type we saw in the previous chapter, but it&amp;#8217;s
bespoke for use in this view. Most notably we keep a list of Artists (for an artist dropdown) and
tracks are represented as a list of trackrow models from the TrackRow.elm module.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;To be able to forward updates to the appropriate TrackRow instance we are using a sequence type&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;There are quite a few actions, But the last 4 are related to the list of TrackRows.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;AlbumDetails can be seen as holding an AlbumListing, updates that concerns the list is handled
by AlbumDetails whilst updates that concerns individual TrackRows are forwarded to the appropriate
TrackRow instance.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_the_update_function&quot;&gt;The update function&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;update : Action -&amp;gt; Model -&amp;gt; ( Model, Effects Action )
update action model =
  case action of
    NoOp -&amp;gt;
      ( model, Effects.none )

    GetAlbum id -&amp;gt;                     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
      ( model
      , Effects.batch
          [ getAlbum id ShowAlbum
          , getArtists HandleArtistsRetrieved
          ]
      )

    ShowAlbum maybeAlbum -&amp;gt;             &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
      case maybeAlbum of
        Just album -&amp;gt;
          ( createAlbumModel model album, Effects.none )

        -- TODO: This could be an error if returned from api !
        Nothing -&amp;gt;
          ( maybeAddPristine model, getArtists HandleArtistsRetrieved )

    HandleArtistsRetrieved xs -&amp;gt;        &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
      ( { model | artists = (Maybe.withDefault [] xs) }
      , Effects.none
      )

    SetAlbumName txt -&amp;gt;                 &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
      ( { model | name = txt }
      , Effects.none
      )

    SaveAlbum -&amp;gt;                        &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
      case (model.id, model.artistId) of
        (Just albumId, Just artistId) -&amp;gt;
          ( model
          , updateAlbum (Album albumId model.name artistId (createTracks model.tracks)) HandleSaved
          )
        (Nothing, Just artistId) -&amp;gt;
          ( model
          , createAlbum { name = model.name
                          , artistId = artistId
                          , tracks = (createTracks model.tracks)
                          } HandleSaved
          )
        (_, _) -&amp;gt;
          Debug.crash &quot;Missing artist.id, needs to be handled by validation&quot;


    HandleSaved maybeAlbum -&amp;gt;          &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
      case maybeAlbum of
        Just album -&amp;gt;
          ( createAlbumModel model album
          , Effects.map (\_ -&amp;gt; NoOp) (Routes.redirect &amp;lt;| Routes.ArtistDetailPage album.artistId)
          )

        Nothing -&amp;gt;
          Debug.crash &quot;Save failed... we&apos;re not handling it...&quot;

    RemoveTrack id -&amp;gt;                  &lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;(7)&lt;/b&gt;
      ( { model | tracks = List.filter (\( rowId, _ ) -&amp;gt; rowId /= id) model.tracks }
      , Effects.none
      )

    MoveTrackUp id -&amp;gt;                  &lt;i class=&quot;conum&quot; data-value=&quot;8&quot;&gt;&lt;/i&gt;&lt;b&gt;(8)&lt;/b&gt;
      let
        track =
          ListX.find (\( rowId, _ ) -&amp;gt; rowId == id) model.tracks
      in
        case track of
          Nothing -&amp;gt;
            ( model, Effects.none )

          Just t -&amp;gt;
            ( { model | tracks = moveUp model.tracks t }
            , Effects.none
            )

    MoveTrackDown id -&amp;gt;                &lt;i class=&quot;conum&quot; data-value=&quot;9&quot;&gt;&lt;/i&gt;&lt;b&gt;(9)&lt;/b&gt;
      let
        track =
          ListX.find (\( rowId, _ ) -&amp;gt; rowId == id) model.tracks

        mayMoveDown t =
          let
            idx =
              ListX.elemIndex t model.tracks
          in
            case idx of
              Nothing -&amp;gt;
                False

              Just i -&amp;gt;
                i &amp;lt; ((List.length model.tracks) - 2)
      in
        case track of
          Nothing -&amp;gt;
            ( model, Effects.none )

          Just t -&amp;gt;
            ( { model
                | tracks =
                    if (mayMoveDown t) then
                      moveDown model.tracks t
                    else
                      model.tracks
              }
            , Effects.none
            )

    ModifyTrack id trackRowAction -&amp;gt;  &lt;i class=&quot;conum&quot; data-value=&quot;10&quot;&gt;&lt;/i&gt;&lt;b&gt;(10)&lt;/b&gt;
      let
        updateTrack ( trackId, trackModel ) =
          if trackId == id then
            ( trackId, TrackRow.update trackRowAction trackModel )
          else
            ( trackId, trackModel )
      in
        ( maybeAddPristine { model | tracks = List.map updateTrack model.tracks }
        , Effects.none
        )&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When we mount the route for an existing album, we need to retrieve both the album and
all artists (for the artist dropdown). To do both in one go we can use &lt;code&gt;Effects.batch&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We use the album param to differntiate between &quot;update&quot; and &quot;new&quot; mode for albums. If show album is called with an album we update our inital model with the information
contained in the given album (this also involves initating TrackRow.models for each album track.
If there is no album, we just add an empty track row and the initiate the retrieval of artists for the artists dropdown.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Once artists are retrieved we update our model to hold these&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This action is executed when the user changes the value of the name field&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The save action either calls update or create in the server api based on whether the model has an albumId or not.
In both instances it needs to convert the model to an Album/AlbumRequest as this is what the signature of the ServerApi functions require&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;A successful save will give an Album type back, we update the model and in this instance we
also redirect the user to the artist detail page.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;7&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This action is called when the user clicks on the remove button for a track row. We&amp;#8217;ll get back to this when
in just a little while&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;8&quot;&gt;&lt;/i&gt;&lt;b&gt;8&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Action to move a track one step up in the track listing. If it&amp;#8217;s already at the top
it&amp;#8217;s a no op. The &quot;heavy&quot; lifting is done in the &lt;code&gt;moveUp&lt;/code&gt; generic helper function&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;9&quot;&gt;&lt;/i&gt;&lt;b&gt;9&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Similar to &lt;code&gt;MoveTrackUp&lt;/code&gt; but it has addtional logic to ensure we don&amp;#8217;t move a track below the
always present empty (Pristine) row in the track listing&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;10&quot;&gt;&lt;/i&gt;&lt;b&gt;10&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The ModifyTrack action forwards to the update function for the TrackRow in question. Each track row is
tagged with an Id (TrackRowId)&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_the_view&quot;&gt;The view&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;view : Signal.Address Action -&amp;gt; Model -&amp;gt; Html                                  &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
view address model =
  div
    []
    [ h1 [] [ text &amp;lt;| pageTitle model ]
    , Html.form
        [ class &quot;form-horizontal&quot; ]
        [ div
            [ class &quot;form-group&quot; ]
            [ label [ class &quot;col-sm-2 control-label&quot; ] [ text &quot;Name&quot; ]
            , div
                [ class &quot;col-sm-10&quot; ]
                [ input
                    [ class &quot;form-control&quot;
                    , value model.name
                    , on &quot;input&quot; targetValue (\str -&amp;gt; Signal.message address (SetAlbumName str))
                    ]
                    []
                ]
            ]
        , ( artistDropDown address model )
        , div
            [ class &quot;form-group&quot; ]
            [ div
                [ class &quot;col-sm-offset-2 col-sm-10&quot; ]
                [ button
                    [ class &quot;btn btn-default&quot;
                    , type&apos; &quot;button&quot;
                    , onClick address SaveAlbum
                    ]
                    [ text &quot;Save&quot; ]
                ]
            ]
        ]
    , h2 [] [ text &quot;Tracks&quot; ]
    , trackListing address model
    ]


artistDropDown : Signal.Address Action -&amp;gt; Model -&amp;gt; Html                        &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
artistDropDown address model =
  let
    val =
      Maybe.withDefault (-1) model.artistId

    opt a =
        option [ value &amp;lt;| toString a.id, selected (a.id == val) ] [ text a.name ]
  in
    div
      [ class &quot;form-group&quot; ]
      [ label [ class &quot;col-sm-2 control-label&quot; ] [ text &quot;Artist&quot; ]
      , div
          [ class &quot;col-sm-10&quot; ]
          [ select
              [ class &quot;form-control&quot; ]
              (List.map opt model.artists)
          ]
      ]


trackListing : Signal.Address Action -&amp;gt; Model -&amp;gt; Html                          &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
trackListing address model =
  table
    [ class &quot;table table-striped&quot; ]
    [ thead
        []
        [ tr
            []
            [ th [] []
            , th [] []
            , th [] [ text &quot;Name&quot; ]
            , th [] [ text &quot;Duration&quot; ]
            , th [] []
            ]
        ]
    , tbody [] (List.map (trackRow address) model.tracks)
    ]


trackRow : Signal.Address Action -&amp;gt; ( TrackRowId, TrackRow.Model ) -&amp;gt; Html    &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
trackRow address ( id, rowModel ) =
  let
    context =
      TrackRow.Context
        (Signal.forwardTo address (ModifyTrack id))
        (Signal.forwardTo address (always (RemoveTrack id)))
        (Signal.forwardTo address (always (MoveTrackUp id)))
        (Signal.forwardTo address (always (MoveTrackDown id)))
  in
    TrackRow.view context rowModel&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The view function for the page.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The artist dropdown (a github star for the observant reader that can spot what&amp;#8217;s missing :-) )&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Generates the track listing for the album&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The rendering of each individual TrackRow is forwarded to the TrackRow module. We pass on a
context so that a TrackRow is able to &quot;signal back&quot; to the AlbumDetails page for the actions
that are owned by AlbumDetails (RemoveTrack, MoveTrackUp and MoveTrackDown). You&amp;#8217;ll see how that
plays out when we look at the TrackRow implementation in the next secion.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;strong&gt;Why the context thingie ?&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Well we can&amp;#8217;t have the AlbumDetails depending on TrackRows and the TrackRow component having a dependency
back to AlbumDetails. To solve that we pass on the tagged forwarding addresses so that TrackRows can signal
AlbumDetails with the appropriate actions. I guess you can sort of think of them as callbacks, but it&amp;#8217;s not quite that.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Another slightly more elaborate explantion might be that when a user performs something on a track row that
we capture (say a click on the remove button). The view from the track row returns a signal (wrapped as an effect) to album details which
in turn returns a signal back to main. The signal is processed by the startapp &quot;event-loop&quot; and flows back through
the update functions (main &amp;#8594; AlbumDetails) and since it&amp;#8217;s tagged to as an action to be handled by AlbumDetails is handled
in AlbumDetails update function (and doesn&amp;#8217;t flow further.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Clear as mud or perhaps it makes sort of sense ?&lt;/p&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_track_row&quot;&gt;Track row&lt;/h3&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_types_2&quot;&gt;Types&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type alias Model =                        &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  { name : String
  , durationMin : Maybe Int
  , durationSec : Maybe Int
  , status : Status
  }


type alias Context =                      &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  { actions : Signal.Address Action
  , remove : Signal.Address ()
  , moveUp : Signal.Address ()
  , moveDown : Signal.Address ()
  }


type Status                               &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  = Saved
  | Modified
  | Error
  | Pristine                              &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;


type Action                               &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
  = SetTrackName String
  | SetMinutes String
  | SetSeconds String&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The model captures information about an album track. Duration is separated into
minutes and seconds to be more presentable and easier for the user to input. In addition
we have a status flag to be able to give the user feedback and handle some conditional logic.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Here you see the type definition for the Context we previously mentioned we used in the when
forwarding view rendering for each individual track row in the Album Details page. (Btw it could be any
component as long as they pass on a context with the given signature of Context).&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The possible status types a row can be in.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Prisitine has a special meaning in the track listing in AlbumDetails. It should always be just one and it should be the last row.
However that&amp;#8217;s not the responsibility of TrackRow. TrackRow should just ensure the status is correct at all times.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The possible actions that TrackRow handles internally&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_update_function&quot;&gt;Update function&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;update : Action -&amp;gt; Model -&amp;gt; Model
update action model =
  case action of
    SetTrackName v -&amp;gt;        &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
      { model | name = v, status = Modified }

    SetMinutes str -&amp;gt;        &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
      let
        maybeMinutes = Result.toMaybe &amp;lt;| String.toInt str
      in
        case maybeMinutes of
          Just m -&amp;gt;
            { model | durationMin = maybeMinutes, status = Modified }

          Nothing -&amp;gt;
            if String.isEmpty str then
              { model | durationMin = Nothing, status = Modified}
            else
              model


    SetSeconds str -&amp;gt;        &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
      let
        maybeSeconds = Result.toMaybe &amp;lt;| String.toInt str
      in
        case maybeSeconds of
          Just m -&amp;gt;
            if m &amp;lt; 60 then
              { model | durationSec = maybeSeconds, status = Modified }
            else
              model

          Nothing -&amp;gt;
            if String.isEmpty str then
              { model | durationSec = Nothing, status = Modified}
            else
              model&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Updates the trackname model property when user inputs into the trackname field&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Updates the minutes property if a valid number is entered. Also blanks the field
when the text input field becomes empty&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Similar to minutes, but also ensures that you don&amp;#8217;t enter more than 59 !&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_view&quot;&gt;View&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We&amp;#8217;ll only show parts of the view to limit the amount of code you need to scan through.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;view : Context -&amp;gt; Model -&amp;gt; Html
view context model =
  tr
    []
    [ td [] [ statusView model ]
    , td [] [ moveView context model ]
    , td [] [ nameView context model ]
    , td [] [ durationView context model ]
    , td [] [ removeView context model ]
    ]


nameView : Context -&amp;gt; Model -&amp;gt; Html
nameView context model =
  input
    [ class &quot;form-control&quot;
    , value model.name
    , on &quot;input&quot; targetValue (\str -&amp;gt; Signal.message context.actions (SetTrackName str))  &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
    ]
    []


removeView : Context -&amp;gt; Model -&amp;gt; Html
removeView context model =
  button
    [ onClick context.remove ()                                                           &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    , class &amp;lt;| &quot;btn btn-sm btn-danger &quot; ++ if isPristine model then &quot;disabled&quot; else &quot;&quot;
    ]
    [ text &quot;Remove&quot; ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When a user causes an input event on the name input field we create a message using the address in context.actions with action SetTrackName
So this message will cause an update eventually forwarded to the update function of TrackRow&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When a user clicks on the remove button we use the address given by context.remove with a payload of () (ie void).
This message will always be forwarded to the address for AlbumDetails with the payload set to &lt;code&gt;RemoveTrack&lt;/code&gt; with the given track row id.
All of which TrackRow is blissfully unaware of.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_main_elm_wiring_it_all_up&quot;&gt;Main.elm wiring it all up&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type alias Model =
  WithRoute
    Routes.Route
    { --....
    , albumDetailModel : AlbumDetail.Model
    }


type Action
  = NoOp
  -- ...
  | AlbumDetailAction AlbumDetail.Action
  | RouterAction (TransitRouter.Action Routes.Route)


initialModel =
  { transitRouter = TransitRouter.empty Routes.EmptyRoute
  -- ...
  , albumDetailModel = AlbumDetail.init
  }


mountRoute prevRoute route model =
  case route of
    -- ...

    AlbumDetailPage albumId -&amp;gt;         &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
      let
        (model&apos;, effects) =
          AlbumDetail.update (AlbumDetail.GetAlbum albumId) AlbumDetail.init
      in
        ( { model | albumDetailModel = model&apos; }
        , Effects.map AlbumDetailAction effects)


    NewArtistAlbumPage artistId -&amp;gt;     &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
      let
        (model&apos;, effects) =
          AlbumDetail.update (AlbumDetail.ShowAlbum Nothing) (AlbumDetail.initForArtist artistId)
      in
        ( { model | albumDetailModel = model&apos; }
        , Effects.map AlbumDetailAction effects)

    -- ...


update action model =
  case action of
    -- ..

    AlbumDetailAction act -&amp;gt;           &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
      let
        ( model&apos;, effects ) =
          AlbumDetail.update act model.albumDetailModel
      in
        ( { model | albumDetailModel = model&apos; }
        , Effects.map AlbumDetailAction effects
        )

    -- ..&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When we mount the route for the AlbumDetailsPage (&quot;/albums/:albumId&quot;) we call the
update function of AlbuDetail with a &lt;code&gt;GetAlbum&lt;/code&gt; action. You might remember that this in turn calls the functions
for retrieving an Album and the function for retrieving artists as a batch.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When the user performs an action that results in the NewArtistAlbumPage being mounted (&quot;/artists/:artistId/albums/new&quot;)
, we call the update on AlbumDetail with &lt;code&gt;ShowAlbum&lt;/code&gt; action and a reinitialized model where artistId is set.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;In the update function of Main we forward any actions particular to AlbumDetail&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_frontend_summary&quot;&gt;Frontend summary&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Working with the frontend code in Elm has been mostly plain sailing. I struggled a bit to get
all my ducks(/effects) in a row and I&amp;#8217;m not too happy with some of the interactions related to new vs update.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Unfortunately the elm-reactor isn&amp;#8217;t working all that well with 0.16, certainly not on my machine.
It also doesn&amp;#8217;t work particularily well with single page apps that changes the url. I looked at and tried a couple of
alternatives and settled on using &lt;a href=&quot;https://github.com/maxgurewitz/elm-server&quot;&gt;elm-server&lt;/a&gt;. I had to make some modifications
to make it work nicely with an SPA. I submitted a PR that seems to work nicely for my use case atleast.
With that in place, the roundtrip from change to feedback became very schneizz indeed !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Undoubtably there is quite a bit that feels like boiler plate. The addition of routing also introduces yet another thing you have
to keep in mind in several places. Boilerplate it might be, but it&amp;#8217;s also quite explicit.  I would imagine that in a large app you might grow a bit weary of some of the boilerplate and start looking for ways to reduce it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;d be lying if I said I&amp;#8217;ve fully grasped; signals, tasks, ports, effects and mailboxes. But it&amp;#8217;s gradually becoming clearer
and it&amp;#8217;s very nice that you can produce pretty cool things without investing to much up front.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_concluding_remarks&quot;&gt;Concluding remarks&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I utterly failed to make a shorter blog post yet again. To my defence, the default formatting of Elm
do favor newlines bigtime. Most of the Elm code has been formatted by &lt;a href=&quot;https://github.com/avh4/elm-format&quot;&gt;elm-format&lt;/a&gt; btw.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;m really starting to see the benefits of statically (strongly) typed functional languages. The journey
so far has been a massive learing experience. Heck this stuff has been so much fun, I ended up taking a day off work so that
I could work on this for a whole day with most of my good brain cells still at acceptable performance levels.
Shame I can&amp;#8217;t use this stuff at work, but I&amp;#8217;m starting to accumulate quite a substantial collection of selling points.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Whats next ?&lt;/div&gt;
&lt;p&gt;The sample app has started to accumulate quite a bit of technical dept, so I suppose the next episode(s)
should start to address some of that.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Typed up CRUD SPA with Haskell and Elm - Part 3: Routing</title>
      <link>http://rundis.github.io/blog/2016/haskel_elm_spa_part3.html</link>
      <pubDate>Tue, 19 Jan 2016 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2016/haskel_elm_spa_part3.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Any serious Single Page Application needs to have routing. Right ? So before we add
any further pages it&amp;#8217;s time to add routing support to the Elm frontend.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In &lt;a href=&quot;http://rundis.github.io/blog/2016/haskel_elm_spa_part2.html&quot;&gt;episode 2&lt;/a&gt;, we implemented
a Micky Mouse solution for page routing. Clearly that approach won&amp;#8217;t scale. Now is a good time to
implement something that can handle multiple pages, history navigation, direct linking etc.
We could do it all from scratch, but lets opt for pulling in a library.
In this episode we&amp;#8217;ll introduce &lt;a href=&quot;https://github.com/etaque/elm-transit-router&quot;&gt;elm-transit-router&lt;/a&gt;
to the &lt;a href=&quot;https://github.com/rundis/albums&quot;&gt;Albums&lt;/a&gt; sample application.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Useful resources&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Check out the other &lt;a href=&quot;http://rundis.github.io/blog/tags/haskellelmspa.html&quot;&gt;episodes&lt;/a&gt; in this blog series.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The accompanying &lt;a href=&quot;https://github.com/rundis/albums&quot;&gt;Albums&lt;/a&gt; sample app is on github, and there is a tag
for each episode&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I decided pretty early on to try out the &lt;a href=&quot;https://github.com/etaque/elm-transit-router&quot;&gt;elm-transit-router&lt;/a&gt; library.
It seemed to cover most of what I was looking for. It even has some pretty cool support for animations when doing page transitions.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Static typing is supposed to be really helpful when doing refactoring. Introducing routing should be a nice little excercise to
see if that holds. Remember, there still isn&amp;#8217;t a single test in our sample app, so it better hold.
The elm-transit-router library github repo contains a great example app that proved very helpful
in getting it up and running for the Albums app.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;a href=&quot;https://github.com/sporto/hop&quot;&gt;Hop&lt;/a&gt; is an alternative routing library you might want to check out too.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;iframe width=&quot;420&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/5o4sAxnk3U4&quot; frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_implementation_changes&quot;&gt;Implementation changes&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;frontend/elm-package.json&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;  // (...
  &quot;source-directories&quot;: [
        &quot;.&quot;,
        &quot;src/&quot;                                             &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
    ],

  // ...
  &quot;dependencies&quot;: {
    //... others ommitted
    &quot;etaque/elm-route-parser&quot;: &quot;2.1.0 &amp;lt;= v &amp;lt; 3.0.0&quot;,       &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    &quot;etaque/elm-transit-style&quot;: &quot;1.0.1 &amp;lt;= v &amp;lt; 2.0.0&quot;,      &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
    &quot;etaque/elm-transit-router&quot;: &quot;1.0.1 &amp;lt;= v &amp;lt; 2.0.0&quot;      &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;

  }
  ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We&amp;#8217;ve moved all elm files but Main.elm to the a src sub directory. So we need to add src to the list of source directories&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;A typed route parser with a nice DSL in Elm: We use it for defining our routes&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Html animations for &lt;a href=&quot;https://github.com/etaque/elm-transit&quot;&gt;elm-transit&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Drop-in router with animated route transitions for single page apps in Elm. Drop in, as in fitting very nicely with &lt;a href=&quot;https://github.com/evancz/start-app&quot;&gt;elm start-app&lt;/a&gt;.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Album dependencies&lt;/div&gt;
&lt;p&gt;&lt;span class=&quot;image&quot;&gt;&lt;a class=&quot;image&quot; href=&quot;http://rundis.github.io/blog/2016/albums_dependencies_large.png&quot;&gt;&lt;img src=&quot;http://rundis.github.io/blog/2016/albums_dependencies_small.png&quot; alt=&quot;Click for larger diagram&quot;&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The addition of the 3 new dependencies also adds quite a few transitive dependencies. The diagram
above is automatically generated by the &lt;a href=&quot;https://github.com/rundis/elm-light&quot;&gt;elm-light&lt;/a&gt; plugin for Light Table.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Defining routes (frontend/src/Routes.elm)&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type Route                                                   &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  = Home
  | ArtistListingPage
  | ArtistDetailPage Int
  | NewArtistPage
  | EmptyRoute


routeParsers : List (Matcher Route)
routeParsers =
  [ static Home &quot;/&quot;                                         &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  , static ArtistListingPage &quot;/artists&quot;
  , static NewArtistPage &quot;/artists/new&quot;
  , dyn1 ArtistDetailPage &quot;/artists/&quot; int &quot;&quot;                &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  ]


decode : String -&amp;gt; Route
decode path =                                               &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
  RouteParser.match routeParsers path
    |&amp;gt; Maybe.withDefault EmptyRoute


encode : Route -&amp;gt; String
encode route =                                              &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
  case route of
    Home -&amp;gt; &quot;/&quot;
    ArtistListingPage   -&amp;gt; &quot;/artists&quot;
    NewArtistPage       -&amp;gt; &quot;/artists/new&quot;
    ArtistDetailPage  i -&amp;gt; &quot;/artists/&quot; ++ toString i
    EmptyRoute -&amp;gt; &quot;&quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Union type that defines the different routes for the application&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;A static route matcher (&lt;code&gt;static&lt;/code&gt; is a function from the RouteParser dsl)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Dynamic route matcher with one dynamic param&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We try to match a given path with the route matchers defined above. Returns route of first successful match, or the &lt;code&gt;EmptyRoute&lt;/code&gt; route
if no match is found.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Encode a given route as a path&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;A few handy router utils (frontend/src/Routes.elm)&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;redirect : Route -&amp;gt; Effects ()
redirect route =                                       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  encode route
    |&amp;gt; Signal.send TransitRouter.pushPathAddress
    |&amp;gt; Effects.task


clickAttr : Route -&amp;gt; Attribute
clickAttr route =                                     &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  on &quot;click&quot; Json.value (\_ -&amp;gt;  Signal.message TransitRouter.pushPathAddress &amp;lt;| encode route)


linkAttrs : Route -&amp;gt; List Attribute
linkAttrs route =                                     &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  let
    path = encode route
  in
    [ href path
    , onWithOptions
        &quot;click&quot;
        { stopPropagation = True, preventDefault = True }
        Json.value
        (\_ -&amp;gt;  Signal.message TransitRouter.pushPathAddress path)
    ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This function allows us to perform routing through a redirect kind of effect. Comes in handy when we need to switch
routes as a result of performing a task or doing an update action of some sort.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Helper function that creates a click handler attribute. When clicked the signal is forwarded to an address of the internal mailbox for the
elm-transit-router library. By means of delegation the internal TransitRouter.Action type is wrapped into our app&amp;#8217;s Action type.
We&amp;#8217;ll get back to this when we wire it all together !&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Another helper function, similar to clickAttr, but this is more specific for links that also has a href attribute&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_changes_in_main_elm&quot;&gt;Changes in Main.elm&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Too hook in elm-transit-router we need to make a couple of changes to how we wire up our model, actions, view and update function.
It&amp;#8217;s also worth noting that from episode 2 have removed all direct update delegation from ArtistListing to ArtistDetail, this now
all will happen through route transitions. An immediate benefit of that is that the ArtistDetail page becomes much more reusable.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Model, actions, transitions and initialization&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type alias Model = WithRoute Routes.Route                                &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  { homeModel : Home.Model
  , artistListingModel : ArtistListing.Model
  , artistDetailModel : ArtistDetail.Model
  }


type Action =
    NoOp
  | HomeAction Home.Action
  | ArtistListingAction ArtistListing.Action
  | ArtistDetailAction ArtistDetail.Action
  | RouterAction (TransitRouter.Action Routes.Route)                    &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;


initialModel : Model
initialModel =
  { transitRouter = TransitRouter.empty Routes.EmptyRoute               &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  , homeModel = Home.init
  , artistListingModel = ArtistListing.init
  , artistDetailModel = ArtistDetail.init
  }


actions : Signal Action
actions =
  Signal.map RouterAction TransitRouter.actions                         &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;


mountRoute : Route -&amp;gt; Route -&amp;gt; Model -&amp;gt; (Model, Effects Action)
mountRoute prevRoute route model =                                      &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
  case route of

    Home -&amp;gt;
      (model, Effects.none)

    ArtistListingPage -&amp;gt;                                                &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
      (model, Effects.map ArtistListingAction (ServerApi.getArtists ArtistListing.HandleArtistsRetrieved))

    ArtistDetailPage artistId -&amp;gt;
      (model, Effects.map ArtistDetailAction (ServerApi.getArtist artistId ArtistDetail.ShowArtist))

    NewArtistPage -&amp;gt;
      ({ model | artistDetailModel = ArtistDetail.init } , Effects.none)

    EmptyRoute -&amp;gt;
      (model, Effects.none)


routerConfig : TransitRouter.Config Routes.Route Action Model
routerConfig =                                                          &lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;(7)&lt;/b&gt;
  { mountRoute = mountRoute
  , getDurations = \_ _ _ -&amp;gt; (50, 200)
  , actionWrapper = RouterAction
  , routeDecoder = Routes.decode
  }


init : String -&amp;gt; (Model, Effects Action)
init path =                                                             &lt;i class=&quot;conum&quot; data-value=&quot;8&quot;&gt;&lt;/i&gt;&lt;b&gt;(8)&lt;/b&gt;
  TransitRouter.init routerConfig path initialModel&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We extend our model using &lt;code&gt;WithRoute&lt;/code&gt; for our Route type in routes. This extends our type with a transitRouter property&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We add a RouteAction to our Action type. We will handle that explicitly in the update function we&amp;#8217;ll cover in the next section&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We define an initial model, which has the initial models for the various pages. In addition we initialize the transitRouter property
with an empty state and EmptyRoute route (that didn&amp;#8217;t read to well). Basically a route that shouldn&amp;#8217;t render anything, because it will transition
to an actual route. It&amp;#8217;s just an intermediary&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Transformer for mapping TransitRouter actions to our own RouterAction. This allows start-app to map external input signals to inputs with an action type our application
can recognize and process.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;mountRoute is a function that provides what we want to happen in our &lt;code&gt;update&lt;/code&gt; when a new route is mounted. Currently we
only pattern match on route to be mounted, but we could also match on the combination of previous route and new route to provide
custom behaviour depending on where you came from and where your are going to. Very powerful !&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When the ArtistListingPage route is mounted we return an effect to retrieve artists (when that effect returns the &lt;code&gt;ArtistListing.HandleArtistRetrieved&lt;/code&gt; action is then eventually passed to the update function of ArtistListing)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;7&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;routerConfig&lt;/code&gt; wires together the various bits that TransitRouter needs to do it&amp;#8217;s thing&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;8&quot;&gt;&lt;/i&gt;&lt;b&gt;8&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The init function now just initializes the TransitRouter with our config, and initial path (which we receive from a port) and our Initial model&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;There&amp;#8217;s quite a bit going on here, but once this is all in place, adding new routes is quite a breeze. I&amp;#8217;d recommend reading
through the Readme for &lt;a href=&quot;https://github.com/etaque/elm-transit-router&quot;&gt;elm-transit-router&lt;/a&gt; to understand more about the details of each step&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;The update function&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;update : Action -&amp;gt; Model -&amp;gt; (Model, Effects Action)
update action model =
  case action of

    NoOp -&amp;gt;
      (model, Effects.none)

    HomeAction homeAction -&amp;gt;
      let (model&apos;, effects) = Home.update homeAction model.homeModel
      in ( { model | homeModel = model&apos; }
         , Effects.map HomeAction effects )

    ArtistListingAction act -&amp;gt;                                                       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
      let (model&apos;, effects) = ArtistListing.update act model.artistListingModel
      in ( { model | artistListingModel = model&apos; }
         , Effects.map ArtistListingAction effects )

    ArtistDetailAction act -&amp;gt;                                                        &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
      let (model&apos;, effects) = ArtistDetail.update act model.artistDetailModel
      in ( { model | artistDetailModel = model&apos; }
         , Effects.map ArtistDetailAction effects )

    RouterAction routeAction -&amp;gt;                                                      &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
      TransitRouter.update routerConfig routeAction model&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;You should recognize this pattern from the previous episode. We delegate all actions tagged with ArtistListingAction
to the update function for ArtistListing. The we update the model with the updated model from ArtistListing and
map any effects returned.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If you remember from &lt;a href=&quot;http://rundis.github.io/blog/2016/haskel_elm_spa_part2.html&quot;&gt;episode 2&lt;/a&gt; this used to reside in ArtistListing, but
has been moved here.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;RouterAction&lt;/code&gt; action types are handled by the update function in TransitRouter. If you Debug.log this function you will see this
is called repeadly when there is a transition from one route to the next. (To handle the animation effects most notably)&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;The main view/layout&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;menu : Signal.Address Action -&amp;gt; Model -&amp;gt; Html
menu address model =                                                       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  header [class &quot;navbar navbar-default&quot;] [
    div [class &quot;container&quot;] [
        div [class &quot;navbar-header&quot;] [
          div [ class &quot;navbar-brand&quot; ] [
            a (linkAttrs Home) [ text &quot;Albums galore&quot; ]
          ]
        ]
      , ul [class &quot;nav navbar-nav&quot;] [
          li [] [a (linkAttrs ArtistListingPage) [ text &quot;Artists&quot; ]]       &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
      ]
    ]
  ]



contentView : Signal.Address Action -&amp;gt; Model -&amp;gt; Html
contentView address model =                                                &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  case (TransitRouter.getRoute model) of
    Home -&amp;gt;
      Home.view (Signal.forwardTo address HomeAction) model.homeModel

    ArtistListingPage -&amp;gt;                                                   &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
      ArtistListing.view (Signal.forwardTo address ArtistListingAction) model.artistListingModel

    ArtistDetailPage i -&amp;gt;
      ArtistDetail.view (Signal.forwardTo address ArtistDetailAction) model.artistDetailModel

    NewArtistPage  -&amp;gt;
      ArtistDetail.view (Signal.forwardTo address ArtistDetailAction) model.artistDetailModel

    EmptyRoute -&amp;gt;
      text &quot;Empty WHAT ?&quot;


view : Signal.Address Action -&amp;gt; Model -&amp;gt; Html
view address model =
  div [class &quot;container-fluid&quot;] [
      menu address model
    , div [ class &quot;content&quot;
          , style (TransitStyle.fadeSlideLeft 100 (getTransition model))]  &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
          [contentView address model]
  ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Menu view function for the app&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Here we use the &lt;code&gt;linkAttrs&lt;/code&gt; util function from Routes.elm to get a click handler. When the link is click
a route transition to the given page will occur (with addressbar update, history tracking and the whole shebang)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We render the appropriate main content view based which route is current in our model.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Getting the view for a page is used in the typical start-app way. Call the view function of the sub component and make sure
to provide a forwarding addres that main can handle in its update function !&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We define the route transition animation using the style attribute (function) in elm-html. Here we use a transition style
defined in &lt;a href=&quot;https://github.com/etaque/elm-transit-style&quot;&gt;elm-transit-style&lt;/a&gt;.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_how_to_navigate_from_one_page_to_another&quot;&gt;How to navigate from one page to another ?&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Move from artistlisting to artistdetail (frontend/src/ArtistListing.elm)&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;artistRow : Signal.Address Action -&amp;gt; Artist -&amp;gt; Html
artistRow address artist =
  tr [] [
     td [] [text artist.name]
    ,td [] [button [ Routes.clickAttr &amp;lt;| Routes.ArtistDetailPage artist.id ] [text &quot;Edit&quot;]]  &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
    ,td [] [button [ onClick address (DeleteArtist (.id artist))] [ text &quot;Delete!&quot; ]]
  ]


view : Signal.Address Action -&amp;gt; Model -&amp;gt; Html
view address model =
  div [] [
      h1 [] [text &quot;Artists&quot; ]
    , button [
            class &quot;pull-right btn btn-default&quot;
          , Routes.clickAttr Routes.NewArtistPage                                            &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
        ]
        [text &quot;New Artist&quot;]
    , table [class &quot;table table-striped&quot;] [
          thead [] [
            tr [] [
               th [] [text &quot;Name&quot;]
              ,th [] []
              ,th [] []
          ]
        ]
        , tbody [] (List.map (artistRow address) model.artists)
    ]
  ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;For navigation using links we just use the util function &lt;code&gt;Routes.clickAttr&lt;/code&gt; function we defined earlier. This will trigger the necessary
route transition to the appropriate page (with params as necessary)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;It&amp;#8217;s worth noting that we since episode 2 have introduced a separate route for handling NewArtist (&lt;code&gt;/artists/new&lt;/code&gt;). We are still
using the same behaviour otherwise, so it&amp;#8217;s just a minor modification to have a separate transition for a new artist (since that doesn&amp;#8217;t have a numeric id as part of its route path)&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Move to the artist listing after saving an artist (frontend/src/ArtistDetail.elm)&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;  -- ... inside update function

  HandleSaved maybeArtist -&amp;gt;
      case maybeArtist of
        Just artist -&amp;gt;
          ({ model | id = Just artist.id
                   , name = artist.name }
            , Effects.map (\_ -&amp;gt; NoOp) (Routes.redirect Routes.ArtistListingPage)   &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
          )

        Nothing -&amp;gt;
          Debug.crash &quot;Save failed... we&apos;re not handling it...&quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We use the &lt;code&gt;Routes.redirect&lt;/code&gt; function we defined earlier. When the task fro saving is completed we trigger an effect
that will transtion route to the ArtistListing page. To allow the effect to work in our update function we need to map it to
an action that ArtistDetail knows about (we don&amp;#8217;t have access to the RouterAction in main here!). That&amp;#8217;s why we map the effect
to a NoOp action.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_the_final_wiring&quot;&gt;The final wiring&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;frontend/main.elm&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;app : StartApp.App Model
app =
  StartApp.start
    { init = init initialPath                  &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
    , update = update
    , view = view
    , inputs = [actions]                       &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    }


main : Signal Html
main =
  app.html


port tasks : Signal (Task.Task Never ())
port tasks =
  app.tasks


port initialPath : String                      &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We call the init function previously defined with a initialPath (which we get from a port, see 3 below)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The inputs fields of the start-app config is for external signals. We wire it to our &lt;code&gt;actions&lt;/code&gt; defintion defined earlier&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We get the initialPath through a port from JavaScript. See the next section for how&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Initially I forgot to wire up the inputs. The net result of that was that none of the links actually did anything.
Was lost for a while there, but the author of elm-transit-router &lt;a href=&quot;https://github.com/etaque&quot;&gt;etaque&lt;/a&gt; was able to spot it easily
when I reached out in the &lt;a href=&quot;http://elmlang.herokuapp.com/&quot;&gt;elm-lang slack channel&lt;/a&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;frontend/index.html&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&amp;lt;!DOCTYPE html&amp;gt;
&amp;lt;html lang=&quot;en&quot;&amp;gt;
  &amp;lt;head&amp;gt;
    &amp;lt;meta charset=&quot;utf-8&quot;&amp;gt;
    &amp;lt;title&amp;gt;Albums&amp;lt;/title&amp;gt;
    &amp;lt;link rel=&quot;stylesheet&quot; href=&quot;assets/css/bootstrap.min.css&quot;&amp;gt;
  &amp;lt;/head&amp;gt;
  &amp;lt;body&amp;gt;
    &amp;lt;script type=&quot;text/javascript&quot; src=&quot;main.js&quot;&amp;gt;&amp;lt;/script&amp;gt;                 &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
    &amp;lt;script type=&quot;text/javascript&quot; src=&quot;/_reactor/debug.js&quot;&amp;gt;&amp;lt;/script&amp;gt;      &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;

    &amp;lt;script type=&quot;text/javascript&quot;&amp;gt;
      var main = Elm.fullscreen(Elm.Main, {initialPath: &quot;/&quot;});             &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
    &amp;lt;/script&amp;gt;

  &amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This is the transpiled elm to js for our frontend app&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We don&amp;#8217;t really need this one, but if reactor in debug mode had worked with ports this would be necessary for debug tracing etc&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We start our elm app with an input param for our initialPath. This is sent to the port defined above. It&amp;#8217;s currently hardcoded to &lt;code&gt;/&lt;/code&gt; (home), but
once we move to a proper web server we would probably use something like window.location.pathname to allow linking directly to
a specific route within our Single Page App.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_summary_and_next_steps&quot;&gt;Summary and next steps&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This was an all Elm episode. Hopefully I didn&amp;#8217;t loose all Haskellites along the way because of that. We&amp;#8217;ve added a crucial
feature for any Single Page (Web) Application in this episode. The end result was pretty neat and tidy too.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So how was the refactoring experience this time ? Well the compiler was certainly my best buddy along the way. Obviously I also
had to consult the documentation of elm-transit-router quite often. i had a few times where things appeared to be compiling fine
in Light Table, but actually there was some error in a Module referred by Main. I&amp;#8217;m not sure if it&amp;#8217;s make&amp;#8217;s fault or just that there is
something missing in the elm-light plugin. I&amp;#8217;ll certainly look into that. Always handy to have the command line available when you&amp;#8217;re
not sure about whether your IDE/Editor is tripping you up or not. I don&amp;#8217;t think tests would have caught many of the issues I encountered.
Forgetting to wire up inputs to startapp was probably my biggest blunder, and I&amp;#8217;m sure no test would have covered that. I needed to know that this
was something I had to wire up for it to work. RTFM etc.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Next up I think we will look at how much effort there is to add additional features. The hypothesis is that it should be
fairly straighforward, but who knows !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Typed up CRUD SPA with Haskell and Elm - Part 2: Persistence up and running</title>
      <link>http://rundis.github.io/blog/2016/haskel_elm_spa_part2.html</link>
      <pubDate>Thu, 14 Jan 2016 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2016/haskel_elm_spa_part2.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;My journey into Elm and Haskell continues. It&amp;#8217;s time to add database support.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Since &lt;a href=&quot;http://rundis.github.io/blog/2015/haskell_elm_spa_part1.html&quot;&gt;episode 1&lt;/a&gt; I&amp;#8217;ve
managed to implement simple CRUD features for the Artist entity of the &lt;a href=&quot;https://github.com/rundis/albums&quot;&gt;Albums&lt;/a&gt; sample application.
It&amp;#8217;s been anything but plain sailing, but it&amp;#8217;s been a blast so far. Trying to wrap my head around two
new languages and their libraries in parallell is somewhat daunting. The journey would probably
have been smoother if I took more time to learn the language proper. Learning by doing is at times
frustrating, at the same time very rewarding when stuff finally works.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;quoteblock&quot;&gt;
&lt;blockquote&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;There seems to be a pretty close correlation between &lt;strong&gt;it compiles&lt;/strong&gt; and &lt;strong&gt;it works&lt;/strong&gt; when programming
in Elm and Haskell&lt;/p&gt;
&lt;/div&gt;
&lt;/blockquote&gt;
&lt;div class=&quot;attribution&quot;&gt;
&amp;#8212; Magnus&lt;br&gt;
&lt;cite&gt;(yeah I know; correlation does not imply causation)&lt;/cite&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&quot;toc&quot; class=&quot;toc&quot;&gt;
&lt;div id=&quot;toctitle&quot; class=&quot;title&quot;&gt;Table of Contents&lt;/div&gt;
&lt;ul class=&quot;sectlevel1&quot;&gt;
&lt;li&gt;&lt;a href=&quot;#_overview&quot;&gt;Overview&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_backend&quot;&gt;Backend&lt;/a&gt;
&lt;ul class=&quot;sectlevel2&quot;&gt;
&lt;li&gt;&lt;a href=&quot;#_adding_cors_support&quot;&gt;Adding cors support&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_enter_sqlite&quot;&gt;Enter SQLite&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_backend_summary&quot;&gt;Backend summary&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_frontend&quot;&gt;Frontend&lt;/a&gt;
&lt;ul class=&quot;sectlevel2&quot;&gt;
&lt;li&gt;&lt;a href=&quot;#_frontend_summary&quot;&gt;Frontend summary&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#_conclusion_and_next_steps&quot;&gt;Conclusion and next steps&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_overview&quot;&gt;Overview&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Useful resources&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Check out the other &lt;a href=&quot;http://rundis.github.io/blog/tags/haskellelmspa.html&quot;&gt;episodes&lt;/a&gt; in this blog series.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The accompanying &lt;a href=&quot;https://github.com/rundis/albums&quot;&gt;Albums&lt;/a&gt; sample app is on github, and there is a tag
for each episode&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;So what have I done for this episode ?&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Added persistence support to the haskell/servant backend server using &lt;a href=&quot;https://www.sqlite.org/&quot;&gt;SQLite&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;REST API now supports POST, PUT, DELETE and GET (multiple/single) Artists&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The Elm frontend has features for listing, deleting, updating and creating new artists&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;http://rundis.github.io/blog/2016/albumlistingpage.png&quot; alt=&quot;albumlistingpage&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;ve taken a bottom up approach to developing the features. For both the Frontend and the Backend I&amp;#8217;ve
implemented everything in one module. After that I&amp;#8217;ve done pretty substantial refactorings into smaller
modules while letting the respective compilers guide me along the way. So how did that work out ?&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_backend&quot;&gt;Backend&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Pretty early on I managed to get &lt;a href=&quot;https://github.com/lukexi/halive&quot;&gt;halive&lt;/a&gt; to start working. Having live recompiling is
really nice and seriously improved my workflow. I have very limited editor support because my editor (&lt;a href=&quot;https://github.com/LightTable/LightTable&quot;&gt;Light Table&lt;/a&gt;)
currently doesn&amp;#8217;t provide much in terms of haskell support. I was almost derailed with developing a Haskell plugin (or making the existing one work), but
managed to keep on track.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_adding_cors_support&quot;&gt;Adding cors support&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;During development of the spike for the previous episode I used a chrome plugin to get around CORS
restrictions from my browser. Surely this has to be solvable ? Indeed it was, &lt;a href=&quot;https://github.com/larskuhtz/wai-cors&quot;&gt;wai-cors&lt;/a&gt; to the rescue.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;backend/albums.cabal&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;  build-depends:
    -- ...
    ,  wai-cors
    -- ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;backend/src/Main.hs&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;;....

import Network.Wai.Middleware.Cors

;....

albumCors :: Middleware
albumCors = cors $ const (Just albumResourcePolicy)                             &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;


albumResourcePolicy :: CorsResourcePolicy                                       &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
albumResourcePolicy =
    CorsResourcePolicy
        { corsOrigins = Nothing -- gives you /*
        , corsMethods = [&quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;HEAD&quot;, &quot;OPTION&quot;]
        , corsRequestHeaders = simpleHeaders -- adds &quot;Content-Type&quot; to defaults
        , corsExposedHeaders = Nothing
        , corsMaxAge = Nothing
        , corsVaryOrigin = False
        , corsRequireOrigin = False
        , corsIgnoreFailures = False
        }


main :: IO ()
main = do
  run 8081 $ albumCors $ app                                                    &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Define wai cors middleware&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Define a cors policy. This one is very lax. You wouldn&amp;#8217;t want to use this for anything public facing as is&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Apply the middleware to our app. Now cross origin headers are added and OPTION prefligh requests are supported. Nice&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Cors inspiration harvested from &lt;a href=&quot;https://github.com/nicklawls/lessons&quot; class=&quot;bare&quot;&gt;https://github.com/nicklawls/lessons&lt;/a&gt; btw
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_enter_sqlite&quot;&gt;Enter SQLite&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I looked at a few different options for database support. Most examples and tutorials related
to servant and database usage seems to favor &lt;a href=&quot;http://www.yesodweb.com/book/persistent&quot;&gt;persistent&lt;/a&gt;.
I&amp;#8217;m surely going to have a closer look at that, but my initial impression was that perhaps there was just
a little bit to much going on there. Just a little bit to much &quot;magic&quot; ? Having lost my taste
for ORM&amp;#8217;s in the JVM spehere (hibernate in particular) I wanted to start with something closer to the metal.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So to make it a little harder for myself I went for the &lt;a href=&quot;https://github.com/nurpax/sqlite-simple&quot;&gt;sqlite-simple&lt;/a&gt; library.
Pretty happy with the choice so far.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;backend/albums.cabal&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;  build-depends:
    -- ...
    , sqlite-simple
    -- ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;backend/Main.hs&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;{-# LANGUAGE OverloadedStrings #-}
module Main where


import qualified Storage as S                              &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
import qualified Api as A                                  &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
import Network.Wai
import Network.Wai.Handler.Warp
import Servant
import Network.Wai.Middleware.Cors
import Control.Exception (bracket)
import Database.SQLite.Simple as Sql


app :: Sql.Connection -&amp;gt; Application
app conn = serve A.api (A.artistsServer conn)              &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;


testConnect :: IO Sql.Connection
testConnect = Sql.open &quot;:memory:&quot;                          &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;


withTestConnection :: (Sql.Connection -&amp;gt; IO a) -&amp;gt; IO a
withTestConnection cb =                                    &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
  withConn $ \conn -&amp;gt; cb conn
  where
    withConn = bracket testConnect Sql.close               &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;

{-
  ...
  cors stuff omitted, already covered
-}


main :: IO ()
main = do
  withTestConnection $ \conn -&amp;gt;  do
    S.bootstrapDB conn                                     &lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;(7)&lt;/b&gt;
    run 8081 $ albumCors $ app conn                        &lt;i class=&quot;conum&quot; data-value=&quot;8&quot;&gt;&lt;/i&gt;&lt;b&gt;(8)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Module with functions for communication with the Albums database. Only used for bootstrapping with test data in main&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Module that defines the webservice api&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We make sure to pass a connection to our webservice server&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;For simplicity we are using an in memory database&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Wrap a function (cb) giving it a connection and cleaning up when done&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;bracket&lt;/code&gt; ensures we also release the connection in case of any exceptions.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;7&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Creates schema and bootstraps with some sample data&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;8&quot;&gt;&lt;/i&gt;&lt;b&gt;8&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Ensure we pass the connection to our app function&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Read more about the &lt;a href=&quot;https://wiki.haskell.org/Bracket_pattern&quot;&gt;bracket pattern&lt;/a&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;backend/Api.hs&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;{-# LANGUAGE TypeOperators #-}
{-# LANGUAGE DataKinds     #-}

module Api where

import qualified Model as M                           &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
import qualified Storage as S
import Data.Aeson
import Control.Monad.IO.Class     (MonadIO, liftIO)
import Control.Monad.Trans.Either
import Servant
import Database.SQLite.Simple as Sql


instance ToJSON M.Artist
instance FromJSON M.Artist


type ArtistAPI =                                       &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
       Get &apos;[JSON] [M.Artist]
  :&amp;lt;|&amp;gt; ReqBody &apos;[JSON] M.Artist :&amp;gt; Post &apos;[JSON] M.Artist
  :&amp;lt;|&amp;gt; Capture &quot;artistId&quot; Int :&amp;gt; Get &apos;[JSON] M.Artist
  :&amp;lt;|&amp;gt; Capture &quot;artistId&quot; Int :&amp;gt; ReqBody &apos;[JSON] M.Artist :&amp;gt; Put &apos;[JSON] M.Artist
  :&amp;lt;|&amp;gt; Capture &quot;artistId&quot; Int :&amp;gt; Delete &apos;[] ()

-- &apos;

artistsServer :: Sql.Connection -&amp;gt; Server ArtistAPI    &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
artistsServer conn =
  getArtists :&amp;lt;|&amp;gt; postArtist :&amp;lt;|&amp;gt; getArtist :&amp;lt;|&amp;gt;  updateArtist :&amp;lt;|&amp;gt; deleteArtist

  where
    getArtists                   = liftIO $ S.findArtists conn     &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
    getArtist artistId           = liftIOMaybeToEither err404 $ S.artistById conn artistId
    postArtist artist            = liftIO $ S.newArtist conn artist
    updateArtist artistId artist = liftIO $ S.updateArtist conn artist artistId
    deleteArtist artistId        = liftIO $ S.deleteArtist conn artistId


liftIOMaybeToEither ::  (MonadIO m) =&amp;gt; a -&amp;gt; IO (Maybe b) -&amp;gt; EitherT a m b
liftIOMaybeToEither err x = do                         &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
    m &amp;lt;- liftIO x
    case m of
      Nothing -&amp;gt; left err
      Just x -&amp;gt; right x


type API = &quot;artists&quot; :&amp;gt; ArtistAPI


api :: Proxy API
api = Proxy&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The record definitions for our API lives in this module&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We&amp;#8217;ve extended the api type defintions from &lt;a href=&quot;http://rundis.github.io/blog/2015/haskell_elm_spa_part1.html#_main_hs&quot;&gt;episode 1&lt;/a&gt;
to define the shape of get multiple, get single, post, put and delete.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Connection has been added as a parameter to our artist server&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;liftIO&lt;/code&gt; is a &lt;a href=&quot;https://en.wikibooks.org/wiki/Haskell/Monad_transformers&quot;&gt;monad transformer&lt;/a&gt;. I&amp;#8217;d love to be able to explain
how it works, but well&amp;#8230;&amp;#8203; Anyways net result is that I don&amp;#8217;t have to define &lt;code&gt;EitherT ServantErr IO ..&lt;/code&gt; all over the place&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;liftIOMaybeToEither&lt;/code&gt; - what it says. Handy function to return a servant error (which again maps to a http error) if a function like getArtist doesn&amp;#8217;t return
a result. Tx to ToJans for &lt;a href=&quot;https://gist.github.com/ToJans/233f82087ee7b385e6e1&quot;&gt;inspiration&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
put aka update artist should also return a 404 when a non existing artist id is provided.
Actually, error handling is pretty light throughout, but we&amp;#8217;ll get back to that in a later episode !
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;/backend/Model.hs&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;{-# LANGUAGE DeriveGeneric #-}

module Model where

import GHC.Generics

data Artist = Artist                &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  { artistId :: Maybe Int           &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  , artistName :: String            &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  } deriving (Eq, Show, Generic)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Moved record defintions to a separate module. Currently just Artist&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Make id optional. This is a quick and dirty way to be able to use the same
record definiton for new artists as for updates and gets.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Names in records are not scoped withing the record so one solution is to manually
make sure names stay unique.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock warning&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-warning&quot; title=&quot;Warning&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
From what I gather record syntax is a bit clunky in Haskell (atleast when compared to Elm).
This &lt;a href=&quot;http://stackoverflow.com/questions/6922437/haskell-any-way-to-qualify-or-disambiguate-record-names&quot;&gt;stackoverflow post&lt;/a&gt;
didn&amp;#8217;t bring any warm fuzzy feelings. If anyone has some better solutions which also plays
well with the handy servant and SQLite simple functions feel free to leave a comment below !
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;backend/Storage.hs&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;{-# LANGUAGE OverloadedStrings #-}
module Storage where


import qualified Model as M
import qualified Data.Text as Txt


import Database.SQLite.Simple as Sql
import Database.SQLite.Simple.Types as SqlTypes


instance Sql.FromRow M.Artist where                         &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  fromRow = M.Artist &amp;lt;$&amp;gt; Sql.field &amp;lt;*&amp;gt; Sql.field



artistById :: Sql.Connection -&amp;gt; Int -&amp;gt; IO (Maybe M.Artist)  &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
artistById conn idParam =
  findById conn &quot;artist&quot; idParam :: IO (Maybe M.Artist)


findArtists :: Sql.Connection -&amp;gt; IO [M.Artist]
findArtists conn =
  Sql.query_ conn &quot;select * from artist&quot; :: IO [M.Artist]


newArtist :: Sql.Connection -&amp;gt; M.Artist -&amp;gt; IO M.Artist
newArtist conn artist = do
  Sql.execute conn &quot;insert into artist (name) values (?) &quot; (Sql.Only $ M.artistName artist)
  rawId &amp;lt;- lastInsertRowId conn
  let updArtist = artist { M.artistId = Just (fromIntegral rawId) }  &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  return updArtist


-- Really we should check whether the artist exists here
updateArtist :: Sql.Connection -&amp;gt; M.Artist -&amp;gt; Int -&amp;gt; IO M.Artist
updateArtist conn artist idParam = do
  Sql.executeNamed conn &quot;update artist set name = :name where id = :id&quot; params
  return artist { M.artistId = Just idParam }                        &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
  where
    params = [&quot;:id&quot; := (idParam :: Int), &quot;:name&quot; := ((M.artistName artist) :: String)]


deleteArtist :: Sql.Connection -&amp;gt; Int -&amp;gt; IO ()
deleteArtist conn idParam =
  Sql.execute conn &quot;delete from artist where id = ?&quot; (Sql.Only idParam)


findById :: (FromRow a) =&amp;gt; Sql.Connection -&amp;gt; String -&amp;gt; Int -&amp;gt; IO (Maybe a)
findById conn table idParam = do
  rows &amp;lt;- Sql.queryNamed conn (createFindByIdQuery table) [&quot;:id&quot; := (idParam :: Int)]
  let result = case (length rows) of
                  0 -&amp;gt; Nothing
                  _ -&amp;gt; Just $ head rows      &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;

  return result


createFindByIdQuery :: String -&amp;gt; SqlTypes.Query
createFindByIdQuery table =
  SqlTypes.Query $ Txt.pack $ &quot;SELECT * from &quot; ++ table ++ &quot; where id = :id&quot;   &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;

-- ... boostrap function left out, check the source repo for details&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Define SQLite row converter to create artist records for rows with id and name&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Finding an artist by Id may return empty results. Prematurely factored out a generic findById function that is used here&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Add the id of the newly inserted artist row to the resulting artist. (The Maybe artistId starts to smell)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Yuck, this smells even worse. The decision to support an optional id on the Artist record doesn&amp;#8217;t ring true&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Using let allows us to &quot;work inside&quot; the IO monad. Otherwise the compiler complains along the lines of &lt;code&gt;Couldn&amp;#8217;t match expected type ‘[r1]’ with actual type ‘IO [r0]’&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Whacking strings together is discouraged (helps avoid sql injection for one), but getting around it is possible with a little serimony&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_backend_summary&quot;&gt;Backend summary&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Well now we got persistence up and running with a good ole&apos; relational database. That&amp;#8217;s
not very exciting and I might return to change that in a future episode. The REST api is quite simple and lacking in validation and error handling, but it&amp;#8217;s hopefully a decent start and foundation
for future changes.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;After working with Clojure and Leiningen not to long ago, the server startup time feels blistering fast in comparison.
Getting halive to work made significant improvements to the development workflow.
When working with Haskell I get a constant reminder that I would benefit from learning more about the language
and fundemental concepts. The compiler messages still throws me off a lot of times, but the situation is gradually improving as I&amp;#8217;m learning.
I guess I&amp;#8217;m already spoilt with the error messages from Elm which feels a lot clearer and better at highlighting the root cause(s) of my mistakes.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;m still fumbling to design a sensible structure for the custom data types. I have a feeling
several iterations will be needed as I add support for additional services.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_frontend&quot;&gt;Frontend&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;It&amp;#8217;s a shame the hot reloading support in elm-reactor is broken at the time of writing, otherwise the development experience
would have been a lot better. &lt;code&gt;Make&lt;/code&gt; &amp;#8594; &lt;code&gt;reload browser&lt;/code&gt; is just a keystroak away in Light Table, but still.
Having the informative compiler error and warning messages inline in my Editor is really nice though.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Do better understand the elm-architecture I&amp;#8217;ve tried to follow, you should really check out the
&lt;a href=&quot;https://github.com/evancz/elm-architecture-tutorial&quot;&gt;tutorial&lt;/a&gt;. It does a much better job at explaining the core
concepts than I do.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;http://rundis.github.io/blog/2016/albums_pages.png&quot; alt=&quot;albums pages&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;frontend/Main.elm&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;module Main where


import ArtistListing
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onClick)
import Task exposing (..)
import Effects exposing (Effects, Never)
import StartApp


type alias Model =                                    &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  { artistListing : ArtistListing.Model}


type Action =                                         &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    ShowHomePage
  | ArtistListingAction ArtistListing.Action


init : (Model, Effects Action)                        &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
init =
  let
    (artistListing, fx) = ArtistListing.init
  in
    ( Model artistListing
      , Effects.map ArtistListingAction fx            &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
    )




update : Action -&amp;gt; Model -&amp;gt; (Model, Effects Action)
update action model =
  case action of

    ShowHomePage -&amp;gt;                                   &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
      let
        (artistListing, fx) = ArtistListing.init
      in
        ( {model | artistListing = artistListing}
        , Effects.map ArtistListingAction fx
        )

    ArtistListingAction sub -&amp;gt;                        &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
      let
        (artistListing, fx) = ArtistListing.update sub model.artistListing
      in
        ( {model | artistListing = artistListing}
        , Effects.map ArtistListingAction fx
        )


menu : Signal.Address Action -&amp;gt; Model -&amp;gt; Html
menu address model =
  header [class &quot;navbar navbar-default&quot;] [
    div [class &quot;container&quot;] [
      div [class &quot;navbar-header&quot;] [
        button [ class &quot;btn-link navbar-brand&quot;, onClick address ShowHomePage ]
        [text &quot;Albums Crud&quot;]
      ]
    ]
  ]


view : Signal.Address Action -&amp;gt; Model -&amp;gt; Html
view address model =
  div [class &quot;container-fluid&quot;] [
      menu address model   &lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;(7)&lt;/b&gt;
    , ArtistListing.view (Signal.forwardTo address ArtistListingAction) model.artistListing
  ]

-- ... app, main and port for tasks left out, no changes since previous episode&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The main model composes the artistlisting page model&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Actions for main, currently just holds the actions for ArtistListing + a convenience action to reset/show home page&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The init function from ArtistListing returns it&amp;#8217;s model and an effect (get artist from server task). We initialize the
main model with the artistlisting model&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We map the effect from ArtistListing to an Main module effect which is then handled by the startapp &quot;signal loop&quot;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Quick and dirty way to trigger showing of the artist listing page (re-initialized)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;All ArtistListing actions are tagged with ArtistListingAction, we delegate to the update function for ArtistListing
, update the main model accordingly and the map the returne effect&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;7&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;To get/create the view for ArtistListing we call it&amp;#8217;s view function, but we need to ensure signals sent from  ArtistListing makes it back to the main view mailbox address. &lt;code&gt;Signal.forwardTo&lt;/code&gt; helps us create a forwarding address.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Read more about &lt;a href=&quot;https://github.com/elm-guides/elm-for-js/blob/master/Mailboxes%2C%20Messages%2C%20and%20Addresses.md#talk-to-this-guy&quot;&gt;Mailboxes, Messages and Addresses&lt;/a&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;frontend/ArtistListing.elm&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;module ArtistListing (Model, Action (..), init, view, update) where


import ServerApi exposing (..)                                                 &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
import ArtistDetail
-- ... other imports ommited

type Page = ArtistListingPage | ArtistDetailPage


type alias Model =
  { artists : List Artist
  , artistDetail : ArtistDetail.Model
  , page : Page}



type Action =
    HandleArtistsRetrieved (Maybe (List Artist))
  | SelectArtist (Int)
  | DeleteArtist (Int)
  | HandleArtistDeleted (Maybe Http.Response)
  | ArtistDetailAction ArtistDetail.Action
  | NewArtist


init : (Model, Effects Action)
init =
  let
    (artistDetail, fx) = ArtistDetail.init
  in
    ( Model [] artistDetail ArtistListingPage
      , getArtists HandleArtistsRetrieved                                      &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    )


update : Action -&amp;gt; Model -&amp;gt; (Model, Effects Action)
update action model =
  case action of

    HandleArtistsRetrieved xs -&amp;gt;                                               &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
      ( {model | artists = (Maybe.withDefault [] xs) }
      , Effects.none
      )

    DeleteArtist id -&amp;gt;
      (model, deleteArtist id HandleArtistDeleted)

    HandleArtistDeleted res -&amp;gt;
      (model, getArtists HandleArtistsRetrieved)

    NewArtist -&amp;gt;                                                              &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
      update (ArtistDetailAction &amp;lt;| ArtistDetail.ShowArtist Nothing) model

    SelectArtist id -&amp;gt;
      update (ArtistDetailAction &amp;lt;| ArtistDetail.GetArtist id) model

    ArtistDetailAction sub -&amp;gt;                                                 &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
      let
        (detailModel, fx) = ArtistDetail.update sub model.artistDetail
      in
        ( { model | artistDetail = detailModel
                  , page = ArtistDetailPage }                                 &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
        , Effects.map ArtistDetailAction fx
        )



-- ... artistView details ommitted for brevity

view : Signal.Address Action -&amp;gt; Model -&amp;gt; Html
view address model =
  div [class &quot;content&quot;] [
    case model.page of                                                       &lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;(7)&lt;/b&gt;

      ArtistListingPage -&amp;gt;
        artistsView address model

      ArtistDetailPage -&amp;gt;
        ArtistDetail.view (Signal.forwardTo address ArtistDetailAction) model.artistDetail

  ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The &lt;code&gt;ServerApi&lt;/code&gt; module exposes functions to interact with the backend server&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;getArtists HandleArtistsRetrieved&lt;/code&gt; calls the serverAPI with a action param, so that when the ajax/xhr callback finally makes in back into the elm signal loop, the update function is called with the action we want&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Update the model with the list of artists retrieved (if any)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;To show the artist detail page in &quot;create&quot; mode we create a ArtistDetailAction with the appropriate ArtistDetail.action&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;ArtistDetailAction sub actions are actions that are delegated to the actions of the ArtistDetail module.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Note that we change &quot;page context&quot; here so that the view function displays the appropriate page&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;7&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Our naive page routing, just toggles display of pages by the page attribute of our model&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We&amp;#8217;ve implemented a very simplistic page routing here. In a later episode we will refactor to
something more managable for handling proper page routing.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;div class=&quot;title&quot;&gt;frontend/ArtistDetail.elm&lt;/div&gt;
&lt;p&gt;This page handles update/creation of a single Artist. I&amp;#8217;ll leave it to you to check out
the details of the &lt;a href=&quot;https://github.com/rundis/albums/releases/tag/part_2&quot;&gt;sample code&lt;/a&gt; on github.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;frontend/ServerApi.elm&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;module ServerApi where


import Json.Decode as JsonD exposing ((:=))
import Json.Encode as JsonE
import Effects exposing (Effects)
import Http
import Task


type alias ArtistRequest a =                                                 &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  { a | name : String }

type alias Artist =
  { id : Int
  , name : String
  }

baseUrl : String
baseUrl = &quot;http://localhost:8081&quot;


getArtist : Int -&amp;gt; (Maybe Artist -&amp;gt; a) -&amp;gt; Effects.Effects a
getArtist id action =                                                        &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  Http.get artistDecoder (baseUrl ++ &quot;/artists/&quot; ++ toString id)
    |&amp;gt; Task.toMaybe
    |&amp;gt; Task.map action                                                       &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
    |&amp;gt; Effects.task


getArtists : (Maybe (List Artist) -&amp;gt; a) -&amp;gt; Effects a
getArtists action =
  Http.get artistsDecoder (baseUrl ++ &quot;/artists&quot;)
    |&amp;gt; Task.toMaybe
    |&amp;gt; Task.map action
    |&amp;gt; Effects.task

createArtist : ArtistRequest a -&amp;gt; (Maybe Artist -&amp;gt; b) -&amp;gt; Effects.Effects b
createArtist artist action =                                                 &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
  Http.send Http.defaultSettings
        { verb = &quot;POST&quot;
        , url = baseUrl ++ &quot;/artists&quot;
        , body = Http.string (encodeArtist artist)                           &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
        , headers = [(&quot;Content-Type&quot;, &quot;application/json&quot;)]
        }
    |&amp;gt; Http.fromJson artistDecoder
    |&amp;gt; Task.toMaybe
    |&amp;gt; Task.map action
    |&amp;gt; Effects.task

-- .. the remaining services and encoding|decoding left out for brevity&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This type is an extensible &lt;a href=&quot;http://elm-lang.org/docs/records#record-types&quot;&gt;record type&lt;/a&gt;. It allows our
artist related services to be a little bit more generic and still keep a level of type checking&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;GET a single artist from our backend api. (Actually it returns and effect that will executa a &lt;a href=&quot;http://elm-lang.org/guide/reactivity#tasks&quot;&gt;task&lt;/a&gt; which upon callback will eventually call the update function in our app with the given action)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We&amp;#8217;ve relented on type safety for actions by allowing it to be a generic param, but we gain some flexibility
that allows our service to be usable in many different contexts&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;To take more control over http actions we use &lt;code&gt;Http.send&lt;/code&gt;. It&amp;#8217;s closer to the metal so it&amp;#8217;s a little
bit more boilerplate.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Encode the artist (request) to a json string&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To see the remaining services and details of decoding and encoding please consolt the &lt;a href=&quot;https://github.com/rundis/albums/releases/tag/part_2&quot;&gt;sample code&lt;/a&gt; on github.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_frontend_summary&quot;&gt;Frontend summary&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We are beginning to see the resmblance of a Single Page Application. We have started to compose
views and pages using the Elm Architecture. The app supports basic CRUD oparations for an Artist entity.
Error handling is light, there is no validation and our routing solution is overly simplistic, but we&amp;#8217;ll get
to that soonish !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Working with Elm has been an absolute pleasure. The compiler messages really do help. Doing refactoring (without tests I might add)
doesn&amp;#8217;t feel anywhere near as scary as I&amp;#8217;m used to from other languages.
I&amp;#8217;m starting to understand more about the Elm Architecture, but I&amp;#8217;m still getting a little confused about the details
of Signals, Tasks, Mailboxes, Effects etc. It&amp;#8217;s coming to me gradually. The important thing is I can still be quite productive
even though I don&amp;#8217;t understand all the details.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sidebarblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I have to say I&amp;#8217;m not looking forward to my next refactoring in some messy imperative jquery page mutant at work.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_conclusion_and_next_steps&quot;&gt;Conclusion and next steps&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;m aware this blog post got way to long even though I tried to shave of some of the code from the
code listings. I&amp;#8217;ll have to try to take on smaller/more targeted chunks in future episodes.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Anyways. I&amp;#8217;m staring to feel I&amp;#8217;m getting somewhere now. Both with Haskell and Elm. Learning Haskell is
by far the most challenging but getting my head around Functional Reactive Programming in Elm isn&amp;#8217;t without challenges either.
My motivation is still strong and I&amp;#8217;m learning a ton of stuff.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Candidate areas to address for the next episode are; routing, validation, error handling and obviously more useful features.
I&amp;#8217;m thinking perhaps routing comes first, but we&amp;#8217;ll see.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Managing and diagramming elm packages with d3 in Light Table</title>
      <link>http://rundis.github.io/blog/2016/elm_light_package.html</link>
      <pubDate>Fri, 1 Jan 2016 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2016/elm_light_package.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In an effort to making management of project dependencies in Elm projects a little easier, the Elm plugin
for &lt;a href=&quot;http://lighttable.com/&quot;&gt;Light Table&lt;/a&gt; the &lt;a href=&quot;https://github.com/rundis/elm-light&quot;&gt;elm-light&lt;/a&gt; has a few neat features up it&amp;#8217;s sleave.
Check out the demo below for a brief overview.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
You can find the elm-light plugin &lt;a href=&quot;https://github.com/rundis/elm-light&quot;&gt;here&lt;/a&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_demo&quot;&gt;Demo&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://youtu.be/Okk-YjEeUgI&quot;&gt;ScreenCast demo&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;iframe width=&quot;420&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/Okk-YjEeUgI&quot; frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Other relevant demos:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;http://rundis.github.io/blog/2015/elm_light.html&quot;&gt;elm-light intro demo&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_short_implementation_summary&quot;&gt;Short implementation summary&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;m just going to give a very brief overview of a few key pieces for how the features are implemented here.
I might add a more detailed blog post if there is any interest for that in the future.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_package_management&quot;&gt;Package management&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The package manager is just a thin wrapper around the &lt;code&gt;elm-package&lt;/code&gt; executable.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn parse-json-file [json-file]
  (when (files/exists? json-file)
    (-&amp;gt; (-&amp;gt;&amp;gt; (files/open-sync json-file)
             :content
             (.parse js/JSON))
        (js-&amp;gt;clj :keywordize-keys true))))


(defn remove-pkg [path pkg]
  (let [pkg-file (files/join path &quot;elm-package.json&quot;)]
    (-&amp;gt; (u/parse-json-file pkg-file)
        (update-in [:dependencies] (fn [deps]
                                     (-&amp;gt; (into {}
                                               (map (fn [[k v]]
                                                      [(u/nskw-&amp;gt;name k) v]) deps))
                                         (dissoc pkg))))
        u/pretty-json
        ((partial files/save pkg-file)))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To list, update and remove dependencies it parses (and updates) the project file for elm projects; &lt;code&gt;elm-package.json&lt;/code&gt;. In addition
it parses the &lt;code&gt;exact-dependencies.json&lt;/code&gt; file for all resolved dependencies.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Working with json in ClojureScript feels almost seamless to working with native ClojureScript datastructures
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_view_rendering&quot;&gt;View rendering&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To render the package listing the plugin uses &lt;a href=&quot;https://github.com/levand/quiescent&quot;&gt;quiescent&lt;/a&gt; and &lt;a href=&quot;https://facebook.github.io/react/&quot;&gt;react&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(q/defcomponent PackageTable [props]
  (d/table
   {:className &quot;package-table&quot;}
   (d/thead
    {}
    (d/tr
     {}
     (d/th {} &quot;Package&quot;)
     (d/th {} &quot;Range&quot;)
     (d/th {} &quot;Exact&quot;)
     (d/th {} &quot;&quot;)))
   (apply d/tbody {}
          (map #(PackageRow (assoc %
                              :on-remove (:on-remove props)
                              :on-browse (:on-browse props)))
               (:packages props)))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;You can find a detailed blog post about some of the benefits of using react for view rendering in Light Table
in &lt;a href=&quot;http://rundis.github.io/blog/2015/lt_react.html&quot;&gt;Implementing a Clojure ns-browser in Light Table with React&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_dependency_autocompletion&quot;&gt;Dependency autocompletion&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Whan adding dependencies there is a handy autocompleter. This uses a json resource from &lt;a href=&quot;http://package.elm-lang.org/&quot; class=&quot;bare&quot;&gt;http://package.elm-lang.org/&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn fetch-all-packages
  &quot;Fetch all packages from package.elm-lang.org&quot;
  [callback]
  (fetch/xhr (str &quot;http://package.elm-lang.org/all-packages?date=&quot; (.getTime (new js/Date)))
             {}
             (fn [data]
               (let [pkgs (js-&amp;gt;clj (.parse js/JSON data) :keywordize-keys true)]
                 (callback pkgs)))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_dependency_graph&quot;&gt;Dependency graph&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To implement the dependency graph d3 and dagreD3 is used. Both of these ships node-modules. Using node-modules from
Light Table plugins is definetely not rocket science !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(def dagreD3 (js/require (files/join u/elm-plugin-dir &quot;node_modules/dagre-d3&quot;)))
(def d3 (js/require (files/join u/elm-plugin-dir &quot;node_modules/d3&quot;)))


defn create-graph [data]                                                         &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (let [g (.setGraph (new dagreD3.graphlib.Graph)  #js {})]
    (doseq [x (:nodes data)]
      (.setNode g (dep-id x) (node-label x)))
    (doseq [x (:edges data)]
      (.setEdge g (:a x) (:b x) #js {:label (:label x)
                                     :style (when (:transitive x)
                                              &quot;stroke-dasharray: 5, 5;&quot;)}))
    g))



(behavior ::on-render                                                           &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
          :desc &quot;Elm render dependencies&quot;
          :triggers #{:elm.graph.render}
          :reaction (fn [this]
                      (let [svg (.select d3 &quot;svg&quot;)
                            g (.select svg &quot;g&quot;)
                            renderer (.render dagreD3)]
                        (renderer g (create-graph (:data @this)))
                        (init-zoom svg g)
                        (resize-graph this svg))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The function to create the dependency graph. Helper functions omitted, but not much to it really&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Light Table behavior that is responsible for rendering the graph&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_credits&quot;&gt;Credits&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;http://d3js.org/&quot;&gt;d3.js&lt;/a&gt; - Provides awesome graphing features&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/cpettitt/dagre-d3&quot;&gt;dagreD3&lt;/a&gt; - Create Directed Acyclic Graphs in a breeze&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Typed up CRUD SPA with Haskell and Elm  - Part 1: Spike time</title>
      <link>http://rundis.github.io/blog/2015/haskell_elm_spa_part1.html</link>
      <pubDate>Mon, 28 Dec 2015 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2015/haskell_elm_spa_part1.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Join me on my journey into statically typed functional languages. I&amp;#8217;ve been living a pretty happily
dynamic life so far. What&amp;#8217;s the fuzz with all those types ? What do they give me in a real life
scenario (aka is it worth using for work gigs) ? I need to make an effort and try to figure
some of this out. This blog series is an attempt to document some of my experiences along the way through a practical example.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;There will be:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;A single page web application with crud features&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Lots of types, refactoring and hopefully some testing&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;An evolving web-app github repo for your amusement or amazement&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_just_a_little_background_on_me&quot;&gt;Just a little background on me&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;For quite some time I&amp;#8217;ve been wanting to learn more about functional languages that are statically (and strongly) typed.
What benefits do they really provide in practice and what are the downsides ?
My background is a from quite a few years with Java, and the last 3-4 years I&amp;#8217;ve been working
 mostly with Groovy, JavaScript and Clojure/ClojureScript.
I&amp;#8217;ve dabbled a little with Elm recently (&lt;a href=&quot;http://rundis.github.io/blog/2015/elm_sweeper.html&quot;&gt;minesweeper in Elm&lt;/a&gt;)
, and I&amp;#8217;ve tried to take on Haskell a couple of times (without much success I might add).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I mostly do web apps at work, so I figured I need to try and make something at least remotely
similar to what I do in real life.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_let_s_get_started&quot;&gt;Let&amp;#8217;s get started&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This is the point where I&amp;#8217;ve run into analysis paralysis so many a time before.
So I set out to create a crud app, but what shall I build. After some deliberation
I settled on making something related to Music. You know Albums, Artists, Tracks and such.
I have no idea what the end result will be, but to start off I&amp;#8217;ll make a simple spike.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;http://rundis.github.io/blog/2015/artists.png&quot; alt=&quot;artists&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;The spike should&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;establish a base architecture&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;implement a simple feature: &lt;strong&gt;List artists&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;You will find the sample application code on &lt;a href=&quot;https://github.com/rundis/albums&quot;&gt;github&lt;/a&gt;.
There will be a tag for each blog post in the series&lt;/p&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_backend&quot;&gt;Backend&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I wanted to implement server component that would provide REST-services. There are quite
a few options available for Haskell that can help with that. After some research and trials
I ended up using &lt;a href=&quot;https://haskell-servant.github.io/&quot;&gt;Servant&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Some of the other options I looked at includes:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://www.spock.li/&quot;&gt;Spock&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/scotty-web/scotty&quot;&gt;Scotty&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;http://snapframework.com/&quot;&gt;Snap&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;http://www.yesodweb.com/&quot;&gt;Yesod&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I just had to choose one, and Servant seemed like a nice fit for REST stuff and I managed to get it
working without to much hazzle.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_project_set_up&quot;&gt;Project set up&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;m using &lt;a href=&quot;https://www.haskell.org/cabal/&quot;&gt;cabal&lt;/a&gt;, but you might also want to consider looking
at &lt;a href=&quot;http://docs.haskellstack.org/en/stable/index.html&quot;&gt;stack&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;name:                albums
version:             0.1.0.0
synopsis:            Albums rest backend
license:             MIT
license-file:        LICENSE
author:              rundis
maintainer:          mrundberget@hotmail.com
category:            Web
build-type:          Simple
cabal-version:       &amp;gt;=1.10

executable albums
  main-is:             Main.hs              &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  build-depends:
      base &amp;gt;= 4.7 &amp;amp;&amp;amp; &amp;lt; 5
    , either
    , aeson &amp;gt;= 0.8                          &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    , servant                               &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
    , servant-server
    , wai
    , warp
  hs-source-dirs:      src                  &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
  default-language:    Haskell2010&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The entry point for the application&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Provides JSON support&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The servant library that helps us create type safe rest services&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The directory(ies) where the source code for our app resides&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;For the purposes of this spike all haskell code will reside in &lt;code&gt;Main.hs&lt;/code&gt;. This will
surely not be the case as the app progresses.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
If you wan&amp;#8217;t to try out automatic reloading support, you may want to check out &lt;a href=&quot;https://github.com/lukexi/halive&quot;&gt;halive&lt;/a&gt;.
Unfortunately I couldn&amp;#8217;t get it to work on my machine (OS/X Maverick), but it might work our for you though :-)
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_main_hs&quot;&gt;Main.hs&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;data Artist = Artist
  { artistId :: Int
  , name :: String
  } deriving (Eq, Show, Generic)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A simple type describing the shape of an Artist in our app.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;instance ToJSON Artist                                       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;

type ArtistAPI =                                             &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
       Get &apos;[JSON] [Artist]                                  &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  :&amp;lt;|&amp;gt; Capture &quot;artistId&quot; Int :&amp;gt; Get &apos;[JSON] Artist          &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;


artistsServer :: Server ArtistAPI
artistsServer = getArtists :&amp;lt;|&amp;gt; artistOperations             &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;

  where getArtists :: EitherT ServantErr IO [Artist]
        getArtists = return artists                          &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;

        artistOperations artistId =
          viewArtist

          where viewArtist :: EitherT ServantErr IO Artist
                viewArtist = artistById artistId             &lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;(7)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;ToJSON&lt;/code&gt; is a &lt;a href=&quot;https://www.haskell.org/tutorial/classes.html&quot;&gt;type class&lt;/a&gt;. This line
basically is all we need to set up for json encoding an instance of our Artist type.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We describe our REST api using a type&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Get on this api returns a list of Artists&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Definition of how to get a single Artist by it&amp;#8217;s id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The &lt;code&gt;server&lt;/code&gt; type is the part where we descibe how we actually serve the api&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The handler for listing artists. Currently it just returns a static list&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;7&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The handler for retrieving a given artist by its id&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;code&gt;:&amp;lt;&amp;gt;&lt;/code&gt; is a &lt;a href=&quot;https://wiki.haskell.org/Combinator&quot;&gt;combinator&lt;/a&gt; that ships with Servant. It allows us to combine the various parts
of our API into a single type.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;artistById :: Int -&amp;gt; EitherT ServantErr IO Artist
artistById idParam =
  case a of
    Nothing -&amp;gt; left (err404 {errBody = &quot;No artist with given id exists&quot;})  &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
    Just b -&amp;gt; return b                                                     &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  where
    a = find ((== idParam) . artistId) artists                             &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If the find (by id) in &lt;strong&gt;3&lt;/strong&gt; returns Nothing (see &lt;a href=&quot;https://hackage.haskell.org/package/base-4.8.1.0/docs/Data-Maybe.html&quot;&gt;Maybe monad&lt;/a&gt;).
We return a 404 error with a custom body&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Upon success return the given artist instance&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Find a given artist by id from our List of artists&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;code&gt;EitherT&lt;/code&gt; - An either monad. Check out the description from the servant tutorial on &lt;a href=&quot;https://haskell-servant.github.io/tutorial/server.html#the-eithert-servanterr-io-monad&quot;&gt;EitherT&lt;/a&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Wrapping it all up&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;type API = &quot;artists&quot; :&amp;gt; ArtistAPI    &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;


api :: Proxy API
api = Proxy                          &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;


app :: Application
app = serve api artistsServer        &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;


main :: IO ()
main = run 8081 app                  &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;A generic type for our api. It let&amp;#8217;s us combine multiple types, but the
main reason it&amp;#8217;s factored out for now is to avoid repetion of the root path for our
api &lt;code&gt;artists&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;TBH I haven&amp;#8217;t grokked why this is needed, but it&amp;#8217;s probably to do with some type magic ?&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;An &quot;abstract&quot; web application. serve gives us a &lt;a href=&quot;http://www.stackage.org/package/wai&quot;&gt;WAI&lt;/a&gt; web application.
I guess WAI is like a common API for Haskell Web applicaitons.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The main entry point for our application. It starts our web application on port 8081
(and uses &lt;a href=&quot;http://www.stackage.org/package/warp&quot;&gt;warp&lt;/a&gt; behind the scene to do so.)&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To get the backend up and running, check out the readme for the &lt;a href=&quot;https://github.com/rundis/albums&quot;&gt;sample application&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_backend_experiences&quot;&gt;Backend experiences&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Following the &lt;a href=&quot;https://haskell-servant.github.io/tutorial/server.html&quot;&gt;Servant tutorial&lt;/a&gt; it was quite
easy to get a simple translated example to work. However I did start to struggle once I started
to venture off from the tutorial. Some of it is obviously due to my nearly non-existing haskell knowledge.
But I think what tripped me up most was the EitherT monad. Heck I still don&amp;#8217;t really know what
a monad is. The error messages I got along the way didn&amp;#8217;t help me much, but I guess gradually
they&amp;#8217;ll make more and more sense, once my haskell foo improves.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_frontend&quot;&gt;Frontend&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So Elm is pretty cool. The syntax isn&amp;#8217;t too far off from Haskell. I&amp;#8217;ve already started
looking at Elm so it makes sense continuing with Elm to hopefully gain deeper knowledge of its
strenghts and weaknesses.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
For a really pleasurable experience when developing elm I would suggest choosing an
editor with linting support. As a shameless plug, one suggestion would be to use &lt;a href=&quot;http://lighttable.com/&quot;&gt;Light Table&lt;/a&gt;
with my &lt;a href=&quot;https://github.com/rundis/elm-light&quot;&gt;elm-light&lt;/a&gt; plugin. (Emacs, Vim, Sublime, Visual Code are other good options)
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_project_setup&quot;&gt;Project setup&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;{
    &quot;version&quot;: &quot;1.0.0&quot;,
    &quot;summary&quot;: &quot;The frontend for the Albums CRUD sample app&quot;,
    &quot;repository&quot;: &quot;https://github.com/rundis/albums.git&quot;,
    &quot;license&quot;: &quot;MIT&quot;,
    &quot;source-directories&quot;: [
        &quot;.&quot;                                                      &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
    ],
    &quot;exposed-modules&quot;: [],
    &quot;dependencies&quot;: {                                            &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
        &quot;elm-lang/core&quot;: &quot;3.0.0 &amp;lt;= v &amp;lt; 4.0.0&quot;,
        &quot;evancz/elm-effects&quot;: &quot;2.0.1 &amp;lt;= v &amp;lt; 3.0.0&quot;,
        &quot;evancz/elm-html&quot;: &quot;4.0.2 &amp;lt;= v &amp;lt; 5.0.0&quot;,
        &quot;evancz/elm-http&quot;: &quot;3.0.0 &amp;lt;= v &amp;lt; 4.0.0&quot;,
        &quot;evancz/start-app&quot;: &quot;2.0.2 &amp;lt;= v &amp;lt; 3.0.0&quot;
    },
    &quot;elm-version&quot;: &quot;0.16.0 &amp;lt;= v &amp;lt; 0.17.0&quot;
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;For simplicity source files currently resides in the root folder of the project.
This will change once the application grows&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Initial set of dependencies used&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_album_elm&quot;&gt;Album.elm&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Before you start you may want to check out &lt;a href=&quot;https://github.com/evancz/start-app&quot;&gt;start-app&lt;/a&gt;.
The frontend code is based on this.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type alias Artist =                                     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  { id : Int
  , name : String
  }

type alias Model =                                      &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  { artists : List Artist}


type Action = ArtistRetrieved (Maybe (List Artist))     &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Front end representation of Artist. You&amp;#8217;ll notice it&amp;#8217;s strikingly similar
to it&amp;#8217;s Haskell counterpart on the server side&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Type for keeping track of our model. Currently it will only contain
a list of artists, but there is more to come later&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&quot;Tagged type&quot; that describes the actions supported in the frontend app.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;init : (Model, Effects Action)
init =                                                  &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  ( Model []
    , getArtists
  )


update : Action -&amp;gt; Model -&amp;gt; (Model, Effects Action)
update action model =                                  &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  case action of
    ArtistRetrieved xs -&amp;gt;
      ( {model | artists = (Maybe.withDefault [] xs) }
      , Effects.none
      )


getArtists : Effects.Effects Action
getArtists =                                           &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  Http.get artists &quot;http://localhost:8081/artists&quot;
    |&amp;gt; Task.toMaybe
    |&amp;gt; Task.map ArtistRetrieved
    |&amp;gt; Effects.task


artist : Json.Decoder Artist
artist =                                               &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
  Json.object2 Artist
    (&quot;artistId&quot; := Json.int)
    (&quot;name&quot; := Json.string)


artists : Json.Decoder (List Artist)
artists =                                              &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
  Json.list artist&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Initializer function called by start-app when staring the application
it returns an empty model and an effect &lt;code&gt;getArtists&lt;/code&gt;. Meaning getArtists will be
invoked once the page is loaded&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The update function handles actions in our app. Currently it only supports
one action, and that is the a callback once getArtists have returned. It updates
the model with the retrieved artists and returns the updated model&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Our ajax call ! We invoke the our rest endpoint using the elm http library. The first
argument to Http.get, &lt;code&gt;artists&lt;/code&gt;, tells elm how to decode the result.
A lot is going on here, but the end result is that it does an xhr request decodes the result (if success)
using the given decoder and eventually invoke the update function with our list of artists (wrapped in a Maybe).&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;A decoder for decoding the json representation of an artist from the server to and &lt;code&gt;Artist&lt;/code&gt; type instance&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The response from our rest endpoint is a list of artists, so we use the JSON.list function
telling it to use our artist decoder for each item in the list&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;artistRow : Artist -&amp;gt; Html
artistRow artist =                                     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  tr [] [
     td [] [text (toString artist.id)]
    ,td [] [text artist.name]
  ]

view : Signal.Address Action -&amp;gt; Model -&amp;gt; Html
view address model =                                  &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  div [class &quot;container-fluid&quot;] [
        h1 [] [text &quot;Artists&quot; ]
      , table [class &quot;table table-striped&quot;] [
          thead [] [
            tr [] [
               th [] [text &quot;Id&quot;]
              ,th [] [text &quot;Name&quot;]
          ]
        ]
      , tbody [] (List.map artistRow model.artists)
    ]
  ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Function to generate the view for a single artist row&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Our main view function for presenting a list of artists&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
We are not rendering dom nodes here, it&amp;#8217;s just a representation of what we want
to render. The actual rendering uses Virual DOM.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Wrapping up the frontend&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;app : StartApp.App Model
app =                                          &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  StartApp.start
    { init = init
    , update = update
    , view = view
    , inputs = []
    }



main : Signal Html
main =                                         &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  app.html



port tasks : Signal (Task.Task Never ())
port tasks =                                   &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  app.tasks&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Using startapp to wire up our core functions (init, update and view)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The entry point function for our frontend app&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When communicating with the outside world elm uses &lt;a href=&quot;http://elm-lang.org/guide/interop#ports&quot;&gt;ports&lt;/a&gt;.
This is used for by our rest invocation. It does so using &lt;a href=&quot;http://elm-lang.org/guide/reactivity#tasks&quot;&gt;tasks&lt;/a&gt; which
is the elm way to describe asynchronous operations.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_frontend_experiences&quot;&gt;Frontend experiences&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Elm ports, tasks and effects are concepts that are yet to dawn completely on me. I protect my brain
temporarily by giving them overy simplistic explanations.
I wasn&amp;#8217;t sure how to do the JSON decoding stuff, but fired up an elm-repl in Light Table and just experiemented a little until
I had something workable.
I used the linter feature of my Light Table plugin quite heavily, and the error messages from elm proved yet again
to be very helpful.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_conclusion_and_next_steps&quot;&gt;Conclusion and next steps&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I pretty sure I could have knocked this up with Clojure/ClojureScript, groovy/grails or plan old JavaScript
in a fraction of the time I&amp;#8217;ve used. But that&amp;#8217;s not really a fair or relevant comparison.
Learning completely new languages and new libraries takes time.
I think I&amp;#8217;ve learned quite a bit already and I&amp;#8217;m very pleased to have made it this far !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Elm was easier to get into than Haskell and the Elm compiler felt a lot more helpful to me than
ghc (haskell compiler). I had a head start on Elm, but I do remember getting started with Elm felt
a lot smoother than jumping into Haskell. I&amp;#8217;m still very much looking forward to improving my haskell skills
and I&amp;#8217;m sure that will proove very valuable eventually.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So what&amp;#8217;s up next? Not sure, but i think adding persistence and the facility to add/update
artists might be next up. I will keep you posted !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Minesweeper - a brief journey from JavaScript/React to Elm</title>
      <link>http://rundis.github.io/blog/2015/elm_sweeper.html</link>
      <pubDate>Tue, 10 Nov 2015 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2015/elm_sweeper.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;After taking a keen interest to Elm lately I figured I needed to solve a real problem. Something a bit fun and achievable in a couple of evenings/nights.
Not being awfully creative, piggiebacking on other peoples&apos; work is sometimes a good option.
In this post I&amp;#8217;ll take you through some of my steps in porting/re-implementing &lt;a href=&quot;https://github.com/cjohansen/react-sweeper&quot; class=&quot;bare&quot;&gt;https://github.com/cjohansen/react-sweeper&lt;/a&gt; (JavaScript and React) to an Elm implementation.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;http://rundis.github.io/blog/2015/elm_sweeper.png&quot; alt=&quot;elm sweeper&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
If you&amp;#8217;d like to have a look at the complete implementation of the game, check out &lt;a href=&quot;https://github.com/rundis/elm-sweeper&quot; class=&quot;bare&quot;&gt;https://github.com/rundis/elm-sweeper&lt;/a&gt;.
There you&amp;#8217;ll find instructions on how to get it running too.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_a_little_background&quot;&gt;A little background&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Right! So I&amp;#8217;ve taken an interest in &lt;a href=&quot;http://elm-lang.org/&quot;&gt;Elm&lt;/a&gt; lately.  If you&amp;#8217;ve read any of my previous posts you might have
noticed that I&amp;#8217;m quite fond of Clojure and ClojureScript. I still very much am and I have tons to learn there still. But I wanted  to dip my toes
into a statically typed functional language. Elm seems quite approachable and I guess probably the talk &lt;a href=&quot;https://www.youtube.com/watch?v=oYk8CKH7OhE&quot;&gt;&quot;Let&amp;#8217;s be mainstream&quot;&lt;/a&gt;
made my mind up to give it a go. After creating a language plugin for Light Table: &lt;a href=&quot;http://rundis.github.io/blog/2015/elm_light.html&quot;&gt;elm-light&lt;/a&gt;
 and attending an Elm workshop at CodeMesh, I needed something concrete to try it out on.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I remembered that a colleague of mine  &lt;a href=&quot;http://www.kodemaker.no&quot;&gt;at Kodemaker&lt;/a&gt;, Christian Johansen,  made a minesweeper implementation using JavaScript and React.
That seemed like a sufficiently interesting problem and I could shamelessly steal most of the game logic :)&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_first_steps_the_game_logic&quot;&gt;First steps - The Game Logic&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So the obvious place to start was the game logic. I had the option of trying to set up &lt;a href=&quot;https://github.com/deadfoxygrandpa/Elm-Test&quot;&gt;Elm-Test&lt;/a&gt;
to use a test-driven inspired approach. But heck I figured I had to try to put those types to the test, so I went for
an all out repl driven approach. That gave me a chance to experience the good and bad with the &lt;a href=&quot;https://github.com/rundis/elm-light#56-editor-repl&quot;&gt;repl integration&lt;/a&gt; of my own Light Table Elm plugin too.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;http://rundis.github.io/blog/2015/elm_repl.png&quot; alt=&quot;elm repl&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_starting_with_records_and_type_aliases&quot;&gt;Starting with records and type aliases&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Reading the &lt;a href=&quot;https://github.com/cjohansen/react-sweeper/blob/master/immutable-es6/src/game.js&quot;&gt;game logic&lt;/a&gt; in react-sweeper I decided to
define a couple of types&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type alias Tile               &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  { id: Int
  , threatCount: Maybe Int    &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  , isRevealed: Bool
  , isMine: Bool}

type GameStatus = IN_PROGRESS | SAFE | DEAD

type alias Game =             &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  { status: GameStatus        &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
  , rows: Int
  , cols: Int
  , tiles: List Tile}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Type alias for records representing a tile in the game.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Threat count is a property on a tile that is not set until the game logic allows it.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Type alias for a record representing a game&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Status of the game, the possible states are defined by GameStatus. SAFE means you&amp;#8217;ve won, DEAD&amp;#8230;&amp;#8203; well&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Describing these types proved to be valuable documentation as well as being very helpful when implementing
the game logic later on.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
What&amp;#8217;s that &lt;code&gt;Maybe&lt;/code&gt; thing ? If someone told me it&amp;#8217;s a &lt;a href=&quot;https://en.wikipedia.org/wiki/Monad_(functional_programming)&quot;&gt;Monad&lt;/a&gt; I wouldn&amp;#8217;t be any wiser. I think of it
as a handy way of describing that something may have a value. A nifty way to eliminate the use of null basically.
It also forces you to be explicit about handling the fact that it may not have a value.
You won&amp;#8217;t get null pointer errors in an Elm program! (nor &lt;code&gt;Undefined is not a function&lt;/code&gt;).
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_finding_neighbours_of_a_tile&quot;&gt;Finding neighbours of a tile&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;When revealing tiles in minesweeper you also reveal any adjacent tiles that aren&amp;#8217;t next to a mine.
In addition you display the threat count (how many mines are adjacent to a tile) for tiles next to those
you just revealed. So we need a way to find the neighbouring tiles of a given tile.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_javascript_implementation&quot;&gt;JavaScript implementation&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;function onWEdge(game, tile) {                                                 &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  return tile % game.get(&apos;cols&apos;) === 0;
}

function onEEdge(game, tile) {                                                 &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  return tile % game.get(&apos;cols&apos;) === game.get(&apos;cols&apos;) - 1;
}


function nw(game, tile) {                                                      &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  return onWEdge(game, tile) ? null : idx(game, tile - game.get(&apos;cols&apos;) - 1);
}

function n(game, tile) {
  return idx(game, tile - game.get(&apos;cols&apos;));
}

// etc , ommitted other directions for brevity


const directions = [nw, n, ne, e, se, s, sw, w];

function neighbours(game, tile) {
  return keep(directions, function (dir) {                                     &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
    return game.getIn([&apos;tiles&apos;, dir(game, tile)]);
  });
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Helper function to determine if a given tile is on the west edge of the board&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Helper function to determine if a given tile is on the east edge of the board&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Returns the the tile north-west of a given tile. Null if none exists to the north-west&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Keep is a helper function that maps over the collection and filters out any resulting `null`s. So the function
iterates all directions (invoking their respective function) and returns all possible tiles
neighbouring the given tile.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_elm_implementation&quot;&gt;Elm implementation&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type Direction = W | NW | N | NE | E | SE | S | SW                                 &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;

onWEdge : Game -&amp;gt; Tile -&amp;gt; Bool                                                     &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
onWEdge game tile =
  (tile.id % game.cols) == 0


onEEdge : Game -&amp;gt; Tile -&amp;gt; Bool
onEEdge game tile =
  (tile.id % game.cols) == game.cols - 1


neighbourByDir : Game -&amp;gt; Maybe Tile -&amp;gt; Direction -&amp;gt; Maybe Tile                     &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
neighbourByDir game tile dir =
  let
    tIdx = tileByIdx game                                                          &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
    isWOk t = not &amp;lt;| onWEdge game t                                                &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
    isEOk t = not &amp;lt;| onEEdge game t
  in
    case (tile, dir) of                                                            &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
      (Nothing, _) -&amp;gt; Nothing                                                      &lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;(7)&lt;/b&gt;
      (Just t, N)  -&amp;gt; tIdx &amp;lt;| t.id - game.cols
      (Just t, S)  -&amp;gt; tIdx &amp;lt;| t.id + game.cols
      (Just t, W)  -&amp;gt; if isWOk t then tIdx &amp;lt;| t.id - 1             else Nothing
      (Just t, NW) -&amp;gt; if isWOk t then tIdx &amp;lt;| t.id - game.cols - 1 else Nothing    &lt;i class=&quot;conum&quot; data-value=&quot;8&quot;&gt;&lt;/i&gt;&lt;b&gt;(8)&lt;/b&gt;
      (Just t, SW) -&amp;gt; if isWOk t then tIdx &amp;lt;| t.id + game.cols - 1 else Nothing
      (Just t, E)  -&amp;gt; if isEOk t then tIdx &amp;lt;| t.id + 1             else Nothing
      (Just t, NE) -&amp;gt; if isEOk t then tIdx &amp;lt;| t.id - game.cols + 1 else Nothing
      (Just t, SE) -&amp;gt; if isEOk t then tIdx &amp;lt;| t.id + game.cols + 1 else Nothing


neighbours : Game -&amp;gt; Maybe Tile -&amp;gt; List Tile
neighbours game tile =
  let
    n = neighbourByDir game tile                                                   &lt;i class=&quot;conum&quot; data-value=&quot;9&quot;&gt;&lt;/i&gt;&lt;b&gt;(9)&lt;/b&gt;
  in
    List.filterMap identity &amp;lt;| List.map n [W, NW, N, NE, E, SE, S, SW]             &lt;i class=&quot;conum&quot; data-value=&quot;10&quot;&gt;&lt;/i&gt;&lt;b&gt;(10)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;A type (actually a &lt;a href=&quot;https://en.wikipedia.org/wiki/Tagged_union&quot;&gt;tagged union&lt;/a&gt;) describing/enumerating the possible directions&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Pretty much the same as it&amp;#8217;s JavaScript counterpart. I&amp;#8217;ve been lazy and assumed the id of a tile
is also the index in the tiles list of our game.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Find a neighbour by a given direction. The function takes 3 arguments; a game record, a tile (that may or may not have a value) and a direction. It returns a tile (that may or may not have a value)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;tileByIdx is a functions that finds a tile by its index. (it returns a tile, &amp;#8230;&amp;#8203; maybe). tIdx is a local function that just curries(/binds/partially applies) the first parameter - game&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;A local function that checks if it&amp;#8217;s okay to retrieve a westward tile for a given tile&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Pattern match on tile and direction. You might consider it a switch statement on steroids.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;7&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If the tile doesn&amp;#8217;t have a value (then we don&amp;#8217;t care about the direction hence _) we return Nothing (Maybe.Nothing)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;8&quot;&gt;&lt;/i&gt;&lt;b&gt;8&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Just t, NW matches on a tile that has value (assigned t) and a given direction of NW. The logic is for this case the same as for it&amp;#8217;s JavaScript counterpart. Well except it returns Nothing if NW isn&amp;#8217;t possible&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;9&quot;&gt;&lt;/i&gt;&lt;b&gt;9&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;A partially applied version of neightBourByDir to make the mapping function in 10. a bit less verbose&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;10&quot;&gt;&lt;/i&gt;&lt;b&gt;10&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We map over all directions finding their neighbours, then &lt;code&gt;List.filterMap identity&lt;/code&gt; filters out all List entries with Nothing.
Leaving us with a list of valid neighbours for the given tile.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We covered quite a bit of ground here. I could have implemented all the direction functions as in the JavaScript implementation,
but opted for a more generic function using pattern matching. It&amp;#8217;s not that I dislike short functions, quite the contrary but
in this case it felt like a good match (no pun intended). Once you get used to the syntax it gives a
really nice overview as well.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Think of &amp;lt;| as one way to avoid parenthesis. It&amp;#8217;s actually a backwards function application
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;When testing this function I got my first runtime error in Elm complaining that my case wasn&amp;#8217;t
exhaustive. Rumors has it that the next version of elm might handle this at compile time as well :-)&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;http://rundis.github.io/blog/2015/elm_case_error.png&quot; alt=&quot;elm case error&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_threat_count&quot;&gt;Threat count&lt;/h3&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_javascript&quot;&gt;JavaScript&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;function getMineCount(game, tile) {                                             &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  var nbs = neighbours(game, tile);
  return nbs.filter(prop(&apos;isMine&apos;)).length;
}

function addThreatCount(game, tile) {                                           &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  return game.setIn([&apos;tiles&apos;, tile, &apos;threatCount&apos;], getMineCount(game, tile));
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Gets the number of neighbouring tiles that are mines for a given tile. (prop is a helper function for retrieving a named property on a js object)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Set the threatCount property on a given tile in the game&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_elm&quot;&gt;Elm&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;mineCount : Game -&amp;gt; Maybe Tile -&amp;gt; Int                                           &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
mineCount game tile =
  List.length &amp;lt;| List.filter .isMine &amp;lt;| neighbours game tile

revealThreatCount : Game -&amp;gt; Tile -&amp;gt; Tile                                        &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
revealThreatCount game tile =
  {tile | threatCount &amp;lt;- Just (mineCount game &amp;lt;| Just tile)
        , isRevealed  &amp;lt;- True}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Same as for it&amp;#8217;s JavaScript counterpart, but using a . syntax for dynamic property access&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Almoust the same as addThreatCount, but since once we add it the tile would also always be revealed
I opted for a two in one function.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;For mine count, both implementations are potentially flawed.&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;For JavaScript you might get 0 for a non-existent tile, which isn&amp;#8217;t too bad. But maybe you&amp;#8217;ll get
a null pointer somewhere deeper down the call stack. To be sure you have to crawl through all function calls this function makes and
apply your JavaScript foo to know things like null &amp;lt; 1 is obviously true, but null &amp;lt; 0 is false. &amp;#8230;&amp;#8203; and so on.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The elm implementation won&amp;#8217;t have any null pointer exceptions, but really it should return Maybe Int to guard
against giving 0 back for a Nothing tile !&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_revealing_safe_adjacent_tiles&quot;&gt;Revealing safe adjacent tiles&lt;/h3&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_javascript_2&quot;&gt;JavaScript&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;function revealAdjacentSafeTiles(game, tile) {
  if (isMine(game, tile)) {
    return game;
  }
  game = addThreatCount(game, tile).setIn([&apos;tiles&apos;, tile, &apos;isRevealed&apos;], true);
  if (game.getIn([&apos;tiles&apos;, tile, &apos;threatCount&apos;]) === 0) {
    return keep(directions, function (dir) {
      return dir(game, tile);
    }).reduce(function (game, pos) {
      return !game.getIn([&apos;tiles&apos;, pos, &apos;isRevealed&apos;]) ?
        revealAdjacentSafeTiles(game, pos) : game;
    }, game);
  }
  return game;
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_elm_2&quot;&gt;Elm&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;revealAdjacentSafeTiles :  Game -&amp;gt; Int -&amp;gt; Game
revealAdjacentSafeTiles game tileId =
  case tileByIdx game tileId of
    Nothing -&amp;gt; game
    Just t -&amp;gt;
      if t.isMine then game else
        let
          updT   = revealThreatCount game t
          updG   = {game | tiles &amp;lt;- updateIn tileId (\_ -&amp;gt; updT) game.tiles}
          fn t g = if not t.isRevealed then revealAdjacentSafeTiles g t.id else g
        in
          if not (updT.threatCount == Just 0) then
            updG
          else
            List.foldl fn updG &amp;lt;| neighbours updG &amp;lt;| Just updT&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_a_brief_comparison&quot;&gt;A brief comparison&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The most noteworthy difference is really the explicit handling of an illegal tile index in the Elm implementation.
If I didn&amp;#8217;t have the JavaScript code to look at, I&amp;#8217;m guessing the difference would have been more noticable. Not necessarily for the better.
We&amp;#8217;ll never know.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Anyways, enough about the game logic. Let&amp;#8217;s move on to the view part.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_comparing_the_view_rendering&quot;&gt;Comparing the view rendering&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_javascript_3&quot;&gt;JavaScript&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The React part for rendering the UI is found in &lt;a href=&quot;https://github.com/cjohansen/react-sweeper/blob/master/immutable-es6/src/ui.js&quot;&gt;ui.js&lt;/a&gt;
Below I&amp;#8217;ve picked out the most interesting parts&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;export function createUI(channel) {                                            &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  const Tile = createComponent((tile) =&amp;gt; {                                     &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    if (tile.get(&apos;isRevealed&apos;)) {
      return div({className: &apos;tile&apos; + (tile.get(&apos;isMine&apos;) ? &apos; mine&apos; : &apos;&apos;)},
                 tile.get(&apos;threatCount&apos;) &amp;gt; 0 ? tile.get(&apos;threatCount&apos;) : &apos;&apos;);
    }
    return div({
      className: &apos;tile&apos;,
      onClick: function () {
        channel.emit(&apos;reveal&apos;, tile.get(&apos;id&apos;));                                &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
      }
    }, div({className: &apos;lid&apos;}, &apos;&apos;));
  });

  const Row = createComponent((tiles) =&amp;gt; {
    return div({className: &apos;row&apos;}, tiles.map(Tile).toJS());
  });

  const Board = createComponent((game) =&amp;gt; {
    return div({
      className: &apos;board&apos;
    }, partition(game.get(&apos;cols&apos;), game.get(&apos;tiles&apos;)).map(Row).toJS());
  });

  const UndoButton = createComponent(() =&amp;gt; {                                  &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
    return button({
      onClick: channel.emit.bind(channel, &apos;undo&apos;)
    }, &apos;Undo&apos;);
  });

  const Game = createComponent((game) =&amp;gt; {
    return div({}, [Board(game), UndoButton()]);
  });

  return (data, container) =&amp;gt; {                                               &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
    render(Game(data), container);
  };
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This function returns a function for creating the react component tree for the game. It takes a channel
param, which is an event emitter. So when components need to notify the &quot;controller&quot; about user actions they can just emit messages to this channel
A neat way to avoid using callbacks!&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;createComponent is a handy helper function that avoids some react boiler plate and provides an optimized shouldComponentUpdate function for each react component used.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When a user clicks on a tile a reveal message with the tile id is emitted&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The game also supports undo previous move :)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Returns a function that when called starts the react rendering of the game in the given container element&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_elm_3&quot;&gt;Elm&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;threatCount : Maybe Int -&amp;gt; List Html
threatCount count =
  case count of
    Nothing -&amp;gt; []
    Just t  -&amp;gt; [text (if t &amp;gt; 0 then toString t else &quot;&quot;)]


tileView : Signal.Address Action -&amp;gt; Game.Tile -&amp;gt; Html                               &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
tileView address tile =
  if tile.isRevealed then
    div [class (&quot;tile&quot; ++ (if tile.isMine then &quot; mine&quot; else &quot;&quot;))]
        &amp;lt;| threatCount tile.threatCount

  else
    div [class &quot;tile&quot;, onClick address (RevealTile tile.id)]                        &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
        [div [class &quot;lid&quot;] []]                                                      &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;


rowView : Signal.Address Action -&amp;gt; List Game.Tile -&amp;gt; Html
rowView address tiles =
  div [class &quot;row&quot;] (List.map (tileView address) tiles)


statusView: Game -&amp;gt; Html
statusView game =
  let
    (status, c) = case game.status of
                    SAFE          -&amp;gt; (&quot; -  You won&quot;, &quot;status-won&quot;)
                    DEAD          -&amp;gt; (&quot; - You lost&quot;, &quot;status-lost&quot;)
                    IN_PROGRESS   -&amp;gt; (&quot;&quot;, &quot;&quot;)
  in
    span [class c] [text status]


view : Signal.Address Action -&amp;gt; Game -&amp;gt; Html                                       &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
view address game =
  let
    rows = Utils.partitionByN game.cols game.tiles
  in
    div [id &quot;main&quot;] [
      h1 [] [text &quot;Minesweeper&quot;, statusView game],
      div [class &quot;board&quot;] (List.map (rowView address) rows),
      div [] [button [class &quot;button&quot;, onClick address NewGame] [text &quot;New game&quot;]]
    ]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The function responsible for rendering a single tile. Very much comparable to the React tile component
in the JavaScript implementation. Similar to  React, we aren&amp;#8217;t returning actual dom elments, Elm also has
a virtual dom implementation&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When a tile is clicked a message is sent to a given address (we&amp;#8217;ll get back to that a little bit later).
Well actually it doesn&amp;#8217;t happen right away, rather think of it as creating an envelope with content and a known address. The Elm runtime receives a signal back
that will take care of sending the message to it&amp;#8217;s rendering function when appropriate.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;div here is actually a function from the HTML module in Elm. It takes two lists as arguments, the first
is a list of attributes and the second is a list of child elements&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Our main entry function for creating our view. It takes an address and game as parameter and returns a virtual dom node (Html)&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;code&gt;Signal.Address Action&lt;/code&gt; : Address points to a particular type of Signal, in our case the Signal is an &lt;code&gt;Action&lt;/code&gt;
we&amp;#8217;ll come back to that shortly. But the short story is that this is what enables us to talk back to the main application.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_wiring_it_all_together&quot;&gt;Wiring it all together&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_javascript_4&quot;&gt;JavaScript&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;const channel = new EventEmitter();
const renderMinesweeper = createUI(channel);
let game = createGame({cols: 16, rows: 16, mines: 48});
let history = List([game]);

function render() {                                                         &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  renderMinesweeper(game, document.getElementById(&apos;board&apos;));
}

channel.on(&apos;undo&apos;, () =&amp;gt; {                                                  &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  if (history.size &amp;gt; 1) {
    history = history.pop();
    game = history.last();
    render();
  }
});

channel.on(&apos;reveal&apos;, (tile) =&amp;gt; {                                            &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  if (isGameOver(game)) { return; }

  const newGame = revealTile(game, tile);

  if (newGame !== game) {
    history = history.push(newGame);
    game = newGame;
  }

  render();

  if (isGameOver(game)) {
    // Wait for the final render to complete before alerting the user
    setTimeout(() =&amp;gt; { alert(&apos;GAME OVER!&apos;); }, 50);
  }
});&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The react render entry point for the game. Called whenever the game state is changed&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The JavaScript implementation keeps a history of all game states. I forgot to mention that &lt;a href=&quot;https://facebook.github.io/immutable-js/&quot;&gt;immutable-js&lt;/a&gt; is for collections.
Undo just gets the previous game state and rerenders. Nice and simple&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Event listener for reveal messages. It invokes reveal tile, adds to history (and potentially ends the game).&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This is all very neat and tidy and works so great because the game state is managed in one place and is passed through
 the ui component tree as an immutable value. The fact that the state is immutable also makes the undo implementation a breeze.
 I really like this approach !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_elm_4&quot;&gt;Elm&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;If you don&amp;#8217;t know Elm at all, this part might be the most tricky to grasp. To simplify things I&amp;#8217;ll split it into
two parts.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_start_app_approach&quot;&gt;Start-app approach&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/evancz/start-app&quot;&gt;Start-app&lt;/a&gt; is a small elm package that makes it easy to get started
with an elm Model-View-Update structure. This is a great place to start for your first elm app.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type Action = RevealTile Int                                             &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;


init : Game                                                              &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
init =
  Game.createGame 15 15 5787345


update : Action -&amp;gt; Game -&amp;gt; Game                                          &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
update Action game =
  case action of
    RevealTile id -&amp;gt; if not (game.status == IN_PROGRESS) then game else  &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
                      Game.revealTile game id

main =                                                                   &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
  StartApp.Simple.start                                                  &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
    { model = init
    , update = update
    , view = view
    }&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Type describing the actions the game supports. Currently just revealing tiles, and you can see that
we also specify that the RevealTile action expects an Int paramater. That would be the tile id.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The init function provides the initial state for our application. &lt;code&gt;createGame&lt;/code&gt; is a helper function for creating
a game with x cols and y rows. The 3.rd param is a seed for randomizing tiles. We&amp;#8217;ll return to that seed thing in the next chapter!&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Update is the function that handles the actual update of state, or rather the transformation to the next state
based on some action. It&amp;#8217;s quite simple in this case, just reveal a given tile and return the updated game&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;No point in revealing more tiles when the game is already over :)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;main&lt;/code&gt; is the entry point into our application. If you use elm-reactor this will be automatically invoked for you, which is handy for getting started quickly&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;StartApp.Simple.start&lt;/code&gt; takes care of wiring things up and start your application&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_trouble_in_paradise_we_get_the_same_board_every_time&quot;&gt;Trouble in paradise, we get the same board every time&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Do you remember the 3rd param to createGame in the previous chapter? That is the initial seed to a random generator (&lt;a href=&quot;http://package.elm-lang.org/packages/elm-lang/core/2.1.0/Random&quot;&gt;Random&lt;/a&gt;) to randomize the
occurence of mines. The problem is that using the same seed produces the same result. Calling an elm random
generator will return a new seed, so of course I could/should have stored that and used that for the next game.
But I still need an initial seed that&amp;#8217;s different every time I start the app. Current time would be a good candidate
for an initial seed. But there is no getCurrentTime function in Elm. Why ? It&amp;#8217;s impure, and Elm doesn&amp;#8217;t like impure functions.
By &quot;pure&quot;, we mean that if you call a function with the same arguments, you get the same result.
There are several reasons why pure functions is a great thing (testing is one), but I won&amp;#8217;t go into that, let&amp;#8217;s just accept the fact
that this is the case, so how can we deal with it ?&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Well the elm-core package has a &lt;a href=&quot;http://package.elm-lang.org/packages/elm-lang/core/2.1.0/Time&quot;&gt;Time module&lt;/a&gt; with a timestamp function that looks useful.
To use that we have to change a few things though, most notably we can&amp;#8217;t use the simple start app approach any more.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-elm&quot; data-lang=&quot;elm&quot;&gt;type Action =
  NewGame                                                                 &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  | RevealTile Int



update : (Float, Action) -&amp;gt; Game -&amp;gt; Game                                  &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
update (time, action) game =
  case action of
    NewGame -&amp;gt; Game.createGame 15 15  (truncate time)                     &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
    RevealTile id -&amp;gt; if not (game.status == IN_PROGRESS) then game else
                       Game.revealTile game id


actions: Signal.Mailbox Action                                            &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
actions =
  Signal.mailbox NewGame

model: Signal Game                                                        &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
model =
  Signal.foldp update init (Time.timestamp actions.signal)

main : Signal Html                                                        &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
main =
  Signal.map (view actions.address) model

port initGame : Task.Task x ()                                            &lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;(7)&lt;/b&gt;
port initGame =
  Signal.send actions.address NewGame&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We introduce a new action &lt;code&gt;NewGame&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Our update function now takes a tuple of time and action + game as input parameters&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We use the elm core function &lt;code&gt;truncate&lt;/code&gt; to convert the time(stamp) float into an integer and use that as our seed to &lt;code&gt;createGame&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We construct a mailbox for our Action messages manually, with an initial value of NewGame&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Our model is a fold (reduce) of all state changes sent to our mailbox (from the app started to the current moment of time).
This is where we introduce the Time.timestamp function, which wraps our action signal and produces a tuple of (timestamp, action)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;main is just a map over our view function with our current model. Since view also expects an (mailbox) address we curry/partially apply that to our view function&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;7&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Unfortunately I couldn&amp;#8217;t figure out how to get the timestamp passed to the init function. The creation
step (4) of the mailbox doesn&amp;#8217;t actually cause the NewGame action to be executed either. So this is a little hack
that fires off a task to execute the NewGame action. This is run after initialization so when you load the game you&amp;#8217;ll not see state 0 for the game, but actually state 1.
If any elm-ers out there reads this, feel free to comment on how this could be done in a more idiomatic fashion!&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
I found &lt;a href=&quot;https://yobriefca.se/blog/2015/08/02/deconstructing-your-first-elm-app/&quot;&gt;this&lt;/a&gt; blogpost
very illuminating for deconstructing start-app.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_but_what_about_undo&quot;&gt;But what about undo ?&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;There is an elm-package I think would help us do that quite simply;
&lt;a href=&quot;https://github.com/TheSeamau5/elm-undo-redo&quot;&gt;elm-undo-redo&lt;/a&gt;. However if you are using &lt;a href=&quot;https://github.com/elm-lang/elm-reactor&quot;&gt;elm-reactor&lt;/a&gt;
you pretty much get undo-redo and more out of the box. Great for development, but maybe not so much for production!&lt;/p&gt;
&lt;/div&gt;
&lt;iframe width=&quot;420&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/P3B4ldi1cmc&quot; frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_summary&quot;&gt;Summary&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Getting into Elm has been a really pleasurable experience so far. It&amp;#8217;s quite easy to get up and running without
knowing all that much about the language. I&amp;#8217;ve found the elm compiler to be a really nice and friendly companion.
The error messages I get are really impressive and I can truly say I&amp;#8217;ve never experienced anything quite like it.
Working with types (at least for this simple application) hasn&amp;#8217;t felt like a burden at all. I still feel I should have
had some tests, but I think I would feel more comfortable refactoring this app with a lot less tests than I would in say JavaScript.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;If my intention for this post had been to bash JavaScript I chose a poor example to compare with. But then again
that was never my intention. I wanted to show how a well written JavaScript app might compare to an Elm implementation
written by an Elm noob. Hopefully I&amp;#8217;ve also managed to demonstrate that it&amp;#8217;s not all that difficult getting started with Elm and perhaps
peeked your interest enough to give it a try !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_resources&quot;&gt;Resources&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;These are some of the resources that have helped me getting up to speed:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://pragmaticstudio.com/elm&quot;&gt;Elm: Building Reactive Web Apps&lt;/a&gt; - A really nice step-by-step tutorial with videos and examples to get you up to speed. You get great value for $29 I think.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://pragmaticstudio.com/elm-signals&quot;&gt;Elm: Signals, Mailboxes &amp;amp; Ports&lt;/a&gt; - Elm signals in depth. Really useful for getting into more detail on what Signals are, how they work and how to use them.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/evancz/elm-architecture-tutorial/&quot;&gt;Elm Architecture Tutorial&lt;/a&gt; - Tutorial outlining &quot;the Elm Architecture&quot;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;http://elm-lang.org/&quot;&gt;elm-lang.org&lt;/a&gt; - The official site for the elm language&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/rundis/elm-light&quot;&gt;elm-light&lt;/a&gt; - My elm plugin for Light Table, or if you use another editor it might be listed &lt;a href=&quot;http://elm-lang.org/get-started#configure-your-editor&quot;&gt;here&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_addendum_potential_improvements&quot;&gt;Addendum - Potential improvements&lt;/h3&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Initialize game with seed without adding an extra state&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Perhaps I should/could have used &lt;a href=&quot;http://elm-lang.org/docs/records#record-types&quot;&gt;extensible records&lt;/a&gt; to model the game&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Maybe Array would be a better choice than List for holding tiles ?&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Elm plugin for Light Table</title>
      <link>http://rundis.github.io/blog/2015/elm_light.html</link>
      <pubDate>Fri, 30 Oct 2015 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2015/elm_light.html</guid>
      	<description>
	&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_background&quot;&gt;Background&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;ve just started playing around a little bit with &lt;a href=&quot;http://elm-lang.org/&quot;&gt;elm&lt;/a&gt;.
This weekend I&amp;#8217;m going to &lt;a href=&quot;http://www.codemesh.io/&quot;&gt;codemesh&lt;/a&gt; where I&amp;#8217;ll be attending an Elm workshop
with the author of Elm, Evan Czaplicki.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To ensure I have an editor I&amp;#8217;m familiar with and to get me started a little, I figured I&amp;#8217;d create an Elm language plugin
for Light Table. However lately I&amp;#8217;ve been a little busy helping out  getting &lt;a href=&quot;https://github.com/LightTable/LightTable&quot; class=&quot;bare&quot;&gt;https://github.com/LightTable/LightTable&lt;/a&gt; version 0.8
released. Last weekend we got an 0.8 alpha out. I needed some of the features from Electron. So now with Light Table using
Electron under the hoods I could finally complete an intial plugin release. It&amp;#8217;s rough, but it&amp;#8217;s an ok start I suppose !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_demo&quot;&gt;Demo&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://youtu.be/B_eZw_GcM-4&quot;&gt;ScreenCast demo&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;iframe width=&quot;420&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/B_eZw_GcM-4&quot; frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_the_plugin&quot;&gt;The plugin&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
You can find the plugin repo on github &lt;a href=&quot;https://github.com/rundis/elm-light&quot; class=&quot;bare&quot;&gt;https://github.com/rundis/elm-light&lt;/a&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>ClojureScript - Performance tuning rewrite-cljs</title>
      <link>http://rundis.github.io/blog/2015/clojurescript_performance_tuning.html</link>
      <pubDate>Tue, 4 Aug 2015 00:00:00 +0200</pubDate>
      <guid isPermaLink="false">2015/clojurescript_performance_tuning.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;How would you go about performance tuning a ClojureScript Library or a ClojureScript application ? Before I started
my summer holidays I started to investigate how I should go about doing that for one of my ClojureScript libraries: &lt;a href=&quot;https://github.com/rundis/rewrite-cljs&quot;&gt;rewrite-cljs&lt;/a&gt;
I didn&amp;#8217;t find a whole lot of info from my trusted old friend Google, so I thought I&amp;#8217;d share some bits and bobs I&amp;#8217;ve learned so far.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;ve previously blogged about how I used rewrite-cljs for two of my Light Table plugins; &lt;a href=&quot;https://github.com/rundis/clj-light-refactor/&quot;&gt;clj-light-refactor&lt;/a&gt; and  &lt;a href=&quot;https://github.com/rundis/parembrace&quot;&gt;parembrace&lt;/a&gt;
The library is a ClojureScript port of the awesome &lt;a href=&quot;https://github.com/xsc/rewrite-clj/&quot;&gt;rewrite-clj&lt;/a&gt; library by Yannick Scherer.
A lot of the porting was just plain sailing with a few adaptations here and there. It&amp;#8217;s truly great that Clojure and ClojureScript are so much aligned.
After the port I also made some changes and adaptations that I knew I needed in my plugins and that I though might be useful for other use cases as well.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;However one limitation that seriously nagged me was that rewrite-cljs wasn&amp;#8217;t performant enough to be able to handle
rewriting of medium to large sized files (as strings currently mind you) from Light Table.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
One of my sample ClojureScript files (about 600 lines / 20K characters) took about 250 ms to parse and build a zip for before
I started looking at performance tuning. At the time of writing this blog post it&amp;#8217;s down to 50-60 ms. Pretty good, but
still need shave it down a quite a bit further to do some of the things I have in mind !
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_opposing_forces&quot;&gt;Opposing forces&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I guess I could have started blindly changing a lot of the implementation to be closer to native JavaScript. However for
several reasons I&amp;#8217;d like to keep it as Clojur&amp;#8217;y as possible and ideally I don&amp;#8217;t want to stray to far away from it origins (rewrite-clj).
How to balance and where to begin ?&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_tools&quot;&gt;Tools&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To get some idea of where to bottlenecks were and what/if any of my optimzations had any effect I really need some tools
to help me out. Fortunately Light Table ships with the chrome developer tools. The profiler is quite helpful, in addition
I used a small benchmark script to see how it perfomed over a slightly longer timespan.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_tuning&quot;&gt;Tuning&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_first_quickwin_moving_away_from_multimethods&quot;&gt;First quickwin - Moving away from multimethods&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Before I profiled anything I came accross a google group discussion about multimethod performance vs protocols for
dispatching. The &lt;a href=&quot;https://github.com/xsc/rewrite-clj/blob/master/src/rewrite_clj/parser/core.clj&quot;&gt;core&lt;/a&gt; of the parser in rewrite-cljs was pretty much a 1-1 port of the one from rewrite-clj.
I decided to try to just dispatch using a cond or case.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn- dispatch
  [c]
  (cond (nil? c)                        parse-eof
        (identical? c *delimiter*)      reader/ignore
        (reader/whitespace? c)          parse-whitespace
        (identical? c \^)               parse-meta
        (identical? c \#)               parse-sharp
        (identical? c \()               parse-list
        (identical? c \[)               parse-vector
        (identical? c \{)               parse-map
        (identical? c \})               parse-unmatched
        (identical? c \])               parse-unmatched
        (identical? c \))               parse-unmatched
        (identical? c \~)               parse-unquote
        (identical? c \&apos;)               parse-quote
        (identical? c \`)               parse-syntax-quote
        (identical? c \;)               parse-comment
        (identical? c \@)               parse-deref
        (identical? c \&quot;)               parse-string
        (identical? c \:)               parse-keyword
        :else                           parse-token))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The result was that I shaved of somewhere between 30-50 ms. I can&amp;#8217;t remember the exact number, but it was substantial.
So eventhough multimethods are nice, for this use case I don&amp;#8217;t think they added that much value and the performance overhead (due to indirection?) just wasn&amp;#8217;t justified.
I did try using both a map and case for char tests, but found that a simple cond outperformed both (on my machine running on an old ClojureScript version in Light Table)&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_some_random_pickings&quot;&gt;Some random pickings&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;When working with Light Table I&amp;#8217;ve previously found that in some cases I could gain some nice performance improvements
by changing from clojure datastructures to native js.
I&amp;#8217;ll show a couple of samples&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_checking_for_token_boundaries&quot;&gt;Checking for token boundaries&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn boundary?
  [c]
  &quot;Check whether a given char is a token boundary.&quot;
  (contains?
    #{\&quot; \: \; \&apos; \@ \^ \` \~
      \( \) \[ \] \{ \} \\ nil}
    c))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;was rewritten to:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(def js-boundaries                                     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  #js [\&quot; \: \; \&apos; \@ \^ \` \~
      \( \) \[ \] \{ \} \\ nil])


(defn boundary?
  [c]
  &quot;Check whether a given char is a token boundary.&quot;
  (&amp;lt; -1 (.indexOf js-boundaries c)))                   &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Figured the list of boundaries only needs to be defined once&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Using JavaScript Array.indexOf proved to be quite efficient. More so than a ClojureScript map lookup in this case.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I used a similar approach for other kinds of boolean tests for characters (whitespace?, linebreak? etc).&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_testing_characters_for_equality&quot;&gt;Testing characters for equality&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Tests like:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(when (= c &quot;\&quot;)
  ... )&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Performs better using identical? (same object):&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(when (identical? c &quot;(&quot;)
  ... )&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_still_far_from_satisfied_swanodette_to_the_rescue&quot;&gt;Still far from satisfied - swanodette to the rescue&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In the end of june/beginning of july I noticed that Davin Nolen was tweeting about promising performance improvments
with regards to cljs-bootstrap. This made me curious and eventually I found some very inspiring commits on a cljs-bootstrap branch of a fork of tools.reader.
Hey, surely this guy nows a thing or two about what really might help and still keep the code nice and clojury.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So I just started picking from relevant commits on this &lt;a href=&quot;https://github.com/swannodette/tools.reader/commits/cljs-bootstrap&quot;&gt;branch&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A few highlights:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_avoiding_protocol_indirection&quot;&gt;Avoiding protocol indirection&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn peek
  &quot;Peek next char.&quot;
  [^not-native reader]     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (r/peek-char reader))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;not-native is a type hint that inline calls directly to protocol implementations&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_type_hinting&quot;&gt;Type hinting&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn ^boolean whitespace?   &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  [c]
  (r/whitespace? c))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The boolean type hint allows the  cljs compiler to avoid emitting a call to &lt;code&gt;cljs.core/truth_&lt;/code&gt;. The type hint is really for true boolean values (true/false), but if we know for sure that the value
isn&amp;#8217;t one of &lt;code&gt;0, &quot;&quot; (empty-string) and NaN&lt;/code&gt; we can coerce the compiler to do our bidding !&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_satisfies_implements&quot;&gt;satisfies? &amp;#8658; implements?&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Changing:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(if (satisfies? IWithMeta o)
  ...)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(if (implements? IWithMeta o)
  ...)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Helps quite a bit.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_2x_performance_increase_what_now&quot;&gt;2X+ performance increase, what now ?&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We&amp;#8217;ve achieve quite a bit, but it&amp;#8217;s still between 100-120 ms for my sample. I need more. More I tell you !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So back to the profiler to try and pick out some suspicious candidates.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2015//lt_profiler.png&quot; alt=&quot;lt profiler&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;I made various micro-improvements like changing&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;str&lt;/strong&gt; to &lt;strong&gt;goog.stringbuffer&lt;/strong&gt; for concatinating strings&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;aget&lt;/strong&gt; to &lt;strong&gt;.charAt&lt;/strong&gt; for getting a character at a position in a string&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Stringbuffer initialization to occur once and using clear inside functions (felt a bit like global variables (: )&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;count&lt;/strong&gt; to &lt;strong&gt;.length&lt;/strong&gt; for string length&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;etc&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;It all helped a bit, steadily shaving of a millisecond here and a millisecond there (even had some setbacks along the way !).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_do_s_and_don_ts&quot;&gt;Do&amp;#8217;s and Don&amp;#8217;ts&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A couple of function showed a lot of own-time in the profiler. I really couldn&amp;#8217;t figure out why though. They didn&amp;#8217;t
seem to do much, but delegate to other functions.
I tried a range of things until I stumbled accross this &lt;a href=&quot;http://stuartsierra.com/2015/06/01/clojure-donts-optional-arguments-with-varargs&quot;&gt;blogpost&lt;/a&gt; by Stuart Sierra.
Both of the methods was using the following pattern for handling a single var-arg:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn token-node
  &quot;Create node for an unspecified EDN token.&quot;
  [value &amp;amp; [string-value]]                       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (-&amp;gt;TokenNode
    value
    (or string-value (pr-str value))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;&amp;amp; [string-value]&lt;/code&gt; destructures the sequence of arguments&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This constructor method was called a lot. So not only was this perhaps not ideal stylewise, but it turns out
it has some pretty bad performance characteristics as well. (Not knowing the details, I can only speculate on why&amp;#8230;&amp;#8203;)&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So I changed the above code to:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn token-node
  &quot;Create node for an unspecified EDN token.&quot;
  ([value]
   (token-node value (pr-str value)))
  ([value string-value]
  (-&amp;gt;TokenNode value string-value)))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Yay! Changing two frequently called functions to use method overloading had a huge impact on performance.
Not only that, but I noticed that the garbage collector was using substantially less time as well.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_summary&quot;&gt;Summary&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Performance tuning is fun, but really hard. Not knowing anything about the inner wokings of ClojureScript and the closure compiler doesn&amp;#8217;t help.
There wasn&amp;#8217;t much to be found in terms of help using my normal search foo, and the book &quot;Performance tuning ClojureScript&quot; hasn&amp;#8217;t been seen quite yet.
That beeing said, this is probably the first time in over a year and half playing/working with ClojureScript that I&amp;#8217;ve even thought about performance issues with ClojureScript. Mostly it&amp;#8217;s a non issue for
my use cases.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Quite a few of the tweaks didn&amp;#8217;t really make the code that much less idiomatic, however there were a couple of cases where the host language
seeps out.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Feel free to share you experiences with performance tuning ClojureScript. I&amp;#8217;d really like to learn more about it
and hopefully make some additional shavings in rewrite-cljs !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;a href=&quot;https://github.com/rundis/rewrite-cljs&quot;&gt;rewrite-cljs&lt;/a&gt; 0.3.1 was just released. Snappier than ever &lt;span class=&quot;icon green&quot;&gt;&lt;i class=&quot;fa fa-smile-o&quot;&gt;&lt;/i&gt;&lt;/span&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Showcasing rewrite-cljs - Parembrace for Light Table</title>
      <link>http://rundis.github.io/blog/2015/parembrace.html</link>
      <pubDate>Fri, 12 Jun 2015 00:00:00 +0200</pubDate>
      <guid isPermaLink="false">2015/parembrace.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Wow! Implementing my own paredit plugin for Light Table. How (and why) on earth did I end up doing that ?&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A few months back I set forth on a mission trying to bring some proper Clojure refactoring support to Light Table through
the &lt;a href=&quot;https://github.com/rundis/clj-light-refactor/&quot;&gt;clj-light-refactor&lt;/a&gt; plugin. One of the first features I implemented
was a &lt;a href=&quot;http://rundis.github.io/blog/2015/clj_light_thread.html&quot;&gt;threading refactoring&lt;/a&gt; using clojure.zip and cljs.reader.
It quickly became evident that both clojure.zip and cljs.reader put severe limitations on what I would be able to implement.
The reader is quite limited in terms of the syntaz it allows and using a plain zipper would make it incredibly tedious in terms of
handling formatting (whitespace, newlines and comments etc).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The experience of using a zipper for refactoring was really appealing to me, but I needed something way better to be able
to do anything really useful. I put the whole thing on the backburner for a while, until I stumbled upon
&lt;a href=&quot;https://github.com/xsc/rewrite-clj/&quot;&gt;rewrite-clj&lt;/a&gt;. It looked like just the thing I needed, however it had no ClojureScript
support though. After weeks of deliberation I decided to write a ClojureScript port, aptly named &lt;a href=&quot;https://github.com/rundis/rewrite-cljs&quot;&gt;rewrite-cljs&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The ParEdit support in Light Table is somewhat limited, a few plugins to remedy that has been implemented none of which
are actively maintained or easily extendable. They all focus on the editor, text and moving braces around.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Could I make something a lot more structured for Light Table, where the focus is on navigating and moving proper clojure code nodes in a virtual AST ?
If Light Table falls over and dies, will all my efforts have been in vain ?&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Well I present to you &lt;a href=&quot;https://github.com/rundis/parembrace&quot;&gt;&lt;strong&gt;parembrace&lt;/strong&gt;&lt;/a&gt; a slightly different take on implementing
a paredit plugin for Light Table using rewrite-cljs for most of it&amp;#8217;s heavy lifting
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2015//wrap_slurping.gif&quot; alt=&quot;wrap slurping&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 1. Wrap forward slurping&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_implementation_challenges&quot;&gt;Implementation challenges&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_a_more_powerful_reader&quot;&gt;A more powerful reader&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;My first challenge was that the default reader in ClojureScript, cljs.reader, only supports a subset of
of valid clojure code. Things like anonymous functions and other reader macros are not supported.
I had to address that before I could even consider trying to do a port of rewrite-clj.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Luckily I found most of what I needed in the &lt;a href=&quot;https://github.com/lazerwalker/clojurescript-in-clojurescript&quot;&gt;clojurescript-in-clojurescript&lt;/a&gt; project.
It even supported a IndexingPUshBackReader which was essential for retaining source positional information about the nodes in a zipper.
I had to hack around it a little bit, but nearly everything I needed was in place. Yay !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
I ended up bundling the modded reader in rewrite-cljs btw.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_porting_rewrite_clj&quot;&gt;Porting rewrite-clj&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I won&amp;#8217;t bore you with the details here, but it was mostly pretty straight forward. While I was at it, I opted
for extending its&apos; features somewhat:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;I added bounds meta information for all nodes (start - end coordinates)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Finder functions to locate nodes by a given position in the underlying source&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;A paredit namespace&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
The paredit namespace should probably be factored out to a separate lib. I really shouldn&amp;#8217;t  bloat rewrite-cljs unnecessarily.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Whan creating(/aka porting) rewrite-cljs my intention was always to ensure that it was reusable from many other contexts than
my own client libs/apps. Whether I&amp;#8217;ve succeeded with that I guess is yet to be proven !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;It&amp;#8217;s used from parembrace and clj-light-refactor, but I see no reason why you wouldn&amp;#8217;t be able to reuse it
from say the Atom editor or your somewhat overly ambitious fully structural ClojureScript SPA editor project.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_performance&quot;&gt;Performance&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;It quickly became evident that parsing all code in an editor to a rewrite-cljs zipper structure
for every paredit editor action wouldn&amp;#8217;t be usable for files beyond 100-200 lines of code.
For now I have to settle for the inconvenience of working within the context of top level forms.
Having used the plugin during it&amp;#8217;s development for a couple of weeks now, that&amp;#8217;s not really a problem
99 % if the time (at least for me that is).&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_a_smattering_of_code&quot;&gt;A smattering of code&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Let me run you through an example. Paredit raise-sexpr&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(dynamic-wind in (lambda () |body) out) ; -&amp;gt;
(dynamic-wind in |body out) ; -&amp;gt;
body&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_rewrite_cljs&quot;&gt;rewrite-cljs&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn raise [zloc]                               &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (if-let [containing (z/up zloc)]
    (z/replace containing (z/node zloc))         &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    zloc))                                       &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;zloc is a the zipper node we wish to raise. From the example above the body token node&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If zloc has a parent node (seq), then we replace the parent node with the node at zloc&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If zloc has no parent, we can&amp;#8217;t raise we just return zloc&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Trying it out&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(ns foo-bar
  (:require [rewrite-clj.zip :as z]
            [rewrite-clj.paredit :as pe])

(-&amp;gt; (z/of-string &quot;(dynamic-wind in (lambda () body) out)&quot;)    &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
    (pe/find-by-pos {:row 1 :col 29})                         &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    pe/raise                                                  &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
    pe/raise
    z/root-string)                                            &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Create a clojure zipper with rewrite nodes for the initial code&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Locate zloc, a pointer to the &lt;strong&gt;body&lt;/strong&gt; node in our instance&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Raise (twice to produce the end result)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Wrap up the zipper and return it&amp;#8217;s stringified representation&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_light_table&quot;&gt;Light Table&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The generic function for invoking paredit commands in parembrace looks something like the this:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn paredit-cmd [ed f]
  (let [pos (editor/-&amp;gt;cursor ed)
        form (u/get-top-level-form ed)                                         &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
        zloc (positioned-zip pos form)]                                        &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    (when zloc
      (editor/replace ed (:start form) (:end form) (-&amp;gt; zloc f z/root-string))  &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
      (editor/move-cursor ed pos)                                              &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
      (format-keep-pos ed))))                                                  &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Get the top-level form at given position&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Given form an position in LT terms, create a zipper and position it at node with given position&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Replace the form in editor with the rewritten form after applying paredit/zipper function &lt;strong&gt;f&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The positioning isn&amp;#8217;t quite as trivial as this with depth changing commands&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Format the form nicely&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;For raise, f would in our example be a reference to &lt;code&gt;pe/raise&lt;/code&gt;, but really it could be
something really whacky like :&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;#(-&amp;gt; % pe/raise pe/kill z/leftmost)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;which would given you:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(|dynamic-wind in)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Let me know if that is something you would find useful &lt;span class=&quot;icon green&quot;&gt;&lt;i class=&quot;fa fa-smile-o&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Behaviors and commands&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::raise!                                                   &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
          :triggers #{:parembrace.raise!}
          :reaction (fn [ed]
                      (paredit-cmd ed pe/raise)))



(cmd/command {:command :parembrace.raise                             &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
              :desc &quot;Parembrace: Raise&quot;
              :exec (fn []
                      (when-let [ed (pool/last-active)]
                        (object/raise ed :parembrace.raise!)))})&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The behavior here strictly speaking isn&amp;#8217;t needed, but it provides a means to scope the feature
to only be available for editors tagged as clojure editors&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The commands are there for you to be able to either execute from the command bar, or for mapping a keyboard shortcut&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_current_state_and_future_plans_for_parembrace&quot;&gt;Current state and future plans for Parembrace ?&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A large percentage of the features in the &lt;a href=&quot;http://pub.gajendra.net/src/paredit-refcard.pdf&quot;&gt;paredit reference card&lt;/a&gt; has been
implemented. Some features behave slightly different, and there are a couple of novel nuggets there as well.
All is not well though. Cursor positioning needs improving and performance needs to be tweaked.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;What does the future hold ? Well I&amp;#8217;m planning on implementing the missing features and I&amp;#8217;m sure I&amp;#8217;ll add a few more
useful nuggets too. The most important thing I aim to provide is a clear pluggable way of extending and modifying features
to allow you to customize parembrace to your liking.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I believe rewrite-cljs already has paid off multiple times. I can&amp;#8217;t thank &lt;a href=&quot;https://github.com/xsc&quot;&gt;xsc&lt;/a&gt; enough
for writing &lt;a href=&quot;https://github.com/xsc/rewrite-clj/&quot;&gt;rewrite-clj&lt;/a&gt;. It&amp;#8217;s really awesome and without it I&amp;#8217;d still be fumbling around with parsers and what-not.
I can reuse rewrite-cljs from both parembrace and clj-light-refactor. In the latter not only can I start implementing cool code refactoring features, but
I can do things like structurally traverse and  rewrite the project.clj file. I can&amp;#8217;t wait to get started&amp;#8230;&amp;#8203; well I have to wait because I&amp;#8217;m moving to a new house, but after that&amp;#8230;&amp;#8203;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
If you are a Light Table user, do take &lt;a href=&quot;https://github.com/rundis/parembrace&quot;&gt;Parembrace&lt;/a&gt; for a spin and let me know what you think !
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Implementing a Clojure ns-browser in Light Table with React</title>
      <link>http://rundis.github.io/blog/2015/lt_react.html</link>
      <pubDate>Wed, 22 Apr 2015 00:00:00 +0200</pubDate>
      <guid isPermaLink="false">2015/lt_react.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;ve long been looking for better ways to navigate between code in Clojure projects in Light Table.
The workspace navigator isn&amp;#8217;t particularily keyboard friendly. For navigating files &lt;a href=&quot;https://github.com/joshuafcole/claire&quot;&gt;claire&lt;/a&gt;
is a better option. Coming from IntelliJ I have been used to navigating to classes/resources in java projects in a breeze.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I needed something more clojure project aware, so I decided to implement a namespace browser.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Lately I&amp;#8217;ve been working on the &lt;a href=&quot;https://github.com/rundis/clj-light-refactor&quot;&gt;clj-light-refactor&lt;/a&gt; plugin, providing
better Clojure support in Light Table. It made sense to me to add a namespace browser feature to the plugin at some point.
Through experience with integrating the &lt;a href=&quot;https://github.com/clojure-emacs/cider-nrepl&quot;&gt;cider-nrepl&lt;/a&gt; middleware
I found that I had most of the tools necessary to implement a simple namespace browser.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A namespace browser obviously needs a bit of UI, and this is where the power of having an editor framework
based on node-webkit/atom-shell opens up for a range of opportunities. I could use the std dom lib that ships
with Light Table, but I decided I&amp;#8217;d rather have a go at implementing the UI part using React. Just for fun.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;There are a range of ClojureScript wrappers for React, but I decided to opt for one of the least opinionated ones : &lt;a href=&quot;https://github.com/levand/quiescent&quot;&gt;quiescent&lt;/a&gt;.
Let&amp;#8217;s have a look at how I did it !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;openblock float-group&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;div class=&quot;imageblock left&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2015//ns_list.png&quot; alt=&quot;ns list&quot; width=&quot;400&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 1. Namespace list&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock left&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2015//ns_vars.png&quot; alt=&quot;ns vars&quot; width=&quot;400&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 2. Public vars for selected namespace&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_setting_up_react_and_quiescent&quot;&gt;Setting up React and quiescent&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;As you&amp;#8217;ll see, this part is pretty easy.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_quiescent_dependency_project_clj&quot;&gt;Quiescent dependency - project.clj&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defproject clj-light-refactor &quot;0.1.5&quot;
  :dependencies [[org.clojure/clojure &quot;1.5.1&quot;]
                 [quiescent &quot;0.1.4&quot;]])               &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;To include quiescent, just add it as a dependency. I opted for an older version because the ClojureScript version currently supported by LT is fairly old.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_react_dependency_plugin_behaviours_file&quot;&gt;React dependency - plugin behaviours file&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;[:app :lt.objs.plugins/load-js [&quot;react.min.js&quot;                       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
                                &quot;clj-light-refactor_compiled.js&quot;]]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Just add the react js using the load-js behavior for plugins. It needs to load before quiescent, so it&amp;#8217;s added before the transpiled js for the plugin project.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_state_bot_and_such&quot;&gt;State, BOT and such&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;My namespace browser will need to have state. The namespace browser will retrieve it&amp;#8217;s data
from a cider-nrepl middleware op. Continuously invoking this backend for the data would kill the performance.
State in Light Table is typically stored in objects. Objects are basically a map of data stored in an ClojureScript atom.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
To learn more about BOT (Behaviors, Objects and Tags), check out &lt;a href=&quot;http://www.chris-granger.com/2013/01/24/the-ide-as-data/&quot;&gt;The IDE as a value&lt;/a&gt; by Chris Granger.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Quiescent has no opinions with regards to state, you just feed quiescent components with data, so using LT objects shouldn&amp;#8217;t be of any concern.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defui wrapper [this]                                             &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  [:div.outer
   [:div {:id &quot;nsbrowser-wrapper&quot;} &quot;Retrieving namespaces...&quot;]])

(object/object* ::nsbrowser
                :tags #{:clojure.nsbrowser}                       &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
                :label &quot;Clojure ns browser&quot;
                :order 2
                :init (fn [this]                                  &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
                        (wrapper this)))

(def ns-bar (object/create ::nsbrowser))                          &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;React needs a container element to mount in. We just create a wrapper (nsbrowser-wrapper), using the LT defui macro.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We add a custom tag to our object. Using this tag we can attach behaviors, i.e reaction to events, to our object.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Objects have an init function that can return a UI representation. Initially thats just our wrapper div. The actual content we will provide through behaviors.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Instantiate the object&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_rendering_the_nsbrowser_ui_using_quiescent_and_react&quot;&gt;Rendering the nsbrowser UI using quiescent and react&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(declare render)

(defn handle-keypress [props ev]                                           &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
  (let [kk (.-which ev)]
    (case kk
      38 (do (.preventDefault ev) ((:on-up props)))
      40 (do (.preventDefault ev) ((:on-down props)))
      13 (do (.preventDefault ev) ((:on-select props)))
      27 (do (.preventDefault ev) ((:on-escape props)))
      :default)))

(q/defcomponent SearchInput [props]                                        &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
  (d/input {:placeholder &quot;search&quot;
            :value (:search-for props)
            :onKeyDown (partial handle-keypress props)
            :onChange  #((:on-change props) (aget % &quot;target&quot; &quot;value&quot;))
            :autoFocus (:focus props)}))

(q/defcomponent ResultItem [item]                                          &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
  (d/li {:className (when (:selected item) &quot;selected&quot;)} (:name item)))

(q/defcomponent ResultList [props]                                         &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  (apply d/ul {:className (when (:selected-ns props) &quot; nsselection&quot;)}
               (map ResultItem (:items props))))

(q/defcomponent Searcher [props]                                           &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  (d/div {:className &quot;filter-list&quot;}
         (SearchInput props)
         (when-let [sel-ns (:selected-ns props)]
           (d/div {:className &quot;nstitle&quot;} sel-ns))
         (ResultList (select-keys props [:items :selected-ns]))))


(defn render [props]                                                       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (q/render (Searcher (merge {:on-down #(object/raise ns-bar :move-down!)
                              :on-up #(object/raise ns-bar :move-up!)
                              :on-select #(object/raise ns-bar :select!)
                              :on-escape #(object/raise ns-bar :escape!)
                              :on-change (fn [search-for]
                                           (object/raise ns-bar :search! search-for))}
                             props))
            (.getElementById js/document &quot;nsbrowser-wrapper&quot;)))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The render function is where we initially mount our react components and subsequently
rerender our UI upon any change in our data. The function takes a map (containing the data to render) and we merge in some properties
for handling events we wish to handle in our ui. More on that later.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This is the root component for our UI. It basically contains a search input and a result list (with a optional heading, when a namespace has been selected)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Subcomponent for the result list&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Subcomponent for a result list item, applies a &lt;em&gt;.selected&lt;/em&gt; class if this item is selected&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Subcomponent for the search input. This is used for filtering and navigating our result list.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Handler for keyboard events in the search input&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
If you are not familiar with react, it might seem inefficient to render the entire UI everytime. But
react is quite clever with its DOM operations, using a virtual dom it only performs the DOM operations necessary to
represent the diff since the last render. Further optimization is provided by quiescent as any quiescent component
will check whether the first param have changed using a clojure equality test (fast). If no props have changed, it will tell React that
the component doesn&amp;#8217;t need to rerender. Short story, you don&amp;#8217;t need to worry about render speed. It&amp;#8217;s more than fast enough.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The benefits of this approach might not be immediatly visible, but believe me it makes it very simple to reason about the UI.
When some state changes, rerender the entire UI. You don&amp;#8217;t need to worry about making the individual dom updates needed to
represent the change. This part is handled by react.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_working_with_data&quot;&gt;Working with data&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;When implementing the logic for changing which items is selected it made sense to extract the core
of that to immutable helper functions. Nothing new here, but it&amp;#8217;s a whole lot easier when no state is represented
in the dom, but rather in data structures somewhere else (like in an atom).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn move-down [items]
  (let [curr-idx (selected-idx items)]
    (if-not (&amp;lt; curr-idx (dec (count items)))
      items
      (-&amp;gt; items
          (assoc-in  [curr-idx :selected] false)
          (assoc-in  [(inc curr-idx) :selected] true)))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Implementing then move up/down logic are just simple functions. Testing them interactivly in Light Table
is dead easy using the inbuild repl with inline results.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_behaviors_for_filter_navigation_and_selection&quot;&gt;Behaviors for filter, navigation and selection&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::move-up!                                                     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
          :triggers #{:move-up!}
          :reaction (fn [this]
                      (let [moved (move-up (:filtered-items @this))]
                        (object/merge! this {:filtered-items moved})
                        (render {:items moved
                                 :selected-ns (:selected-ns @this)
                                 :search-for (:search-for @this)})
                        (sidebar-cmd/ensure-visible this))))            &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;

(behavior ::select!                                                     &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
          :triggers #{:select!}
          :reaction (fn [this]
                      (when-let [sel-idx (selected-idx (:filtered-items @this))]
                        (when-let [ed (pool/last-active)]
                          (let [item-name (:name (nth (:filtered-items @this) sel-idx))]
                            (if-not (:selected-ns @this)
                              (do
                                (object/merge! this {:search-for &quot;&quot;
                                                     :selected-ns item-name})
                                (object/raise ed :list-ns-vars item-name))
                              (let [sym (str (:selected-ns @this) &quot;/&quot; item-name)]
                                (object/raise ed :editor.jump-to-definition! sym)
                                (object/raise this :clear!))))))))


(behavior ::search!                                                    &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
          :triggers #{:search!}
          :reaction (fn [this search-for]
                      (let [items (if (:selected-ns @this) (:vars @this) (:items @this))
                            filtered
                            (-&amp;gt;&amp;gt; items
                                 (filter-items search-for)
                                 maybe-select-first
                                 vec)]
                        (object/merge! this {:filtered-items filtered
                                             :search-for search-for})
                        (render {:items filtered
                                 :selected-ns (:selected-ns @this)
                                 :search-for search-for}))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;All the move up behavior basically does is updating the state holding which item (in our filtered list of items)
is selected and then rerenders the UI with the updated item list&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When scrolling down the list (an UL element), we need to make sure the item is visible so we need to scroll. I
couldn&amp;#8217;t figure out a react-way to do this, so I reused a function from LT&amp;#8217;s command browser to achieve this.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The select behavior does one of two things. If the item selected is an namespace item it triggers
a behavior for retrieving (and subsequently later render) a list of public vars for that namespace. If the item is a var
it triggers a behavior for jumping to the definition of that var. The latter is a behavior already present in the Light Table Clojure plugin.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The search behavior filters the list of items to show based on what the user has entered in the search input.
It stores that filtered list in our object and rerenders the ui.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
The &lt;em&gt;this&lt;/em&gt; argument for our behavior reaction function is the ns-bar object instance we defined earlier.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt; [:clojure.nsbrowser :lt.plugins.cljrefactor.nsbrowser/move-up!]
 [:clojure.nsbrowser :lt.plugins.cljrefactor.nsbrowser/select!]
 [:clojure.nsbrowser :lt.plugins.cljrefactor.nsbrowser/search!]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Hooking up our behaviors to our object can be done inline using code, or declaratively using
a behaviors definition file. I&amp;#8217;ve opted for the latter and hooked them up in the plugin behaviors file.
What we say here is that objects with the given tag &lt;em&gt;:clojure.nsbrowser&lt;/em&gt; responds to the behavior defined in the second arg for the vectors.
Should you find that you&amp;#8217;d like to override one or more of the behaviors (or disable them alltogether) you can easily
do that.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_a_silly_example_overriding_the_move_behavior&quot;&gt;A silly example - overriding the move behavior&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Let&amp;#8217;s say you have a better idea for how the move behavior should work. You override that
in your Light Table user plugin (everyone has one !).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_providing_your_own_behavior&quot;&gt;Providing your own behavior&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(ns lt.plugins.user                                                    &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (:require [lt.object :as object]
            [lt.plugins.nsrefactor.nsbrowser :as nsbrowser])           &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  (:require-macros [lt.macros :refer [behavior]]))

(behavior ::user-move-up!
          :triggers #{:move-up!}                                       &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
          :reaction (fn [this]
                      (println &quot;Add my custom version here...&quot;)))      &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;You&amp;#8217;ll find the user plugin in $LT_HOME/User. It ships with a default $LT_HOME/User/src/plugins/user.cljs file for your convenience&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Require any namespace you need, for the purpose of this override you might need to have access to functions
in the namespace where the nsbrowser is implemented&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This is the really important bit. Triggers (together with tags) tells LT which behavior reaction functions to invoke
when an event is triggered (through &lt;em&gt;object/raise&lt;/em&gt;)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Implementation for the overriding behavior&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_replacing_the_default_behavior_with_our_own&quot;&gt;Replacing the default behavior with our own&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt; [:clojure.nsbrowser :-lt.plugins.cljrefactor.nsbrowser/move-up!]   &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
 [:clojure.nsbrowser :lt.plugins.user/user-move-up!]                &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;First we turn off the default behavior from the plugin &lt;em&gt;:-&lt;/em&gt; disable a given behavior)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The we hook up our new custom made override behavior&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I think you now can start to the see the power of the BOT model in Light Table. It&amp;#8217;s very flexible,
but the price you pay is that it can be difficult to grasp at first sight. Once you do grock it, you&amp;#8217;ll realize that
you have an incredibly customizable editor at your disposal.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_getting_the_namespace_data&quot;&gt;Getting the namespace data&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So how do we go about getting the list of namespaces and vars for each namespace ?
This is where cider-nrepl comes into play. The ops we wish to call are in the &lt;a href=&quot;https://github.com/clojure-emacs/cider-nrepl/blob/master/src/cider/nrepl/middleware/ns.clj&quot;&gt;ns middleware&lt;/a&gt; for cider-nrepl.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_interacting_with_cider_nrepl&quot;&gt;Interacting with cider-nrepl&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A precondition for this to work is that the cider-nrepl is added as a plugin dependency for your project.
You could do this on a project level, or you could do it globally for all your projects in profiles.clj.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;  :user {:plugins [[cider/cider-nrepl &quot;0.9.0-SNAPSHOT&quot;]]}}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::list-ns
          :triggers #{:list-ns}
          :reaction (fn [ed]
                      (object/raise ed
                                    :eval.custom                                 &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
                                    (mw/create-op {:op &quot;ns-list&quot;})               &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
                                    {:result-type :refactor.list-ns-res          &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
                                     :verbatim true})))


(behavior ::list-ns-res
          :triggers #{:editor.eval.clj.result.refactor.list-ns-res}              &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
          :reaction (fn [ed res]
                      (let [[ok? ret] (mw/extract-result res                     &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
                                                         :singles
                                                         [:ns-list :results])]
                        (if-not ok?
                          (object/raise ed
                                        :editor.exception
                                        (:err ret)
                                        {:line (-&amp;gt; ret :meta :line)})

                          (do
                            (object/raise sidebar/rightbar :toggle ns-bar)       &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
                            (object/raise ns-bar
                                          :update-ns-list!                       &lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;(7)&lt;/b&gt;
                                          (-&amp;gt;&amp;gt; (:ns-list ret)
                                               (maybe-exclude (:exclusions @ns-bar))
                                               (map #(hash-map :name %)))))))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;To evaluate arbitrary clojure code in LT you can use the &lt;em&gt;eval.custom&lt;/em&gt; behavior&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This is a helper method that creates the code to invoke the cider-nrepl middleware&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We can tell LT that the trigger for the response should end with &lt;em&gt;refactor.list-ns-res&lt;/em&gt;. So when
the operation completes in will trigger a behavior named as defined in &lt;strong&gt;4&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The trigger for our behavior to handle the response&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Helper function to extract the result from cider-nrepl op&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Our nsbrowser is displayed in a predefined UI component which is a sidebar. We tell it to display&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;7&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We raise a behavior for displaying the list of namespaces found (see the &lt;a href=&quot;https://github.com/rundis/clj-light-refactor/blob/master/src/lt/plugins/cljrefactor/nsbrowser.cljs&quot;&gt;full source&lt;/a&gt; for how this behavior is defined)&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
The code eval behavior is triggered on an ed object. This is an LT editor object. This means that
we need to have a clojure editor open for our namespace browser to work (hoping to remedy that in the near future).
The editor object contains information about which project we are connected to (and if not connected, prompts you to do so).
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_providing_a_command_to_show_the_namespace_browser&quot;&gt;Providing a command to show the namespace browser&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The final piece of the puzzle is to provide a command to allow us to trigger when the namespace browser should be displayed.
Commands in Light Table are typically the user actions. Commands are actions that can be tied to keyboard shortcuts. They are also displayed
in the Light Table command browser (open by pressing ctrl + space).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(cmd/command {:command :show-nsbrowser                          &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
              :desc &quot;Clojure refactor: Show ns-browser&quot;         &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
              :exec (fn []
                      (when-let [ed (pool/last-active)]         &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
                        (object/raise ed :list-ns)))})          &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The name of the command&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The description for our command, this text is shown in the command browser&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Get the currently active editor object (if one is open)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Trigger the behavior for retrieving the initial namespace list and ultimately display the namespace browser&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_defining_a_keyboard_shortcut&quot;&gt;Defining a keyboard shortcut&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In your user keymap (ctrl + space, find &quot;Setting: User keymap&quot; and select it)&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt; [:editor.clj &quot;ctrl-alt-n&quot; :show-nsbrowser]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Here we&amp;#8217;ve scoped the shortcut to only trigger when we invoke it having an active clojure editor open&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_some_final_sugaring_custom_filtering&quot;&gt;Some final sugaring - Custom filtering&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To provide some customization for our nsbrowser we&amp;#8217;ve defined a user configurable behavior
for that purpose. Currently you can define a list of regex&amp;#8217;s for namespaces you wish to exclude from the listing.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::set-nsbrowser-filters
          :triggers #{:object.instant}                                   &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
          :desc &quot;Clojure Refactor: Configure filter for nsbrowser&quot;
          :type :user
          :params [{:label &quot;exclusions&quot; :type :list}]                    &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
          :exclusive true
          :reaction (fn [this exclusions]
                      (object/merge! this {:exclusions exclusions})))    &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This particular behavior is triggered when the ns-bar object is instatiated&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;You can provide param descriptions which show up in .behaviors files to assist user configuration&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We store the user provided setting in our object&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2015//nsconfig_beh.png&quot; alt=&quot;nsconfig beh&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The default behavior adds a few exclusions by default. You can easily override those by configuring the behavior
in your own user.behaviors. (ctrl + space, find &quot;Settings: User behavior&quot; and select)&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_summary&quot;&gt;Summary&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Having an editor that is basically a web browser with node-js integration provides the foundation to do an incredible amount of
cool stuff. In this post I have shown you how to use React (with quiescent on top) for rendering view items in Light Table.
I have walked you through how that may fit in with the BOT architecture Light Table is based on.
I hope I have managed to give you a glimpse of the power of the BOT architecture and the facilities it provides for extending and customizing
your editor. I haven&amp;#8217;t gone into great detail on how I&amp;#8217;ve interacted with cider-nrepl to provide the namespace data, that belongs in a separate blogpost.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;em&gt;Some of you might have noticed that the Light Table project and it&amp;#8217;s progress has stalled somewhat (ref &lt;a href=&quot;https://groups.google.com/d/msg/light-table-discussion/2csnnNA1pfo/693EWDJVhuwJ&quot;&gt;this post from Chris Granger&lt;/a&gt; on the LT discussion forum.
I&amp;#8217;m still hoping that this situation can be remedied. I firmly believe it&amp;#8217;s possible and with just a wee bit more community effort Light Table can still have a future
as a great Open Source IDE alternative.&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
For improved Clojure support in Light Table, you really should try out the &lt;a href=&quot;https://github.com/rundis/clj-light-refactor&quot;&gt;clj-light-refactor&lt;/a&gt; plugin !
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>A pinch of Clojure love to Light Table</title>
      <link>http://rundis.github.io/blog/2015/clojure_light_love.html</link>
      <pubDate>Tue, 14 Apr 2015 00:00:00 +0200</pubDate>
      <guid isPermaLink="false">2015/clojure_light_love.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The Clojure Refactoring plugin for Light Table has finally been released !
You&amp;#8217;ll find the plugin in the LIght Table plugin manager. Alternatively you
can clone the repo to the plugin folder of LIght Table if you know what you are doing :)&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
You will need to check out the readme &lt;a href=&quot;https://github.com/rundis/clj-light-refactor&quot; class=&quot;bare&quot;&gt;https://github.com/rundis/clj-light-refactor&lt;/a&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To celebrate the launch of the plugin I&amp;#8217;ve made a small demo of some of the features in the plugin.
You might also be interrested in the pre-release &lt;a href=&quot;http://rundis.github.io/blog/2015/clj_light_refactor.html&quot;&gt;demo&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_demo&quot;&gt;Demo&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://youtu.be/1yk8nsjJxb0&quot;&gt;ScreenCast demo&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;iframe width=&quot;420&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/1yk8nsjJxb0&quot; frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_feature_highlights&quot;&gt;Feature highlights&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Simple form refactoring (cycle if, cycle col, introduce threading etc)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Extract function&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Dependency completion and hotloading of dependencies&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Find usages and rename&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Namespace cleanup&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Resolve mising requires/imports&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Some cider features like: test support, smarter autocompletion and better formatting&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Most of the features are currently Clojure only, but some of the simpler ones also works in ClojureScript.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_resources&quot;&gt;Resources&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Pre release demo: &lt;a href=&quot;http://rundis.github.io/blog/2015/clj_light_refactor.html&quot; class=&quot;bare&quot;&gt;http://rundis.github.io/blog/2015/clj_light_refactor.html&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Plugin repo: &lt;a href=&quot;https://github.com/rundis/clj-light-refactor&quot; class=&quot;bare&quot;&gt;https://github.com/rundis/clj-light-refactor&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_credits&quot;&gt;Credits&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/clojure-emacs/refactor-nrepl&quot;&gt;refactor-nrepl&lt;/a&gt; - nREPL middleware to support refactorings in an editor agnostic way. This awesome middleware
has enable most of the advanced refactoring features in the plugin&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/clojure-emacs/cider-nrepl&quot;&gt;cider-nrepl&lt;/a&gt; - A collection of nREPL middleware designed to enhance CIDER. Additional cool
features have been enabled by this middleware, and there are more to come !&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/clojure-emacs/clj-refactor.el&quot;&gt;clj-refactor.el&lt;/a&gt; - Emacs Clojure Refactor plugin. The source of inspiration for my Light Table plugin.
It provides a long list of really cool refactoring features for emacs users.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Taming those pesky datetimes in a clojure stack</title>
      <link>http://rundis.github.io/blog/2015/clojure_dates.html</link>
      <pubDate>Fri, 27 Mar 2015 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2015/clojure_dates.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Have you ever faced frustrating issues when using dates in your clojure stack ? If I mention java.util.Date, java.sql.Date/java.sql.Timestamp
clj-time, json/ISO-8601 and UTC/Timezones, does your bloodpressure rise slightly ?&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This is the blog post I wished I had several weeks back to save me from some of the date pains my current project has been through.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A little while back date handling started to become a nightmare in my current project. We have a stack with
a ClojureScript frontend, a clojure WebApp and a couple of clojure microservices apps using Oracle as a data store.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We decided pretty early on to use &lt;a href=&quot;https://github.com/clj-time/clj-time&quot;&gt;clj-time&lt;/a&gt;. It&amp;#8217;s a really quite nice wrapper on top of &lt;a href=&quot;http://www.joda.org/joda-time/&quot;&gt;joda-time&lt;/a&gt;.
But we didn&amp;#8217;t pay much attention to how dates should be read/written to Oracle or how we should transmit dates across process boundaries.
Timezones is another issue we didn&amp;#8217;t worry to much about either.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
You will probably not regret using an UTC timezone for your Servers and Database. This &lt;a href=&quot;http://yellerapp.com/posts/2015-01-12-the-worst-server-setup-you-can-make.html&quot;&gt;post&lt;/a&gt; puts it succinctly.
Your webclient(s) though is out of your control !
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;m sure some of the measures we have taken can be solved more elegantly, but hopefully you might find some of them useful.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_reading_from_writing_to_the_database&quot;&gt;Reading from/writing to the database&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We use &lt;a href=&quot;https://github.com/clojure/java.jdbc&quot;&gt;clojure/java.jdbc&lt;/a&gt; for our database integration. Here&amp;#8217;s how we managed to
simplify reading and writing dates/datetimes.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(ns acme.helpers.db
  (:import [java.sql PreparedStatement])
  (:require [acme.util.date :as du]
            [clj-time.coerce :as c]
            [clojure.java.jdbc :as jdbc]))


(extend-protocol jdbc/IResultSetReadColumn                                &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  java.sql.Date
  (result-set-read-column [v _ _] (c/from-sql-date v))                    &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;

  java.sql.Timestamp
  (result-set-read-column [v _ _] (c/from-sql-time v)))

(extend-type org.joda.time.DateTime                                       &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  jdbc/ISQLParameter
  (set-parameter [v ^PreparedStatement stmt idx]
    (.setTimestamp stmt idx (c/to-sql-time v))))                          &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We extend the protocol for reading objects from the java.sql.ResultSet.
In our case we chose to treat java.sql.Date and java.sql.Timestamp in the same manner&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;clj-time provides some nifty coercion functions including the facility to coerce from sql dates/times to DateTime&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We extend the DateTime class (which is final btw!) with the ISQLParameter protocol. This is a protocol for setting SQL parameters in statement objects.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We explicitly call setTimestamp on the prepared statement with a DateTime coerced to a java.sqlTimestamp as our value&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Now we can interact with oracle without being bothered with java.sql.Date and java.sql.Timestamp malarkey.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock warning&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-warning&quot; title=&quot;Warning&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
It&amp;#8217;s vital that you require the namespace you have the above incantations, before doing any db interactions. Might be evident, but it&amp;#8217;s worth emphasizing.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Clojure &lt;a href=&quot;http://clojure.org/protocols&quot;&gt;protocols&lt;/a&gt; are pretty powerful stuff. It&amp;#8217;s deffo on my list of clojure things I need
to dig deeper into.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_dates_across_process_boundaries&quot;&gt;Dates across process boundaries&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Our services unsurpringly uses JSON as the data exchange format. I suppose the defacto standard date format is &lt;a href=&quot;http://www.iso.org/iso/home/standards/iso8601.htm&quot;&gt;ISO-8601&lt;/a&gt;,
it makes sence to use that. It so happens this is the standard format for DateTime when you stringify it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
You might want to look into &lt;a href=&quot;https://github.com/cognitect/transit-format&quot;&gt;transit&lt;/a&gt;. It would probably have been very useful for us :)
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_outbound_dates&quot;&gt;Outbound dates&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(ns acme.core
  (:require [clojure.data.json :as json]
            [clj-time.coerce :as c]))


(extend-type org.joda.time.DateTime           &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  json/JSONWriter
  (-write [date out]
    (json/-write (c/to-string date) out)))    &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Another extend of DateTime, this time with the JSONWriter protocol.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;When serializing DateTime to json we coerce it to string. clj-time.coerce luckily uses the ISO-8601 format as default&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_inbound_dates&quot;&gt;Inbound dates&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(ns acme.util.date
  (:require [clj-time.core :as t]
            [clj-time.format :as f]
            [clj-time.coerce :as c]))


(def iso-date-pattern (re-pattern &quot;^\\d{4}-\\d{2}-\\d{2}.*&quot;))


(defn date? [date-str]                                                         &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (when (and date-str (string? date-str))
    (re-matches iso-date-pattern date-str)))


(defn json-&amp;gt;datetime [json-str]
  (when (date? json-str)
    (if-let [res (c/from-string json-str)]                                     &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
      res
      nil))) ;; you should probably throw an exception or something here !

(defn datetimeify [m]
  (let [f (fn [[k v]]
            (if (date? v)
              [k (json-&amp;gt;datetime v)]                                           &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
              [k v]))]
    (clojure.walk/postwalk (fn [x] (if (map? x) (into {} (map f x)) x)) m)))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;A crude helper function to check if a given value is a date. There is a lot that passes through as valid ISO-8601
we settled for atleast a minimum of YYYY-MM-DD&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Coerces a string to a DateTime, the coercion will return nil if it can&amp;#8217;t be coerced, that&amp;#8217;s probably worth an exception&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Traverse a arbitrary nested map and coerce values that (most likely) are dates&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Hook up middleware&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn wrap-date [handler]                                     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (fn [req]
    (handler (update-in req [:params] (datetimeify %)))))


def app (-&amp;gt; routes
            auth/wrap-auth
            wrap-date                                         &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
            wrap-keyword-params
            wrap-json-params
            wrap-datasource
            wrap-params
            wrap-config))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Middleware that calls our helper function to coerce dates with the request map as input&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Hook up the middleware&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_handling_dates_in_the_webclient&quot;&gt;Handling dates in the webclient&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We have a ClojureScript based client so it made sense for us to use &lt;a href=&quot;https://github.com/andrewmcveigh/cljs-time&quot;&gt;cljs-time&lt;/a&gt;.
It&amp;#8217;s very much inspired by clj-time, but there are some differences. The most obvious one is that there is no jodatime, so
&lt;a href=&quot;http://docs.closure-library.googlecode.com/git/namespace_goog_date.html&quot;&gt;Google Closure goog.date&lt;/a&gt; is used behind the scenes.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;div class=&quot;title&quot;&gt;So how do we convert to and from the iSO-8601 string based format in our client ?&lt;/div&gt;
&lt;p&gt;Surprisingly similar to how we do it on the server side as it happens !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;;; require similar to the ones on the server side. cljs-time. rather than clj-time.


(defn datetimes-&amp;gt;json [m]                                                       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (let [f (fn [[k v]]
            (if (instance? goog.date.Date v)                                    &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
              [k (c/to-string v)]
              [k v]))]
    (clojure.walk/postwalk (fn [x] (if (map? x) (into {} (map f x)) x)) m)))


;; AJAX/HTTP Utils

(defn resp-&amp;gt;view [resp]                                                         &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  (-&amp;gt; resp
      (update-in [:headers] #(keywordize-keys %))
      (assoc-in [:body] (-&amp;gt; resp datetimeify :body))))                          &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;

(defn view-&amp;gt;req [params]                                                        &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
  (-&amp;gt; params
      datetimes-&amp;gt;json))                                                         &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Function that traverses a nested map and converts from DateTime to ISO-8601&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Almost an instanceOf check to decide if the value is eligible for coercion&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Handy function to transform an ajax response to something appropriate for use in our client side logic&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;datetimeify is identical to our server side impl&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Handy function to take a map, typically request params, and transform to something appropriate for communication
with a backend server. If you are using something like &lt;a href=&quot;https://github.com/r0man/cljs-http&quot;&gt;cljs-http&lt;/a&gt; it might be appropriate to hook it in as a middleware.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Coerce any DateTime values to ISO-8601 date strings&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
What about timezones on the client ? The default for the datetime constructor in cljs-time is to use UTC. So when displaying
time and/or accepting date with time input from the client you need to convert to/from the appropriate timezone.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(ns acme.client
  (:require [cljs-time.format :as f]
            [cljs-time.core :as t]))


(def sample (t/now)) ;; lets say 2015-03-27T00:53:38.950Z


(-&amp;gt;&amp;gt; sample
     t/to-default-time-zone                          ; UTC+1 for me
     (f/unparse (f/formatter &quot;dd.MM.yyyy hh:mm&quot;)))   ; =&amp;gt; 27.03.2015 01:53&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_summary&quot;&gt;Summary&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Using clojure protocols we managed to simplify reading and writing date(times) to the database. Protocols also helped us serialize
date(times) to json. For reading json we had to hack it a little bit. By using fairly similar libs for dates on both the client and our server apps
we managed to reuse quite a bit. In addition We have reasonable control of where we need to compensate for timezones.
Most importantly though, our server-side and client-side logic can work consistently with a sensible and powerful date implementation.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Securing Clojure Microservices using buddy - Part 4: Secure and liberate a service app</title>
      <link>http://rundis.github.io/blog/2015/buddy_auth_part4.html</link>
      <pubDate>Wed, 25 Mar 2015 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2015/buddy_auth_part4.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Part 4 in my blog series about securing clojure web services using &lt;a href=&quot;https://github.com/funcool/buddy&quot;&gt;buddy&lt;/a&gt;.
The time has finally come to demonstrate how you may secure a REST based microservice application.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Previous episodes in this series:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;http://rundis.github.io/blog/2015/buddy_auth_part1.html&quot;&gt;Securing Clojure Microservices using buddy - Part 1: Creating Auth Tokens&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;http://rundis.github.io/blog/2015/buddy_auth_part2.html&quot;&gt;Securing Clojure Microservices using buddy - Part 2: WebApp authentication and authorization&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;http://rundis.github.io/blog/2015/buddy_auth_part3.html&quot;&gt;Securing Clojure Microservices using buddy - Part 3: Token revocation&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Sample code (tagged for each blog post) can be found on &lt;a href=&quot;https://github.com/rundis/acme-buddy&quot;&gt;github&lt;/a&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Before I discovered buddy my first attempt at prototyping a clojure web app with security tried to combine
the use of &lt;a href=&quot;https://github.com/cemerick/friend&quot;&gt;Friend&lt;/a&gt; and &lt;a href=&quot;http://clojure-liberator.github.io/liberator&quot;&gt;Liberator&lt;/a&gt;.
To complicate matters I tried to make an app that both served user content (html) and provided a REST api.
I had a hard time figuring out how to make the two play nicely together. If it hadn&amp;#8217;t been for the brilliant article:
&lt;a href=&quot;http://sritchie.github.io/2014/01/17/api-authentication-with-liberator-and-friend/&quot;&gt;API Authentication with Liberator and Friend&lt;/a&gt; by Sam Ritchie,
I wouldn&amp;#8217;t have gotten very far.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In this episode I will try to demonstrate how you may use buddy in combination with Liberator
to secure a REST-oriented microservice application. We are going to build upon the token based
authentication and authorization from the previous episodes and create the &lt;strong&gt;acme-catalog&lt;/strong&gt; service app.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_a_small_contribution_to_buddy&quot;&gt;A small contribution to buddy&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The primary buddy lib to help you secure ring based web apps is &lt;a href=&quot;https://github.com/funcool/buddy-auth&quot;&gt;buddy-auth&lt;/a&gt;.
Unfortunately when I first wanted to use buddy-auth for authentication and authorization, it didn&amp;#8217;t provide
out of the box support for jws tokens. What to do ? Well I decided to do what any good open citizen should do.
I submitted a pull request. My first clojure lib contribution got accepted. Yay !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_relevant_code_snippets_for_acme_catalog&quot;&gt;Relevant code snippets for acme-catalog&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_wrap_authentication_middleware&quot;&gt;Wrap authentication middleware&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(ns acme-catalog.core
  (:require [compojure.core :refer [defroutes ANY]]
            [ring.middleware.params :refer [wrap-params]]
            [ring.middleware.keyword-params :refer [wrap-keyword-params]]
            [ring.middleware.json :refer [wrap-json-params]]
            [clojure.java.io :as io]
            [buddy.auth.backends.token :refer [jws-backend]]
            [buddy.auth.middleware :refer [wrap-authentication]]
            [buddy.core.keys :as ks]
            [acme-catalog.resources :as r]))

(defroutes app-routes
  (ANY &quot;/products&quot; [] r/products)
  (ANY &quot;/products/:id&quot; [id] (r/product id)))


(def auth-backend (jws-backend {:secret (ks/public-key (io/resource &quot;auth_pubkey.pem&quot;))  &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
                                :token-name &quot;Acme-Token&quot;}))

(def app
  (-&amp;gt; app-routes
      (wrap-authentication auth-backend)                                                 &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
      wrap-keyword-params
      wrap-json-params))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Buddy auth backend that supports jws tokens. We provide the public key for the certifacate used by
acme-auth to create our tokens. In addition we can optionally provide a custom name for our token&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Apply middleware that uses backend to read the token, unsign it and populate request map with the token info&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;olist arabic&quot;&gt;
&lt;div class=&quot;title&quot;&gt;What does the wrap-authentication middleware do ?&lt;/div&gt;
&lt;ol class=&quot;arabic&quot;&gt;
&lt;li&gt;
&lt;p&gt;Retrieves the &lt;em&gt;Authorization&lt;/em&gt; header (if one exist) from the request headers&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Looks for the token param (default &quot;Token&quot;, but in our case &quot;Acme-Token&quot;)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;If found reads the token and unsigns it using the secret (in our case the public key)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The contents of the unsigned token is added to an :identity key in your request map&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Sample request map&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;{:identity
  {:user
    {:user-roles [{:role-id 10, :application-id 10}
                  {:role-id 41, :application-id 40}],
     :username test, :id 1},
 :exp 1427285979},
 ;; etc...
 }&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_authorizing_liberator_resources&quot;&gt;Authorizing liberator resources&lt;/h3&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Liberator routes your request through a graph of decisions and actions. &lt;a href=&quot;http://clojure-liberator.github.io/liberator/assets/img/decision-graph.svg&quot;&gt;This graph&lt;/a&gt;
provides a useful context in case you are not familiar with what decisions kicks in when !
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I initially tripped on the difference between HTTP status 401 and 403. &lt;a href=&quot;http://stackoverflow.com/questions/3297048/403-forbidden-vs-401-unauthorized-http-responses&quot;&gt;Stackoverflow&lt;/a&gt;
provides a pretty clear explanation.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_helper_functions_for_role_access&quot;&gt;Helper functions for role access&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(def acme-catalog-roles
  {:customer 41 :catalog-admin 40})                                       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;

(defn any-granted? [ctx roles]                                            &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  (seq
   (clojure.set/intersection
    (set (map :role-id (-&amp;gt; ctx :request :identity :user :user-roles)))
    (set (vals (select-keys acme-catalog-roles roles))))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Hardcoded definition of roles applicable for the acme-catalog app&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Helper function to check if the user has been granted one or more of the applicable roles&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_liberator_resource_commons&quot;&gt;Liberator resource commons&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Liberator resources are composable, so to avoid too much repetion across resources we&amp;#8217;ve created
a small helper function to define behavior for the two key decision points with regards to
authentication and authorization checks.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn secured-resource [m]
  {:authorized?    #(authenticated? (:request %))                                       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
   :allowed?       (fn [ctx]
                     (let [default-auth? (any-granted? ctx (keys acme-catalog-roles))]  &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
                       (if-let [auth-fn (:allowed? m)]
                         (and default-auth? (auth-fn ctx))                              &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
                         default-auth?)))})&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;:authorized?&lt;/strong&gt; corresponds to 401. Here we check if the user is authenticated. We use a buddy function: &lt;em&gt;authenticated?&lt;/em&gt;
to do the check. If the user isn&amp;#8217;t authentication this function will return false&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;:allowed?&lt;/strong&gt; corresponds to 403. We provide a default impl here that says that the user must atleast have
one of the acme-catalog roles to be authorized to access a secured resource&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;In addition we provide an optional facility to specify a custom function for more fine grained authorization checks. See below for example.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_securing_products_resources&quot;&gt;Securing products resources&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defresource product-categories
  (secured-resource {})                                                                   &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  :available-media-types [&quot;application/json&quot;]
  :allowed-methods       [:get]
  :handle-ok             (fn [ctx] &quot;List of categories&quot;))

(defresource products
  (secured-resource {:allowed? (by-method {:get true                                      &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
                                           :post #(any-granted? % [:catalog-admin])})})
  :available-media-types [&quot;application/json&quot;]
  :allowed-methods       [:get :post]
  :handle-ok             (fn [ctx] &quot;List of products coming your way honey&quot;))


(defresource product [id]
  (secured-resource {:allowed? (by-method {:get true
                                           :delete #(any-granted? % [:catalog-admin])
                                           :put #(any-granted? % [:catalog-admin])})})
  :available-media-types [&quot;application/json&quot;]
  :allowed-methods       [:get :put :delete]
  :handle-ok             (fn [ctx]                                                        &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
                           (if (and (= &quot;99&quot; id)
                                    (not (any-granted? ctx [:catalog-admin])))
                             (ring-response {:status 403
                                             :headers {}
                                             :body &quot;Only admins can access product 99&quot;})
                             &quot;A single product returned&quot;)))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;For the product-categories service anybody with a acme-catalog role may access&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;For products we restrict access by request method. Only catalog admins may add new products, while anyone can list products.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Silly example, but demonstrates that you can always bypass the defaults and do custom authorization
further down in the liberator decision chain.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_trying_it_all_out_commando_style&quot;&gt;Trying it all out - commando style&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Get a valid token&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;acme-auth: lein ring server-headless

# In another terminal
curl -i -X POST -d &apos;{&quot;username&quot;: &quot;test&quot;, &quot;password&quot;:&quot;secret&quot;}&apos; -H &quot;Content-type: application/json&quot; http://localhost:6001/create-auth-token

# Responds with something like:
HTTP/1.1 201 Created
Date: Wed, 25 Mar 2015 11:49:39 GMT
Content-Type: application/json; charset=utf-8
Content-Length: 1057
Server: Jetty(7.6.13.v20130916)

{&quot;token-pair&quot;:{&quot;auth-token&quot;:&quot;eyJ0eXAiOiJKV1MiLCJhbGciOiJSUzI1NiJ9.eyJ1c2VyIjp7InVzZXItcm9sZXMiOlt7InJvbGUtaWQiOjEwLCJhcHBsaWNhdGlvbi1pZCI6MTB9LHsicm9sZS1pZCI6NDEsImFwcGxpY2F0aW9uLWlkIjo0MH1dLCJ1c2VybmFtZSI6InRlc3QiLCJpZCI6MX0sImV4cCI6MTQyNzI4NTk3OX0.eNTNG8Hu8a4OD9xWSoEZgwGUd15Oytj-GQZY4RgmTEdx9OjkLDRBefU89GNlEEq19Bsd3ciuWzTXKg3B0qvAk4F4-najY_erPGypSlBvRUI0Fa1_wA2PRYxT-zCTiSIxD-oM0oq_3Z61QlN0k-Sf7shel42-x9z7r8RQeNMr-iMk-hOI_v7moQogN08FiZnctcQdE8qKg_DEhwO3l780eBta_vr3tGSd174IRthz59G61P-XqV8wC4HZymbe8TCMc-3uniIvQeoG_rC3oRqNfjkxZlTB_h6mOjs1p3h_cUmrsOhSk0mQe5mrwSzuCiunMcKQ1jsb88daWkvjMrwRUg&quot;,&quot;refresh-token&quot;:&quot;eyJ0eXAiOiJKV1MiLCJhbGciOiJSUzI1NiJ9.eyJ1c2VyLWlkIjoxLCJleHAiOjE0Mjk4NzYxODAsImlhdCI6MTQyNzI4NDE4MH0.FH2xooPoGnrSEbcU17Tr8ls9A-Noc3n9ZzLWGrblrI0bbIIFz25eJLcJbVGT3dLs7syc0KG3v4O0LAwQ6URvgl0aV2IT366KpmOiMUpsYmgqDCuE45FlSB2IBQKOLBTb6j18jpIsy0Kev6iHUCpvgKyNPcglElnVLFFahVwk_DDyrWusPcX-Di3AqSJdyz6ruBuPGzbzS6DMNkasTFNI1TLwjuokzVCdIYSNiQmgc1IozBFjHdeqQ_5kUdinv_tiW7yho0CwqiGSa9i56b328aZR5lADXR6gom5Oy4XTDDR6eMoDcvZKBncLV3YO29HC58EmZLghbX6832i0J7jfGw&quot;}}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Calling acme-catalog&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;acme-catalog: lein ring server-headless

#in another terminal
curl -i -H &quot;Authorization: Acme-Token eyJ0eXAiOiJKV1MiLCJhbGciOiJSUzI1NiJ9.eyJ1c2VyIjp7InVzZXItcm9sZXMiOlt7InJvbGUtaWQiOjEwLCJhcHBsaWNhdGlvbi1pZCI6MTB9LHsicm9sZS1pZCI6NDEsImFwcGxpY2F0aW9uLWlkIjo0MH1dLCJ1c2VybmFtZSI6InRlc3QiLCJpZCI6MX0sImV4cCI6MTQyNzI4NTk3OX0.eNTNG8Hu8a4OD9xWSoEZgwGUd15Oytj-GQZY4RgmTEdx9OjkLDRBefU89GNlEEq19Bsd3ciuWzTXKg3B0qvAk4F4-najY_erPGypSlBvRUI0Fa1_wA2PRYxT-zCTiSIxD-oM0oq_3Z61QlN0k-Sf7shel42-x9z7r8RQeNMr-iMk-hOI_v7moQogN08FiZnctcQdE8qKg_DEhwO3l780eBta_vr3tGSd174IRthz59G61P-XqV8wC4HZymbe8TCMc-3uniIvQeoG_rC3oRqNfjkxZlTB_h6mOjs1p3h_cUmrsOhSk0mQe5mrwSzuCiunMcKQ1jsb88daWkvjMrwRUg&quot; http//localhost:6003/products/1

# reponds with something like
HTTP/1.1 200 OK
Date: Wed, 25 Mar 2015 13:47:50 GMT
Vary: Accept
Content-Type: application/json;charset=UTF-8
Content-Length: 25
Server: Jetty(7.6.13.v20130916)

A single product returned&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_integration_with_acme_webstore&quot;&gt;Integration with acme-webstore&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Calling acme-catalog from acme-webstore should now be a pretty simple matter. We just need to make
sure we pass on the token.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_calling_acme_catalog&quot;&gt;Calling acme-catalog&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(ns acme-webstore.catalog
  (:require [clj-http.client :as http]))


(defn get-from-catalog [path token]
  (http/get path {:headers {&quot;Authorization&quot; (str &quot;Acme-Token &quot; token)}}))       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;

(defn get-products [req]
  (let [auth-token (-&amp;gt; req :session :token-pair :auth-token)                    &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
        resp (get-from-catalog &quot;http://localhost:6003/products&quot; auth-token)]
    (:body resp)))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We make sure we pass the token in the &lt;em&gt;Authorization&lt;/em&gt; header with the given token name&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The auth-token for the logged in user is found under the session key for the request&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The rest is just a matter of hooking up the appropriate route and view. I&amp;#8217;ll leave that part up to you !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_summary&quot;&gt;Summary&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Most of the hard work was already done in the previous episodes. Providing authentication and authorization
for our REST services was pretty simple. We also demonstrated that integrating with Liberator was mostly
a matter of hooking into the appropriate decision points for our resource definitions.
We didn&amp;#8217;t utilize all that much of buddy-auth here, but your app might find use for some of its more advanced features.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I think this episode demonstrates some of the benefits of using a library like buddy. It&amp;#8217;s not very opnionated which leaves you with a lot of decisions to make.
But it does have the building blocks you need and it provides you with great flexibility when it comes to integrating with other libraries.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;At the moment I&amp;#8217;m not sure if there is going to be any further episodes in the near future. But the again it might.
Feel free to leave suggestions in the commenting section though.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Implementing a Clojure threading refactoring in ClojureScript using Light Table</title>
      <link>http://rundis.github.io/blog/2015/clj_light_thread.html</link>
      <pubDate>Mon, 16 Mar 2015 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2015/clj_light_thread.html</guid>
      	<description>
	&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;About a week ago I blogged and did a ScreenCast about &lt;a href=&quot;http://rundis.github.io/blog/2015/clj_light_refactor.html&quot;&gt;Clojure refactoring in Light Table&lt;/a&gt;.
I introduced some clojure refactorings enabled by the not yet released &lt;a href=&quot;https://github.com/rundis/clj-light-refactor&quot;&gt;plugin&lt;/a&gt; I&amp;#8217;m currently
working on. In this post I thought I&amp;#8217;d walk you through a feature I&amp;#8217;ve added since then in a little more detail.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Clj-Light-Refactor plugin on github &lt;a href=&quot;https://github.com/rundis/clj-light-refactor&quot; class=&quot;bare&quot;&gt;https://github.com/rundis/clj-light-refactor&lt;/a&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Again &lt;a href=&quot;https://github.com/clojure-emacs/clj-refactor.el&quot;&gt;clj-refactor.el&lt;/a&gt; provided me with a great list of potential
refactoring candidates. I decided I&amp;#8217;d start with the threading refactoring, mostly because I&amp;#8217;ve missed something like that
for Light Table on a daily basis.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Goal&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;; Turn something like this;
(map #(+ % 1) (filter even? [1 2 3 4 5]))

;into
(-&amp;gt;&amp;gt; [1 2 3 4 5]
     (filter even?)
     (map #(+ % 1)))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;I&amp;#8217;d like the refactorings to work for both Clojure and ClojureScript&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;I think it would be the best option if I could implement it in the lt plugin client code (using clojurescript)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Use third party lib if that saves me time and provides a great platform for future refactorings&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_analysis_paralysis&quot;&gt;Analysis paralysis&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;quoteblock&quot;&gt;
&lt;blockquote&gt;
..the state of over-analyzing (or over-thinking) a situation so that a decision or action is never taken, in effect paralyzing the outcome..
&lt;/blockquote&gt;
&lt;div class=&quot;attribution&quot;&gt;
&amp;#8212; WIKIPEDIA
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Before I could get started on the implementation I had to do a bit of research. I tried to find
a clojurescript compatible lib that would make it easy to read/&quot;parse&quot; clojure and clojurescript code
and make it easy to navigate and manipulate it. I looked at parser libs like &lt;a href=&quot;https://github.com/lbradstreet/instaparse-cljs&quot;&gt;Instaparse-cljs&lt;/a&gt; and &lt;a href=&quot;https://github.com/cgrand/parsley&quot; class=&quot;bare&quot;&gt;https://github.com/cgrand/parsley&lt;/a&gt; [parsley]
but both seemed like a little bit to much effort to get me started. &lt;a href=&quot;https://github.com/xsc/rewrite-clj&quot;&gt;rewrite-clj&lt;/a&gt; seemed
very promising, but unfortunately no ClojureScript port (feel free to vote for or contribute to this &lt;a href=&quot;https://github.com/xsc/rewrite-clj/issues/4&quot;&gt;issue&lt;/a&gt;)&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;div class=&quot;title&quot;&gt;What to do ?&lt;/div&gt;
&lt;p&gt;After much deliberation it dawned on my that maybe I should have a go at it without using any libs.
ClojureScript ships with &lt;em&gt;cljs.reader&lt;/em&gt;. That should get me started right ? Next step is to get the code
into something easily navigable and modifiable (immutably of course). Another look at xlj-rewrite provided the necessary neuron kickstart: zipper of course.
Good job there is a &lt;a href=&quot;https://github.com/clojure/clojurescript/blob/master/src/cljs/clojure/zip.cljs&quot;&gt;ClojreScript version&lt;/a&gt; already at hand !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
There are many resources out there on zippers in clojure. &lt;a href=&quot;http://www.ibm.com/developerworks/library/j-treevisit/&quot;&gt;This article&lt;/a&gt; is pretty thorough
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_thread_last_step_by_step_overview&quot;&gt;Thread last step by step overview&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To really get to grips with what I had to achieve I sat down and sketched up something like the illustration
below. Quite helpful when your in-brain tree visualizer has gotten somewhat rusty.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2015//thread_first.png&quot; alt=&quot;thread first&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;olist arabic&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Steps&lt;/div&gt;
&lt;ol class=&quot;arabic&quot;&gt;
&lt;li&gt;
&lt;p&gt;First we wrap our form in a thread-last if we haven&amp;#8217;t done so already&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;We take the last argument of the list node right of the threading operator and promote that node
to become the first argument to the threading (&quot;function/&quot;macro)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Same as above, now the node we promote is a vector&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;When the first node next to the threading operator node isn&amp;#8217;t a list (or a list of just one arg), we are done.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Thread first isn&amp;#8217;t much different, so I&amp;#8217;ll leave that excersize up to you !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Some of you might raise your finger at the way I skipped breaking down the &lt;strong&gt;#(+ % 1)&lt;/strong&gt; node.
We&amp;#8217;ll get back to that later, but I&amp;#8217;ll give you a hint :&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;Could not find tag parser for (+ in (&quot;inst&quot; &quot;uuid&quot; &quot;queue&quot; &quot;js&quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_code_essential&quot;&gt;Code essential&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_reading_code_from_a_string&quot;&gt;Reading code from a string&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn str-&amp;gt;seq-zip [form-str]
  (when (seq form-str)
    (-&amp;gt; form-str
        rdr/read-string        &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
        z/seq-zip)))           &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Using cljs.reader to read(/parse) code.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Create a sequence zipper from the parsed form&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Please note that cljs.reader only a subset (edn) of clojure. That means that several reader macros like #(), &apos;() etc will croak
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_thread_one_promote_one_pass&quot;&gt;Thread one / promote one pass&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn do-thread-one [cand cand-fn]
  (if-not (further-threadable? cand)                         &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
    cand
    (let [promote (-&amp;gt; cand cand-fn z/node)                   &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
          therest (-&amp;gt; cand cand-fn z/remove)]                &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
      (-&amp;gt; therest
          z/up
          (z/insert-left promote)                            &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
          (#(z/replace % (unwrap-list-if-one (z/node %))))   &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
          z/up))))                                           &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;First we need to check if the form is further threadable, if it isn&amp;#8217;t then just return the zipper (cand) with it&amp;#8217;s current position&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Get the node that should be promoted using &lt;strong&gt;cand-fn&lt;/strong&gt;. cand-fn basically handles navigating the zipper to find the last argument to the function call (thread-last) or the first argument (thread-first)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Gently rip out the node to be promoted, so you are left with the rest sans this node&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Insert the node to be promoted as the first sibling to the threading operator node&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If the node at the position of the rest node is a list with just one item, it should be the function and we can leave out the parens&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Move the zipper &quot;cursor&quot; up to the first arg of the thread operator function (for potentially further threading)&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_thread_fully&quot;&gt;Thread fully&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn- do-thread [orig cand-fn t]
  (when (seq orig)
    (let [root (if (threaded? orig) orig (wrap-in-thread orig t))]  &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
      (loop [cand root]
        (if-not (further-threadable? cand)                          &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
          cand
          (recur (do-thread-one cand cand-fn)))))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If not already wrapped in a form with a threading operator, do so (just for convenience)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Keep promoting until isn&amp;#8217;t possible to promote further&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_zip_it_up&quot;&gt;Zip it up&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn zip-&amp;gt;str [zipnode]
  (-&amp;gt; zipnode
      z/root
      pr-str))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_orchestration&quot;&gt;Orchestration&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn thread [form-str]
  (let [node (str-&amp;gt;seq-zip form-str)
        threading (when node (threaded? node))]
    (when (and node threading)
      (-&amp;gt; node
          (do-thread (threading-locator threading) threading)
          zip-&amp;gt;str))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Entry point function to read form string, do threading and return result as string again&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_hooking_it_into_light_table&quot;&gt;Hooking it into Light Table&lt;/h3&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_replace_helper_function&quot;&gt;Replace helper function&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;defn replace-cmd [ed replace-fn]
  (cmd/exec! :paredit.select.parent)                                       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (when-let [candidate  (editor/selection ed)]
    (let [bounds (editor/selection-bounds ed)]
      (when-let [res (replace-fn candidate)]                               &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
        (editor/replace-selection ed res))                                 &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
      (editor/move-cursor ed (-&amp;gt; bounds :from (update-in [:ch] inc))))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Using paredit command to select parent expression&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Execute threading function on selected expression&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Replace selection with given the refactored result&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_behavior_and_commands&quot;&gt;Behavior and commands&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::thread-fully!                                           &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
          :triggers #{:refactor.thread-fully!}
          :reaction (fn [ed]
                      (replace-cmd ed thread)))

(cmd/command {:command ::thread-fully                               &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
              :desc &quot;Clojure refactor: Thread fully&quot;
              :exec (fn []
                      (when-let [ed (pool/last-active)]
                        (object/raise ed :refactor.thread-fully!)))})&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We create behaviors for each refactor feature so that we can target the feature to a given set of editor tags&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Commands are what the user sees in the LIght Table command pane, and which can be assigned to keyboard shortcuts&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_configuring_behaviors&quot;&gt;Configuring behaviors&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;  [:editor.clj :lt.plugins.cljrefactor.threading/thread-fully!]
  [:editor.cljs :lt.plugins.cljrefactor.threading/thread-fully!]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We enable the behaviors for both Clojure and ClojureScript tagged editor objects.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_problems&quot;&gt;Problems ?&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Well the limitations of cljs.reader is a problem. The anonymous function literal is something
I use all the time. I did quickly look at &lt;em&gt;cljs.reader/register-tag-parser!&lt;/em&gt; but couldn&amp;#8217;t really come up
with a workable strategy here. So if anyone have suggestions for a more complete parsing of clojure code in ClojureScript
please give me a ping ! I ended up escaping it as a string for now. Not exactly great if you&amp;#8217;d like to apply the refactoring
inside an anonymous function literal block.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock warning&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-warning&quot; title=&quot;Warning&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Actually I also had some issues using clojure.zip from Light Table, but a restart seemed to solve it
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_summary&quot;&gt;Summary&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Once I managed to make a decision on which route to pursue, the rest was mainly just a blast.
it´s really awesome how much of Clojure it&amp;#8217;s possible to use in ClojureScript and digging into
zippers was a real eyeopener for me. I believe I now have a foundation to provide a range
of useful client side refactoring features and I&amp;#8217;ve already started pondering on what to address next.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Some thorny issues remain, and some icing like customizable formatting etc still remains.
The complete list of threading refactorings are listed &lt;a href=&quot;https://github.com/rundis/clj-light-refactor#threading&quot;&gt;here&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The main takeaway for me is that I keep learning more and more about Clojure, and as a bonus I get
new nifty features for my current editor of choice !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Clojure refactoring in Light Table</title>
      <link>http://rundis.github.io/blog/2015/clj_light_refactor.html</link>
      <pubDate>Sun, 8 Mar 2015 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2015/clj_light_refactor.html</guid>
      	<description>
	&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_background&quot;&gt;Background&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A colleague of mine, the emacs wizard &lt;a href=&quot;https://github.com/magnars&quot;&gt;Magnar&lt;/a&gt; has on multiple occations demonstrated
some of the cool refactoring features for Clojure he has at his disposal in emacs.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;m currently a &lt;a href=&quot;https://github.com/LightTable/LightTable&quot;&gt;Light Table&lt;/a&gt; user and plugin author. Surely it should
be possible to add some refactoring support to Light Table ? I started looking at &lt;a href=&quot;https://github.com/clojure-emacs/clj-refactor.el&quot;&gt;clj-refactor.el&lt;/a&gt; and
I couldn&amp;#8217;t initially figure out where to start. But I found that some of the cool features were actually enabled
by an nrepl middleware &lt;a href=&quot;https://github.com/clojure-emacs/refactor-nrepl&quot;&gt;refactor-nrepl&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;quoteblock&quot;&gt;
&lt;blockquote&gt;
nREPL middleware to support refactorings in an editor agnostic way.
&lt;/blockquote&gt;
&lt;div class=&quot;attribution&quot;&gt;
&amp;#8212; refactor-nrepl
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Yay, now that&amp;#8217;s what I call a great initiative. I decided to give it a go, and here&amp;#8217;s a taste of what I managed to come up with so far.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_demo&quot;&gt;Demo&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;a href=&quot;http://youtu.be/xlGpRTVIkYQ&quot;&gt;ScreenCast demo&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;iframe width=&quot;420&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/xlGpRTVIkYQ&quot; frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_the_plugin&quot;&gt;The plugin&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
You can find the plugin repo on github &lt;a href=&quot;https://github.com/rundis/clj-light-refactor&quot; class=&quot;bare&quot;&gt;https://github.com/rundis/clj-light-refactor&lt;/a&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_a_taste_of_implementation&quot;&gt;A taste of implementation&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I won&amp;#8217;t go into to much details in this blogpost, but I thought I&amp;#8217;d give you a little teaser
on how I&amp;#8217;ve gone about interacting with the middleware. Light Table supports calling arbitrary clojure code through it&amp;#8217;s custom nrepl middleware.
So getting started wasn&amp;#8217;t really that difficult.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_middleware_invocation&quot;&gt;Middleware invocation&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn artifact-list-op []
  (str &quot;(do (require &apos;refactor-nrepl.client) (require &apos;clojure.tools.nrepl)&quot;
       &quot;(def tr (refactor-nrepl.client/connect))&quot;
       &quot;(clojure.tools.nrepl/message (clojure.tools.nrepl/client tr 10000) {:op \&quot;artifact-list\&quot;}))&quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The above code is an example of the code necessary to connect to and invoke an operation on then refactor-nrepl
middleware for listing clojare artifacts.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_behaviour_in_light_table&quot;&gt;Behaviour in Light Table&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::trigger-artifact-hints
          :triggers #{:artifact.hints.update!}
          :debounce 500
          :reaction (fn [editor res]
                      (when-let [default-client (-&amp;gt; @editor :client :default)]                  &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
                          (notifos/set-msg! (str &quot;Retrieving clojars artifacts&quot;))
                          (object/raise editor                                                  &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
                                        :eval.custom                                            &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
                                        (artifact-list)
                                        {:result-type :refactor.artifacts :verbatim true}))))   &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;For this particular operation (autocompletion of deps) we require that the user has already got a connection to a lein project&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We raise an event on the editor instance (in this case it&amp;#8217;s an editor with a project.clj file)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;:eval.custom is a behavior for evaluate arbitrary clojure code&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We set the result type to something custom so that we can define a corresponding custom behavior
to handle the results&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::finish-artifact-hints
          :triggers #{:editor.eval.clj.result.refactor.artifacts}                                 &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
          :reaction (fn [editor res]
                      (let [artifacts (-&amp;gt; res :results first :result first :value (s/split #&quot; &quot;))
                            hints (create-artifact-hints editor artifacts)]                       &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
                        (object/merge! editor {::dep-hints hints})                                &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
                        (object/raise auto-complete/hinter :refresh!))))                          &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The important part here is that the &lt;em&gt;editor.eval.clj.result&lt;/em&gt; is assumed by the Light Table client
whilst &lt;em&gt;refactor.artifacts&lt;/em&gt; is appended, given the corresponding param we supplied above. So by naming
our trigger like this, our behaviour will be triggered&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We pick out the results from the refactor-nrepl operation and transform it into a datastructure that&amp;#8217;s suitable
for whatever we need to do (in this case providing autocompletion hints)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We store the list of artifacts in the editor (atom) so that our autocomplete hinter doesn&amp;#8217;t go bananas invoking
the middleware like crazy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Finally we tell the autocomplete hinter to refresh itself to include the list of artifacts&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
The autocomplete part is skimpily explained here, but the important bit I&amp;#8217;m trying to get across is how to
invoke the middleware and how to pick up the results. Autocompletion in Light Table deserves a blog post of it&amp;#8217;s own at some point in the future
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_middleware_preconditions&quot;&gt;Middleware preconditions&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;For any of the features in the plugin to work we have to set up the middleware.
So you need to add something like this to your ~/.lein/profiles.clj&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;:plugins [[refactor-nrepl &quot;X.Y.Z&quot;]       &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
          [cider/cider-nrepl &quot;A.B.C&quot;]]   &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This is the core dependency that does all the heavy lifting for the features currently implemented&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The Cider nrepl middleware is used by refactor-nrepl. However the cider middleware on it&amp;#8217;s own provides several cool
features that might come handy to the clj-light-refactor plugin in the near future :)&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock warning&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-warning&quot; title=&quot;Warning&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
The version indentifiers are intentionally left out, because it&amp;#8217;s currently a little in flux.
This plugin won&amp;#8217;t be released until the refactor-nrepl comes with it&amp;#8217;s next official release.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_the_road_ahead&quot;&gt;The road ahead&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This is just the beginning, but it feels like I&amp;#8217;m on to something. The clj-refactor.el project provides
an huge list of potential features to implement, the refactor-nrepl middleware will surely continue to evolve
and last but not least the cider middleware has plenty of useful stuff to harvest from.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;ll keep plugin(g) along and hopefully others might get inspired to contribute as well. At some point in the future maybe parts
of this plugin will be ported to the official Light Table Clojure plugin. Who knows !?&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Securing Clojure Microservices using buddy - Part 3: Token revocation</title>
      <link>http://rundis.github.io/blog/2015/buddy_auth_part3.html</link>
      <pubDate>Thu, 19 Feb 2015 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2015/buddy_auth_part3.html</guid>
      	<description>
	&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Part 3 in my blog series about securing clojure web services using &lt;a href=&quot;https://github.com/funcool/buddy&quot;&gt;buddy&lt;/a&gt;.
In this episode we&amp;#8217;ll be looking at how we might handle revocation of previously issued auth tokens.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Previous episodes in this series:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;http://rundis.github.io/blog/2015/buddy_auth_part1.html&quot;&gt;Securing Clojure Microservices using buddy - Part 1: Creating Auth Tokens&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;http://rundis.github.io/blog/2015/buddy_auth_part2.html&quot;&gt;Securing Clojure Microservices using buddy - Part 2: WebApp authentication and authorization&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Sample code (tagged for each blog post) can be found on &lt;a href=&quot;https://github.com/rundis/acme-buddy&quot;&gt;github&lt;/a&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In part 2 I said that my next post would be about authorization using tokens in a service application.
Well my conscience got the better of me and I decided I had to address the slightly thorny issue of how to handle
token revocation first. In part 2 I left you in a state where you&amp;#8217;d have a really hard time locking a user out or changing
access rights. You would have to trust that the user re-authenticated (or change the key-pair for token signing/unsigning).&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_opposing_forces&quot;&gt;Opposing forces&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Some of the things we are trying to achieve with our auth design are:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Avoiding session state for authentication and authorization. Hence the introduction of self contained auth tokens&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The auth service shouldn&amp;#8217;t become a huge dependency magnet, ideally only client facing apps should have to call the auth-service, whilst the service apps would only use the auth-token for authenticating and authorizing requests&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The user shouldn&amp;#8217;t be prompted for his/her credentials more than necessary&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;The reality though is that:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;We have to be able to lock down a user (malicious or whatever reason)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;We should be able to change a users rights without forcing a re-authentication&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Checking whether a token has been revoked would be impossible without storing state about that fact somewhere&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Continuously checking with the auth-service whether a token has been revoked and/or rights have changed with the auth service would negate
the use of tokens in the first place&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_refresh_tokens&quot;&gt;Refresh tokens&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I briefly started reading up on &lt;a href=&quot;http://tools.ietf.org/html/draft-ietf-oauth-v2-22#section-6&quot;&gt;Oath2 Refresh tokens&lt;/a&gt;. It have to admin I didn&amp;#8217;t quite get it until I read a farily explanatory post on &lt;a href=&quot;http://stackoverflow.com/questions/3487991/why-does-oauth-v2-have-both-access-and-refresh-tokens&quot;&gt;stackoverflow&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The gist of it that we issue two tokens upon authentication. An authentication token (or access token if you like) and a refresh token.
This allows us to set a shorter expiry for the auth token, and we can use the refresh-token to request a new auth token when a previous one has expired.
The sole purpose of refresh tokens is to be able to request new auth tokens.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_solution_outline&quot;&gt;Solution outline&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The diagram below (UML with liberties) illustrates how refresh-tokens might work for us.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2015//refresh-token.png&quot; alt=&quot;refresh token&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;olist arabic&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Steps&lt;/div&gt;
&lt;ol class=&quot;arabic&quot;&gt;
&lt;li&gt;
&lt;p&gt;User logs in with username/password&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The web app invokes the create-auth-token service in acme-auth. This in turn&lt;/p&gt;
&lt;div class=&quot;olist loweralpha&quot;&gt;
&lt;ol class=&quot;loweralpha&quot; type=&quot;a&quot;&gt;
&lt;li&gt;
&lt;p&gt;authenticates the user&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;creates an auth-token&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;creates a refresh token&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The refresh token is stored in a refresh_tokens table&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Both the auth-token and refresh-token is returned to the web-app&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The web app stores the tokens in a cookie which is returned to the browser&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;User makes a request (with a valid auth token)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The web app might make a call to a resource server/service app (providing the auth-token as a auth-header in the request)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;At some point later after the auth-token has expired (say 30 minutes) the user makes another request&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The web app finds that the auth-token has expired and request a new auth-token using the refresh-token (from the cookie)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;We retrieve the stored refresh-token to check if it still valid (ie not revoked)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;We invalidate the existing refresh token in the db (will explain this bit when we look at the implementation)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;We create a new auth token and a new refresh token. The new refresh token is stored in db&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;A new token-pair is returned to the web-app&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The web app can now make a request to a resource server/service with a valid auth-token&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Finally the cookie is updated with the new token-pair&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_where_is_the_code_man&quot;&gt;Where is the code man ?&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Well that was a long intro, so if you are still following along it&amp;#8217;s time to have a look at what changes and additions
are needed from part 1 and 2.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_changing_token_creation_in_acme_auth&quot;&gt;Changing token creation in acme-auth&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-cloure&quot; data-lang=&quot;cloure&quot;&gt;(defn- unsign-token [auth-conf token]
  (jws/unsign token (pub-key auth-conf)))

(defn- make-auth-token [auth-conf user]                                        &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (let [exp (-&amp;gt; (t/plus (t/now) (t/minutes 30)) (jws/to-timestamp))]
    (jws/sign {:user (dissoc user :password)}
              (priv-key auth-conf)
              {:alg :rs256 :exp exp})))

(defn- make-refresh-token! [conn auth-conf user]                               &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  (let [iat (jws/to-timestamp (t/now))
        token (jws/sign {:user-id (:id user)}
                        (priv-key auth-conf)
                        {:alg :rs256 :iat iat :exp (-&amp;gt; (t/plus (t/now) (t/days 30)) (jws/to-timestamp))})]

    (store/add-refresh-token! conn {:user_id (:id user)                        &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
                                    :issued iat
                                    :token token})
    token))

(defn make-token-pair! [conn auth-conf user]                                   &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
  {:token-pair {:auth-token (make-auth-token auth-conf user)
                :refresh-token (make-refresh-token! conn auth-conf user)}})


(defn create-auth-token [ds auth-conf credentials]                             &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
  (jdbc/with-db-transaction [conn ds]
    (let [[ok? res] (auth-user conn credentials)]
      (if ok?
        [true (make-token-pair! conn auth-conf (:user res))]
        [false res]))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The auth token store user and role info as in part 1, but we now have the option of shortening the expiry&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;For simplicity we have created the refresh token using the same key-pair as for the auth token. The refresh token
contains only user-id and issued at time (iat). This allows us retrieval of the db stored token info later on. The expiry for this token can be as long as you are comfortable with (30 days in this instance)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We store the token in the refresh_token table with some fields extracted for ease of querying&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We now return a map with both the auth-token and our shiny new refresh-token&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The entry point service for token creation&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_refreshing_tokens&quot;&gt;Refreshing tokens&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn refresh-auth-token [ds auth-conf refresh-token]
  (if-let [unsigned (unsign-token auth-conf refresh-token)]                                               &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
    (jdbc/with-db-transaction [conn ds]
      (let [db-token-rec (store/find-token-by-unq-key conn (:user-id unsigned) (:iat unsigned))           &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
            user (store/find-user-by-id conn (:user_id db-token-rec))]
        (if (:valid db-token-rec)                                                                         &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
          (do
            (store/invalidate-token! conn (:id db-token-rec))                                             &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
            [true (make-token-pair! conn auth-conf user)])                                                &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
          [false {:message &quot;Refresh token revoked/deleted or new refresh token already created&quot;}])))
    [false {:message &quot;Invalid or expired refresh token provided&quot;}]))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We unsign the refresh-token to ensure it is valid (not tampered with or expired)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We use information from the refresh token to retrieve it&amp;#8217;s db stored representation.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This test could return false for 3 cases; token deleted, token has been revoked or the token has been invalidated because a new refresh token has been created&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The existing refresh token is invalidated in the database&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We create a new token pair (where the newly created refresh token is stored in a new db row in the refrest_token table)&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Why creating a new refresh token every time ?&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Imagine that someone gets hold of a users refresh token. Lets say the user requests a token refresh first, now if the hijacker
is making a refresh-request with the hijacked request token we detect that a refresh is attempted on a token that is already invalid.
We can&amp;#8217;t tell if the user or the hijacker is first, but either way we could take action (trigger warning/lock user account etc)
In the code above we can&amp;#8217;t tell the diffence between why a refresh token is invalid, so you might wish to have a separate flag for this particular check.&lt;/p&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_middleware_changes_in_the_acme_webstore&quot;&gt;Middleware changes in the acme-webstore&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn wrap-auth-cookie [handler cookie-secret]                                    &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (-&amp;gt; handler
      (wrap-session
       {:store (cookie-store {:key cookie-secret})
        :cookie-name &quot;acme&quot;
        :cookie-attrs {:max-age (* 60 60 24 30)}}))) ;; you should probably add :secure true to enforce https


(defn unsign-token [token]
  (jws/unsign token (ks/public-key (io/resource &quot;auth_pubkey.pem&quot;))))


(defn wrap-auth-token [handler]                                                  &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  (fn [req]
    (let [auth-token (-&amp;gt; req :session :token-pair :auth-token)
          unsigned-auth (when auth-token (unsign-token auth-token))]
      (if unsigned-auth
        (handler (assoc req :auth-user (:user unsigned-auth)))
        (handler req)))))

(defn- handle-token-refresh [handler req refresh-token]
  (let [[ok? res] (refresh-auth-token refresh-token)                             &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
        user (:user (when ok? (unsign-token (-&amp;gt; res :token-pair :auth-token))))]
    (if user
      (-&amp;gt; (handler (assoc req :auth-user user))                                  &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
          (assoc :session {:token-pair (:token-pair res)}))
      {:status 302
       :headers {&quot;Location &quot; (str &quot;/login?m=&quot; (:uri req))}})))                   &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;

(defn wrap-authentication [handler]
  (fn [req]
    (if (:auth-user req)
      (handler req)
      (if-let [refresh-token (-&amp;gt; req :session :token-pair :refresh-token)]
        (handle-token-refresh handler req refresh-token)                         &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
          {:status 302
           :headers {&quot;Location &quot; (str &quot;/login?m=&quot; (:uri req))}}))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The only change we made to the cookie middleware is increase the ttl.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The wrap-auth-token middleware just needed to change to handle that auth-token is found as part of a token pair
(not shown: the login handler adds the token pair to the session upon successful authentication)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If the auth token has expired and refresh token exists we initiate an attempt to refresh the token pair&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Invokes the acme-auth service for requesting token refresh&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If a refreshing the token pair was successful we invoke the next handler in the chain and assoc the new token pair with the session key in the response
(which in turn ends up in the cookie)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;We give up, you have to log in again&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock warning&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-warning&quot; title=&quot;Warning&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
It might not be a great ideat to store the auth token and the refresh token in the same cookie. Haven&amp;#8217;t really
thought that bit through tbh.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_summary&quot;&gt;Summary&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A lot of thinking and not a lot of code this time. But I feel we have come up with a solution that might provide a suitable
balance between risk and statelessless with regards to revoking tokens/user access. Refresh tokens
allows us to stay clear of sessions and avoid asking the usere for their credentials.  &lt;a href=&quot;https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet&quot;&gt;CSRF&lt;/a&gt;
is obviously still an issue, but we have taken some small steps to detect when the users cookie might have been hijacked.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The next episode will definately be about authentication and authorization in a service app.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Scratching my AsciiDoc itch</title>
      <link>http://rundis.github.io/blog/2015/asciilight.html</link>
      <pubDate>Sun, 15 Feb 2015 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2015/asciilight.html</guid>
      	<description>
	&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_background&quot;&gt;Background&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So I have been writing my previous blog posts in &lt;a href=&quot;http://asciidoctor.org/&quot;&gt;AsciiDoc&lt;/a&gt; using &lt;a href=&quot;https://github.com/LightTable/LightTable&quot;&gt;Light Table&lt;/a&gt;.
AsciiDoc is really great and I haven&amp;#8217;t regretted using it for my blog at any point in time. To create my blog site
I&amp;#8217;m using &lt;a href=&quot;http://jbake.org/&quot;&gt;Jbake&lt;/a&gt; and its all published to github (gh-pages). To preview my blog posts while writing I either
had to start a separate browser window (with a AsciiDoc browser plugin) or I had to set up a gradle watch task and
use something like SimpleHttpServer to serve my &quot;baked&quot; site locally.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;m probably still going to test my site locally, but I really felt a need for something similar to the &lt;a href=&quot;https://github.com/MarcoPolo/lt-markdown&quot; class=&quot;bare&quot;&gt;https://github.com/MarcoPolo/lt-markdown&lt;/a&gt;
plugin.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;quoteblock&quot;&gt;
&lt;blockquote&gt;
I wish I had an editor where I could easily program my own extensions.
&lt;/blockquote&gt;
&lt;div class=&quot;attribution&quot;&gt;
&amp;#8212; Magnus Rundberget&lt;br&gt;
&lt;cite&gt;A few years back&lt;/cite&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I guess I&amp;#8217;m just lucky, but whacking something together wasn&amp;#8217;t really that hard. I thought I&amp;#8217;d share my experience.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_technology&quot;&gt;Technology&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;AsciiDoctor comes with JavaScript support through &lt;a href=&quot;https://github.com/asciidoctor/asciidoctor.js&quot;&gt;asciidoctor.js&lt;/a&gt;. It even comes
with support for node. Light Table runs on Node (node webkit, soon Atom Shell ?). Light Table plugins are written in
ClojureScript, I much prefer ClojureScript to JavaScript or CoffeeScript for that matter. Anyways I&amp;#8217;m digressing, calling
node modules from a Light Table is no big deal.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_solution&quot;&gt;Solution&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The end result became a new plugin for Light Table. &lt;a href=&quot;https://github.com/rundis/AsciiLight&quot;&gt;AsciiLight&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2015//asciilight_preview.png&quot; alt=&quot;asciilight preview&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
I pretty much nicked most of the ClojureScript code from &lt;a href=&quot;https://github.com/MarcoPolo/lt-markdown&quot; class=&quot;bare&quot;&gt;https://github.com/MarcoPolo/lt-markdown&lt;/a&gt;. Cheers Marco Polo !
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_calling_asciidoctor_js&quot;&gt;Calling asciidoctor.js&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;For reasons unknown to me I had some troubles calling the Objects/functions needed from asciidoctor.js
directly from ClojureScript so I had to make a thing JavaScript wrapper my self. No big deal, but
I&amp;#8217;d be interested to find out why it croaked.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;var asciidoctor = require(&apos;asciidoctor.js&apos;)();
var processor = asciidoctor.Asciidoctor(true);     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
var opal = asciidoctor.Opal;


var doConvert = function(content, baseDir) {
  var opts = opal.hash2(
      [&apos;base-dir&apos;, &apos;safe&apos;, &apos;attributes&apos;],
      {&apos;base-dir&apos;: baseDir,
       &apos;safe&apos;: &apos;secure&apos;,
        attributes: [&apos;icons=font@&apos;, &apos;showtitle&apos;]});

    return  processor.$convert(content, opts);     &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
};

module.exports = {
  convert: function(content, baseDir) {
    return doConvert(content, baseDir);
  }
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Load Node module and configure AsciiDoctor to support extensions&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The function where we actually call asciidoctor&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;There was a lot of trial and error to figure out what to call the options and how to pass
these options to asciidoctor. Some seemed to work others seemed to have no effect. To be improved
in a future release for sure. The most painful part here was that I couldn&amp;#8217;t figure out how to reload
my custom node module &amp;#8230;&amp;#8203; hence a lot of Light Table restarts. Surely there must be a better way.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_plugin_code&quot;&gt;Plugin code&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;defn setAdocHTML! [ed obj]
  (let [html (-&amp;gt;
              (adoc-&amp;gt;html (.getValue (editor/-&amp;gt;cm-ed ed))
                          (files/parent (-&amp;gt; @ed :info :path)))                     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
              (s/replace #&quot;class=\&quot;content\&quot;&quot; &quot;class=\&quot;adoc-content\&quot;&quot;))]
    (set! (.-innerHTML (object/-&amp;gt;content obj)) html)))                             &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;

(defn get-filename [ed]
  (-&amp;gt; @ed :info :name))

(defui adoc-skeleton [this]
  [:div {:class &quot;adoc&quot;}
   [:h1 &quot;Asciidoc content coming here&quot;]])

(object/object* ::asciilight                                                       &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
                :tags [:asciilight]
                :name &quot;markdown&quot;
                :behaviors [::on-close-destroy]
                :init (fn [this filename]
                        (object/update! this [:name] (constantly (str filename &quot; - Live&quot;)))
                        (adoc-skeleton this)))

(behavior ::on-close-destroy                                                       &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
          :triggers #{:close}
          :reaction (fn [this]
                      (when-let [ts (:lt.objs.tabs/tabset @this)]
                        (when (= (count (:objs @ts)) 1)
                          (tabs/rem-tabset ts)))
                      (object/raise this :destroy)))

(behavior ::read-editor                                                            &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
          :triggers [:change ::read-editor]
          :desc &quot;AsciiLight: Read the content inside an editor&quot;
          :reaction (fn [this]
                      (let [adoc-obj (:adoc @this)]
                        (setAdocHTML! this adoc-obj))))

(cmd/command {:command ::watch-editor                                              &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
              :desc &quot;AsciiLight: Watch this editor for changes&quot;
              :exec (fn []
                      (let [ed (pool/last-active)
                            filename (get-filename ed)
                            adoc-obj (object/create ::asciilight filename)]
                        (tabs/add-or-focus! adoc-obj)
                        (object/update! ed [:adoc] (fn [] adoc-obj))
                        (object/add-behavior! ed ::read-editor)
                        (object/raise ed ::read-editor)))})&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Retrieve whatever is in the given editor ed and request ascidoctor.js to make nice html from it.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Insert the generated html into the preview viewer&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;An atom that holds the markup used for the preview. Destroyed when its owning tab is closed.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Behavior that is triggered when the tab (or LightTable) is closed. Performs cleanup as one should !&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Behavior that is triggered whenever the user changes the content of the editor being watched. For large documents
we might want to introduce a throttle on this behaviour.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;This i the command you see in the command bar in Light Table. It&amp;#8217;s the entry point for the plugin currently and
is responsible for adding a new tab and setting up the link between the editor to be watched and the preview tab.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;That&amp;#8217;s pretty manageable for something quite usable.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_behaviors_and_a_note_on_css&quot;&gt;Behaviors and a note on CSS&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;[[:app :lt.objs.plugins/load-js &quot;asciilight_compiled.js&quot;]
 [:app :lt.objs.plugins/load-css &quot;css/font-awesome.css&quot;]
 [:app :lt.objs.plugins/load-css &quot;css/adoc.css&quot;]]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Here we load the transpiled javascript for our plugin, css icon support throught font-awesome and
a slightly customized css for our asciidoc preview.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_css_the_cascading_part_you_know&quot;&gt;CSS, the cascading part you know.&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;AsciiDoc ships with a default CSS you may use (it even has a &lt;a href=&quot;https://github.com/asciidoctor/asciidoctor-stylesheet-factory&quot;&gt;stylesheet factory&lt;/a&gt;)
That&amp;#8217;s cool. Light Table also has styles, hey it even has lots of skins.
So I had to spend some time ensuring that the css I added through the plugin didn&amp;#8217;t mess up the
user selected styles from Light Table. For instance both LIght Table and AsciiDoc found good use for a css class called content.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Lost a few hairs (not many left tbh)&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_summary&quot;&gt;Summary&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;It&amp;#8217;s very early days for this plugin, and it has many snags. But its a decent start considering
I used maybe 6-8 hours in total, most of which was time struggling with css. It just feels
great writing this blogpost with a preview of what I&amp;#8217;m writing using a plugin of my own creation.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;One itch scratched !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Securing Clojure Microservices using buddy - Part 2: WebApp authentication and authorization</title>
      <link>http://rundis.github.io/blog/2015/buddy_auth_part2.html</link>
      <pubDate>Mon, 2 Feb 2015 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2015/buddy_auth_part2.html</guid>
      	<description>
	&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In &lt;a href=&quot;/blog/2015/buddy_auth_part1.html&quot;&gt;Part 1&lt;/a&gt; of this blog series we learned how to create tokens that could be used for authentication
and authorization. In this episode we will create a sample web app called &lt;a href=&quot;https://github.com/rundis/acme-buddy/tree/master/acme-webstore&quot;&gt;acme-webstore&lt;/a&gt;.
The acme-webstore will make use of the tokens generated from the &lt;a href=&quot;https://github.com/rundis/acme-buddy/tree/master/acme-auth&quot;&gt;acme-auth&lt;/a&gt; service.
The app will implement a simple login and logout flow and demonstrate how you may employ role based authorization.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_disclaimer&quot;&gt;Disclaimer&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;admonitionblock warning&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-warning&quot; title=&quot;Warning&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;There are many concerns to be addressed with regards to securing a web app. Be sure to do proper research
for what your needs and potential risks are. A good starting point might be to check out &lt;a href=&quot;https://www.owasp.org/index.php/Category:OWASP_Top_Ten_Project#tab=OWASP_Top_10_for_2013&quot;&gt;OWASP&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_buddy_support&quot;&gt;Buddy support&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Buddy provides support for authentication and authorization of web applications through &lt;a href=&quot;https://github.com/funcool/buddy-auth&quot;&gt;buddy-auth&lt;/a&gt;.
I believe that version 0.3.0 of this lib doesn&amp;#8217;t provide support for key-pair signed jws tokens out of the box.
Buddy auth does provide a flexible mechanism for creating your own backends and it also provides what looks to be
a fairly flexible scheme for authorization.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;For this episode I chose not to go down that route though. Actually the app won&amp;#8217;t be using buddy-auth at all. We are going to
plunge into the abyss and see how far we get on our own. The end result might be that me or someone else
makes a contribution to buddy-auth to save us from some of the steps here !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_login&quot;&gt;Login&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The first thing to implement is a login flow to authenticate our users against the acme-auth service.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2015//acme_login.png&quot; alt=&quot;acme login&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 1. Sample login screen&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_calling_acme_auth&quot;&gt;Calling acme-auth&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To perform the REST calls to acme-auth our app will use the excellent &lt;a href=&quot;https://github.com/dakrone/clj-http&quot;&gt;clj-http&lt;/a&gt; library&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn create-token [req]                                                           &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (http/post &quot;http://localhost:6001/create-auth-token&quot;
             {:content-type :json
              :accept :json
              :throw-exceptions false
              :as :json
              :form-params (select-keys (:params req) [:username :password])}))

(defn do-login [req]
  (let [resp (create-token req)]
    (condp = (:status resp)
      201 (-&amp;gt; (response/redirect (if-let [m (get-in req [:query-params &quot;m&quot;])] m &quot;/dashboard&quot;))    &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
              (assoc :session {:token (-&amp;gt; resp :body :token)}))                                   &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
      401 (show-login req [&quot;Invalid username or password&quot;])                                       &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;
      {:status 500 :body &quot;Something went pearshape when trying to authenticate&quot;})))               &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Helper function that invokes acme-auth using clj-http&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The default behaviour is redirecting the user to a dashboard page after successful login, however if a query param &quot;m&quot;
is set it will redirect to the url provided in m. Redirection will be covered explicitly later on.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Upon successful authentication we add the token to the users session. Sessions will also be discussed explicitly later on.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If authentication failed, display the login screen again with an error message&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Lazy error handling&amp;#8230;&amp;#8203;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Logging out&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn logout [req]
  (assoc (response/redirect &quot;/&quot;) :session nil))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Logging out is just a matter of clearing the user session.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_rewind_middleware_overview&quot;&gt;Rewind: Middleware overview&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;div class=&quot;title&quot;&gt;web.clj&lt;/div&gt;
&lt;p&gt;Before plunging deeper into the details its useful to get a highlevel view of the various middlewares applied to the
routes in the sample application.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defroutes public-routes
  (route/resources &quot;/&quot;)
  (GET &quot;/&quot; []       show-index)
  (GET &quot;/login&quot; []  sec/show-login)
  (POST &quot;/login&quot; [] sec/do-login)
  (GET &quot;/logout&quot; [] sec/logout))


(defroutes secured-routes
  (GET &quot;/accounts/:id&quot; [] show-account)
  (GET &quot;/accounts&quot; []     (sec/wrap-restrict-by-roles show-accounts [:store-admin]))   &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (GET &quot;/dashboard&quot; []    show-dashboard))


(defroutes app-routes
  (-&amp;gt; public-routes
      sec/wrap-auth-token)                                                             &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  (-&amp;gt; secured-routes
      sec/wrap-authentication                                                          &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
      sec/wrap-auth-token))                                                            &lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;(4)&lt;/b&gt;

(def app (-&amp;gt; app-routes
             wrap-keyword-params
             wrap-params
             wrap-absolute-redirects                                                   &lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;(5)&lt;/b&gt;
             sec/wrap-authorized-redirects                                             &lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;(6)&lt;/b&gt;
             (sec/wrap-auth-cookie &quot;SoSecret12345678&quot;)))                               &lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;(7)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Custom middleware for restricting access based on role(s)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Custom middleware for picking out user info from a users token (if logged in)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Custom middleware to verify that user is authenticated for given route(s)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;4&quot;&gt;&lt;/i&gt;&lt;b&gt;4&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Duplication, cop out to ensure we have user info both for secured and unsecured routes&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;5&quot;&gt;&lt;/i&gt;&lt;b&gt;5&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Redirects should really should use absolute urls (most browsers support relative though)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;6&quot;&gt;&lt;/i&gt;&lt;b&gt;6&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Custom middleware to prevent redirect attacks&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;7&quot;&gt;&lt;/i&gt;&lt;b&gt;7&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Custom middleware wrapping a ring session using a cookie store. Obviously you wouldn&amp;#8217;t define the cookie secret here !&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_sessions_and_cookies&quot;&gt;Sessions and cookies&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;For a single-page web app or a REST client I would probably have been completely feasible using our auth token directly.
However if we have a web app with a nice mix of server side generated html and chunks of client side scripting with ajax,
we need to consider whether/how to use sessions.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Out of the box ring comes with session support in two flavours. Sessions based on a memory store or a cookie based store.
In both cases a cookie will be used, but for the in memory store the cookie is only used to uniquely identify the server side cached
data for that user session. When using the cookie store, the users session data is stored in the cookie (encrypted and &lt;a href=&quot;http://en.wikipedia.org/wiki/Message_authentication_code&quot;&gt;MAC&amp;#8217;ed&lt;/a&gt;) which is passed back and
forth between the server and the client.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The article &lt;a href=&quot;http://www.lispcast.com/clojure-web-security&quot;&gt;clojure web security&lt;/a&gt; by Eric Normand provides some very valuable insights into session
handling (amoung other things) in Clojure.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Regardless of the article just mentioned the Security Architect of Acme corp instructed me to pursue the cookie based session store.
To make matters worse, the Architect insisted on using a long-lived cookie. He went on about the benefits of avoiding
clustered sessions stores, that the usability of the web store would be hopeless with short lived sessions and that surely
there had to be measures to mitigate some of the additional risks involved.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Who am I to argue (I&amp;#8217;m no expert by any means) let us see where the cookie store option takes us.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock warning&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-warning&quot; title=&quot;Warning&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I suppose one of the biggest risk with the cookie approach is &quot;man in the middle attacks&quot;. First mitigating step is to use SSL (and not just partially).
Secondly there is the obvious risk of someone having taken control over the device you used for your logged in session. Maybe you should implement
&lt;a href=&quot;http://en.wikipedia.org/wiki/Two_factor_authentication&quot;&gt;two factor authentication&lt;/a&gt; and require reauthentication for any critical operations ?
Setting a long expiry for both the token and cookie might be far to risky for your scenario, maybe you need to implement something
akin to &lt;a href=&quot;http://stackoverflow.com/questions/3487991/why-does-oauth-v2-have-both-access-and-refresh-tokens&quot;&gt;oauth refresh tokens&lt;/a&gt;.
Also revocation of a token is definitely an interesting scenario we will need to handle in a later blog post !&lt;/p&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Enough analysis/paralysis for now, I guess the bottom line is you&amp;#8217;ll need to figure out what is secure enough for you.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_cookie_store&quot;&gt;Cookie store&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn wrap-auth-cookie [handler cookie-secret]
  (-&amp;gt; handler
      (wrap-session
       {:store (cookie-store {:key cookie-secret})  &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
        :cookie-name &quot;acme&quot;
        :cookie-attrs {:max-age (* 60 60 24)}})))   &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;The cookie content (session data ) is encrypted and a MAC signature added. For storing our token this may or may not be overkill. Our token is already MAC&amp;#8217;ed, however it&amp;#8217;s content is possible to extract quite easily as it is.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Only shown setting the max age here, but you definitely should set the :secure attribute to true (and put up something like nginx infront of your app to terminate ssl).&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
A big win with the cookie approach is that a server restart is no big deal. The user stays logged in. If you are using staged deploys, no session synchronization is needed.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_unsigning_the_token&quot;&gt;Unsigning the token&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn unsign-token [token]
  (jws/unsign token (ks/public-key (io/resource &quot;auth_pubkey.pem&quot;)) {:alg :rs256}))     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;


(defn wrap-auth-token [handler]
  (fn [req]
    (let [user (:user (when-let [token (-&amp;gt; req :session :token)]                        &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
                   (unsign-token token)))]
      (handler (assoc req :auth-user user)))))                                          &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Unsign the jws token using the public key from acme-auth&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;If the user has logged in, the token should be stored in session. Unsign if it exists.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Add the user info from the token to an explicit key in the request-map&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_ensuring_that_the_user_is_logged_in_for_a_given_route&quot;&gt;Ensuring that the user is logged in for a given route&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn wrap-authentication [handler]
  (fn [req]
    (if (:auth-user req)
      (handler req)
      {:status 302
       :headers {&quot;Location &quot; (str &quot;/login?m=&quot; (:uri req))}})))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;If the user hasn&amp;#8217;t logged in, we redirect to the login page. To allow the user to return to the url he/she originally tried
to access, we provide the url as a query param to the login handler.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_authorization&quot;&gt;Authorization&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We have implemented login, now lets see how we can implement a simple mechanism for authorizing what a user may or may not
do once authenticated. We&amp;#8217;ll cover role based authorization for now. Your app might require more fine-grained control and
various other mechanisms for authorization.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(def acme-store-roles                                                     &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  {:customer 10 :store-admin 11})

(defn any-granted? [req roles]                                            &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
  (seq
   (clojure.set/intersection
    (set (map :role-id (-&amp;gt; req :auth-user :user-roles)))
    (set (vals (select-keys acme-store-roles roles))))))


(defn wrap-restrict-by-roles [handler roles]                              &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
  (fn [req]
    (if (any-granted? req roles)
      (handler req)
      {:status 401 :body &quot;You are not authorized for this feature&quot;})))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;A hardcoded set of roles we care about in this app&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Function to verify if authed user has any of the roles given&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Middleware for declaratively restricting routes based on role privileges&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_showing_elements_based_on_role_privileges&quot;&gt;Showing elements based on role privileges&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn- render-menu [req]
  (let [user (:auth-user req)]
    [:nav.menu
     [:div {:class &quot;collapse navbar-collapse bs-navbar-collapse navbar-inverse&quot;}
      [:ul.nav.navbar-nav
       [:li [:a {:href (if user &quot;/dashboard&quot; &quot;/&quot;)} &quot;Home&quot;]]
       (when user
         [:li [:a {:href (str &quot;/accounts/&quot; (:id user))} &quot;My account&quot;]])
       (when &lt;strong&gt;(any-granted? req [:store-admin])&lt;/strong&gt;
         [:li [:a {:href &quot;/accounts&quot;} &quot;Account listing&quot;]])]
      [:ul.nav.navbar-nav.navbar-right
       (if user
         [:li [:a {:href &quot;/logout&quot;} &quot;Logout&quot;]]
         [:li [:a {:href &quot;/login&quot;} &quot;Login&quot;]])]]]))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2015//acme_admin_dash.png&quot; alt=&quot;acme admin dash&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 2. Sample Dashboard screen with the Account listing menu option for admins&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;As you can see, you can easily use the any-granted? function for providing granular restrictions on UI elements.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_preventing_redirect_attacks&quot;&gt;Preventing redirect attacks&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In the login handler we added a feature for redirecting the user to the url he/she tried to access before redirected to the login page.
We don&amp;#8217;t want to open up for redirect attacks so we added a simple middleware to help us prevent that from happening.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Lets say someone sends you a link like this &lt;a href=&quot;http://localhost:6002/login?m=http%3A%2F%2Fwww.robyouonline.bot&quot; class=&quot;bare&quot;&gt;http://localhost:6002/login?m=http%3A%2F%2Fwww.robyouonline.bot&lt;/a&gt; You probably don&amp;#8217;t want your users to end up there upon successfully login.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(def redirect-whitelist
  [#&quot;http://localhost:6002/.*&quot;])

(defn wrap-authorized-redirects [handler]
  (fn [req]
    (let [resp (handler req)
          loc (get-in resp [:headers &quot;Location&quot;])]
      (if (and loc (not (some #(re-matches % loc) redirect-whitelist)))
        (do
            ;; (log/warning &quot;Possible redirect attack: &quot; loc)
            (assoc-in resp [:headers &quot;Location&quot;] &quot;/&quot;))
        resp))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Obviously you&amp;#8217;d need to use the proper host and scheme etc once you put a proxy with a proper domain name in front etc.
You get the general idea though.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_summary&quot;&gt;Summary&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In part 1 we were creating a backend service for creating auth tokens. In this post you have seen how you could use that
token service to implement authentication and role based authorization in a public facing web app. Long lived tokens are
not without issues, and we have glossed over some big ones. Token revocation is a candidate for a near future blog post, but
before that I&amp;#8217;d like to cover usage of the token in a service application.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The next blog post will be about acme-orders and/or acme-catalog.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Securing Clojure Microservices using buddy - Part 1: Creating Auth Tokens</title>
      <link>http://rundis.github.io/blog/2015/buddy_auth_part1.html</link>
      <pubDate>Tue, 27 Jan 2015 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2015/buddy_auth_part1.html</guid>
      	<description>
	&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_disclaimer&quot;&gt;Disclaimer&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;admonitionblock warning&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-warning&quot; title=&quot;Warning&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;There is much more to securing web apps and microservices than just authentication and authorization.
This blog series will almost exclusively focus on those two aspects.&lt;/p&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Let&amp;#8217;s say you have decided to go down the microservices path with Clojure. How would
you go about implementing authentication and authorization for your various apps and services ?&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In this blog series I&amp;#8217;ll take you through my stumblings through how you might address
some of the concerns. At this point I have no idea how it might turn out, but I&amp;#8217;m pretty
sure I&amp;#8217;ll learn quite a bit along the way.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_sample_architecture&quot;&gt;Sample architecture&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To illustrate various aspects I&amp;#8217;ll be using the following sample high-level architecture
as a starting point. It&amp;#8217;s just a sketch,  so don&amp;#8217;t get too hung up on the dependency arrows, that might change.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2015//auth_fun.png&quot; alt=&quot;auth fun&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;You&amp;#8217;ll find the evolving code examples at &lt;a href=&quot;https://github.com/rundis/acme-buddy&quot; class=&quot;bare&quot;&gt;https://github.com/rundis/acme-buddy&lt;/a&gt;. A tag will be created
for each blog posting.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_initial_selection_of_technologies&quot;&gt;Initial selection of technologies&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The most known and used library in clojure for securing your ring webapps is &lt;a href=&quot;https://github.com/cemerick/friend&quot;&gt;friend&lt;/a&gt;.
To my knowledge it&amp;#8217;s a great library, and you should seriously consider using it for your apps as well.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A little while back I did a small spike on using friend and &lt;a href=&quot;http://clojure-liberator.github.io/liberator/&quot;&gt;liberator&lt;/a&gt;. Liberator
is a super library for rest enabling your applications/services. I came across the blog post &lt;a href=&quot;http://sritchie.github.io/2014/01/17/api-authentication-with-liberator-and-friend/&quot;&gt;API Authentication with Liberator and Friend&lt;/a&gt;.
I tried to implement something similar but couldn&amp;#8217;t quite get it working and I have to admit I had problems groking what
was actually going on.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So for this blog series I decided to start off with something less opinionated. Hopefully that will enable me to understand
more about the concerns involved. In &lt;a href=&quot;https://github.com/funcool/buddy&quot;&gt;buddy&lt;/a&gt; I found an a la carte menu of building blocks
that looked very promising as a starting point.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_token_based_authentication&quot;&gt;Token based authentication&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The goal for this first post is to create a service that allows a caller to authenticate a user by credentials
and receive an authentication token upon successful authentication. That token can then be used by services and apps
to authenticate and authorize requests for the duration of defined lifespan for the token. The service
will be implemented in the acme-auth service app.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;a href=&quot;http://stackoverflow.com/questions/1592534/what-is-token-based-authentication&quot;&gt;What is token based authentication ?&lt;/a&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_database&quot;&gt;Database&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;For this sample app we&amp;#8217;ll use a plain old boring rdbms. The schema will be as follows.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2015//acme_user_db.png&quot; alt=&quot;acme user db&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_password_hashing&quot;&gt;Password hashing&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We need to store our passwords securely hashed in the user table. Buddy provides &lt;a href=&quot;https://github.com/funcool/buddy-hashers&quot;&gt;buddy-hashers&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Adding a user&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(ns acme-auth.service
  (:require [buddy.hashers :as hs]
            [acme-auth.store :as store]))

(defn add-user! [ds user]
  (store/add-user! ds (update-in user [:password] #(hs/encrypt %))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;hs/encrypt - Hashes the password using bcrypt+sha512 (default, others available). Buddy generates a
random &lt;a href=&quot;http://en.wikipedia.org/wiki/Salt_%28cryptography%29&quot;&gt;salt&lt;/a&gt; if you don&amp;#8217;t provide one as an option param.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Sample hash&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre&gt;&lt;sup&gt;1&lt;/sup&gt;bcrypt+sha512$&lt;sup&gt;2&lt;/sup&gt;32da7e602406d818c6768194$&lt;sup&gt;3&lt;/sup&gt;12$&lt;sup&gt;4&lt;/sup&gt;243261243132246c32674a576d514c75585255434f64444f4c59414b653843357a4e645547397279616c304a696f525656393166434862347a2e564b&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The password hash we store to the database consists of 4 parts concatinated with $.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;olist arabic&quot;&gt;
&lt;ol class=&quot;arabic&quot;&gt;
&lt;li&gt;
&lt;p&gt;Algorithm&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Salt       - In our case the randomly generated by buddy&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Iterations - Number of iterations used for hashing the pwd&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Encrypted password hash&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Authenticating a user&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn auth-user [ds credentials]
  (let [user (store/find-user ds (:username credentials))
        unauthed [false {:message &quot;Invalid username or password&quot;}]]
    (if user
      (if (hs/check (:password credentials) (:password user))            &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
        [true {:user (dissoc user :password)}]                           &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
        unauthed)
      unauthed)))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Verify provided plain text password credential against the hashed password in the db&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;You probably don&amp;#8217;t want to ship the password in the token !&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock tip&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-tip&quot; title=&quot;Tip&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
Bcrypt is intentionally relatively slow. It&amp;#8217;s a measure to help prevent brute force attacks.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_creating_a_signed_token&quot;&gt;Creating a signed token&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;With the user store in place we can turn our attention to creating our (signed) token. Buddy provides us with &lt;a href=&quot;https://github.com/funcool/buddy-sign&quot;&gt;buddy-sign&lt;/a&gt;.
We could have opted for a &lt;a href=&quot;http://en.wikipedia.org/wiki/Hash-based_message_authentication_code&quot;&gt;HMAC&lt;/a&gt; based algorithm,
but we&amp;#8217;ll take it up one notch and use an algorithm that requires a public/private key-pair.
Not only that, but we&amp;#8217;ll serialize our token content in a json format following the &lt;a href=&quot;https://tools.ietf.org/html/draft-ietf-jose-json-web-signature-41&quot;&gt;jws&lt;/a&gt;
draft spec.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/rundis/acme-buddy/tree/master/acme-auth&quot;&gt;acme-auth&lt;/a&gt; will own the private key and use that for signing
whilst the other apps will have the public key for unsigning the token.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_creating_a_key_pair&quot;&gt;Creating a key-pair&lt;/h4&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;You&amp;#8217;ll be asked to enter a passphrase in both steps below. Keep it safe !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;openssl genrsa -aes128 -out auth_privkey.pem 2048&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;You should probably use something stronger than -aes128. You&amp;#8217;ll need to fiddle with your JVM, but might be worth it
unless it&amp;#8217;s important for you that your government agencies have access to decrypting your token signatures.&lt;/p&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;openssl rsa -pubout -in auth_privkey.pem -out auth_pubkey.pem&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_signing&quot;&gt;Signing&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(ns acme-auth.service
  (:require [buddy.sign.generic :as sign]
            [buddy.sign.jws :as jws]
            [buddy.core.keys :as ks]
            [clj-time.core :as t]
            [clojure.java.io :as io]))


(defn- pkey [auth-conf]                                             &lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;(1)&lt;/b&gt;
  (ks/private-key
   (io/resource (:privkey auth-conf))
   (:passphrase auth-conf)))

(defn create-auth-token [ds auth-conf credentials]
  (let [[ok? res] (auth-user ds credentials)
        exp (-&amp;gt; (t/plus (t/now) (t/days 1)) (jws/to-timestamp))]   &lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;(2)&lt;/b&gt;
    (if ok?
      [true {:token (jws/sign res                                  &lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;(3)&lt;/b&gt;
                              (pkey auth-conf)
                              {:alg :rs256 :exp exp})}]
      [false res])))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;1&quot;&gt;&lt;/i&gt;&lt;b&gt;1&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Helper function to read the private key we generated above&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;2&quot;&gt;&lt;/i&gt;&lt;b&gt;2&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Sets a timestamp for when the token expires&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;i class=&quot;conum&quot; data-value=&quot;3&quot;&gt;&lt;/i&gt;&lt;b&gt;3&lt;/b&gt;&lt;/td&gt;
&lt;td&gt;Creates a signed token&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;The token consists of 3 parts concatenated using &quot;.&quot;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Base64 encoded string with header data (algorithm and other optional headers you might have set)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Base64 encoded json string with your message (claims in jws speak). Expiry ie. :exp is also a claim btw.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Base64 encoded MAC (Message Authentication Code) signature for our message (header + claims)&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;With that knowledge in mind, you see why it might be a good idea to leave the password out of the token (even though it would have been the hashed pwd we&amp;#8217;re talking about).&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_exposing_our_service&quot;&gt;Exposing our service&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;handler&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn create-auth-token [req]
  (let [[ok? res] (service/create-auth-token (:datasource req)
                                           (:auth-conf req)
                                           (:params req))]
    (if ok?
      {:status 201 :body res}
      {:status 401 :body res})))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Ring / Compojure wrap-up&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defroutes app-routes
  (POST &quot;/create-auth-token&quot; [] handlers/create-auth-token))


(defn wrap-datasource [handler]
  (fn [req]
      (handler (assoc req :datasource (get-ds)))))

(defn wrap-config [handler]
  (fn [req]
    (handler (assoc req :auth-conf {:privkey &quot;auth_privkey.pem&quot;
                                    :passphrase &quot;secret-key&quot;}))))

(def app
  (-&amp;gt; app-routes
      wrap-datasource
      wrap-config
      wrap-keyword-params
      wrap-json-params
      wrap-json-response))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_invoking&quot;&gt;Invoking&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;curl -i -X POST -d &apos;{&quot;username&quot;: &quot;test&quot;, &quot;password&quot;:&quot;secret&quot;}&apos; -H &quot;Content-type: application/json&quot; http://localhost:6001/create-auth-token&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Would yield something like:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;{&quot;token&quot;:&quot;eyJ0eXAiOiJKV1MiLCJhbGciOiJSUzI1NiJ9.eyJ1c2VyIjp7InVzZXItcm9sZXMiOlt7InJvbGUtaWQiOjEwLCJhcHBsaWNhdGlvbi1pZCI6MTB9LHsicm9sZS1pZCI6MTEsImFwcGxpY2F0aW9uLWlkIjoxMH1dLCJ1c2VybmFtZSI6InRlc3QiLCJpZCI6MX0sImV4cCI6MTQyMjMxNDk3MH0.bKB3fh2CcPWqP85CK18U_IITxkRce8Xuj8fZGvhqjAaq1dWeiDMKOAGfSlg6GGJi-CrRepMaLOEfAVN23R7yoYb543wgm1Tv_pOYuNQ02tYRQMRJXSxVKS1m9zMEWlszLVet8Q3kfrLBaOxjdvjSp8exjsPeOcfCaqdcXPn9mwWSz0X8k1iaLbnY2fRL0mWbbG8rz4bSUSE0KX0xnKH3LqrtJcZE3BDHSr7tVqaxcHaFt4ivRpk3EYBzMtwRSCQ4jwAMibsh1XhvJMo4QeDwil-et70qJMV5XCJOsAr3SF4FVlNeUsNx2Aj1lORGIN7c8xKq-MDaTaGYV2O7L_0mGA&quot;}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Unsigning the token is quite similar to the signing. However when unsigning you must have the
public key we generated earlier.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;For the token above, the claims part of the message would look like this:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;{&quot;user&quot;:{&quot;user-roles&quot;:[{&quot;role-id&quot;:10,&quot;application-id&quot;:10},
                       {&quot;role-id&quot;:11,&quot;application-id&quot;:10}],
         &quot;username&quot;:&quot;test&quot;,
         &quot;id&quot;:1},
 &quot;exp&quot;:1422314970}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_summary&quot;&gt;Summary&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We have created a small clojure app with a user database and a rest service that authenticates a
user and returns a signed token with information about the user and his/her role+app/service authorizations.
We&amp;#8217;ve briefly covered password hashing and message signing using buddy.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The auth-token service will serve as a building block for the next step. How do we make use of token
for authentication and authorization purposes in the acme-webstore ? That&amp;#8217;s the topic of my next blog
post in this series. Stay tuned !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>A Groovy Light Table client - Not dead (yet)</title>
      <link>http://rundis.github.io/blog/2015/gr_lt_status_jan2015.html</link>
      <pubDate>Sun, 25 Jan 2015 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2015/gr_lt_status_jan2015.html</guid>
      	<description>
	&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_background&quot;&gt;Background&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In 2014 I blogged about the process of evolving a groovy(/gradle) plugin for Light Table from scratch.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Posts so far:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;/blog/2014/gr_lt_part1.html&quot;&gt;A Groovy Light Table client - Step 1: Connecting the client&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;/blog/2014/gr_lt_part2.html&quot;&gt;A Groovy Light Table client - Step 2: Evaluating Code&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;/blog/2014/gr_lt_part3.html&quot;&gt;A Groovy Light Table client - Step 3: Running out of quick wins&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;/blog/2014/gr_lt_part4.html&quot;&gt;A Groovy Light Table client - Step 4: Exploring new avenues with Gradle&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;/blog/2014/gr_lt_part5.html&quot;&gt;A Groovy Light Table client - Step 5: Gradle dependencies in Light Table with dagre-D3&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I even did a &lt;a href=&quot;/blog/2014/groovy_repl.html&quot;&gt;screen cast&lt;/a&gt; showing off some of the features so far.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_so_what_happened&quot;&gt;So what happened ?&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;After the summer holidays my Open Source mojo was drained, I needed a break and I went into uphill cycling mode.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_light_table_doubts&quot;&gt;Light Table doubts&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;First of all. I haven&amp;#8217;t given up on Light Table I somehow even feel strongly obliged to hang in there longer
than most people given that I&amp;#8217;ve contributed. I still use Light Table, actually more than ever because I&amp;#8217;m currently
hacking on a clojure/clojurescript project.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In October the founder of Light Table annouced Eve and released this &lt;a href=&quot;http://www.chris-granger.com/2014/10/01/beyond-light-table/&quot;&gt;blog post&lt;/a&gt;
Obviously there was initial fears that this would be the end of Light Table. However 3 of the most active contributors
to Light Table stepped up. There was a lot of visible activity initially (proper spring cleaning of the issues log).
However visible activity from Light Table has been in steady decline and the last release was 21. november of last year.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I believe they are working on moving from node-webkit to atom shell, the layout system is being revised. There is also a hack night planned
in a few days time.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I guess I just wished someone stepped up and outlined a clear road-map for Light Table and that
a steady stream of releases towards a version 1.0 started coming out :)&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_possibilites_for_further_developments&quot;&gt;Possibilites for further developments&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Great things are happening with gradle I believe in terms of performance and also in terms of whats possible
to achieve with the Tooling API. This opens up a whole range of oportunities to provide IDE support for languages that gradle supports.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The groovy and gradle parts of the currenty groovy plugin should probably be split with a generic gradle
plugin and specific language plugins (scala, java&amp;#8230;&amp;#8203;) depending on that.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;How about things like ?:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Continuous unit testing - utilizing gradle builds incremental nature and the coming watcher tasks.
Couple that with showing results inline in Light Table&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Compilation - Same story here, show compilation errors inline&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;run webapp - Run apropriate gradle task to start your webapp and fire up a browser window inline in lighttable
, maybe even hook it up with a browser debug/repl connection&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_help_needed&quot;&gt;Help needed&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;d love to hear if anyone has actually used the plugin and if so which parts of it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;m currently fully engaged in a clojure/clojurescript project, which takes all of my day time and quite a few evenings.
It puts me in a better shape to contribute to Light Table, but currently leaves me little time to do so.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;olist arabic&quot;&gt;
&lt;div class=&quot;title&quot;&gt;That might change though, but I guess I need 2 things to happen before I pick up work on this plugin:&lt;/div&gt;
&lt;ol class=&quot;arabic&quot;&gt;
&lt;li&gt;
&lt;p&gt;Some visible progress from Light Table to show that it&amp;#8217;s intending to survive&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Hopefully someone feels inspired to help contribute progressing the plugin (pull requests are welcome)&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Bootifying my ring app</title>
      <link>http://rundis.github.io/blog/2015/bootify-ring.html</link>
      <pubDate>Mon, 19 Jan 2015 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2015/bootify-ring.html</guid>
      	<description>
	&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_a_little_background&quot;&gt;A little background&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A few weeks back I noticed a tweet about &lt;a href=&quot;https://github.com/boot-clj/boot&quot;&gt;boot-clj&lt;/a&gt;. This weekend I finally had some time to look into whether it could
be a viable alternative to &lt;a href=&quot;https://github.com/technomancy/leiningen&quot;&gt;Leiningen&lt;/a&gt; for our apps or not.
We have a couple of ring based apps running as uberjars, so I decided to try to make a boot build for one of the projects. For the purpose of this blogpost however
I&amp;#8217;ve created a sample app. Source available on &lt;a href=&quot;https://github.com/rundis/boot-sample&quot;&gt;github&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_why_bother_with_an_alternative_when_there_is_leiningen&quot;&gt;Why bother with an alternative when there is Leiningen ?&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I haven&amp;#8217;t been in the clojuresphere all that long.
I do have a history as java and groovy developer and have been through a history of using &lt;a href=&quot;http://ant.apache.org/&quot;&gt;ant&lt;/a&gt;,
&lt;a href=&quot;http://maven.apache.org/&quot;&gt;maven&lt;/a&gt; and lately &lt;a href=&quot;https://www.gradle.org/&quot;&gt;gradle&lt;/a&gt; for my builds.
In terms of development experience Leiningen is definately a step up from all of them. However I feel Leiningen has left me longing
as soon as my builds have become a bit more elaborate (testing javascript, transpiling, create artifacts, upload to repo, run migrations
deploy to different environments etc). I&amp;#8217;m sure all of this is achievable with Lein, but is it really architected to excel for that purpose ?
TBH I&amp;#8217;d love to see gradle get some serious clojure love, but it doesn&amp;#8217;t seem to be coming anytime soon. Maybe boot will be my next build tooling love :)&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Reading up a bit on boot checked a few boxes for some of my longings though:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Your build doesn&amp;#8217;t have to be all declarative&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Sensible abstractions and libraries to allow you to compose and extend your build using the full power of clojure&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Compose build pipelines somewhat similar to how you would compose middlewares in ring&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Task is the fundamental building block&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Tasks typically works on immutable filesets (files treated as values, you never touch the filesystem directly yourself !)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Possibility of complete classpath isolation at task level&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Great repl and commandline support.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&amp;#8230;&amp;#8203; and surely a lots more&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_lein_boot&quot;&gt;Lein &amp;#8594; Boot&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_leningen_project&quot;&gt;Leningen project&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;project.clj&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defproject boot-sample &quot;0.1.0&quot;
  :description &quot;Boot sample application&quot;
  :url &quot;https://github.com/rundis/boot-sample&quot;
  :min-lein-version &quot;2.0.0&quot;
  :dependencies [[org.clojure/clojure &quot;1.6.0&quot;]
                 [compojure &quot;1.2.1&quot;]
                 [liberator &quot;0.12.2&quot;]
                 [ring/ring-jetty-adapter &quot;1.3.1&quot;]
                 [ring/ring-json &quot;0.3.1&quot;]
                 [bouncer &quot;0.3.1&quot;]
                 [io.aviso/pretty &quot;0.1.14&quot;]]
  :ring {:handler boot-sample.core/app                       &lt;b class=&quot;conum&quot;&gt;(1)&lt;/b&gt;
         :port 3360}
  :profiles {:dev {:plugins [[lein-ring &quot;0.8.13&quot;]]
                   :test-paths ^:replace []}
             :test {:dependencies [[midje &quot;1.6.3&quot;]]
                    :plugins [[lein-midje &quot;3.1.3&quot;]]
                    :test-paths [&quot;test&quot;]
                    :resource-paths [&quot;test/resources&quot;]}})&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The entry point for my ring app&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The above project is a really simple project definition. To run my app I just have to execute:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;lein ring uberjar
java -jar target/boot-sample-0.1.0-standalone.jar&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;core.clj&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(ns boot-sample.core
  (:require [ring.middleware.params :refer [wrap-params]]
            [ring.middleware.keyword-params :refer [wrap-keyword-params]]
            [ring.middleware.json :refer [wrap-json-params]]
            [compojure.core :refer [defroutes ANY GET]]
            [liberator.core :refer [defresource resource]]))

(defn index-handler [req]
  &quot;Hello Boot sample (or maybe Lein still)&quot;)

(defresource booters
  :available-media-types       [&quot;application/json&quot;]
  :allowed-methods             [:get]
  :handle-ok                   (fn [ctx] [{:id &quot;Pod1&quot;} {:id &quot;Pod 2&quot;}]))

(defroutes app-routes
  (ANY &quot;/&quot; [] index-handler)
  (ANY &quot;/booters&quot; [] booters))


(def app (-&amp;gt; app-routes
             wrap-keyword-params
             wrap-json-params
             wrap-params))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Hey. Hang on. There is no main method here, how can the java -jar command work without one ?
Well, because the ring plugin creates one for us.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;cat target classes/boot_sample/core/main.clj&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;gives us&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(do
  (clojure.core/ns boot-sample.core.main
   (:require ring.server.leiningen)
                   (:gen-class))
  (clojure.core/defn -main []
    (ring.server.leiningen/serve
     (quote {:ring {:auto-reload? false,
                    :stacktraces? false,
                    :open-browser? false,
                    :port 3360,
                    :handler boot-sample.core/app}}))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;That&amp;#8217;s useful to know in case boot-clj doesn&amp;#8217;t happen to have a ring task that does something similar.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_boot_me_up&quot;&gt;Boot me up&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Boot comes with a range of predefined tasks that I can compose to get quite close to the Leiningen build above.
I&amp;#8217;ll focus on getting that uberjar up and running.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I could have done it all on the command line or in the boot repl, but lets just be a little declarative (still functions don&amp;#8217;t worry!).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;build.boot&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(set-env!
 :resource-paths #{&quot;src&quot;}                                &lt;b class=&quot;conum&quot;&gt;(1)&lt;/b&gt;
 :dependencies &apos;[[org.clojure/clojure &quot;1.6.0&quot;]
                 [compojure &quot;1.2.1&quot;]
                 [liberator &quot;0.12.2&quot;]
                 [ring/ring-jetty-adapter &quot;1.3.1&quot;]
                 [ring/ring-json &quot;0.3.1&quot;]
                 [bouncer &quot;0.3.1&quot;]
                 [io.aviso/pretty &quot;0.1.14&quot;]])

(task-options!
 pom {:project &apos;boot-Sample
      :version &quot;0.1.0&quot;}
 aot {:namespace &apos;#{boot-sample.core}}                  &lt;b class=&quot;conum&quot;&gt;(2)&lt;/b&gt;
 jar {:main &apos;boot_sample.core                           &lt;b class=&quot;conum&quot;&gt;(3)&lt;/b&gt;
      :manifest {&quot;Description&quot; &quot;Sample boot app&quot;
                 &quot;Url&quot; &quot;https://github.com/rundis/boot-sample&quot;}})


(deftask build
  &quot;Build uberjar&quot;
  []
  (comp (aot) (pom) (uber) (jar)))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;To bundle your sources in the output jar, you have to specify src as a resource-path. A small gotcha there.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;We need to aot our core.clj namespace so that java -jar can invoke it&amp;#8217;s main method&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;We need to help java -jar with the location of our main class in the jar&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;However you might remember from above that there is no main method in core.clj.
So the last piece of the puzzle is to add one. It&amp;#8217;t not that hard.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(ns boot-sample.core
  (:require [ring.middleware.params :refer [wrap-params]]
            [ring.middleware.keyword-params :refer [wrap-keyword-params]]
            [ring.middleware.json :refer [wrap-json-params]]
            [compojure.core :refer [defroutes ANY GET]]
            [liberator.core :refer [defresource resource]]
            [ring.adapter.jetty :as jetty])                                &lt;b class=&quot;conum&quot;&gt;(1)&lt;/b&gt;
  (:gen-class))                                                            &lt;b class=&quot;conum&quot;&gt;(2)&lt;/b&gt;


;; ... the other stuff

(defn -main []
  (jetty/run-jetty app {:port 3360}))                                     &lt;b class=&quot;conum&quot;&gt;(3)&lt;/b&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Using the jetty ring adapter&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The :gen-class directive generates the necessary stuff for our main method to be invokable from java
during aot compilation&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Fire away&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Note&lt;/div&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;At the time of writing there was a regression in boot that caused aot to fail.
I needed to build boot from source, should be fixed in the next release though.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;git clone git@github.com:boot-clj/boot.git
cd boot/boot/core
lein install&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Now all is set to try it out:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;boot build
java -jar target/boot-sample-0.1.0.jar&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_all_is_well_then&quot;&gt;All is well then ?&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Unfortunately not quite. For uberjar projects it seems boot-clj at the time of writing has some serious
performance challenges.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;On my machine generating the uberjar takes:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Leiningen : 12 seconds&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;boot-clj  : 46 seconds !&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;It&amp;#8217;s not like Leiningen is lightning fast in the first place. But for this scenario boot just doesn&amp;#8217;t cut it.
I reported an &lt;a href=&quot;https://github.com/boot-clj/boot/issues/94&quot;&gt;issue&lt;/a&gt; and got prompt responses from the developers
which can only be a good sign.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_concluding_remarks&quot;&gt;Concluding remarks&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;My initial question of whether or not I feel we could use boot for our current projects gets a thumbs down for now.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I think boot-clj carries a lot of promise and have some really great ideas. It&amp;#8217;s going to be interesting to
see if boot-clj becomes a viable alternative to leiningen. I suppose a porting and/or interop story with lein
and lein plugins might be needed in addition to maturing both the model and obviously its performance characteristics.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I&amp;#8217;m certainly keen on trying it out more. I might try out the clojurescript support next and maybe churn out some custom tasks
just for fun.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>A Groovy Light Table client - Step 5: Gradle dependencies in Light Table with dagre-D3</title>
      <link>http://rundis.github.io/blog/2014/gr_lt_part5.html</link>
      <pubDate>Wed, 18 Jun 2014 00:00:00 +0200</pubDate>
      <guid isPermaLink="false">2014/gr_lt_part5.html</guid>
      	<description>
	&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_background&quot;&gt;Background&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This is the fifth post in my series &quot;A Groovy Light Table client&quot;. A blog series about steps I take when trying to build a Groovy plugin for Light Table.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_tapping_more_into_the_potential_of_light_table&quot;&gt;Tapping more into the Potential of Light Table&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So far the Groovy Light Table plugin hasn&amp;#8217;t really showcased the real power of the Light Table Editor. What feature could showcase more of Light Table and at the same time prove useful in many scenarios ? For most projects I have worked on, the number of dependencies and their relationships have usually been non trivial. A couple of years back I wrote a post about showing gradle dependencies as a graphwiz png. Wouldn&amp;#8217;t it be cool if I could show my gradle dependencies  inline in Light Table ? It would be even cooler if the graph was interactive and provided more/different value than the default dependency reporting you got from Gradle itself&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_dagre_d3&quot;&gt;dagre-D3&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So what library should I choose for laying out my planned dependency diagram ? My first instinct was something related to D3. However laying out a dot-graph sensibly on my own didn&amp;#8217;t seem like a challenge I was quite up to. Luckily I found dagre-D3 and it looked to be just the thing I needed.  Of course I would have loved to have found something more clojurish and ideally something that supported an immediate mode ui (akin to Facebook React, but for graphing).  Maybe I didn&amp;#8217;t look long or well enough but I couldn&amp;#8217;t find anything obvious so I settled for &lt;a href=&quot;https://github.com/cpettitt/dagre-d3&quot;&gt;dagre-D3&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_gradle_dependencies&quot;&gt;Gradle dependencies&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The second challenge I faced before even getting started was: How would I go about retrieving rich dependency information for my gradle projects using the tooling-api ? The information about dependencies default provided through the tooling api is fairly limited and wouldn&amp;#8217;t have produced a very informative graph at all. Luckily I found through dialog with the Gradle guys that it should be possible to achieve what I wanted through a custom gradle model.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_it_s_all_about_the_data&quot;&gt;It&amp;#8217;s all about the data&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;When I initially started developing the custom gradle model for retrieving dependency information I designed a data structure that resembled the dependency modelling in Gradle. However after prototyping with dagre and later trying to display multi project dependency graphs I decided to change the design. I ended up with a data structure more similar to that of a graph with nodes and edges.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_custom_gradle_model&quot;&gt;Custom Gradle Model&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To create a Custom Gradle Model you need to create a Gradle Plugin. My plugin got the very informative name &quot;Generic Gradle Model&quot; (naming is hard!).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;class GenericGradleModelPlugin implements Plugin {
    final ToolingModelBuilderRegistry registry;

    @Inject
    public GenericGradleModelPlugin(ToolingModelBuilderRegistry registry) {
        this.registry = registry;
    }

    @Override
    void apply(Project project) {
        registry.register(new CustomToolingModelBuilder())
    }
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The important bit above is registering my custom tooling builder to make it available to the tooling api !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;private static class CustomToolingModelBuilder implements ToolingModelBuilder {

// .. other private methods left out for brevity

Map confDiGraph(Configuration conf) {
  def nodeTree = conf.allDependencies
    .findAll {it instanceof ProjectDependency}
    .collect {getProjectDepInfo(it as ProjectDependency)} +
    conf.resolvedConfiguration
        .firstLevelModuleDependencies
        .collect { getDependencyInfo(it) }

    def nodes = nodeTree.collect {collectNodeEntry(it)}.flatten().unique {nodeId(it)}
    def edges = nodeTree.collect {
      collectEdge(conf.name, it)
    }.flatten().unique()

    [nodes: nodes, edges: edges]
  }

  Map projectDeps(Project project) {
    [
      name: project.name,
      group: project.group,
      version: project.version,
      configurations: project.configurations.collectEntries{Configuration conf -&amp;gt;
          [conf.name, confDiGraph(conf)]
      }
    ]
  }

  public boolean canBuild(String modelName) {
    modelName.equals(GenericModel.class.getName())
  }

  public Object buildAll(String modelName, Project project) {
    new DefaultGenericModel(
      rootDependencies: projectDeps(project),
      subprojectDependencies: project.subprojects.collect {projectDeps(it)}
  }
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The custom tooling model builder harvests information about all dependencies for all defined configurations in the project. If the project is a multi-project It will collect the same information for each subproject in addition to collect information about interdependencies between the sub projects.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_applying_the_plugin_to_gradle_projects_we_connect_to&quot;&gt;Applying the plugin to gradle projects we connect to&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Before we can retrieve our custom gradle model, we need to apply the plugin to the project in question. I could ask the users to do it themselves, but that wouldn&amp;#8217;t be particularly user friendly.
Luckily Gradle provides init scripts that you can apply to projects and the tooling api supports doing so. Init scripts allows you to do&amp;#8230;&amp;#8203; well &amp;#8230;&amp;#8203; init stuff for your projects. Applying a plugin from the outside falls into that category.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;initscript {
  repositories {
    maven { url &apos;http://dl.bintray.com/rundis/maven&apos; }
  }
  dependencies { classpath &quot;no.rundis.gradle:generic-gradle-model:0.0.2&quot; }
}

allprojects {
  apply plugin: org.gradle.tooling.model.generic.GenericGradleModelPlugin
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_retrieving_the_model&quot;&gt;Retrieving the model&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;def genericModel = con.action(new GetGenericModelAction())
                            .withArguments(&quot;--init-script&quot;, new File(&quot;lib/lt-project-init.gradle&quot;).absolutePath)
                            .addProgressListener(listener)
                            .run()

private static class GetGenericModelAction implements Serializable, BuildAction {
  @Override
  GenericModel execute(BuildController controller) {
    controller.getModel(GenericModel)
  }
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To retrieve the model we use a custom build action and applies the plugin implementing the custom model using the --init-script command line argument for gradle.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Voila we have the data we need and we return the dependency info (async) after you have connected to a gradle project.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_show_me_a_graph&quot;&gt;Show me a graph&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The dependency graph and associated logic was separated out to a separate namespace (graph.cljs).
We&amp;#8217;ll quickly run through some of the highlights of the LightTable clojurescript parts for displaying the dependency graph.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_graph_object&quot;&gt;Graph object&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defui dependency-graph-ui [this]
  [:div.graph
   [:div.dependency-graph
    [:svg:svg {:width &quot;650&quot; :height &quot;680&quot;}
     [:svg:g {:transform &quot;translate(20,20)&quot;}]]]])

(object/object* ::dependency-graph
                :tags [:graph.dependency]
                :name &quot;Dependency graph&quot;
                :init (fn [this]
                        (load/js (files/join plugin-dir &quot;js/d3.v3.min.js&quot;) :sync)
                        (load/js (files/join plugin-dir &quot;js/dagre-d3.js&quot;) :sync)
                        (let [content (dependency-graph-ui this)]
                          content)))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The first step was to create and object that represents the view (and is able to hold the dependency data). The init method is responsible for loading the required graphing libs and then it creates the initial placeholder markup for the graph.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_some_behaviours&quot;&gt;Some behaviours&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::on-dependencies-loaded
          :desc &quot;Gradle dependencies loaded for selected project&quot;
          :triggers #{:graph.set.dependencies}
          :reaction (fn [this rootDeps subDeps]
                      (object/merge! this {:rootDeps rootDeps
                                           :subDeps subDeps})))


(behavior ::on-show-dependencies
          :desc &quot;Show dependency graph&quot;
          :triggers #{:graph.show.dependencies}
          :reaction (fn [this root-deps]
                      (tabs/add-or-focus! dependency-graph)
                      (default-display this)))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The first behavior is triggered when the groovy backend has finished retrieving the project info, and more specifically the dependencies. If the project is a single project only the rootDeps will contain data.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The second behavior is triggered (by a command) when the user wishes to view the dependency graph for a connected gradle project.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_render_multiproject_graph_hightlighs&quot;&gt;Render Multiproject graph Hightlighs&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;For multi projects the plugin renders an overview graph where you can see the interdependencies between you sub projects.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn create-multiproject-graph [this]
  (let [g (new dagreD3/Digraph)]
    (doseq [x (:nodes (multi-proj-deps this))]
      (.addNode g (dep-id x) #js {:label (str &quot;&amp;lt;div class=&apos;graph-label clickable&apos; data-proj-name=&apos;&quot;
                                              (:name x) &quot;&apos; title=&apos;&quot;
                                              (dep-id x) &quot;&apos;&amp;gt;&quot;
                                              (:name x) &quot;&amp;lt;br/&amp;gt;&quot;
                                              (:version x)
                                              &quot;&amp;lt;/div&amp;gt;&quot;)}))
    (doseq [x (:edges (multi-proj-deps this))]
      (.addEdge g nil (:a x) (:b x) #js {:label &quot;&quot;}))
    g))

(defn render-multi-deps [this]
  (let [renderer (new dagreD3/Renderer)
        g (dom/$ :g (:content @this))
        svg (dom/$ :svg (:content @this))
        layout (.run renderer (create-multiproject-graph this) (d3-sel g))
        dim (dimensions this)]
    (unbind-select-project this)
    (bind-select-project this)
    (.attr (d3-sel svg) &quot;width&quot; (+ (:w dim) 20))
    (.attr (d3-sel svg) &quot;height&quot; (+ (:h dim) 20))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The first function shows how we use dagre-D3 to create a logical dot graph representation. We basically add nodes and edges (dep&amp;#8594;dep). Most of the code is related to what&amp;#8217;s rendered inside each node.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The second function shows how we actually layout and display the graph.  In addition we bind click handlers to our custom divs inside the nodes. The click handlers allows for drill down into a detailed graph about each dependency configuration.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_end_results&quot;&gt;End results&lt;/h3&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2014//ratpack_multi.png&quot; alt=&quot;ratpack multi&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 1. Multiproject sample : Ratpack&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2014//ratpack_reactor.png&quot; alt=&quot;ratpack reactor&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 2. Project configuration dependencies&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I think we achieved some pretty cool things. Maybe not a feature that you need everyday, but its certainly useful to get an overview of your project dependencies. For troubleshooting transitive dependency issues and resolution conflicts etc you might need more details though.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We have certainly showcased that you can do some really cool things with Light Table that you probably wouldn&amp;#8217;t typically do (easily) with a lot of other editors and IDE&amp;#8217;s. We have also dug deeper into the gradle tooling api. The gradle tooling api when maturing even more will provide some really cool new options for  JVM IDE integrations. A smart move by gradleware that opens up for integrations from a range of editors, IDE&amp;#8217;s and specialised tools and applications.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The end result of the dependency graph integration became the largest chunk of the 0.0.6 release.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>A Groovy Light Table client - Step 4: Exploring new avenues with Gradle</title>
      <link>http://rundis.github.io/blog/2014/gr_lt_part4.html</link>
      <pubDate>Mon, 26 May 2014 00:00:00 +0200</pubDate>
      <guid isPermaLink="false">2014/gr_lt_part4.html</guid>
      	<description>
	&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_background&quot;&gt;Background&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This is the fourth post in my series &quot;A Groovy Light Table client&quot;. A blog series about steps I take when trying to build a Groovy plugin for Light Table.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_initial_ponderings&quot;&gt;Initial ponderings&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Gradle ships with a Tooling API that makes it fairly easily to integrate with your Gradle projects. Initially I thought that Gradle integration should be a separate plugin that other jvm language plugins could depend on, starting with the Groovy plugin. However after much deliberation I decided to start out with bundling the gradle integration with the Groovy plugin. There is certainly a degree of selecting the easy option to that decision. However I still consider the integration exploratory and I&amp;#8217;m not sure how it will pan out. I&amp;#8217;ve settled for a strategy of keeping it logically fairly separate, with a mind to separating gradle specifics out to its own plugin when things become clearer.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_classpath_integration_for_groovy_repl&quot;&gt;Classpath Integration for Groovy &quot;REPL&quot;&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In part 3 I talked about some REPL like features where variables that result in bindings are stored in a editor session and used as input to the next evaluation. Since then I&amp;#8217;ve also added the feature of caching method definitions (albeit as closures so I&amp;#8217;m sure there are gotchas to that approach as well).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Anyways wouldn&amp;#8217;t it be nice If I could also explore my project classes and my projects third party library dependencies in a REPL like fashion ? Hence the idea of providing a Gradle integration. With the Tooling API I should be able to retrieve a class path. So this is where i started.
Before anyone potentially asking; I will not bother with maven or ant at any point in time, I&amp;#8217;ll leave that to someone else.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_retrieving_the_class_path_as_a_list_from_a_gradle_project&quot;&gt;Retrieving the class path as a list from a Gradle project&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;// Step 1: Connecting to project
def con = GradleConnector.newConnector()
  .forProjectDirectory(projectDir)
  .connect()

// Step 2: Get hold of a project model, for now a IdeaModel provides what we need
def ideaProject = con.model(IdeaProject)
  .addProgressListener(listener)
  .get()

// Step 3: Get list of dependencies
def deps = ideaProject.children
  .dependencies
  .flatten()
  .findAll { it.scope.scope == &quot;COMPILE&quot; }
  .collect {
    [
      name   : it.gradleModuleVersion?.name,
      group  : it.gradleModuleVersion?.group,
      version: it.gradleModuleVersion?.version,
      file   : it.file?.path,
      source : it.source?.path,
      javadoc: it.javadoc?.path
    ]
  }

def classpathList = deps.file + [new File(projectDir, &quot;build/classes/main&quot;).path]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The above code is actually wrapped in a class. Connection and model instances are cached for performance reasons.
We connect to our gradle project. If the project ships with a gradle wrapper (which it should IMO), the gradle connector will use that version (download the distribution even if need be). Otherwise it will use the gradle version of the tooling-api. At the time of writing that&amp;#8217;s 1.12
The tooling api doesn&amp;#8217;t really expose as much information by default as you might wish. However it ships with an IdeaModel and an EclipseModel that provides what we need for the purposes of creating a class path. As an Idea user the IdeaModel seemed the right choice ! There is also added a progress listener, which is a callback from the api reporting progress. The progress listener returns each progress event as a string to Light Table so that we can display progress information
We basically navigate the model and extract information about dependencies and put it in a list of maps for ease of jsonifying (useful later !). The location of our projects custom compiled classes are added manually to the class path list (ideally should have been retrieved from the model as well&amp;#8230;&amp;#8203;)
Adding the class path list to our groovy shell before code invocation&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;private GroovyShell createShell(Map params) {
def transform = new ScriptTransform()
def conf = new CompilerConfiguration()
  conf.addCompilationCustomizers(new ASTTransformationCustomizer(transform))
  conf.addCompilationCustomizers(ic)

  if(params.classPathList) {
    conf.setClasspathList(params.classPathList)
  }

  new GroovyShell(conf)
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Its basically just a matter of adding the class path list to the CompilerConfiguration we initialise our GroovyShell with. Sweet !
Voila your groovy scripts can invoke any class in your project´s class path.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This addition basically resulted in version 0.0.4&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_reporting_progress&quot;&gt;Reporting progress&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_groovy&quot;&gt;Groovy&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;class ProgressReporter implements LTProgressReporter {
    final LTConnection ltCon

    ProgressReporter(LTConnection ltCon) { this.ltCon = ltCon }

    @Override
    void statusChanged(ProgressEvent event) {
        if (event.description?.trim()) {
            reportProgress(event.description)
        }
    }

    void reportProgress(String message) {
        ltCon.sendData([null, &quot;gradle.progress&quot;,[msg: message]])
    }
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Notes&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;statusChanges is called by gradle (LTProgressReporter extends the Gradle ProgressListener interface)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;reportProgress sends the progress information to Light Table&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_light_table&quot;&gt;Light Table&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::on-gradle-progress
  :desc &quot;Reporting of progress from gradle related tasks&quot;
  :triggers #{:gradle.progress}
  :reaction (fn [this info]
              (notifos/msg* (str &quot;Gradle progress: &quot; (:msg info)) {:timeout 5000})))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The progress behaviour just prints a message to the Light Table status bar.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_executing_gradle_tasks&quot;&gt;Executing Gradle Tasks&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;There are two parts to this puzzle. One is to retrieve information about what tasks are actually available for the given project. The other is to actually invoke the task (tasks in the future).
Listing tasks Groovy/Server&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt; // Step 1: Retrieve generic Gradle model
def gradleProject = con.model(GradleProject)
  .addProgressListener(listener)
  .get()

// Step 2: Get list of available tasks
gradleProject.tasks.collect{
  [
    name: it.name,
    displayName: it.displayName,
    description: it.description,
    path: it.path
  ]
}

// Step 3: Send task list to client (omitted, you get the general idea by now !)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_listing_tasks_in_light_table&quot;&gt;Listing tasks in Light Table&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The list of tasks is actually retrieved by the Light Table plugin once you select to connect to a gradle project. Furthermore the list is cached in an atom.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::on-gradle-projectinfo
  :desc &quot;Gradle project model information&quot;
  :triggers #{:gradle.projectinfo}
  :reaction (fn [this info]
              (object/merge! groovy {::gradle-project-info info})
              (object/assoc-in! cmd/manager [:commands :gradle.task.select :options] (add-selector))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;When the groovy server has finished retrieving the tasks (and other project info) the above behaviour is triggered in Light Table:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We store the project info in our Groovy object (an atom)
We also update the command for selecting tasks with the new list of tasks. See the section below for details.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::set-selected
  :triggers #{:select}
  :reaction (fn [this v]
              (scmd/exec-active! v)))

(defn selector [opts]
  (doto (scmd/filter-list opts)
    (object/add-behavior! ::set-selected)))

(defn get-tasks []
  (-&amp;gt;@groovy ::gradle-project-info :tasks))

(defn add-selector []
  (selector {:items (get-tasks)
             :key :name
             :transform #(str &quot;&amp;lt;p&amp;gt;&quot; (:name %4) &quot;&amp;lt;/p&amp;gt;&quot;
                              &quot;&amp;lt;p class=&apos;binding&apos;&amp;gt;&quot; (:description %4) &quot;&amp;lt;/p&amp;gt;&quot;)}))

(cmd/command {:command :gradle.task.select
              :desc &quot;Groovy: Select Gradle task&quot;
              :options (add-selector)
              :exec (fn [item]
                      (object/raise groovy :gradle.execute item))})&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The above code adds a sub panel to the default sidebar command panel. When you select the command :gradle.task.select it will show a child panel listing the tasks from the get-tasks function.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2014//lt_gr_tasks.png&quot; alt=&quot;lt gr tasks&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;;; Behavior to actually trigger execution of a selected task from the list above
(behavior ::on-gradle-execute
  :desc &quot;Gradle execute task(s)&quot;
  :triggers #{:gradle.execute}
  :reaction (fn [this task]
              (clients/send
                (clients/by-name &quot;Groovy&quot;)
                :gradle.execute
                {:tasks [(:name task)]})))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Once you have selected a task the above behaviour is triggered. We get hold of an editor agnostic groovy client and send an execute task message with a list of task (currently always just one). The data we send will be extended in the future to support multiple tasks and build arguments.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Server side Task execution&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;// Generic execute task function
def execute(Map params, Closure onComplete) {
    def resultHandler = [
        onComplete: {Object result -&amp;gt;
            onComplete status: &quot;OK&quot;
        },
        onFailure: {GradleConnectionException failure -&amp;gt;
            onComplete status: &quot;ERROR&quot;, error: failure
        }
    ] as ResultHandler


    con.newBuild()
    .addProgressListener(listener)
    .forTasks(params.tasks as String[])
    .run(resultHandler)
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Here we use the asynch features of the Gradle Tooling API. Executing a task may actually take a while so it certainly makes sense. Callers of the execute method will receive a callback (onComplete) once task execution is completed successfully (of failed).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;projectConnection.execute(params) {Map result -&amp;gt;
    ltConnection.sendData([
        null,
        result.status == &quot;ERROR&quot; ? &quot;gradle.execute.err&quot; : &quot;gradle.execute.success&quot;,
        result
    ])
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We invoke the execute method with a closure argument and return the results (success/failure) back to Light Table.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This brings us pretty much up to version 0.0.5&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_summary&quot;&gt;Summary&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Well we covered a lot of ground here. We can now call any class that&amp;#8217;s in your Gradle project&amp;#8217;s class path from a groovy editor in Light Table. We&amp;#8217;ve also started on providing Gradle features that are language agnostic. Starting with support for listing and executing tasks in your gradle project.
We&amp;#8217;ve added decent progress reporting and performance seems to be pretty good too. Looks like we have something we can build further upon !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I have lots of ideas; Infinitesting,  single test with inline results, compile single file, grails integration ? etc etc. I also really want to show project dependencies in a graph. However before I can do any of those things I need to extend the tooling api with custom models &amp;#8230;&amp;#8203; and/or maybe I should see if I can contribute to the gradle project in extending the tooling-api with a richer generic project model.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We&amp;#8217;ll have to wait and see. Next week I&amp;#8217;m off to gr8conf.eu in Copenhagen. Really looking forward to meeting up with all the great Groovy dudes/dudettes.  And who knows maybe the hackergarten evening will result in something new and exciting !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Groovy Light Table Plugin</title>
      <link>http://rundis.github.io/blog/2014/groovy_repl.html</link>
      <pubDate>Mon, 19 May 2014 00:00:00 +0200</pubDate>
      <guid isPermaLink="false">2014/groovy_repl.html</guid>
      	<description>
	&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A short demonstration of the repl like capabilities of my Light Table Groovy plugin (&lt;a href=&quot;https://github.com/rundis/LightTable-Groovy&quot; class=&quot;bare&quot;&gt;https://github.com/rundis/LightTable-Groovy&lt;/a&gt;)&lt;/p&gt;
&lt;/div&gt;
&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;http://www.youtube.com/embed/5ji8RR2A4gQ&quot; frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt;
	</description>
    </item>
    <item>
      <title>A Groovy Light Table client - Step 3: Running out of quick wins</title>
      <link>http://rundis.github.io/blog/2014/gr_lt_part3.html</link>
      <pubDate>Mon, 12 May 2014 00:00:00 +0200</pubDate>
      <guid isPermaLink="false">2014/gr_lt_part3.html</guid>
      	<description>
	&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_background&quot;&gt;Background&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This is the third post in my series &quot;A Groovy Light Table client&quot;. A blog series about steps I take when trying to build a Groovy plugin for Light Table.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_running_out_of_quick_wins&quot;&gt;Running out of quick wins&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;After 0.0.2 of the plugin was released I was pretty happy. I had something that I could actually use as an alternative Groovy Console. However I was keen to keep up the flow so I figured I would try to implement an autocomplete feature. The task proved rather daunting. Not so much from the Light Table side of things, but rather from the Groovy side. First I tried to see if I could reuse anything from GroovySh, but that didn&amp;#8217;t look to promising. After that I tried to get my head around whether I could somehow reuse something from IntelliJ or Eclipse. I failed to see the light so I gave up that endeavour. Secondly I tried to see if there was an easy way to provide an inline documentation feature. Sadly I couldn&amp;#8217;t find much reusable and something with a small foot print here either. Someone should make a REST based doc search feature for Groovy Docs one day !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I turned my attention to a couple of other plugins that I thought would be useful for Light Table. I created a Buster.JS plugin &lt;a href=&quot;https://github.com/busterjs/lt-instabuster&quot;&gt;InstaBuster&lt;/a&gt; for easily running JavaScript tests. I also created a snippets/code templates plugin &lt;a href=&quot;https://github.com/rundis/lt-snippets&quot;&gt;lt-snippets&lt;/a&gt; and some snippet collections, among them a small collection of &lt;a href=&quot;https://github.com/rundis/lt-groovy-snippets&quot;&gt;groovy snippets&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;There is just no way I could ever compete with the mainstream IDE&amp;#8217;s, but then again that was never really the original intention. But even with limited capacity it should still be possible to provide useful groovy support and maybe even something fairly unique within the super hackable framework of Light Table.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_a_small_step_towards_a_groovy_repl&quot;&gt;A (small) step towards a Groovy REPL&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;After working with Light Table and the Clojure/ClojureScript REPL I have grown very fond of that exploratory nature of working. Is there anything I could do with the plugin to give a more REPL like feel ? Well a small but helpful step would be to be able to remember what I previously have evaluated &amp;#8230;&amp;#8203;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_groovy_bindings&quot;&gt;Groovy Bindings&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A simple but still useful mechanism would be to cache bindings from script execution between evals.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;// from the evalGroovy method
def evalResult = scriptExecutor.execute(data.code, clientSessions.get(currentClientId))
clientSessions.put(currentClientId, evalResult.bindings)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Each editor in Light Table gets it&amp;#8217;s own unique Id. So I just created a simple cache &quot;ClientSessions&quot; that hold a map of binding variables, mapped my that Id. When executing a script the current binding variables are applied to the script and after the script has executed the resulting binding variables are added/replaced in the cache. Dead simple really.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_clearing_bindings_light_table&quot;&gt;Clearing bindings - Light Table&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I figured it would be handy to be able to clear any stored bindings. So a new command and behaviour was created in Light Table&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;;; Behavior for clearing bindings
(behavior ::on-clear-bindings
          :desc &quot;Clear cached bindings for this editor&quot;
          :triggers #{:on.clear.bindings}
          :reaction (fn [editor]
                      (let [info (:info @editor)
                            cl (eval/get-client! {:command :editor.clear.groovy
                                                    :origin editor
                                                    :info info
                                                    :create try-connect})]
                          (clients/send cl
                                        :editor.clear.groovy info
                                        :only editor))))

;; Command that allows a new keyboard bindable action for invoking the behaviour above
(cmd/command {:command :clear-bindings
              :desc &quot;Groovy: Clear bindings for current editor&quot;
              :exec (fn []
                      (when-let [ed (pool/last-active)]
                        (object/raise ed :on.clear.bindings)))})&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The command retrieves the currently active editor and triggers the behaviour. The behaviour retrieves a client connection (or creates one if one shouldn&amp;#8217;t exist) and calls the server (groovy).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;// Wiring up the behaviour in groovy.behaviors
:editor.groovy [:lt.plugins.groovy/on-eval
                     :lt.plugins.groovy/on-eval.one
                     :lt.plugins.groovy/on-clear-bindings
                     :lt.plugins.groovy/groovy-res
                     :lt.plugins.groovy/groovy-err
                     [:lt.object/add-tag :watchable]]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The final piece of the puzzle from the Light Table side is to attach the behavior to the :editor.groovy tag. This enables the behavior to be available from any editor that is tagged with this tag.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_clearing_bindings_groovy&quot;&gt;Clearing bindings - Groovy&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;// The command dispatch got a new command
case &quot;editor.clear.groovy&quot;:
   clientSessions.clear(currentClientId)
   break;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The code above will just nuke any stored binding variables.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_conclusions&quot;&gt;Conclusions&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A tiny step that allows you to eval groovy expressions step by step. Anything that results in a binding is stored between evals. Obviously it&amp;#8217;s a bit limited in that you&amp;#8217;ll run into the familiar trap of trying to use def and be surprised(/annoyed) that it won&amp;#8217;t remember that or if you define a class it won&amp;#8217;t remember that either. It&amp;#8217;s probably possible to cater for some of these traps, but maybe not within the realms of a quick win.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Anyways the end result is Version 0.0.3 !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Next steps&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Firstly there is a Screencast brewing. After that I think a Light Table Gradle plugin is coming before the Groovy plugin gets any further updates. A pluggable Gradle plugin would enable the Groovy plugin to quite easily get the class path for you project. This would allow you to  explore your projects code in a REPL (-like) way. Exploratory testing FTW !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Creating and using snippets in Light Table</title>
      <link>http://rundis.github.io/blog/2014/lt-snippets.html</link>
      <pubDate>Tue, 6 May 2014 00:00:00 +0200</pubDate>
      <guid isPermaLink="false">2014/lt-snippets.html</guid>
      	<description>
	&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A short introduction to my Light Table Snippets plugin (&lt;a href=&quot;https://github.com/rundis/lt-snippets&quot; class=&quot;bare&quot;&gt;https://github.com/rundis/lt-snippets&lt;/a&gt;).&lt;/p&gt;
&lt;/div&gt;
&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;http://www.youtube.com/embed/I6iuXOw3HDQ&quot; frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt;
	</description>
    </item>
    <item>
      <title>JavaScript testing with Light Table and Buster.JS</title>
      <link>http://rundis.github.io/blog/2014/instabuster_part2.html</link>
      <pubDate>Mon, 21 Apr 2014 00:00:00 +0200</pubDate>
      <guid isPermaLink="false">2014/instabuster_part2.html</guid>
      	<description>
	&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Second part of the intro to the Light Table Buster plugin (&lt;a href=&quot;https://github.com/busterjs/lt-instabuster&quot; class=&quot;bare&quot;&gt;https://github.com/busterjs/lt-instabuster&lt;/a&gt;)
This time demonstrating some of the more advanced features.&lt;/p&gt;
&lt;/div&gt;
&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;http://www.youtube.com/embed/jYDiAVbPL8I&quot; frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt;
	</description>
    </item>
    <item>
      <title>JavaScript testing with Light Table and Buster.JS</title>
      <link>http://rundis.github.io/blog/2014/instabuster_part1.html</link>
      <pubDate>Mon, 17 Mar 2014 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2014/instabuster_part1.html</guid>
      	<description>
	&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Intro to the Light Table Buster plugin (&lt;a href=&quot;https://github.com/busterjs/lt-instabuster&quot; class=&quot;bare&quot;&gt;https://github.com/busterjs/lt-instabuster&lt;/a&gt;)&lt;/p&gt;
&lt;/div&gt;
&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;http://www.youtube.com/embed/WKHWazblpbc&quot; frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt;
	</description>
    </item>
    <item>
      <title>A Groovy Light Table client - Step 2: Evaluating Code</title>
      <link>http://rundis.github.io/blog/2014/gr_lt_part2.html</link>
      <pubDate>Sun, 23 Feb 2014 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2014/gr_lt_part2.html</guid>
      	<description>
	&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_background&quot;&gt;Background&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This is the second post in my series &quot;A Groovy Light Table client&quot;. A blog series about steps I take when trying to build a Groovy plugin for Light Table.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In this post I will take you through some of the steps I went through to get Light Table to evaluate groovy (script) code and show results inline in the editor.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;/blog/2014//lt_groovy_eval.png&quot; alt=&quot;lt groovy eval&quot;&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_how_did_we_get_here&quot;&gt;How did we get here ?&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_evaluate_contents_of_editor_cmd_ctrl_shift_enter&quot;&gt;Evaluate contents of editor (cmd/ctrl + shift + enter)&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::on-eval
          :desc &quot;Groovy: Eval current editor&quot;
          :triggers #{:eval}
          :reaction (fn [editor]
                      (object/raise groovy :eval! {:origin editor
                                                   :info (assoc (@editor :info)
                                                           :code (ed/-&amp;gt;val editor)
                                                           :meta {:start 0, :end (ed/last-line editor)})})))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This behavior triggers on &quot;:eval&quot;, which is triggered to any editor (on cmd/ctrl + shift + enter in default key mapping). We just get hold of the text from the editor and gather some meta info  and trigger a &quot;:eval!&quot; behavior on the groovy &quot;mother&quot; object defined in the previous blog post.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_evaluate_current_line_selection&quot;&gt;Evaluate current line/selection&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::on-eval.one
          :desc &quot;Groovy: Eval current selection&quot;
          :triggers #{:eval.one}
          :reaction (fn [editor]
                      (let [pos (ed/-&amp;gt;cursor editor)
                            info (conj (:info @editor)
                                  (if (ed/selection? editor)
                                    {:code (ed/selection editor) :meta {:start (-&amp;gt; (ed/-&amp;gt;cursor editor &quot;start&quot;) :line)
                                                                        :end (-&amp;gt; (ed/-&amp;gt;cursor editor &quot;end&quot;) :line)}}
                                    {:pos pos :code (ed/line editor (:line pos)) :meta {:start (:line pos) :end (:line pos)}}))]
                        (object/raise groovy :eval! {:origin editor :info info}))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The only difference here is that we gather the code for the current line or current selection. Then we trigger the same behavior as for evaluating the whole editor.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_our_groovy_eval&quot;&gt;Our groovy Eval!&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::eval!
          :triggers #{:eval!}
          :reaction (fn [this event]
                      (let [{:keys [info origin]} event
                            client (-&amp;gt; @origin :client :default)]
                        (notifos/working &quot;Evaluating groovy...&quot;)
                        (clients/send (eval/get-client! {:command :editor.eval.groovy
                                                         :origin origin
                                                         :info info
                                                         :create try-connect})
                                      :editor.eval.groovy info
                                      :only origin))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This behavior is what actually sends off a eval request to the groovy client. Quite a lot happens under the hood (by help of inbuilt LightTable behaviors):&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;It tries to find a client (connection) for the editor
If no connection exists it will try to create a new one. On create it will invoke the try-connect function that we defined for the gui connect/connect bar behavior in the previous blog post
Once connected it will jsonify our parameters and send them off to our groovy client&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;The JSON might look something like:&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;[89,
&quot;editor.eval.groovy&quot;,
  {&quot;line-ending&quot;:&quot;\n&quot;,
   &quot;name&quot;:&quot;sample.groovy&quot;,
   &quot;type-name&quot;:&quot;Groovy&quot;,
   &quot;path&quot;:&quot;/Users/mrundberget/Library/Application Support/LightTable/plugins/Groovy/sample.groovy&quot;,
   &quot;mime&quot;:&quot;text/x-groovy&quot;,
   &quot;tags&quot;:[&quot;editor.groovy&quot;],
   &quot;code&quot;:&quot;println \&quot;hello\&quot;&quot;,
   &quot;meta&quot;:{&quot;start&quot;:22,&quot;end&quot;:22}}]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Notes&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;The first param is the client id for the editor that triggered the behavior. This client Id doesn&amp;#8217;t represent the same as a connection id (ref previous blog post). Many editors may share the same connection !&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The second param is the command (our groovy client will of course support many different commands, this is one of them)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The third and last parameter is our info. The code is the essential bit, but some of the meta information, like line info comes in handy when handling the response later on&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_the_actual_groovy_evaluation&quot;&gt;The actual groovy evaluation&lt;/h3&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_command_dispatch&quot;&gt;Command dispatch&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;ltClient.withStreams { input, output -&amp;gt;
  try {
    input.eachLine { line -&amp;gt;
    def (currentClientId, command, data) = new JsonSlurper().parseText(line)
    switch (command) {
    case &quot;client.close&quot;:
      stop()
      break
    case &quot;editor.eval.groovy&quot;:
      evalGroovy(data, currentClientId)
      break
   default:
     log &quot;Invalid command: $command&quot;
  }
  // ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We parse any lines received from Light Table and based on the command received invokes the appropriate handler. In this case evalGroovy.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_eval_groovy&quot;&gt;Eval groovy&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;private void evalGroovy(data, currentClientId) {
  def evalResult = scriptExecutor.execute(data.code)

  def resultParams = [meta: data.meta]
  if (evalResult.out) {
    resultParams &amp;lt;&amp;lt; [out: evalResult.out]
  }
  if(evalResult.exprValues) {
    resultParams &amp;lt;&amp;lt; [result: convertToClientVals(evalResult.exprValues)]
  }

  if (!evalResult.err) {
    data = [currentClientId?.toInteger(), &quot;groovy.res&quot;, resultParams]
  } else {
    data = [currentClientId?.toInteger(), &quot;groovy.err&quot;, [ex: evalResult.err] + resultParams]
  }
  sendData data
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The first and most significant line is where we evaluate the groovy code received. This post would be too long if we went into all the details of what it does, but here&amp;#8217;s a high-level summary:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We basically create a GroovyShell and compile our code to a script. Normally that would just compile a Script class. However we  wish to collect a lot more information than you typically would get from default groovy script execution. So we do an AST transformation on the script class and add a custom abstract script class as a base class for the compiled script class.  This allows us to inject behavior and wrap statement execution (all compiled into the script for optimal performance).  That way we are able to collect information about values for most types of statements. We collect line number and value (each line could end up having many values :-) )
We run the script (capturing system.out and system.err).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;The function returns:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Anything written to standard out (println etc)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Errors if any and line number for error where possible&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;A list for of maps with line number and value(s)&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Most of the AST stuff is not something I&amp;#8217;ve written. It&amp;#8217;s been contributed by Jim White after I posted a question on the groovy-user mailing list. I asked for advice on which way to proceed and the response from the groovy community was awesome. Jim in particular was more than eager to contribute to the plugin. OpenSource rocks ! So when I say we, I sometimes mean we literally.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Anyways, based on the results of the script execution we notify Light Table to trigger either a &quot;:groovy.res&quot; behavior or a &quot;groovy.err&quot; behavior.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The json response for sendData for a successful execution might look something like:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;[89,
 &quot;groovy.res&quot;,
 {&quot;meta&quot;:{&quot;start&quot;:22,&quot;end&quot;:23},&quot;out&quot;:&quot;hello\nmama\n&quot;,&quot;result&quot;:[{&quot;line&quot;:1,&quot;values&quot;:[&quot;null&quot;]},{&quot;line&quot;:2,&quot;values&quot;:[&quot;null&quot;]}]}]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_handling_the_evaluation_results_in_light_table&quot;&gt;Handling the evaluation results in Light Table&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn notify-of-results [editor res]
  (doseq [ln (:result res)]
    (let [lineNo (+ (:line ln) (-&amp;gt; res :meta :start) -1)]
      (object/raise editor :editor.result (clojure.string/join &quot; &quot; (:values ln)) {:line lineNo :start-line lineNo}))))

(behavior ::groovy-res
          :triggers #{:groovy.res}
          :reaction (fn [editor res]
                      (notifos/done-working)
                      (when-let [o (:out res)] (.log js/console o))
                      (notify-of-results editor res)))

(defn notify-of-error [editor res]
  (let [lineNo (+ (-&amp;gt; res :ex :line) (-&amp;gt; res :meta :start) -1)]
    (object/raise editor :editor.exception (:ex res) {:line lineNo :start-line lineNo&apos;})))

(behavior ::groovy-err
          :triggers #{:groovy.err}
          :reaction (fn [editor res]
                      (object/raise editor :groovy.res res)
                      (notify-of-error editor res)))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;These are the behavior definitions that handles either successful or evaluation of scripts with errors. Basically we:
Print to the Light Table Console anything that was captured to system.out/system.err by our groovy evaluation
Show inline results for each line, multiple results for a line are space separated. For showing inline results we are using a predefined Light Table behavior (:editor.result)
If the behavior is to handle an error, we show evaluation results up until the script exception. In addition we display details (stack trace) for the exception at the line in the script it occurred&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_wiring_it_all_up&quot;&gt;Wiring it all up&lt;/h3&gt;
&lt;div class=&quot;sect3&quot;&gt;
&lt;h4 id=&quot;_groovy_behaviors&quot;&gt;groovy.behaviors&lt;/h4&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;{:+ {:app [(:lt.objs.plugins/load-js [&quot;codemirror/groovy.js&quot;, &quot;groovy_compiled.js&quot;])]
     :clients []
     :editor.groovy [:lt.plugins.groovy/on-eval
                     :lt.plugins.groovy/on-eval.one
                     :lt.plugins.groovy/groovy-res
                     :lt.plugins.groovy/groovy-err
                     [:lt.object/add-tag :watchable]]
     :files [(:lt.objs.files/file-types
              [{:name &quot;Groovy&quot; :exts [:groovy] :mime &quot;text/x-groovy&quot; :tags [:editor.groovy]}])]
     :groovy.lang [:lt.plugins.groovy/eval!
                   :lt.plugins.groovy/connect]}}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The eval and results/err behaviors are defined for the editor tag. So they are only applicable for editors marked as groovy editors. Any editor open with a file name ending in .groovy will automatically be attached to a editor.groovy tag. (You can also set it manually cmd+space &amp;#8594; &quot;Editor: Set current editor syntax&quot;).
The &quot;:eval!&quot; behavior is defined for the :groovy.lang tag. Its tied to our groovy mother object just like the connect behavior. These behaviors are totally groovy client specific, whilst the other behaviors are less so (although not exactly generic as they are now…)&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_wrap_up&quot;&gt;Wrap up&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;A little bit of plumbing was needed to get this set up. But the hard parts was really coming up with the groovy AST transformation stuff. I guess by now you might have started getting an inkling that Light Table is fairly composable ? It really is super flexible. You don&amp;#8217;t like the behavior for handling inline results for the groovy plugin ? You could easily write your own and wire it up in your user.behaviors file in Light Table. It&amp;#8217;s wicked cool, actually it really is your editor !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Yesterday I released version 0.0.2 of the Groovy LightTable plugin. Its available through the Light Table plugin manager, or if you wish to play with the code or maybe feel like contributing feel free to fork the repo at : &lt;a href=&quot;https://github.com/rundis/LightTable-Groovy&quot; class=&quot;bare&quot;&gt;https://github.com/rundis/LightTable-Groovy&lt;/a&gt;. Pull requests are welcome.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So where to next ? I&amp;#8217;d really like to try and create an InstaRepl editor for the plugin. A groovy script editor that evaluates code as you type. There&amp;#8217;s gotta be one or two challenges related to that. A quick win might be to provide groovy api documentation from inside Light Table. I&amp;#8217;ll let you know what happens in the next post.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;admonitionblock note&quot;&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td class=&quot;icon&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Note&lt;/div&gt;
&lt;/td&gt;
&lt;td class=&quot;content&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Disclaimer: I might have misunderstood some nuances of Light Table, but hopefully I&amp;#8217;m roughly on track. If you see anything glaringly wrong, do let me know.&lt;/p&gt;
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>A Groovy Light Table client - Step 1: Connecting the client</title>
      <link>http://rundis.github.io/blog/2014/gr_lt_part1.html</link>
      <pubDate>Sun, 16 Feb 2014 00:00:00 +0100</pubDate>
      <guid isPermaLink="false">2014/gr_lt_part1.html</guid>
      	<description>
	&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_building_a_plugin_in_light_table&quot;&gt;Building a plugin in Light Table&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This is the first post in (hopefully) a series of blog posts about the various steps I go through when trying to create a plugin for Light Table. I have decided to try to create a Groovy plugin. I chose Groovy to ensure there was at least one technology fairly familiar to me. I have just started using Light Table, I have no previous experience with ClojureScript and I have just recently started writing some Clojure beyond the basic tutorials.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The short term goal is for the plugin to provide inline results and maybe an instarepl of some sort for groovy scripts.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/rundis/LightTable-Groovy&quot;&gt;LightTable-Groovy&lt;/a&gt; is the name of my plugin project and you can find the latest source there. It might be a couple of steps ahead of the blog posts though !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_documentation&quot;&gt;Documentation&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Light Table was made &lt;a href=&quot;http://www.chris-granger.com/2014/01/07/light-table-is-open-source/&quot;&gt;open source&lt;/a&gt; in january and documentation for plugin developers is a little sparse.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;So to have something to go by I decided to use some of the other language plugins as inspiration:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/LightTable/Python&quot;&gt;Python plugin&lt;/a&gt; (comes bundled/under the light table umbrella)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/existentialmutt/lt-ruby&quot;&gt;Ruby Instarepl&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/jetaggart/light-haskell&quot;&gt;Haskell plugin&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I haven&amp;#8217;t worked with any of the above mentioned languages, but they did provide enough inspiration to deduce how a Light Table client might interact.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;BTW. A quick starter just to get you up an running with a hello world plugin could be this screen cast by Mike Haney.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_connecting_a_client_process_overview&quot;&gt;Connecting a client - Process overview&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Before we dwelve into the code It&amp;#8217;s a good idea to have a high level understanding of what we are trying to achieve !&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;A couple of use cases that needs to be supported:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Evaluate current selection or current line of groovy code and present results (preferably inline)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Evaluate contents of current editor and present results&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Provide as much info about the results of each statement as possible&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;(Maybe need to evaluate line/statement by statement)&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;For a future instarepl, any change in the editor will trigger an evaluation
It becomes evident that our plugin needs to provide some kind of process that reacts to events from light table.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;olist arabic&quot;&gt;
&lt;div class=&quot;title&quot;&gt;A default pattern for achieving this has been devised for Light Table and roughly equates to the following steps:&lt;/div&gt;
&lt;ol class=&quot;arabic&quot;&gt;
&lt;li&gt;
&lt;p&gt;A connect event is triggered from Light Table (you need to set up your plugin to trigger that event…). Typically the connect event can be invoked manually from the connect bar in light table, or it can be triggered implicetly when evaluating code.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;You fire of a process - Using inbuilt support from Light Table you start a process either a shell script or whatever really. I created a shell script that sets some environment stuff and then basically kicks off a groovy script. Light table provides a tcp/ip port and a unique client id which you need to forward to the process.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Create a tcp client: In your process you create a tcp client using the given port&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Send ack message: Send a json message with client id and an event name (behavior) to Light Table (through the tcp connection!)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Confirm handshake for process: In your process (i.e. not the tcp connection!) write &quot;Connected&quot; to standard out. (&quot;Connected&quot; is just what the other plugins use, you could use  anything you like as long as it matches the connect behaviors(handlers) you provide inside light table.)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Listen for events: Now you are connected and given you have set up your behaviors in Light Table correctly, your new connection should be reported as connected and shown in the Light Table connect bar. Now you listen for events on your tcp client and provides appropriate responses back to Light Table accordingly. (Handling this is the subject of a future blog post)&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_behaviors_for_connecting_from_groovy_cljs&quot;&gt;Behaviors for connecting (from groovy.cljs):&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(defn run-groovy[{:keys [path name client] :as info}]
  (let [obj (object/create ::connecting-notifier info)
        client-id (clients/-&amp;gt;id client)
        project-dir (files/parent path)]
    (object/merge! client {:port tcp/port
                           :proc obj})
    (notifos/working &quot;Connecting..&quot;)
    (proc/exec {:command binary-path
                :args [tcp/port client-id project-dir]
                :cwd plugin-dir
                :env {&quot;GROOVY_PATH&quot; (files/join (files/parent path))}
                :obj obj})))

(defn check-groovy[obj]
  (assoc obj :groovy (or (::groovy-exe @groovy)
                         (.which shell &quot;groovy&quot;))))

(defn check-server[obj]
  (assoc obj :groovy-server (files/exists? server-path)))

(defn handle-no-groovy [client]
  (clients/rem! client)
  (notifos/done-working)
  (popup/popup! {:header &quot;We couldn&apos;t find Groovy.&quot;
                 :body &quot;In order to evaluate in Groovy files, Groovy must be installed and on your system PATH.&quot;
                 :buttons [{:label &quot;Download Groovy&quot;
                            :action (fn []
                                      (platform/open &quot;http://gvmtool.net/&quot;))}
                           {:label &quot;ok&quot;}]}))

(defn notify [obj]
  (let [{:keys [groovy path groovy-server client]} obj]
    (cond
     (or (not groovy) (empty? groovy)) (do (handle-no-groovy client))
     :else (run-groovy obj))
    obj))

(defn check-all [obj]
  (-&amp;gt; obj
      (check-groovy)
      (check-server)
      (notify)))

(defn try-connect [{:keys [info]}]
  (.log js/console (str &quot;try connect&quot; info))
  (let [path (:path info)
        client (clients/client! :groovy.client)]
    (check-all {:path path
                :client client})
    client))


(object/object* ::groovy-lang
                :tags #{:groovy.lang})


(def groovy (object/create ::groovy-lang))

(scl/add-connector {:name &quot;Groovy&quot;
                    :desc &quot;Select a directory to serve as the root of your groovy project... then again it might not be relevant...&quot;
                    :connect (fn []
                               (dialogs/dir groovy :connect))})
(behavior ::connect
                  :triggers #{:connect}
                  :reaction (fn [this path]
                              (try-connect {:info {:path path}})))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Notes:&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;scl/add-connector: This statement adds a connect dialog to our groovy plugin. You select a root directory and upon selection the ::connect behavior is triggered&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;::connect basically responds with invoking a method for connecting. This does some sanity checks and if all goes well ends up invoking  run-groovy.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;run-groovy : Fires up our groovy (server) process&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;def groovy   is basically the &quot;mother&quot; object of our plugin. It helps us scope behaviors and commands&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_the_server_part_ltserver_groovy&quot;&gt;The server part (LTServer.groovy)&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;import groovy.json.*

params = [
  ltPort:   args[0].toInteger(),
  clientId: args[1].toInteger() // light table generated id for the client (connection)
]

logFile = new File(&quot;server.log&quot;)

def log(msg) {
  logFile &amp;lt;&amp;lt; &quot;${new Date().format(&apos;dd.MM.yyyy mm:hh:sss&apos;)} - $msg\n&quot;
}

client = null
try {
  client = new Socket(&quot;127.0.0.1&quot;, params.ltPort)
} catch (Exception e) {
  log &quot;Could not connect to port: ${params.ltPort}&quot;
  throw e
}

def sendData(data) {
  client &amp;lt;&amp;lt; new JsonBuilder(data).toString() + &quot;\n&quot;
}
// ack to Light Table
sendData (
  [
    name: &quot;Groovy&quot;,
    &quot;client-id&quot;: params.clientId,
    dir: new File(&quot;&quot;).absolutePath,
    commands: [&quot;editor.eval.groovy&quot;],
    type: &quot;groovy&quot;
  ]
)
println &quot;Connected&quot; // tells lighttable we&apos;re good

client.withStreams {input, output -&amp;gt;
  while(true) {
  // insert code to listen for events from light table and respond to those (eval code etc)
  }
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_notification_of_successful_connection&quot;&gt;Notification of successful connection&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;(behavior ::on-out
          :triggers #{:proc.out}
          :reaction (fn [this data]
                      (let [out (.toString data)]
                        (object/update! this [:buffer] str out)
                        (if (&amp;gt; (.indexOf out &quot;Connected&quot;) -1)
                          (do
                            (notifos/done-working)
                            (object/merge! this {:connected true}))
                          (object/update! this [:buffer] str data)))))

(behavior ::on-error
          :triggers #{:proc.error}
          :reaction (fn [this data]
                      (let [out (.toString data)]
                        (when-not (&amp;gt; (.indexOf (:buffer @this) &quot;Connected&quot;) -1)
                          (object/update! this [:buffer] str data)
                          ))
                      ))

(behavior ::on-exit
          :triggers #{:proc.exit}
          :reaction (fn [this data]
                      ;(object/update! this [:buffer] str data)
                      (when-not (:connected @this)
                        (notifos/done-working)
                        (popup/popup! {:header &quot;We couldn&apos;t connect.&quot;
                                       :body [:span &quot;Looks like there was an issue trying to connect
                                              to the project. Here&apos;s what we got:&quot; [:pre (:buffer @this)]]
                                       :buttons [{:label &quot;close&quot;}]})
                        (clients/rem! (:client @this)))
                      (proc/kill-all (:procs @this))
                      (object/destroy! this)
                      ))

(object/object* ::connecting-notifier
                :triggers []
                :behaviors [::on-exit ::on-error ::on-out]
                :init (fn [this client]
                        (object/merge! this {:client client :buffer &quot;&quot;})
                        nil))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The above behaviors basically handles signaling success, error or connection exits for our groovy client. As you can see in ::on-out this is where we check standard out from the process for the string &quot;Connected&quot;, to signal success.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_wiring_up_behaviors_behaviors_groovy&quot;&gt;Wiring up behaviors (behaviors.groovy)&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-clojure&quot; data-lang=&quot;clojure&quot;&gt;{:+ {:app [(:lt.objs.plugins/load-js [&quot;codemirror/groovy.js&quot;, &quot;groovy_compiled.js&quot;])]
     :clients []
     :editor.groovy []
     :files [(:lt.objs.files/file-types
              [{:name &quot;Groovy&quot; :exts [:groovy] :mime &quot;text/x-groovy&quot; :tags [:editor.groovy]}])]
     :groovy.lang [:lt.plugins.groovy/connect]}}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The important part in terms on the connection is the wiring of the connect behavior to &quot;:groovy.lang&quot;. This is needed for groovy to appear as a connection item in the light table connect bar.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&quot;codemirror/groovy.js&quot; deserves a special mention. This is what provides syntax highlighting for our groovy files (defined in the :files vector). The syntax highlighting is provided by the groovy mode module from CodeMirror.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_wrapping_up&quot;&gt;Wrapping up&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So what have we achieved. Well we now have a connection to Light Table from an external process that can listen and respond to events from Light Table. For the purposes of this blog post series, its a Groovy client that hopefully pretty soon will be able to evaluate groovy scripts and respond with evaluation results. We didn&amp;#8217;t pay much attention to it, but we also got syntax highlighting of our Groovy files complements of CodeMirror.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;It took a while to grok how the connection part worked. Once I did understand roughly what was needed I was a bit annoyed with myself for messing about so much. I&amp;#8217;m hoping this post might help others to avoid some of the mistakes I stumbled into.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>
    <item>
      <title>Javascript testing in your JVM projects using Gradle and BusterJS</title>
      <link>http://rundis.github.io/blog/2013/buster-plugin.html</link>
      <pubDate>Mon, 19 Aug 2013 00:00:00 +0200</pubDate>
      <guid isPermaLink="false">2013/buster-plugin.html</guid>
      	<description>
	&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;When I first started looking at testing in javascript land a while back I quickly felt lost in space.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Filled with questions like;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;which framework(s) to choose ?&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;how do I get framework x to work from my IDE ?&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;more importantly how to I manage to include the javascript tests in my CI builds ?&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;how can I avoid repetitive setup pain across projects ?&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;why is it such a hassle getting started ?&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I can&amp;#8217;t say I have answered any of the questions above fully, but I have taken some strides in the right direction.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_buster_js&quot;&gt;Buster.JS&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;a href=&quot;http://docs.busterjs.org/en/latest/&quot;&gt;Buster&lt;/a&gt; is a flexible and modularized framework for writing and running your JavaScript tests.
There are others out there, but from what I could gather and based on advice from my frontend wizard colleagues I decided to give it a good go. It&amp;#8217;s still in beta, but from my experiences so far its more than mature enough for proper use in projects.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_a_few_important_aspects_about_buster_js&quot;&gt;A few important aspects about Buster.JS:&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Tests are run in real browsers (phantomjs for headless). No emulation bull
You can run tests in multiple browsers in parallell
Its really really fast
Write tests in the fashion that suits you (xUnit or spec)
Nice assertion library and integrated with Sinon.JS (powerful stubbing and spying)
&amp;#8230;&amp;#8203; and lots more&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_gradle_buster_plugin&quot;&gt;Gradle buster plugin&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;For my jvm project builds I use Gradle. Maven and Ant projects that spend time with me a few weeks tend to find themselves converted. So I set out to create a buster plugin for gradle, aptly named gradle-buster-plugin. Still early days, but already it has started to prove quite valuable.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;div class=&quot;title&quot;&gt;The plugin has two high-level goals;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Allow you to easily run javascripts as part of your CI builds&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Provide you with a smooth development experience by adding value on top of whats already present in Buster.JS.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The homepage for the pluging is here: &lt;a href=&quot;https://github.com/rundis/gradle-buster-plugin&quot; class=&quot;bare&quot;&gt;https://github.com/rundis/gradle-buster-plugin&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_what_do_i_have_to_do_aka_getting_started&quot;&gt;What do I have to do ? (aka getting started)&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_installing_preconditions&quot;&gt;Installing preconditions&lt;/h3&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Install node.js/npm - Mac: $ brew install node&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Install Buster.JS  - $ npm install buster -g&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Install Phantom.JS  - Mac: $ brew install phantomjs&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_set_up_the_buster_plugin_in_your_gradle_config&quot;&gt;Set up the buster plugin in your gradle config&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;buildscript {
    repositories { jcenter() }
    dependencies {
        classpath  &apos;org.gradle.buster:gradle-buster-plugin:0.2.4.1&apos;
    }
}

apply plugin: &apos;war&apos; // just assuming you have a war project
apply plugin: &apos;buster&apos;

build.dependsOn busterTest // hook up javascript task in the build&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_set_up_a_buster_js_configuration_file&quot;&gt;Set up a buster.js configuration file&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;var config = module.exports;

config[&quot;Sample JSTests&quot;] = {
    environment: &quot;browser&quot;,

    libs: [&quot;src/main/webaapp/js/libs/jquery-1.10.2.js&quot;],
    sources: [&quot;src/main/web-app/js/app/**/*.js&quot;],
    tests: [&quot;src/test/js/**/*-test.js&quot;]
};&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_sample_unit&quot;&gt;Sample unit&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So you could create a file like src/main/webapp/js/app/dummy-service.js&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;var myapp = this.myapp || {};
myapp.services = app.services || {};
(function () {
    myapp.services.DummyService = function (my) {
        my.listTodos = function(success, error) {
            $.get(&apos;/todos/list&apos;)
               .done(function(data) {
                  success(data);
               })
               .fail(function(jqXHR, textStatus, errorThrown) {
                  error(&quot;Error getting todos&quot;)
               });
        };
        return my;
    }(myapp.services.DummyService || {});
}());&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_sample_unit_test&quot;&gt;Sample unit test&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Create a corresponding unit test in src/test/js/app/dummy-service-test.js&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;(function () {
    buster.testCase(&quot;DummyService&quot;, {
        setUp: function() {
            this.service = myapp.services.DummyService;
            this.server = sinon.fakeServer.create();
            this.success = this.spy();
            this.error = this.spy();
        },
        tearDown: function () {
            this.server.restore();
        },
        &quot;should successfully list todos&quot;: function () {
            this.service.listTodos(this.success, this.error);
            this.server.requests[0].respond(
                200,
                { &quot;Content-Type&quot;: &quot;application/json&quot; },
                JSON.stringify([{ id: 1, text: &quot;Provide examples&quot;, done: true }])
            );

            assert.calledOnce(this.success);
        },
        &quot;should invoke error callback on errors&quot;: function () {
            this.service.listTodos(this.success, this.error);
            this.server.requests[0].respond(
                500,
                { &quot;Content-Type&quot;: &quot;application/json&quot; },
                JSON.stringify([{ id: 1, text: &quot;dummy&quot;, done: true }])
            );

            assert.calledOnce(this.error);
        }
    });
}());&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_running_the_tests_locally&quot;&gt;Running the tests locally&lt;/h3&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;$ gradle busterTest&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Test results are found in : build/busterTest-results/bustertests.xml&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Autotesting
When doing your tdd cycles its quite useful to use the autotest feature (kinda like infinitest).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;$ gradle busterAutoTest&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Will leave the server running and listen for file changes in the patterns specified by the buster.js file above. So if I change the test or unit above a test run will automatically be fired off and results reported to the console. Its pretty fast so you should be able to keep a good flow going !
Just do Ctrl + C to kill the autotesting.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Multiple browsers
Its quite easy to set up just see the readme for the plugin&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;CI Server
Obviously you will need to set up the preconditions. If you&amp;#8217;re server isn&amp;#8217;t headless you have the option of testing with a few proper browsers(firefox and chrome on linux, safari if your server is mac&amp;#8230;&amp;#8203; which I doubt).&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;_conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Its certainly not perfect, but with the above you have a pretty good start. Once you get over the hurdle of setting up the preconditions it really is quite pleasant to work with. You should be amazed by the performance of the tests runs if you are from a jvm background.
What about IDE integration ? With the autotest feature I can&amp;#8217;t say I have missed it much. I have my IDE and a visible console available and get instant feedback on saves in my IDE.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Smooth !&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>

  </channel>
</rss>
