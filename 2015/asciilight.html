<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Scratching my AsciiDoc itch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <link href="/blog/css/bootstrap.min.css" rel="stylesheet">
    <link href="/blog/css/asciidoctor.css" rel="stylesheet">
    <link href="/blog/css/base.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href="/blog/css/prettify.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/blog/assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/blog/assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/blog/assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/blog/assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../favicon.ico">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-58695124-1', 'auto');
      ga('send', 'pageview');

    </script>
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog/index.html">Rundis</a>
        </div>
        <div class="navbar-collapse collapse bs-navbar-collapse">
            <ul class="nav navbar-nav">
                <li><a href="/blog/archive.html">Archive</a></li>
                <li><a href="/blog/about.html">About</a></li>
                <li><a href="/blog/feed.xml">Subscribe</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="https://github.com/rundis/blog"><i class="fa fa-lg fa-github"></i></a>
                </li>
            </ul>
        </div>
    </div>
</div>
<div class="container">

	<div class="page-header">
		<h1>Scratching my AsciiDoc itch</h1>
	</div>

	<p><em>15 February 2015</em></p>
  <p><em>Tags: </em>
    <a href="/blog/tags/clojurescript.html">clojurescript</a>
  </em>
    <a href="/blog/tags/node.html">node</a>
  </em>
    <a href="/blog/tags/javascript.html">javascript</a>
  </p>
  <a href="https://twitter.com/share" class="twitter-share-button"
    data-url="http://rundis.github.io/blog/2015/asciilight.html"
    data-via="mrundberget"
    data-lang="en">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

	<p><div class="sect1">
<h2 id="_background">Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So I have been writing my previous blog posts in <a href="http://asciidoctor.org/">AsciiDoc</a> using <a href="https://github.com/LightTable/LightTable">Light Table</a>.
AsciiDoc is really great and I haven&#8217;t regretted using it for my blog at any point in time. To create my blog site
I&#8217;m using <a href="http://jbake.org/">Jbake</a> and its all published to github (gh-pages). To preview my blog posts while writing I either
had to start a separate browser window (with a AsciiDoc browser plugin) or I had to set up a gradle watch task and
use something like SimpleHttpServer to serve my "baked" site locally.</p>
</div>
<div class="paragraph">
<p>I&#8217;m probably still going to test my site locally, but I really felt a need for something similar to the <a href="https://github.com/MarcoPolo/lt-markdown" class="bare">https://github.com/MarcoPolo/lt-markdown</a>
plugin.</p>
</div>
<div class="quoteblock">
<blockquote>
I wish I had an editor where I could easily program my own extensions.
</blockquote>
<div class="attribution">
&#8212; Magnus Rundberget<br>
<cite>A few years back</cite>
</div>
</div>
<div class="paragraph">
<p>I guess I&#8217;m just lucky, but whacking something together wasn&#8217;t really that hard. I thought I&#8217;d share my experience.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_technology">Technology</h2>
<div class="sectionbody">
<div class="paragraph">
<p>AsciiDoctor comes with JavaScript support through <a href="https://github.com/asciidoctor/asciidoctor.js">asciidoctor.js</a>. It even comes
with support for node. Light Table runs on Node (node webkit, soon Atom Shell ?). Light Table plugins are written in
ClojureScript, I much prefer ClojureScript to JavaScript or CoffeeScript for that matter. Anyways I&#8217;m digressing, calling
node modules from a Light Table is no big deal.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_solution">Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The end result became a new plugin for Light Table. <a href="https://github.com/rundis/AsciiLight">AsciiLight</a></p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2015//asciilight_preview.png" alt="asciilight preview">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I pretty much nicked most of the ClojureScript code from <a href="https://github.com/MarcoPolo/lt-markdown" class="bare">https://github.com/MarcoPolo/lt-markdown</a>. Cheers Marco Polo !
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_calling_asciidoctor_js">Calling asciidoctor.js</h3>
<div class="paragraph">
<p>For reasons unknown to me I had some troubles calling the Objects/functions needed from asciidoctor.js
directly from ClojureScript so I had to make a thing JavaScript wrapper my self. No big deal, but
I&#8217;d be interested to find out why it croaked.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">var asciidoctor = require('asciidoctor.js')();
var processor = asciidoctor.Asciidoctor(true);     <i class="conum" data-value="1"></i><b>(1)</b>
var opal = asciidoctor.Opal;


var doConvert = function(content, baseDir) {
  var opts = opal.hash2(
      ['base-dir', 'safe', 'attributes'],
      {'base-dir': baseDir,
       'safe': 'secure',
        attributes: ['icons=font@', 'showtitle']});

    return  processor.$convert(content, opts);     <i class="conum" data-value="2"></i><b>(2)</b>
};

module.exports = {
  convert: function(content, baseDir) {
    return doConvert(content, baseDir);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Load Node module and configure AsciiDoctor to support extensions</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The function where we actually call asciidoctor</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There was a lot of trial and error to figure out what to call the options and how to pass
these options to asciidoctor. Some seemed to work others seemed to have no effect. To be improved
in a future release for sure. The most painful part here was that I couldn&#8217;t figure out how to reload
my custom node module &#8230;&#8203; hence a lot of Light Table restarts. Surely there must be a better way.</p>
</div>
</div>
<div class="sect2">
<h3 id="_plugin_code">Plugin code</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">defn setAdocHTML! [ed obj]
  (let [html (-&gt;
              (adoc-&gt;html (.getValue (editor/-&gt;cm-ed ed))
                          (files/parent (-&gt; @ed :info :path)))                     <i class="conum" data-value="1"></i><b>(1)</b>
              (s/replace #"class=\"content\"" "class=\"adoc-content\""))]
    (set! (.-innerHTML (object/-&gt;content obj)) html)))                             <i class="conum" data-value="2"></i><b>(2)</b>

(defn get-filename [ed]
  (-&gt; @ed :info :name))

(defui adoc-skeleton [this]
  [:div {:class "adoc"}
   [:h1 "Asciidoc content coming here"]])

(object/object* ::asciilight                                                       <i class="conum" data-value="3"></i><b>(3)</b>
                :tags [:asciilight]
                :name "markdown"
                :behaviors [::on-close-destroy]
                :init (fn [this filename]
                        (object/update! this [:name] (constantly (str filename " - Live")))
                        (adoc-skeleton this)))

(behavior ::on-close-destroy                                                       <i class="conum" data-value="4"></i><b>(4)</b>
          :triggers #{:close}
          :reaction (fn [this]
                      (when-let [ts (:lt.objs.tabs/tabset @this)]
                        (when (= (count (:objs @ts)) 1)
                          (tabs/rem-tabset ts)))
                      (object/raise this :destroy)))

(behavior ::read-editor                                                            <i class="conum" data-value="5"></i><b>(5)</b>
          :triggers [:change ::read-editor]
          :desc "AsciiLight: Read the content inside an editor"
          :reaction (fn [this]
                      (let [adoc-obj (:adoc @this)]
                        (setAdocHTML! this adoc-obj))))

(cmd/command {:command ::watch-editor                                              <i class="conum" data-value="6"></i><b>(6)</b>
              :desc "AsciiLight: Watch this editor for changes"
              :exec (fn []
                      (let [ed (pool/last-active)
                            filename (get-filename ed)
                            adoc-obj (object/create ::asciilight filename)]
                        (tabs/add-or-focus! adoc-obj)
                        (object/update! ed [:adoc] (fn [] adoc-obj))
                        (object/add-behavior! ed ::read-editor)
                        (object/raise ed ::read-editor)))})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retrieve whatever is in the given editor ed and request ascidoctor.js to make nice html from it.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Insert the generated html into the preview viewer</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>An atom that holds the markup used for the preview. Destroyed when its owning tab is closed.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Behavior that is triggered when the tab (or LightTable) is closed. Performs cleanup as one should !</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Behavior that is triggered whenever the user changes the content of the editor being watched. For large documents
we might want to introduce a throttle on this behaviour.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>This i the command you see in the command bar in Light Table. It&#8217;s the entry point for the plugin currently and
is responsible for adding a new tab and setting up the link between the editor to be watched and the preview tab.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s pretty manageable for something quite usable.</p>
</div>
</div>
<div class="sect2">
<h3 id="_behaviors_and_a_note_on_css">Behaviors and a note on CSS</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">[[:app :lt.objs.plugins/load-js "asciilight_compiled.js"]
 [:app :lt.objs.plugins/load-css "css/font-awesome.css"]
 [:app :lt.objs.plugins/load-css "css/adoc.css"]]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we load the transpiled javascript for our plugin, css icon support throught font-awesome and
a slightly customized css for our asciidoc preview.</p>
</div>
<div class="sect3">
<h4 id="_css_the_cascading_part_you_know">CSS, the cascading part you know.</h4>
<div class="paragraph">
<p>AsciiDoc ships with a default CSS you may use (it even has a <a href="https://github.com/asciidoctor/asciidoctor-stylesheet-factory">stylesheet factory</a>)
That&#8217;s cool. Light Table also has styles, hey it even has lots of skins.
So I had to spend some time ensuring that the css I added through the plugin didn&#8217;t mess up the
user selected styles from Light Table. For instance both LIght Table and AsciiDoc found good use for a css class called content.</p>
</div>
<div class="paragraph">
<p>Lost a few hairs (not many left tbh)</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s very early days for this plugin, and it has many snags. But its a decent start considering
I used maybe 6-8 hours in total, most of which was time struggling with css. It just feels
great writing this blogpost with a preview of what I&#8217;m writing using a plugin of my own creation.</p>
</div>
<div class="paragraph">
<p>One itch scratched !</p>
</div>
</div>
</div></p>

  <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'rundis';
	      var disqus_identifier = 'asciilight';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	<hr />

		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2015 Magnus Rundberget
          <a class="pull-right btn btn-xs" href="https://twitter.com/mrundberget"><i class="fa fa-twitter"></i></a>
          <a class="pull-right btn btn-xs" href="https://github.com/rundis"><i class="fa fa-github"></i></a>
          <a class="pull-right btn btn-xs" href="http://no.linkedin.com/in/mrundberget"><i class="fa fa-linkedin"></i></a>
        </p>
      </div>
    </div>

    <script src="../js/jquery-1.11.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/prettify.js"></script>
  </body>
</html>
