<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Clojure refactoring in Light Table</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <link href="/blog/css/bootstrap.min.css" rel="stylesheet">
    <link href="/blog/css/asciidoctor.css" rel="stylesheet">
    <link href="/blog/css/base.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href="/blog/css/prettify.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/blog/assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/blog/assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/blog/assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/blog/assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../favicon.ico">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-58695124-1', 'auto');
      ga('send', 'pageview');

    </script>
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog/index.html">Rundis</a>
        </div>
        <div class="navbar-collapse collapse bs-navbar-collapse">
            <ul class="nav navbar-nav">
                <li><a href="/blog/archive.html">Archive</a></li>
                <li><a href="/blog/about.html">About</a></li>
                <li><a href="/blog/feed.xml">Subscribe</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="https://github.com/rundis/blog"><i class="fa fa-lg fa-github"></i></a>
                </li>
            </ul>
        </div>
    </div>
</div>
<div class="container">

	<div class="page-header">
		<h1>Clojure refactoring in Light Table</h1>
	</div>

	<p><em>08 March 2015</em></p>
  <p><em>Tags: </em>
    <a href="/blog/tags/clojure.html">clojure</a>
  </em>
    <a href="/blog/tags/lighttable.html">lighttable</a>
  </p>
  <a href="https://twitter.com/share" class="twitter-share-button"
    data-url="http://rundis.github.io/blog/2015/clj_light_refactor.html"
    data-via="mrundberget"
    data-lang="en">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

	<p><div class="sect1">
<h2 id="_background">Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A colleague of mine, the emacs wizard <a href="https://github.com/magnars">Magnar</a> has on multiple occations demonstrated
some of the cool refactoring features for Clojure he has at his disposal in emacs.</p>
</div>
<div class="paragraph">
<p>I&#8217;m currently a <a href="https://github.com/LightTable/LightTable">Light Table</a> user and plugin author. Surely it should
be possible to add some refactoring support to Light Table ? I started looking at <a href="https://github.com/clojure-emacs/clj-refactor.el">clj-refactor.el</a> and
I couldn&#8217;t initially figure out where to start. But I found that some of the cool features were actually enabled
by an nrepl middleware <a href="https://github.com/clojure-emacs/refactor-nrepl">refactor-nrepl</a>.</p>
</div>
<div class="quoteblock">
<blockquote>
nREPL middleware to support refactorings in an editor agnostic way.
</blockquote>
<div class="attribution">
&#8212; refactor-nrepl
</div>
</div>
<div class="paragraph">
<p>Yay, now that&#8217;s what I call a great initiative. I decided to give it a go, and here&#8217;s a taste of what I managed to come up with so far.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_demo">Demo</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://youtu.be/xlGpRTVIkYQ">ScreenCast demo</a></p>
</div>
<iframe width="420" height="315" src="https://www.youtube.com/embed/xlGpRTVIkYQ" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="sect1">
<h2 id="_the_plugin">The plugin</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can find the plugin repo on github <a href="https://github.com/rundis/clj-light-refactor" class="bare">https://github.com/rundis/clj-light-refactor</a>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_taste_of_implementation">A taste of implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I won&#8217;t go into to much details in this blogpost, but I thought I&#8217;d give you a little teaser
on how I&#8217;ve gone about interacting with the middleware. Light Table supports calling arbitrary clojure code through it&#8217;s custom nrepl middleware.
So getting started wasn&#8217;t really that difficult.</p>
</div>
<div class="sect2">
<h3 id="_middleware_invocation">Middleware invocation</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn artifact-list-op []
  (str "(do (require 'refactor-nrepl.client) (require 'clojure.tools.nrepl)"
       "(def tr (refactor-nrepl.client/connect))"
       "(clojure.tools.nrepl/message (clojure.tools.nrepl/client tr 10000) {:op \"artifact-list\"}))"))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above code is an example of the code necessary to connect to and invoke an operation on then refactor-nrepl
middleware for listing clojare artifacts.</p>
</div>
</div>
<div class="sect2">
<h3 id="_behaviour_in_light_table">Behaviour in Light Table</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::trigger-artifact-hints
          :triggers #{:artifact.hints.update!}
          :debounce 500
          :reaction (fn [editor res]
                      (when-let [default-client (-&gt; @editor :client :default)]                  <i class="conum" data-value="1"></i><b>(1)</b>
                          (notifos/set-msg! (str "Retrieving clojars artifacts"))
                          (object/raise editor                                                  <i class="conum" data-value="2"></i><b>(2)</b>
                                        :eval.custom                                            <i class="conum" data-value="3"></i><b>(3)</b>
                                        (artifact-list)
                                        {:result-type :refactor.artifacts :verbatim true}))))   <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For this particular operation (autocompletion of deps) we require that the user has already got a connection to a lein project</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We raise an event on the editor instance (in this case it&#8217;s an editor with a project.clj file)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>:eval.custom is a behavior for evaluate arbitrary clojure code</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We set the result type to something custom so that we can define a corresponding custom behavior
to handle the results</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(behavior ::finish-artifact-hints
          :triggers #{:editor.eval.clj.result.refactor.artifacts}                                 <i class="conum" data-value="1"></i><b>(1)</b>
          :reaction (fn [editor res]
                      (let [artifacts (-&gt; res :results first :result first :value (s/split #" "))
                            hints (create-artifact-hints editor artifacts)]                       <i class="conum" data-value="2"></i><b>(2)</b>
                        (object/merge! editor {::dep-hints hints})                                <i class="conum" data-value="3"></i><b>(3)</b>
                        (object/raise auto-complete/hinter :refresh!))))                          <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The important part here is that the <em>editor.eval.clj.result</em> is assumed by the Light Table client
whilst <em>refactor.artifacts</em> is appended, given the corresponding param we supplied above. So by naming
our trigger like this, our behaviour will be triggered</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We pick out the results from the refactor-nrepl operation and transform it into a datastructure that&#8217;s suitable
for whatever we need to do (in this case providing autocompletion hints)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We store the list of artifacts in the editor (atom) so that our autocomplete hinter doesn&#8217;t go bananas invoking
the middleware like crazy</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Finally we tell the autocomplete hinter to refresh itself to include the list of artifacts</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The autocomplete part is skimpily explained here, but the important bit I&#8217;m trying to get across is how to
invoke the middleware and how to pick up the results. Autocompletion in Light Table deserves a blog post of it&#8217;s own at some point in the future
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_middleware_preconditions">Middleware preconditions</h3>
<div class="paragraph">
<p>For any of the features in the plugin to work we have to set up the middleware.
So you need to add something like this to your ~/.lein/profiles.clj</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">:plugins [[refactor-nrepl "X.Y.Z"]       <i class="conum" data-value="1"></i><b>(1)</b>
          [cider/cider-nrepl "A.B.C"]]   <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the core dependency that does all the heavy lifting for the features currently implemented</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The Cider nrepl middleware is used by refactor-nrepl. However the cider middleware on it&#8217;s own provides several cool
features that might come handy to the clj-light-refactor plugin in the near future :)</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The version indentifiers are intentionally left out, because it&#8217;s currently a little in flux.
This plugin won&#8217;t be released until the refactor-nrepl comes with it&#8217;s next official release.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_road_ahead">The road ahead</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is just the beginning, but it feels like I&#8217;m on to something. The clj-refactor.el project provides
an huge list of potential features to implement, the refactor-nrepl middleware will surely continue to evolve
and last but not least the cider middleware has plenty of useful stuff to harvest from.</p>
</div>
<div class="paragraph">
<p>I&#8217;ll keep plugin(g) along and hopefully others might get inspired to contribute as well. At some point in the future maybe parts
of this plugin will be ported to the official Light Table Clojure plugin. Who knows !?</p>
</div>
</div>
</div></p>

  <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'rundis';
	      var disqus_identifier = 'clj_light_refactor';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	<hr />

		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2015 Magnus Rundberget
          <a class="pull-right btn btn-xs" href="https://twitter.com/mrundberget"><i class="fa fa-twitter"></i></a>
          <a class="pull-right btn btn-xs" href="https://github.com/rundis"><i class="fa fa-github"></i></a>
          <a class="pull-right btn btn-xs" href="http://no.linkedin.com/in/mrundberget"><i class="fa fa-linkedin"></i></a>
        </p>
      </div>
    </div>

    <script src="../js/jquery-1.11.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/prettify.js"></script>
  </body>
</html>
