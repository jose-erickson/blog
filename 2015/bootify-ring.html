<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Bootifying my ring app</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <link href="/blog/css/bootstrap.min.css" rel="stylesheet">
    <link href="/blog/css/asciidoctor.css" rel="stylesheet">
    <link href="/blog/css/base.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href="/blog/css/prettify.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/blog/assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/blog/assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/blog/assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/blog/assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../favicon.ico">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-58695124-1', 'auto');
      ga('send', 'pageview');

    </script>
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog/index.html">Rundis</a>
        </div>
        <div class="navbar-collapse collapse bs-navbar-collapse">
            <ul class="nav navbar-nav">
                <li><a href="/blog/archive.html">Archive</a></li>
                <li><a href="/blog/about.html">About</a></li>
                <li><a href="/blog/feed.xml">Subscribe</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="https://github.com/rundis/blog"><i class="fa fa-lg fa-github"></i></a>
                </li>
            </ul>
        </div>
    </div>
</div>
<div class="container">

	<div class="page-header">
		<h1>Bootifying my ring app</h1>
	</div>

	<p><em>19 January 2015</em></p>
  <p><em>Tags: </em>
    <a href="/blog/tags/clojure.html">clojure</a>
  </em>
    <a href="/blog/tags/boot.clj.html">boot.clj</a>
  </p>
  <a href="https://twitter.com/share" class="twitter-share-button"
    data-url="http://rundis.github.io/blog/2015/bootify-ring.html"
    data-via="mrundberget"
    data-lang="en">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

	<p><div class="sect1">
<h2 id="_a_little_background">A little background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A few weeks back I noticed a tweet about <a href="https://github.com/boot-clj/boot">boot-clj</a>. This weekend I finally had some time to look into whether it could
be a viable alternative to <a href="https://github.com/technomancy/leiningen">Leiningen</a> for our apps or not.
We have a couple of ring based apps running as uberjars, so I decided to try to make a boot build for one of the projects. For the purpose of this blogpost however
I&#8217;ve created a sample app. Source available on <a href="https://github.com/rundis/boot-sample">github</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_bother_with_an_alternative_when_there_is_leiningen">Why bother with an alternative when there is Leiningen ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I haven&#8217;t been in the clojuresphere all that long.
I do have a history as java and groovy developer and have been through a history of using <a href="http://ant.apache.org/">ant</a>,
<a href="http://maven.apache.org/">maven</a> and lately <a href="https://www.gradle.org/">gradle</a> for my builds.
In terms of development experience Leiningen is definately a step up from all of them. However I feel Leiningen has left me longing
as soon as my builds have become a bit more elaborate (testing javascript, transpiling, create artifacts, upload to repo, run migrations
deploy to different environments etc). I&#8217;m sure all of this is achievable with Lein, but is it really architected to excel for that purpose ?
TBH I&#8217;d love to see gradle get some serious clojure love, but it doesn&#8217;t seem to be coming anytime soon. Maybe boot will be my next build tooling love :)</p>
</div>
<div class="ulist">
<div class="title">Reading up a bit on boot checked a few boxes for some of my longings though:</div>
<ul>
<li>
<p>Your build doesn&#8217;t have to be all declarative</p>
</li>
<li>
<p>Sensible abstractions and libraries to allow you to compose and extend your build using the full power of clojure</p>
</li>
<li>
<p>Compose build pipelines somewhat similar to how you would compose middlewares in ring</p>
</li>
<li>
<p>Task is the fundamental building block</p>
</li>
<li>
<p>Tasks typically works on immutable filesets (files treated as values, you never touch the filesystem directly yourself !)</p>
</li>
<li>
<p>Possibility of complete classpath isolation at task level</p>
</li>
<li>
<p>Great repl and commandline support.</p>
</li>
<li>
<p>&#8230;&#8203; and surely a lots more</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lein_boot">Lein &#8594; Boot</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_leningen_project">Leningen project</h3>
<div class="paragraph">
<p>project.clj</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defproject boot-sample "0.1.0"
  :description "Boot sample application"
  :url "https://github.com/rundis/boot-sample"
  :min-lein-version "2.0.0"
  :dependencies [[org.clojure/clojure "1.6.0"]
                 [compojure "1.2.1"]
                 [liberator "0.12.2"]
                 [ring/ring-jetty-adapter "1.3.1"]
                 [ring/ring-json "0.3.1"]
                 [bouncer "0.3.1"]
                 [io.aviso/pretty "0.1.14"]]
  :ring {:handler boot-sample.core/app                       <b class="conum">(1)</b>
         :port 3360}
  :profiles {:dev {:plugins [[lein-ring "0.8.13"]]
                   :test-paths ^:replace []}
             :test {:dependencies [[midje "1.6.3"]]
                    :plugins [[lein-midje "3.1.3"]]
                    :test-paths ["test"]
                    :resource-paths ["test/resources"]}})</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The entry point for my ring app</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The above project is a really simple project definition. To run my app I just have to execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">lein ring uberjar
java -jar target/boot-sample-0.1.0-standalone.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>core.clj</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(ns boot-sample.core
  (:require [ring.middleware.params :refer [wrap-params]]
            [ring.middleware.keyword-params :refer [wrap-keyword-params]]
            [ring.middleware.json :refer [wrap-json-params]]
            [compojure.core :refer [defroutes ANY GET]]
            [liberator.core :refer [defresource resource]]))

(defn index-handler [req]
  "Hello Boot sample (or maybe Lein still)")

(defresource booters
  :available-media-types       ["application/json"]
  :allowed-methods             [:get]
  :handle-ok                   (fn [ctx] [{:id "Pod1"} {:id "Pod 2"}]))

(defroutes app-routes
  (ANY "/" [] index-handler)
  (ANY "/booters" [] booters))


(def app (-&gt; app-routes
             wrap-keyword-params
             wrap-json-params
             wrap-params))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hey. Hang on. There is no main method here, how can the java -jar command work without one ?
Well, because the ring plugin creates one for us.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">cat target classes/boot_sample/core/main.clj</code></pre>
</div>
</div>
<div class="paragraph">
<p>gives us</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(do
  (clojure.core/ns boot-sample.core.main
   (:require ring.server.leiningen)
                   (:gen-class))
  (clojure.core/defn -main []
    (ring.server.leiningen/serve
     (quote {:ring {:auto-reload? false,
                    :stacktraces? false,
                    :open-browser? false,
                    :port 3360,
                    :handler boot-sample.core/app}}))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s useful to know in case boot-clj doesn&#8217;t happen to have a ring task that does something similar.</p>
</div>
</div>
<div class="sect2">
<h3 id="_boot_me_up">Boot me up</h3>
<div class="paragraph">
<p>Boot comes with a range of predefined tasks that I can compose to get quite close to the Leiningen build above.
I&#8217;ll focus on getting that uberjar up and running.</p>
</div>
<div class="paragraph">
<p>I could have done it all on the command line or in the boot repl, but lets just be a little declarative (still functions don&#8217;t worry!).</p>
</div>
<div class="paragraph">
<p>build.boot</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(set-env!
 :resource-paths #{"src"}                                <b class="conum">(1)</b>
 :dependencies '[[org.clojure/clojure "1.6.0"]
                 [compojure "1.2.1"]
                 [liberator "0.12.2"]
                 [ring/ring-jetty-adapter "1.3.1"]
                 [ring/ring-json "0.3.1"]
                 [bouncer "0.3.1"]
                 [io.aviso/pretty "0.1.14"]])

(task-options!
 pom {:project 'boot-Sample
      :version "0.1.0"}
 aot {:namespace '#{boot-sample.core}}                  <b class="conum">(2)</b>
 jar {:main 'boot_sample.core                           <b class="conum">(3)</b>
      :manifest {"Description" "Sample boot app"
                 "Url" "https://github.com/rundis/boot-sample"}})


(deftask build
  "Build uberjar"
  []
  (comp (aot) (pom) (uber) (jar)))</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>To bundle your sources in the output jar, you have to specify src as a resource-path. A small gotcha there.</p>
</li>
<li>
<p>We need to aot our core.clj namespace so that java -jar can invoke it&#8217;s main method</p>
</li>
<li>
<p>We need to help java -jar with the location of our main class in the jar</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>However you might remember from above that there is no main method in core.clj.
So the last piece of the puzzle is to add one. It&#8217;t not that hard.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(ns boot-sample.core
  (:require [ring.middleware.params :refer [wrap-params]]
            [ring.middleware.keyword-params :refer [wrap-keyword-params]]
            [ring.middleware.json :refer [wrap-json-params]]
            [compojure.core :refer [defroutes ANY GET]]
            [liberator.core :refer [defresource resource]]
            [ring.adapter.jetty :as jetty])                                <b class="conum">(1)</b>
  (:gen-class))                                                            <b class="conum">(2)</b>


;; ... the other stuff

(defn -main []
  (jetty/run-jetty app {:port 3360}))                                     <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Using the jetty ring adapter</p>
</li>
<li>
<p>The :gen-class directive generates the necessary stuff for our main method to be invokable from java
during aot compilation</p>
</li>
<li>
<p>Fire away</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>At the time of writing there was a regression in boot that caused aot to fail.
I needed to build boot from source, should be fixed in the next release though.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">git clone git@github.com:boot-clj/boot.git
cd boot/boot/core
lein install</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now all is set to try it out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">boot build
java -jar target/boot-sample-0.1.0.jar</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_all_is_well_then">All is well then ?</h3>
<div class="paragraph">
<p>Unfortunately not quite. For uberjar projects it seems boot-clj at the time of writing has some serious
performance challenges.</p>
</div>
<div class="ulist">
<div class="title">On my machine generating the uberjar takes:</div>
<ul>
<li>
<p>Leiningen : 12 seconds</p>
</li>
<li>
<p>boot-clj  : 46 seconds !</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It&#8217;s not like Leiningen is lightning fast in the first place. But for this scenario boot just doesn&#8217;t cut it.
I reported an <a href="https://github.com/boot-clj/boot/issues/94">issue</a> and got prompt responses from the developers
which can only be a good sign.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_concluding_remarks">Concluding remarks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>My initial question of whether or not I feel we could use boot for our current projects gets a thumbs down for now.</p>
</div>
<div class="paragraph">
<p>I think boot-clj carries a lot of promise and have some really great ideas. It&#8217;s going to be interesting to
see if boot-clj becomes a viable alternative to leiningen. I suppose a porting and/or interop story with lein
and lein plugins might be needed in addition to maturing both the model and obviously its performance characteristics.</p>
</div>
<div class="paragraph">
<p>I&#8217;m certainly keen on trying it out more. I might try out the clojurescript support next and maybe churn out some custom tasks
just for fun.</p>
</div>
</div>
</div></p>

  <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'rundis';
	      var disqus_identifier = 'bootify_ring';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	<hr />

		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2015 Magnus Rundberget
          <a class="pull-right btn btn-xs" href="https://twitter.com/mrundberget"><i class="fa fa-twitter"></i></a>
          <a class="pull-right btn btn-xs" href="https://github.com/rundis"><i class="fa fa-github"></i></a>
          <a class="pull-right btn btn-xs" href="http://no.linkedin.com/in/mrundberget"><i class="fa fa-linkedin"></i></a>
        </p>
      </div>
    </div>

    <script src="../js/jquery-1.11.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/prettify.js"></script>
  </body>
</html>
