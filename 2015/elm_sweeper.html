<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Minesweeper - a brief journey from JavaScript/React to Elm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <link href="/blog/css/bootstrap.min.css" rel="stylesheet">
    <link href="/blog/css/asciidoctor.css" rel="stylesheet">
    <link href="/blog/css/base.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href="/blog/css/prettify.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/blog/assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/blog/assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/blog/assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/blog/assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../favicon.ico">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-58695124-1', 'auto');
      ga('send', 'pageview');

    </script>
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog/index.html">Rundis</a>
        </div>
        <div class="navbar-collapse collapse bs-navbar-collapse">
            <ul class="nav navbar-nav">
                <li><a href="/blog/archive.html">Archive</a></li>
                <li><a href="/blog/about.html">About</a></li>
                <li><a href="/blog/feed.xml">Subscribe</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="https://github.com/rundis/blog"><i class="fa fa-lg fa-github"></i></a>
                </li>
            </ul>
        </div>
    </div>
</div>
<div class="container">

	<div class="page-header">
		<h1>Minesweeper - a brief journey from JavaScript/React to Elm</h1>
	</div>

	<p><em>10 November 2015</em></p>
  <p><em>Tags: </em>
    <a href="/blog/tags/JavaScript.html">JavaScript</a>
  </em>
    <a href="/blog/tags/React.html"> React</a>
  </em>
    <a href="/blog/tags/Elm.html"> Elm</a>
  </p>
  <a href="https://twitter.com/share" class="twitter-share-button"
    data-url="http://rundis.github.io/blog/2015/elm_sweeper.html"
    data-via="mrundberget"
    data-lang="en">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

	<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>After taken a keen interest to Elm lately I figured I needed to solve a real problem. Something a bit fun and achievable in a couple of evenings/nights.
Not being awfully creative, piggiebacking on other peoples' work is sometimes a good option.
In this post I&#8217;ll take you through some of my steps in porting/re-implementing <a href="https://github.com/cjohansen/react-sweeper">https://github.com/cjohansen/react-sweeper</a> (JavaScript and React) to an Elm implementation.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2015/elm_sweeper.png" alt="elm sweeper">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="icon-tip" title="Tip"></i>
</td>
<td class="content">
If you&#8217;d like to have a look at the complete implementation of the game, check out <a href="https://github.com/rundis/elm-sweeper">https://github.com/rundis/elm-sweeper</a>.
There you&#8217;ll find instructions on how to get it running too.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_little_background">A little background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Right! So I&#8217;ve taken an interest in <a href="http://elm-lang.org/">Elm</a> lately.  If you&#8217;ve read any of my previous posts you might have
noticed that I&#8217;m quite fond of Clojure and ClojureScript. I still very much am and I have tons to learn there still. But I wanted  to dip my toes
into a strongly typed functional language. Elm seems quite approachable and I guess probably the talk <a href="https://www.youtube.com/watch?v=oYk8CKH7OhE">"Let&#8217;s be mainstream"</a>
made my mind up to give it a go. After creating a language plugin for Light Table: <a href="http://rundis.github.io/blog/2015/elm_light.html">elm-light</a>
 and attending an Elm workshop at CodeMesh, I needed something concrete to try it out on.</p>
</div>
<div class="paragraph">
<p>I remembered that a colleague of mine  <a href="http://www.kodemaker.no">at Kodemaker</a>, Christian Johansen,  made a minesweeper implementation using JavaScript and React.
That seemed like a sufficiently interesting problem and I could shamelessly steal most of the game logic :)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_first_steps_the_game_logic">First steps - The Game Logic</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So the obvious place to start was the game logic. I had the option of trying to set up <a href="https://github.com/deadfoxygrandpa/Elm-Test">Elm-Test</a>
to use a test-driven inspired approach. But heck I figured I had to try to put those types to the test, so I went for
an all out repl driven approach. That gave me a chance to experience the good and bad with the <a href="https://github.com/rundis/elm-light#56-editor-repl">repl integration</a> of my own Light Table Elm plugin too.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2015/elm_repl.png" alt="elm repl">
</div>
</div>
<div class="sect2">
<h3 id="_starting_with_records_and_type_aliases">Starting with records and type aliases</h3>
<div class="paragraph">
<p>Reading the <a href="https://github.com/cjohansen/react-sweeper/blob/master/immutable-es6/src/game.js">game logic</a> in react-sweeper I decided to
define a couple of types</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint elm language-elm"><code>type alias Tile               <i class="conum" data-value="1"></i><b>(1)</b>
  { id: Int
  , threatCount: Maybe Int    <i class="conum" data-value="2"></i><b>(2)</b>
  , isRevealed: Bool
  , isMine: Bool}


type alias Game =             <i class="conum" data-value="3"></i><b>(3)</b>
  { isDead: Bool              <i class="conum" data-value="4"></i><b>(4)</b>
  , isSafe: Bool              <i class="conum" data-value="5"></i><b>(5)</b>
  , rows: Int
  , cols: Int
  , tiles: List Tile}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Type alias for records representing a tile in the game.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Threat count is a property on a tile that is not set until the game logic allows it.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Type alias for a record representing a game</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Did you click on a mine? Found out later that this could easily be inferred, but kept it in</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Did you reveal all non-mine tiles i.e win the game ?</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Describing these types proved to be valuable documentation as well as being very helpful when implementing
the game logic later on.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
What&#8217;s that <code>Maybe</code> thing ? If someone told me it&#8217;s a <a href="https://en.wikipedia.org/wiki/Monad_(functional_programming)">Monad</a> I wouldn&#8217;t be any wiser. I think of it
as a handy way of describing that something may have a value. A nifty way to eliminate the use of null basically.
It also forces you to be explicit about handling the fact that it may not have a value.
You won&#8217;t get null pointer errors in an Elm program! (nor <code>Undefined is not a function</code>).
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_finding_neighbours_of_a_tile">Finding neighbours of a tile</h3>
<div class="paragraph">
<p>When revealing tiles in minesweeper you also reveal any adjacent tiles that aren&#8217;t next to a mine.
In addition you display the threat count (how many mines are adjacent to a tile) for tiles next to those
you just revealed. So we need a way to find the neighbouring tiles of a given tile.</p>
</div>
<div class="sect3">
<h4 id="_javascript_implementation">JavaScript implementation</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint javascript language-javascript"><code>function onWEdge(game, tile) {                                                 <i class="conum" data-value="1"></i><b>(1)</b>
  return tile % game.get('cols') === 0;
}

function onEEdge(game, tile) {                                                 <i class="conum" data-value="2"></i><b>(2)</b>
  return tile % game.get('cols') === game.get('cols') - 1;
}


function nw(game, tile) {                                                      <i class="conum" data-value="3"></i><b>(3)</b>
  return onWEdge(game, tile) ? null : idx(game, tile - game.get('cols') - 1);
}

function n(game, tile) {
  return idx(game, tile - game.get('cols'));
}

// etc , ommitted other directions for brevity


const directions = [nw, n, ne, e, se, s, sw, w];

function neighbours(game, tile) {
  return keep(directions, function (dir) {                                     <i class="conum" data-value="4"></i><b>(4)</b>
    return game.getIn(['tiles', dir(game, tile)]);
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Helper function to determine if a given tile is on the west edge of the board</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Helper function to determine if a given tile is on the east edge of the board</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Returns the the tile north-west of a given tile. Null if none exists to the north-west</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Keep is a helper function that maps over the collection and filters out any resulting `null`s. So the function
iterates all directions (invoking their respective function) and returns all possible tiles
neighbouring the given tile.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_elm_implementation">Elm implementation</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint elm language-elm"><code>
type Direction = W | NW | N | NE | E | SE | S | SW                                 <i class="conum" data-value="1"></i><b>(1)</b>

onWEdge : Game -&gt; Tile -&gt; Bool                                                     <i class="conum" data-value="2"></i><b>(2)</b>
onWEdge game tile =
  (tile.id % game.cols) == 0


onEEdge : Game -&gt; Tile -&gt; Bool
onEEdge game tile =
  (tile.id % game.cols) == game.cols - 1


neighbourByDir : Game -&gt; Maybe Tile -&gt; Direction -&gt; Maybe Tile                     <i class="conum" data-value="3"></i><b>(3)</b>
neighbourByDir game tile dir =
  let
    tIdx = tileByIdx game                                                          <i class="conum" data-value="4"></i><b>(4)</b>
    isWOk = (\t -&gt; not &lt;| onWEdge game t)                                          <i class="conum" data-value="5"></i><b>(5)</b>
    isEOk = (\t -&gt; not &lt;| onEEdge game t)
  in
    case (tile, dir) of                                                            <i class="conum" data-value="6"></i><b>(6)</b>
      (Nothing, _) -&gt; Nothing                                                      <i class="conum" data-value="7"></i><b>(7)</b>
      (Just t, N)  -&gt; tIdx &lt;| t.id - game.cols
      (Just t, S)  -&gt; tIdx &lt;| t.id + game.cols
      (Just t, W)  -&gt; if isWOk t then tIdx &lt;| t.id - 1             else Nothing
      (Just t, NW) -&gt; if isWOk t then tIdx &lt;| t.id - game.cols - 1 else Nothing    <i class="conum" data-value="8"></i><b>(8)</b>
      (Just t, SW) -&gt; if isWOk t then tIdx &lt;| t.id + game.cols - 1 else Nothing
      (Just t, E)  -&gt; if isEOk t then tIdx &lt;| t.id + 1             else Nothing
      (Just t, NE) -&gt; if isEOk t then tIdx &lt;| t.id - game.cols + 1 else Nothing
      (Just t, SE) -&gt; if isEOk t then tIdx &lt;| t.id + game.cols + 1 else Nothing


neighbours : Game -&gt; Maybe Tile -&gt; List Tile
neighbours game tile =
  let
    n = neighbourByDir game tile                                                   <i class="conum" data-value="9"></i><b>(9)</b>
  in
    List.filterMap identity &lt;| List.map n [W, NW, N, NE, E, SE, S, SW]             <i class="conum" data-value="10"></i><b>(10)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A type (actually a <a href="https://en.wikipedia.org/wiki/Tagged_union">tagged union</a>) describing/enumerating the possible directions</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pretty much the same as it&#8217;s JavaScript counterpart. I&#8217;ve been lazy and assumed the id of a tile
is also the index in the tiles list of our game.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Find a neighbour by a given direction. The function takes 3 arguments; a game record, a tile (that may or may not have a value) and a direction. It returns a tile (that may or may not have a value)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>tileByIdx is a functions that finds a tile by its index. (it returns a tile, &#8230; maybe). tIdx is a local function that just curries(/binds/partially applies) the first parameter - game</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>An anonymous function that checks if it&#8217;s okay to retrieve a westward tile for a given tile</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Pattern match on tile and direction. You might consider it a switch statement on steroids.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>If the tile doesn&#8217;t have a value (then we don&#8217;t care about the direction hence _) we return Nothing (Maybe.Nothing)</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Just t, NW matches on a tile that has value (assigned t) and a given direction of NW. The logic is for this case the same as for it&#8217;s JavaScript counterpart. Well except it returns Nothing if NW isn&#8217;t possible</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>A partially applied version of neightBourByDir to make the mapping function in 10. a bit less verbose</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>We map over all directions finding their neighbours, then <code>List.filterMap identity</code> filters out all List entries with Nothing.
Leaving us with a list of valid neighbours for the given tile.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We covered quite a bit of ground here. I could have implemented all the direction functions as in the JavaScript implementation,
but opted for a more generic function using pattern matching. It&#8217;s not that I dislike short functions, quite the contrary but
in this case it felt like a good match (no pun intended). Once you get used to the syntax it gives a
really nice overview as well.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="icon-tip" title="Tip"></i>
</td>
<td class="content">
Think of &lt;| as one way to avoid parenthesis. It&#8217;s actually a backwards function application
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When testing this function I got my first runtime error in Elm complaining that my case wasn&#8217;t
exhaustive. Rumors has it that the next version of elm might handle this at compile time as well :-)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2015/elm_case_error.png" alt="elm case error">
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_threat_count">Threat count</h3>
<div class="sect3">
<h4 id="_javascript">JavaScript</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint javascript language-javascript"><code>function getMineCount(game, tile) {                                             <i class="conum" data-value="1"></i><b>(1)</b>
  var nbs = neighbours(game, tile);
  return nbs.filter(prop('isMine')).length;
}

function addThreatCount(game, tile) {                                           <i class="conum" data-value="2"></i><b>(2)</b>
  return game.setIn(['tiles', tile, 'threatCount'], getMineCount(game, tile));
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Gets the number of neighbouring tiles that are mines for a given tile. (prop is a helper function for retrieving a named property on a js object)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the threatCount property on a given tile in the game</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_elm">Elm</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint elm language-elm"><code>mineCount : Game -&gt; Maybe Tile -&gt; Int                                           <i class="conum" data-value="1"></i><b>(1)</b>
mineCount game tile =
  List.length &lt;| List.filter (\t -&gt; t.isMine) &lt;| neighbours game tile

revealThreatCount : Game -&gt; Tile -&gt; Tile                                        <i class="conum" data-value="2"></i><b>(2)</b>
revealThreatCount game tile =
  {tile | threatCount &lt;- Just (mineCount game &lt;| Just tile)
        , isRevealed  &lt;- True}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Same as for it&#8217;s JavaScript counterpart, but using a anonymous function because there is no dynamic
property accessors in Elm</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Almoust the same as addThreatCount, but since once we add it the tile would also always be revealed
I opted for a two in one function.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<div class="title">For mine count, both implementations are potentially flawed.</div>
<ul>
<li>
<p>For JavaScript you might get 0 for a non-existent tile, which isn&#8217;t too bad. But maybe you&#8217;ll get
a null pointer somewhere deeper down the call stack. To be sure you have to crawl through all function calls this function makes and
apply your JavaScript foo to know things like null &lt; 1 is obviously true, but null &lt; 0 is false. &#8230; and so on.</p>
</li>
<li>
<p>The elm implementation won&#8217;t have any null pointer exceptions, but really it should return Maybe Int to guard
against giving 0 back for a Nothing tile !</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_revealing_safe_adjacent_tiles">Revealing safe adjacent tiles</h3>
<div class="sect3">
<h4 id="_javascript_2">JavaScript</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint javascript language-javascript"><code>function revealAdjacentSafeTiles(game, tile) {
  if (isMine(game, tile)) {
    return game;
  }
  game = addThreatCount(game, tile).setIn(['tiles', tile, 'isRevealed'], true);
  if (game.getIn(['tiles', tile, 'threatCount']) === 0) {
    return keep(directions, function (dir) {
      return dir(game, tile);
    }).reduce(function (game, pos) {
      return !game.getIn(['tiles', pos, 'isRevealed']) ?
        revealAdjacentSafeTiles(game, pos) : game;
    }, game);
  }
  return game;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_elm_2">Elm</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint elm language-elm"><code>revealAdjacentSafeTiles :  Game -&gt; Int -&gt; Game
revealAdjacentSafeTiles game tileId =
  case tileByIdx game tileId of
    Nothing -&gt; game
    Just t -&gt;
      if t.isMine then game else
        let
          updT = revealThreatCount game t
          updG = {game | tiles &lt;- updateIn tileId (\_ -&gt; updT) game.tiles}
          f    = (\t g -&gt; if not t.isRevealed then revealAdjacentSafeTiles g t.id else g)
        in
          if not (updT.threatCount == Just 0) then
            updG
          else
            List.foldl f updG &lt;| neighbours updG &lt;| Just updT</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_a_brief_comparison">A brief comparison</h4>
<div class="paragraph">
<p>The most noteworthy difference is really the explicit handling of an illegal tile index in the Elm implementation.
If I didn&#8217;t have the JavaScript code to look at, I&#8217;m guessing the difference would have been more noticable. Not necessarily for the better.
We&#8217;ll never know.</p>
</div>
<div class="paragraph">
<p>Anyways, enough about the game logic. Let&#8217;s move on to the view part.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comparing_the_view_rendering">Comparing the view rendering</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_javascript_3">JavaScript</h3>
<div class="paragraph">
<p>The React part for rendering the UI is found in <a href="https://github.com/cjohansen/react-sweeper/blob/master/immutable-es6/src/ui.js">ui.js</a>
Below I&#8217;ve picked out the most interesting parts</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint javascript language-javascript"><code>export function createUI(channel) {                                            <i class="conum" data-value="1"></i><b>(1)</b>
  const Tile = createComponent((tile) =&gt; {                                     <i class="conum" data-value="2"></i><b>(2)</b>
    if (tile.get('isRevealed')) {
      return div({className: 'tile' + (tile.get('isMine') ? ' mine' : '')},
                 tile.get('threatCount') &gt; 0 ? tile.get('threatCount') : '');
    }
    return div({
      className: 'tile',
      onClick: function () {
        channel.emit('reveal', tile.get('id'));                                <i class="conum" data-value="3"></i><b>(3)</b>
      }
    }, div({className: 'lid'}, ''));
  });

  const Row = createComponent((tiles) =&gt; {
    return div({className: 'row'}, tiles.map(Tile).toJS());
  });

  const Board = createComponent((game) =&gt; {
    return div({
      className: 'board'
    }, partition(game.get('cols'), game.get('tiles')).map(Row).toJS());
  });

  const UndoButton = createComponent(() =&gt; {                                  <i class="conum" data-value="4"></i><b>(4)</b>
    return button({
      onClick: channel.emit.bind(channel, 'undo')
    }, 'Undo');
  });

  const Game = createComponent((game) =&gt; {
    return div({}, [Board(game), UndoButton()]);
  });

  return (data, container) =&gt; {                                               <i class="conum" data-value="5"></i><b>(5)</b>
    render(Game(data), container);
  };
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This function returns a function for creating the react component tree for the game. It takes a channel
param, which is an event emitter. So when components need to notify the "controller" about user actions they can just emit messages to this channel
A neat way to avoid using callbacks!</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>createComponent is a handy helper function that avoids some react boiler plate and provides an optimized shouldComponentUpdate function for each react component used.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When a user clicks on a tile a reveal message with the tile id is emitted</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The game also supports undo previous move :)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Returns a function that when called starts the react rendering of the game in the given container element</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_elm_3">Elm</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint elm language-elm"><code>threatCount : Maybe Int -&gt; List Html
threatCount count =
  case count of
    Nothing -&gt; []
    Just t  -&gt; [text (if t &gt; 0 then toString t else "")]


tileView : Signal.Address Action -&gt; Game.Tile -&gt; Html                               <i class="conum" data-value="1"></i><b>(1)</b>
tileView address tile =
  if tile.isRevealed then
    div [class ("tile" ++ (if tile.isMine then " mine" else ""))]
        &lt;| threatCount tile.threatCount

  else
    div [class "tile", onClick address (RevealTile tile.id)]                        <i class="conum" data-value="2"></i><b>(2)</b>
        [div [class "lid"] []]                                                      <i class="conum" data-value="3"></i><b>(3)</b>


rowView : Signal.Address Action -&gt; List Game.Tile -&gt; Html
rowView address tiles =
  div [class "row"] (List.map (tileView address) tiles)


statusView: Game -&gt; Html
statusView game =
  let
    (status, c) = case (game.isSafe, game.isDead) of
                    (True, _)  -&gt; (" -  You won", "status-won")
                    (_, True) -&gt;  (" - You lost", "status-lost")
                    (_, _)     -&gt; ("", "")
  in
    span [class c] [text status]


view : Signal.Address Action -&gt; Game -&gt; Html                                       <i class="conum" data-value="4"></i><b>(4)</b>
view address game =
  let
    rows = Utils.partitionByN game.cols game.tiles
  in
    div [id "main"] [
      h1 [] [text "Minesweeper", statusView game],
      div [class "board"] (List.map (rowView address) rows),
      div [] [button [class "button", onClick address NewGame] [text "New game"]]
    ]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The function responsible for rendering a single tile. Very much comparable to the React tile component
in the JavaScript implementation. Similar to  React, we aren&#8217;t returning actual dom elments, Elm also has
a virtual dom implementation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When a tile is clicked a message is sent to a given address (we&#8217;ll get back to that a little bit later).
Well actually it doesn&#8217;t happen right away, rather think of it as creating an envelope with content and a known address. The Elm runtime receives a signal back
that will take care of sending the message to it&#8217;s rendering function when appropriate.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>div here is actually a function from the HTML module in Elm. It takes two lists as arguments, the first
is a list of attributes and the second is a list of child elements</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Our main entry function for creating our view. It takes an address and game as parameter and returns a virtual dom node (Html)</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
<code>Signal.Address Action</code> : Address points to a particular type of Signal, in our case the Signal is an <code>Action</code>
we&#8217;ll come back to that shortly. But the short story is that this is what enables us to talk back to the main application.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wiring_it_all_together">Wiring it all together</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_javascript_4">JavaScript</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint javascript language-javascript"><code>const channel = new EventEmitter();
const renderMinesweeper = createUI(channel);
let game = createGame({cols: 16, rows: 16, mines: 48});
let history = List([game]);

function render() {                                                         <i class="conum" data-value="1"></i><b>(1)</b>
  renderMinesweeper(game, document.getElementById('board'));
}

channel.on('undo', () =&gt; {                                                  <i class="conum" data-value="2"></i><b>(2)</b>
  if (history.size &gt; 1) {
    history = history.pop();
    game = history.last();
    render();
  }
});

channel.on('reveal', (tile) =&gt; {                                            <i class="conum" data-value="3"></i><b>(3)</b>
  if (isGameOver(game)) { return; }

  const newGame = revealTile(game, tile);

  if (newGame !== game) {
    history = history.push(newGame);
    game = newGame;
  }

  render();

  if (isGameOver(game)) {
    // Wait for the final render to complete before alerting the user
    setTimeout(() =&gt; { alert('GAME OVER!'); }, 50);
  }
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The react render entry point for the game. Called whenever the game state is changed</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The JavaScript implementation keeps a history of all game states. I forgot to mention that <a href="https://facebook.github.io/immutable-js/">immutable-js</a> is for collections.
Undo just gets the previous game state and rerenders. Nice and simple</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Event listener for reveal messages. It invokes reveal tile, adds to history (and potentially ends the game).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is all very neat and tidy and works so great because the game state is managed in one place and is passed through
 the ui component tree as an immutable value. The fact that the state is immutable also makes the undo implementation a breeze.
 I really like this approach !</p>
</div>
</div>
<div class="sect2">
<h3 id="_elm_4">Elm</h3>
<div class="paragraph">
<p>If you don&#8217;t know Elm at all, this part might be the most tricky to grasp. To simplify things I&#8217;ll split it into
two parts.</p>
</div>
<div class="sect3">
<h4 id="_start_app_approach">Start-app approach</h4>
<div class="paragraph">
<p><a href="https://github.com/evancz/start-app">Start-app</a> is a small elm package that makes it easy to get started
with an elm Model-View-Update structure. This is a great place to start for your first elm app.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint elm language-elm"><code>type Action = RevealTile Int                                     <i class="conum" data-value="1"></i><b>(1)</b>


init : Game                                                      <i class="conum" data-value="2"></i><b>(2)</b>
init =
  Game.createGame 15 15 5787345


update : Action -&gt; Game -&gt; Game                                  <i class="conum" data-value="3"></i><b>(3)</b>
update Action game =
  case action of
    RevealTile id -&gt; if Game.gameOver game then game else        <i class="conum" data-value="4"></i><b>(4)</b>
                      Game.revealTile game id

main =                                                           <i class="conum" data-value="5"></i><b>(5)</b>
  StartApp.Simple.start                                          <i class="conum" data-value="6"></i><b>(6)</b>
    { model = init
    , update = update
    , view = view
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Type describing the actions the game supports. Currently just revealing tiles, and you can see that
we also specify that the RevealTile action expects an Int paramater. That would be the tile id.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The init function provides the initial state for our application. <code>createGame</code> is a helper function for creating
a game with x cols and y rows. The 3.rd param is a seed for randomizing tiles. We&#8217;ll return to that seed thing in the next chapter!</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Update is the function that handles the actual update of state, or rather the transformation to the next state
based on some action. It&#8217;s quite simple in this case, just reveal a given tile and return the updated game</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>No point in revealing more tiles when the game is already over :)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>main</code> is the entry point into our application. If you use elm-reactor this will be automatically invoked for you, which is handy for getting started quickly</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>StartApp.Simple.start</code> takes care of wiring things up and start your application</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_trouble_in_paradise_we_get_the_same_board_every_time">Trouble in paradise, we get the same board every time</h4>
<div class="paragraph">
<p>Do you remember the 3rd param to createGame in the previous chapter? That is the initial seed to a random generator (<a href="http://package.elm-lang.org/packages/elm-lang/core/2.1.0/Random">Random</a>) to randomize the
occurence of mines. The problem is that using the same seed produces the same result. Calling an elm random
generator will return a new seed, so of course I could/should have stored that and used that for the next game.
But I still need an initial seed that&#8217;s different every time I start the app. Current time would be a good candidate
for an initial seed. But there is no getCurrentTime function in Elm. Why ? It&#8217;s impure, and Elm doesn&#8217;t like impure functions.
By "pure", we mean that if you call a function with the same arguments, you get the same result.
There are several reasons why pure functions is a great thing (testing is one), but I won&#8217;t go into that, let&#8217;s just accept the fact
that this is the case, so how can we deal with it ?</p>
</div>
<div class="paragraph">
<p>Well the elm-core package has a <a href="http://package.elm-lang.org/packages/elm-lang/core/2.1.0/Time">Time module</a> with a timestamp function that looks useful.
To use that we have to change a few things though, most notably we can&#8217;t use the simple start app approach any more.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint elm language-elm"><code>
type Action =
  NewGame                                                             <i class="conum" data-value="1"></i><b>(1)</b>
  | RevealTile Int



update : (Float, Action) -&gt; Game -&gt; Game                              <i class="conum" data-value="2"></i><b>(2)</b>
update (time, action) game =
  case action of
    NewGame -&gt; Game.createGame 15 15  (truncate time)                 <i class="conum" data-value="3"></i><b>(3)</b>
    RevealTile id -&gt; if Game.gameOver game then game else
                       Game.revealTile game id


actions: Signal.Mailbox Action                                        <i class="conum" data-value="4"></i><b>(4)</b>
actions =
  Signal.mailbox NewGame

model: Signal Game                                                    <i class="conum" data-value="5"></i><b>(5)</b>
model =
  Signal.foldp update init (Time.timestamp actions.signal)

main : Signal Html                                                    <i class="conum" data-value="6"></i><b>(6)</b>
main =
  Signal.map (view actions.address) model

port initGame : Task.Task x ()                                        <i class="conum" data-value="7"></i><b>(7)</b>
port initGame =
  Signal.send actions.address NewGame
</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We introduce a new action <code>NewGame</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Our update function now takes a tuple of time and action + game as input parameters</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We use the elm core function <code>truncate</code> to convert the time(stamp) float into an integer and use that as our seed to <code>createGame</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We construct a mailbox for our Action messages manually, with an initial value of NewGame</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Our model is a fold (reduce) of all state changes sent to our mailbox (from the app started to the current moment of time).
This is where we introduce the Time.timestamp function, which wraps our action signal and produces a tuple of (timestamp, action)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>main is just a map over our view function with our current model. Since view also expects an (mailbox) address we curry/partially apply that to our view function</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Unfortunately I couldn&#8217;t figure out how to get the timestamp passed to the init function. The creation
step (4) of the mailbox doesn&#8217;t actually cause the NewGame action to be executed either. So this is a little hack
that fires off a task to execute the NewGame action. This is run after initialization so when you load the game you&#8217;ll not see state 0 for the game, but actually state 1.
If any elm-ers out there reads this, feel free to comment on how this could be done in a more idiomatic fashion!</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="icon-tip" title="Tip"></i>
</td>
<td class="content">
I found <a href="https://yobriefca.se/blog/2015/08/02/deconstructing-your-first-elm-app/">this</a> blogpost
very illuminating for deconstructing start-app.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_but_what_about_undo">But what about undo ?</h4>
<div class="paragraph">
<p>There is an elm-package I think would help us do that quite simply;
<a href="https://github.com/TheSeamau5/elm-undo-redo">elm-undo-redo</a>. However if you are using <a href="https://github.com/elm-lang/elm-reactor">elm-reactor</a>
you pretty much get undo-redo and more out of the box. Great for development, but maybe not so much for production!</p>
</div>
<iframe width="420" height="315" src="https://www.youtube.com/embed/P3B4ldi1cmc" frameborder="0" allowfullscreen></iframe>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Getting into Elm has been a really pleasurable experience so far. It&#8217;s quite easy to get up and running without
knowing all that much about the language. I&#8217;ve found the elm compiler to be a really nice and friendly companion.
The error messages I get are really impressive and I can truly say I&#8217;ve never experienced anything quite like it.
Working with types (at least for this simple application) hasn&#8217;t felt like a burden at all. I still feel I should have
had some tests, but I think I would feel more comfortable refactoring this app with a lot less tests than I would in say JavaScript.</p>
</div>
<div class="paragraph">
<p>If my intention for this post had been to bash JavaScript I chose a poor example to compare with. But then again
that was never my intention. I wanted to show how a well written JavaScript app might compare to an Elm implementation
written by an Elm noob. Hopefully I&#8217;ve also managed to demonstrate that it&#8217;s not all that difficult getting started with Elm and perhaps
peeked your interest enough to give it a try !</p>
</div>
<div class="sect2">
<h3 id="_resources">Resources</h3>
<div class="paragraph">
<p>These are some of the resources that have helped me getting up to speed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://pragmaticstudio.com/elm">Elm: Building Reactive Web Apps</a> - A really nice step-by-step tutorial with videos and examples to get you up to speed. You get great value for $29 I think.</p>
</li>
<li>
<p><a href="https://pragmaticstudio.com/elm-signals">Elm: Signals, Mailboxes &amp; Ports</a> - Elm signals in depth. Really useful for getting into more detail on what Signals are, how they work and how to use them.</p>
</li>
<li>
<p><a href="https://github.com/evancz/elm-architecture-tutorial/">Elm Architecture Tutorial</a> - Tutorial outlining "the Elm Architecture"</p>
</li>
<li>
<p><a href="http://elm-lang.org/">elm-lang.org</a> - The official site for the elm language</p>
</li>
<li>
<p><a href="https://github.com/rundis/elm-light">elm-light</a> - My elm plugin for Light Table, or if you use another editor it might be listed <a href="http://elm-lang.org/get-started#configure-your-editor">here</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_addendum_potential_improvements">Addendum - Potential improvements</h3>
<div class="ulist">
<ul>
<li>
<p>Initialize game with seed without adding an extra state</p>
</li>
<li>
<p>Perhaps I should/could have used <a href="http://elm-lang.org/docs/records#record-types">extensible records</a> to model the game</p>
</li>
<li>
<p>Maybe Array would be a better choice than List for holding tiles ?</p>
</li>
</ul>
</div>
</div>
</div>
</div></p>

  <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'rundis';
	      var disqus_identifier = 'elm_sweeper';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	<hr />

		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2015 Magnus Rundberget
          <a class="pull-right btn btn-xs" href="https://twitter.com/mrundberget"><i class="fa fa-twitter"></i></a>
          <a class="pull-right btn btn-xs" href="https://github.com/rundis"><i class="fa fa-github"></i></a>
          <a class="pull-right btn btn-xs" href="http://no.linkedin.com/in/mrundberget"><i class="fa fa-linkedin"></i></a>
        </p>
      </div>
    </div>

    <script src="../js/jquery-1.11.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/prettify.js"></script>
  </body>
</html>
